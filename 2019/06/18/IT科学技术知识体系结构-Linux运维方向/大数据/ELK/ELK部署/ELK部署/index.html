<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="ELK," />





  <link rel="alternate" href="/atom.xml" title="Watchmen1992's Blog" type="application/atom+xml" />






<meta name="description" content="ELK部署">
<meta name="keywords" content="ELK">
<meta property="og:type" content="article">
<meta property="og:title" content="ELK部署">
<meta property="og:url" content="http://yoursite.com/2019/06/18/IT科学技术知识体系结构-Linux运维方向/大数据/ELK/ELK部署/ELK部署/index.html">
<meta property="og:site_name" content="Watchmen1992&#39;s Blog">
<meta property="og:description" content="ELK部署">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2019-06-18T09:19:33.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ELK部署">
<meta name="twitter:description" content="ELK部署">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2019/06/18/IT科学技术知识体系结构-Linux运维方向/大数据/ELK/ELK部署/ELK部署/"/>





  <title>ELK部署 | Watchmen1992's Blog</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?07235ad5687ee838f373b31c7c687d23";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Watchmen1992's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">锦瑟年华当与书香为度，是为不负天地人生。</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/18/IT科学技术知识体系结构-Linux运维方向/大数据/ELK/ELK部署/ELK部署/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="XiaoHua WANG">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/touxiang.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Watchmen1992's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">ELK部署</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-18T17:19:33+08:00">
                2019-06-18
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2019-06-18T17:19:33+08:00">
                2019-06-18
              </time>
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IT科学技术知识体系结构-Linux运维方向/" itemprop="url" rel="index">
                    <span itemprop="name">IT科学技术知识体系结构-Linux运维方向</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IT科学技术知识体系结构-Linux运维方向/大数据/" itemprop="url" rel="index">
                    <span itemprop="name">大数据</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IT科学技术知识体系结构-Linux运维方向/大数据/ELK/" itemprop="url" rel="index">
                    <span itemprop="name">ELK</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IT科学技术知识体系结构-Linux运维方向/大数据/ELK/ELK部署/" itemprop="url" rel="index">
                    <span itemprop="name">ELK部署</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2019/06/18/IT科学技术知识体系结构-Linux运维方向/大数据/ELK/ELK部署/ELK部署/" class="leancloud_visitors" data-flag-title="ELK部署">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          
              <div class="post-description">
                  ELK部署
              </div>
          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h1><h2 id="实现架构"><a href="#实现架构" class="headerlink" title="实现架构"></a>实现架构</h2><p>传统的ELK是使用elasticsearch+logstash+kibana的方式来部署日志收集系统</p>
<p>但是在数据量较大下，该架构过于单薄存在各种问题，因此，我们这里所使用的架构是：</p>
<p>Filebeat—&gt;kafka—&gt;logstash—&gt;[elasticsearch、filesystem、kafka]</p>
<p>也就是说将客户端收集替换成了filebeat，将日志推送到kafka中，然后在用logstash收集kafaka中的数据，logstash的output可以是es、文件服务器等等</p>
<h2 id="架构说明"><a href="#架构说明" class="headerlink" title="架构说明"></a>架构说明</h2><h1 id="Filebeat部署"><a href="#Filebeat部署" class="headerlink" title="Filebeat部署"></a>Filebeat部署</h1><h2 id="filebeat工作原理"><a href="#filebeat工作原理" class="headerlink" title="filebeat工作原理"></a>filebeat工作原理</h2><p>Filebeat是本地文件的日志数据采集器，作为服务器上的代理安装。</p>
<p>Filebeat监视指定的日志目录或特定日志文件，使用tail -f file的机制，收集之后将它们转发给Elasticsearch或Logstash或kafka等进行存储。</p>
<p><strong>Filebeat由两个主要组件组成：</strong></p>
<ul>
<li><p>prospector    探勘器、查找器</p>
</li>
<li><p>harvester    采集器</p>
</li>
</ul>
<p><strong>工作过程概述：</strong></p>
<p>启动Filebeat时，启动<strong>一个或多个</strong>prospector，查看指定的日志文件<strong>目录或者单个文件</strong>。</p>
<p>对于涉及的每个日志文件，prospector 启动对应数量的harvester， 每个harvester会读取到指定文件的新内容，将新数据发送到libbeat，libbeat将聚合事件并将聚合数据发送到你为Filebeat配置的输出。</p>
<h3 id="prospector"><a href="#prospector" class="headerlink" title="prospector"></a>prospector</h3><p>prospector有2个职责：负责找到所有需要收集的文件对象，以及管理harvester</p>
<p>注意：prospector只能读取本地文件， 不能连接到远程主机来读取存储的文件或日志。</p>
<h3 id="harvester"><a href="#harvester" class="headerlink" title="harvester"></a>harvester</h3><p>harvester只有1个职责：负责读取单个文件的内容，并将内容发送到指定的output</p>
<p>prospector会为每一个要收集的文件都启动一个harvester<br>harvester 负责打开和关闭文件，这意味着在运行时文件描述符保持打开状态，如果文件在读取时被删除或重命名，Filebeat将继续读取文件。也就是说，这会存在一个问题，就是如果文件被删了了，但是在harvester关闭之前，磁盘上的空间将会被保留无法释放。默认情况下，Filebeat将文件保持打开状态，直到达到close_inactive状态</p>
<h2 id="Filebeat如何保持文件的状态？"><a href="#Filebeat如何保持文件的状态？" class="headerlink" title="Filebeat如何保持文件的状态？"></a>Filebeat如何保持文件的状态？</h2><p>prospector保存每个文件的状态并经常将状态刷新到磁盘上的注册文件(data/registry)中。</p>
<p>该状态的作用是用于harvester记住正在读取文件的最后偏移量，并确保发送所有日志行。如果输出（例如Elasticsearch或Logstash）无法访问，Filebeat会检测output，并在oputput再次可用时继续读取文件发送。</p>
<p>在Filebeat运行时，每个prospector内存中也会保存的文件状态信息，<br>当重新启动Filebeat时，将使用注册文件的数据来重建文件状态，每个harvester基于注册文件中记录的最后偏移量继续读取。</p>
<p>因为文件可以被重命名或移动，因此文件名和路径不足以识别文件，对于每个文件，Filebeat存储唯一标识符以检测文件是否先前已采集过。</p>
<p>如果每天会创建大量新文件，注册文件增长可能过大。这个时候参阅注册表文件太大相关问题？</p>
<h2 id="Filebeat如何确保至少一次分发"><a href="#Filebeat如何确保至少一次分发" class="headerlink" title="Filebeat如何确保至少一次分发"></a>Filebeat如何确保至少一次分发</h2><p>Filebeat保证所有的事件至少会被传送到配置的output一次，并且不会丢失数据。 Filebeat之所以能够实现此行为，因为它将每个事件的传递状态存储在注册文件中。</p>
<p>如果输出（例如Elasticsearch或Logstash）无法访问，Filebeat会检测output，并在oputput再次可用时继续读取文件发送。</p>
<p>如果Filebeat在发送事件的过程中关闭，它不会等待output确认所有收到事件。发送到output但未确认的任何事件将会在在重新启动Filebeat后再次发送，这可以确保每个事件至少发送一次，但最终可能会将重复发送事件发送到output</p>
<p>介于这个特性，我们可以配置shutdown_timeout参数来指定，在手动关闭filebeat时，等待多久才停止进程</p>
<p>注意：Filebeat的至少一次交付保证在日志轮换和删除旧文件时有限制。如果将日志文件写入磁盘并且写入速度超过Filebeat可以处理的速度，或者在output不可用时删除了文件，则可能会丢失数据。<br>在Linux上，Filebeat也可能因inode重用而跳过行</p>
<h2 id="filebeat安装配置"><a href="#filebeat安装配置" class="headerlink" title="filebeat安装配置"></a>filebeat安装配置</h2><h3 id="基础环境"><a href="#基础环境" class="headerlink" title="基础环境"></a>基础环境</h3><p>Before running Filebeat, you need to install and configure the Elastic stack. See <a href="http://www.elastic.co/guide/en/beats/libbeat/6.2/getting-started.html" target="_blank" rel="noopener">Getting Started with Beats and the Elastic Stack</a>.</p>
<p>A regular <em>Beats setup</em> consists of:</p>
<ul>
<li>Elasticsearch for storage and indexing. See <a href="https://www.elastic.co/guide/en/beats/libbeat/6.2/elasticsearch-installation.html" target="_blank" rel="noopener">Install Elasticsearch</a>.</li>
<li>Logstash (optional) for inserting data into Elasticsearch. See <a href="https://www.elastic.co/guide/en/beats/libbeat/6.2/logstash-installation.html" target="_blank" rel="noopener">Installing Logstash</a>.</li>
<li>Kibana for the UI. See <a href="https://www.elastic.co/guide/en/beats/libbeat/6.2/kibana-installation.html" target="_blank" rel="noopener">Install Kibana</a>.</li>
<li>One or more Beats. You install the Beats on your servers to capture operational data. See <a href="https://www.elastic.co/guide/en/beats/libbeat/6.2/installing-beats.html" target="_blank" rel="noopener">Install Beats</a>.</li>
<li>Kibana dashboards for visualizing the data.</li>
</ul>
<p>也就是说，在部署filebeat之前，我们需要ELK环境，相当于说filebeat是在ELK的基础之上的一个组件。</p>
<p>如果还没有ELK环境的，先跳转到ES部分。</p>
<h3 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h3><p>在这里，我们使用源码包的方式安装：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-6.2.3-linux-x86_64.tar.gz</span><br></pre></td></tr></table></figure>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>默认的配置如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[appdeploy@node001 filebeat6]$ cat filebeat.yml</span><br><span class="line">filebeat.prospectors:</span><br><span class="line">- type: log</span><br><span class="line">  enabled: false</span><br><span class="line">  paths:</span><br><span class="line">    - /var/log/*.log</span><br><span class="line">filebeat.config.modules:</span><br><span class="line">  path: $&#123;path.config&#125;/modules.d/*.yml</span><br><span class="line">  reload.enabled: false</span><br><span class="line">setup.template.settings:</span><br><span class="line">  index.number_of_shards: 3</span><br><span class="line">setup.kibana:</span><br><span class="line">output.elasticsearch:</span><br><span class="line">  hosts: [&quot;localhost:9200&quot;]</span><br></pre></td></tr></table></figure>
<p>一个实际的案例配置文件如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">filebeat.shutdown_timeout: 10s</span><br><span class="line">filebeat.config.prospectors:</span><br><span class="line">  enabled: true</span><br><span class="line">  path: conf/*.yml</span><br><span class="line">  reload.enabled: true</span><br><span class="line">  reload.period: 10s</span><br><span class="line">output.kafka:</span><br><span class="line">  hosts: [&quot;172.24.48.76:19092&quot;, &quot;172.24.48.77:19092&quot;, &quot;172.24.48.78:19092&quot;]</span><br><span class="line">  topic: &apos;%&#123;[fields.log_topic]&#125;&apos;</span><br><span class="line">  key: &apos;%&#123;[fields.app_name]&#125; %&#123;[beat.hostname]&#125;&apos;</span><br><span class="line">  required_acks: 1</span><br><span class="line">  workers: 6</span><br><span class="line">  timeout: 120</span><br><span class="line">  compression: snappy</span><br><span class="line">  max_message_bytes: 10240000</span><br><span class="line">  codec.format:</span><br><span class="line">     string: &apos;%&#123;[fields.app_name]&#125; %&#123;[beat.hostname]&#125; %&#123;[message]&#125;&apos;</span><br><span class="line">xpack.monitoring:</span><br><span class="line">  enabled: true</span><br><span class="line">  elasticsearch:</span><br><span class="line">    hosts: [&quot;http://172.24.48.76:9200&quot;, &quot;http://172.24.48.77:9200&quot;, &quot;http://172.24.48.78:9200&quot;]</span><br></pre></td></tr></table></figure>
<h3 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h3><pre><code>nohup /home/appdeploy/deploy/tools/filebeat6/filebeat -e -c /home/appdeploy/deploy/tools/filebeat6/applogg.yml &gt;&gt;/home/appdeploy/deploy/tools/filebeat6/applogg.log &amp;
</code></pre><h2 id="filebeat的模块"><a href="#filebeat的模块" class="headerlink" title="filebeat的模块"></a>filebeat的模块</h2><p>filebeat的模块简化了收集、解析以及可视化例如nginx、Redis、mysql等通用日志格式这一系列操作。</p>
<p>也就是说，通过使用这些现成的模块，我们可以快速的进行收集，而免去了比较繁琐的自定义设置。</p>
<h2 id="filebeat的配置详解"><a href="#filebeat的配置详解" class="headerlink" title="filebeat的配置详解"></a>filebeat的配置详解</h2><h3 id="设置prospectors-探勘器、查找器"><a href="#设置prospectors-探勘器、查找器" class="headerlink" title="设置prospectors- 探勘器、查找器"></a>设置prospectors- 探勘器、查找器</h3><p>filebeat使用prospectors去定位和处理文件。</p>
<p>在yml配置文件中以”filebeat.prospectors:”开头，下面的列表代表每一个prospectors(一个type就是一个prospectors)</p>
<p>例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">filebeat.prospectors:</span><br><span class="line">- type: log</span><br><span class="line">  paths:</span><br><span class="line">    - /var/log/apache/httpd-*.log</span><br><span class="line"></span><br><span class="line">- type: log</span><br><span class="line">  paths:</span><br><span class="line">    - /var/log/messages</span><br><span class="line">    - /var/log/*.log</span><br></pre></td></tr></table></figure>
<p>filebeat将会为每一个文件都启动一个harvester。</p>
<p>在prospectors这一栏中，有一些参数可以配置：</p>
<ul>
<li><p>type。下面是一些常用的二级参数，归属于type下</p>
<ul>
<li><p>paths：文件的路径列表</p>
</li>
<li><p>exclude_lines</p>
</li>
<li><p>Include_lines</p>
</li>
<li><p>tags。tags可以用于后面的logstash过滤</p>
</li>
<li><p>fileds</p>
</li>
<li><p>scan_frequency：在指定的path下，每隔多久去检测是否有新文件</p>
</li>
<li><p>harvester_buffer_size</p>
</li>
<li><p>max_bytes。这个参数需要关注下。</p>
</li>
<li><p>tail_files</p>
<blockquote>
<p>如果这个参数被设置为true，</p>
</blockquote>
</li>
</ul>
</li>
</ul>
<h3 id="Multiline-多行合并管理"><a href="#Multiline-多行合并管理" class="headerlink" title="Multiline-多行合并管理"></a>Multiline-多行合并管理</h3><p>参考链接：<a href="https://www.elastic.co/guide/en/beats/filebeat/6.2/multiline-examples.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/beats/filebeat/6.2/multiline-examples.html</a></p>
<p>因为在应用的日志输出中，例如java的堆栈信息等，输出是多行的形式，例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[beat-logstash-some-name-832-2015.11.28] IndexNotFoundException[no such index]</span><br><span class="line">    at org.elasticsearch.cluster.metadata.IndexNameExpressionResolver$WildcardExpressionResolver.resolve(IndexNameExpressionResolver.java:566)</span><br><span class="line">    at org.elasticsearch.cluster.metadata.IndexNameExpressionResolver.concreteIndices(IndexNameExpressionResolver.java:133)</span><br><span class="line">    at org.elasticsearch.cluster.metadata.IndexNameExpressionResolver.concreteIndices(IndexNameExpressionResolver.java:77)</span><br><span class="line">    at org.elasticsearch.action.admin.indices.delete.TransportDeleteIndexAction.checkBlock(TransportDeleteIndexAction.java:75)</span><br></pre></td></tr></table></figure>
<p>这几行其实是同一段，我们要放在一起展示，所以需要把这多行的信息进行归纳。这时，就使用到了多行合并的功能</p>
<p>配置案例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">- type: log</span><br><span class="line">  paths:</span><br><span class="line">    - /home/appdeploy/deploy/logs/rider-mission-card/rider-mission-card.log</span><br><span class="line">  multiline.pattern: &apos;^[0-9]&#123;4&#125;-[0-9]&#123;2&#125;-[0-9]&#123;2&#125;&apos;</span><br><span class="line">  multiline.negate: true</span><br><span class="line">  multiline.match: after</span><br></pre></td></tr></table></figure>
<p>上面配置的意思是：不以’^[0-9]{4}-[0-9]{2}-[0-9]{2}’开头的行都合并到上一行的末尾</p>
<p>配置项说明：</p>
<ul>
<li><p>pattern：正则表达式</p>
</li>
<li><p>negate：true 或 false；控制是否匹配上面的正则表达式规则</p>
<p>默认是false，匹配pattern的行，合并到上一行；</p>
<p>true，匹配到pattern的行，不合并到上一行</p>
</li>
<li><p>match：after 或 before，控制如何合并。合并到上一行的末尾或者开头。</p>
<p>处理java等日志时，我们肯定是合并到上一行的后面。</p>
</li>
</ul>
<h3 id="加载外部的配置文件"><a href="#加载外部的配置文件" class="headerlink" title="加载外部的配置文件"></a>加载外部的配置文件</h3><h4 id="prospector-config"><a href="#prospector-config" class="headerlink" title="prospector config"></a><strong>prospector config</strong></h4><p>探勘器、查找器使用如下的方式去加载外部的配置文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">filebeat.config.prospectors:</span><br><span class="line">  enabled: true</span><br><span class="line">  path: configs/*.yml</span><br></pre></td></tr></table></figure>
<p>被加载的外部文件的格式应该是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">- type: log</span><br><span class="line">  paths:</span><br><span class="line">    - /var/log/mysql.log</span><br><span class="line">  scan_frequency: 10s</span><br><span class="line"></span><br><span class="line">- type: log</span><br><span class="line">  paths:</span><br><span class="line">    - /var/log/apache.log</span><br><span class="line">  scan_frequency: 5s</span><br></pre></td></tr></table></figure>
<h4 id="动态重加载"><a href="#动态重加载" class="headerlink" title="动态重加载"></a>动态重加载</h4><p>当配置的，加载外部文件的路径下有文件更新时，filebeat需要能够感知，所以filebeat提供了一个reload的功能。</p>
<p>配置方式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">filebeat.config.prospectors:</span><br><span class="line">  enabled: true</span><br><span class="line">  path: configs/*.yml</span><br><span class="line">  reload.enabled: true</span><br><span class="line">  reload.period: 10s</span><br></pre></td></tr></table></figure>
<p>注意：period的值不要设置少于1s，因为修改文件的操作往往在s级左右，</p>
<h2 id="output配置"><a href="#output配置" class="headerlink" title="output配置"></a>output配置</h2><h3 id="es"><a href="#es" class="headerlink" title="es"></a>es</h3><p>当使用filebeat直接连接es或者kibana时，如果有密码配置，配置文件应该为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">output.elasticsearch:</span><br><span class="line">  hosts: [&quot;myEShost:9200&quot;]</span><br><span class="line">  username: &quot;elastic&quot;</span><br><span class="line">  password: &quot;elastic&quot;</span><br><span class="line">setup.kibana:</span><br><span class="line">  host: &quot;mykibanahost:5601&quot;</span><br><span class="line">  username: &quot;elastic&quot;  </span><br><span class="line">  password: &quot;elastic&quot;</span><br></pre></td></tr></table></figure>
<h3 id="logstash"><a href="#logstash" class="headerlink" title="logstash"></a>logstash</h3><p>在filebeat的output中指定logstash即可：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#----------------------------- Logstash output --------------------------------</span><br><span class="line">output.logstash:</span><br><span class="line">  hosts: [&quot;127.0.0.1:5044&quot;]</span><br><span class="line">  loadbalance: true</span><br><span class="line">  worker: 4</span><br></pre></td></tr></table></figure>
<p>这里有几个比较常用的参数：</p>
<ul>
<li>worker：指定为每个主机的工作进程数，例如设置为2，output主机为2，那么总数为4</li>
<li>loadbalance：当后端有多个logstash主机时，可以设置为true</li>
</ul>
<h3 id="kafka"><a href="#kafka" class="headerlink" title="kafka"></a>kafka</h3><p>配置格式如下：</p>
<h2 id="filebeat监控"><a href="#filebeat监控" class="headerlink" title="filebeat监控"></a>filebeat监控</h2><h2 id="配置文件权限问题"><a href="#配置文件权限问题" class="headerlink" title="配置文件权限问题"></a>配置文件权限问题</h2><p>filebeat在启动的时候，可能会出现下面的问题：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2019-08-02T15:57:04.027+0800    ERROR   cfgfile/reload.go:237   Error loading config: invalid config: config file (&quot;/home/appdeploy/deploy/tools/filebeat6/conf/httpdns.yml&quot;) can only be writable by the owner but the permissions are &quot;-rw-rw-r--&quot; (to fix the permissions use: &apos;chmod go-w /home/appdeploy/deploy/tools/filebeat6/conf/httpdns.yml&apos;)</span><br></pre></td></tr></table></figure>
<p>文件的权限需要是644，在创建文件时，默认的权限是664</p>
<h2 id="系统日志权限问题"><a href="#系统日志权限问题" class="headerlink" title="系统日志权限问题"></a>系统日志权限问题</h2><p>当收集系统日志时，例如cron、secure、message、kern.log等时，如果filebeat使用的时候非root用户启动，那么默认是没有权限读取这些文件的，这个时候，我们就需要对这些日志进行相应的配置，保证启动用户对系统日志有权限。</p>
<h2 id="filebea案例"><a href="#filebea案例" class="headerlink" title="filebea案例"></a>filebea案例</h2><h3 id="收集终端标准输出"><a href="#收集终端标准输出" class="headerlink" title="收集终端标准输出"></a>收集终端标准输出</h3><h1 id="Logstash"><a href="#Logstash" class="headerlink" title="Logstash"></a>Logstash</h1><h2 id="logstash概述"><a href="#logstash概述" class="headerlink" title="logstash概述"></a>logstash概述</h2><p>logstash是一个具备实时pipelining流水线能力的数据收集引擎，它能动态的统一来自不同数据源的数据，规范化后发往output，</p>
<h3 id="logstash工作流"><a href="#logstash工作流" class="headerlink" title="logstash工作流"></a>logstash工作流</h3><p>logstash的工作流非常简单：inputs → filters → outputs</p>
<ul>
<li>input：</li>
</ul>
<h2 id="logstash术语表-glossary-of-terms"><a href="#logstash术语表-glossary-of-terms" class="headerlink" title="logstash术语表-glossary of terms"></a>logstash术语表-glossary of terms</h2><p>参考链接：<a href="https://www.elastic.co/guide/en/logstash/6.2/glossary.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/logstash/6.2/glossary.html</a></p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>我们一般使用源码包的安装方式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://artifacts.elastic.co/downloads/logstash/logstash-6.2.3.tar.gz</span><br></pre></td></tr></table></figure>
<p>下载下来之后，解压即可。</p>
<p>在安装之后，我们可以启动一个最简单的pipeline去测试功能：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd logstash-6.2.3</span><br><span class="line">bin/logstash -e &apos;input &#123; stdin &#123; &#125; &#125; output &#123; stdout &#123;&#125; &#125;&apos;</span><br></pre></td></tr></table></figure>
<p>-e参数可以让我们在命令行直接指定配置，而不是去编辑配置配置，这里的意思是input和output是使用标准输入和标准输出。</p>
<p>完整的输出如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[elk@node002 logstash-6.2.3]$ bin/logstash -e &apos;input &#123; stdin &#123; &#125; &#125; output &#123; stdout &#123;&#125; &#125;&apos;</span><br><span class="line"></span><br><span class="line">Sending Logstash&apos;s logs to /home/elk/logstash-6.2.3/logs which is now configured via log4j2.properties</span><br><span class="line">[2019-07-29T10:53:06,777][INFO ][logstash.modules.scaffold] Initializing module &#123;:module_name=&gt;&quot;fb_apache&quot;, :directory=&gt;&quot;/home/elk/logstash-6.2.3/modules/fb_apache/configuration&quot;&#125;</span><br><span class="line">[2019-07-29T10:53:06,874][INFO ][logstash.modules.scaffold] Initializing module &#123;:module_name=&gt;&quot;netflow&quot;, :directory=&gt;&quot;/home/elk/logstash-6.2.3/modules/netflow/configuration&quot;&#125;</span><br><span class="line">[2019-07-29T10:53:08,037][INFO ][logstash.setting.writabledirectory] Creating directory &#123;:setting=&gt;&quot;path.queue&quot;, :path=&gt;&quot;/home/elk/logstash-6.2.3/data/queue&quot;&#125;</span><br><span class="line">[2019-07-29T10:53:08,088][INFO ][logstash.setting.writabledirectory] Creating directory &#123;:setting=&gt;&quot;path.dead_letter_queue&quot;, :path=&gt;&quot;/home/elk/logstash-6.2.3/data/dead_letter_queue&quot;&#125;</span><br><span class="line">[2019-07-29T10:53:11,772][WARN ][logstash.config.source.multilocal] Ignoring the &apos;pipelines.yml&apos; file because modules or command line options are specified</span><br><span class="line">[2019-07-29T10:53:12,855][INFO ][logstash.agent           ] No persistent UUID file found. Generating new UUID &#123;:uuid=&gt;&quot;f9f6fb83-176e-4ba1-8065-ca5699df67fa&quot;, :path=&gt;&quot;/home/elk/logstash-6.2.3/data/uuid&quot;&#125;</span><br><span class="line">[2019-07-29T10:53:25,521][INFO ][logstash.runner          ] Starting Logstash &#123;&quot;logstash.version&quot;=&gt;&quot;6.2.3&quot;&#125;</span><br><span class="line">[2019-07-29T10:53:34,693][INFO ][logstash.agent           ] Successfully started Logstash API endpoint &#123;:port=&gt;9600&#125;</span><br><span class="line">[2019-07-29T10:54:13,765][INFO ][logstash.pipeline        ] Starting pipeline &#123;:pipeline_id=&gt;&quot;main&quot;, &quot;pipeline.workers&quot;=&gt;4, &quot;pipeline.batch.size&quot;=&gt;125, &quot;pipeline.batch.delay&quot;=&gt;50&#125;</span><br><span class="line">[2019-07-29T10:54:16,628][INFO ][logstash.pipeline        ] Pipeline started succesfully &#123;:pipeline_id=&gt;&quot;main&quot;, :thread=&gt;&quot;#&lt;Thread:0x7028647c run&gt;&quot;&#125;</span><br><span class="line">The stdin plugin is now waiting for input:</span><br><span class="line">[2019-07-29T10:54:19,144][INFO ][logstash.agent           ] Pipelines running &#123;:count=&gt;1, :pipelines=&gt;[&quot;main&quot;]&#125;</span><br><span class="line">2019-07-29T02:54:20.429Z node002</span><br><span class="line">2019-07-29T02:54:20.463Z node002</span><br><span class="line">2019-07-29T02:54:34.399Z node002</span><br><span class="line">hello world</span><br><span class="line">2019-07-29T02:54:39.357Z node002 hello world</span><br></pre></td></tr></table></figure>
<h2 id="配置-1"><a href="#配置-1" class="headerlink" title="配置"></a>配置</h2><h3 id="filebeat-logstash配置案例"><a href="#filebeat-logstash配置案例" class="headerlink" title="filebeat+logstash配置案例"></a>filebeat+logstash配置案例</h3><p>filebeat端配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[appdeploy@node001 filebeat6]$ cat filebeat.yml</span><br><span class="line">filebeat.prospectors:</span><br><span class="line">- type: log</span><br><span class="line">  paths:</span><br><span class="line">    - /home/appdeploy/logstash-tutorial.log</span><br><span class="line">output.logstash:</span><br><span class="line">  hosts: [&quot;192.168.101.172:5144&quot;]</span><br><span class="line">[appdeploy@node001 filebeat6]$</span><br></pre></td></tr></table></figure>
<p>启动filebeat：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./filebeat -e -c filebeat.yml -d "publish"</span><br></pre></td></tr></table></figure>
<p>logstash端配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[elk@node002 logstash-6.2.3]$ cat config/first-pipeline.conf</span><br><span class="line">input &#123;</span><br><span class="line">    beats &#123;</span><br><span class="line">        port =&gt; &quot;5144&quot;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">    stdout &#123; codec =&gt; rubydebug &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编辑完配置文件之后，我们可以检测一下配置文件的正确性：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[elk@node002 logstash-6.2.3]$ ./bin/logstash -f config/first-pipeline.conf --config.test_and_exit</span><br></pre></td></tr></table></figure>
<p>执行后的输出如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Sending Logstash&apos;s logs to /home/elk/logstash-6.2.3/logs which is now configured via log4j2.properties</span><br><span class="line">[2019-07-29T11:22:44,111][INFO ][logstash.modules.scaffold] Initializing module &#123;:module_name=&gt;&quot;fb_apache&quot;, :directory=&gt;&quot;/home/elk/logstash-6.2.3/modules/fb_apache/configuration&quot;&#125;</span><br><span class="line">[2019-07-29T11:22:44,199][INFO ][logstash.modules.scaffold] Initializing module &#123;:module_name=&gt;&quot;netflow&quot;, :directory=&gt;&quot;/home/elk/logstash-6.2.3/modules/netflow/configuration&quot;&#125;</span><br><span class="line">[2019-07-29T11:22:49,059][WARN ][logstash.config.source.multilocal] Ignoring the &apos;pipelines.yml&apos; file because modules or command line options are specified</span><br><span class="line">Configuration OK</span><br><span class="line">[2019-07-29T11:23:29,319][INFO ][logstash.runner          ] Using config.test_and_exit mode. Config Validation Result: OK. Exiting Logstash</span><br><span class="line">[elk@node002 logstash-6.2.3]$</span><br></pre></td></tr></table></figure>
<p>检测通过之后，我们可以启动logsatsh</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/logstash -f config/first-pipeline.conf --config.reload.automatic</span><br></pre></td></tr></table></figure>
<p>—config.reload.automatic参数的作用是，当我们修改了配置文件之后，进程能够自动的reload</p>
<h3 id="grok过滤"><a href="#grok过滤" class="headerlink" title="grok过滤"></a>grok过滤</h3><p>查看当前logstash已安装的所有插件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[elk@node004 logstash-6.2.3]$ bin/logstash-plugin list</span><br></pre></td></tr></table></figure>
<p>grok插件能够帮助你解析结构凌乱的日志，转变成有结构的以及可查询的。</p>
<p>从源数据中拆分出我们需要的字段进行展示。</p>
<p>grok使用正则表达式去匹配源的数据</p>
<p>一个简单的案例：</p>
<p>我们使用logstash内置的%{COMBINEDAPACHELOG}进行匹配</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[elk@node004 config]$ cat first-pipeline.conf</span><br><span class="line">input &#123;</span><br><span class="line">    beats &#123;</span><br><span class="line">        port =&gt; &quot;5144&quot;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">    grok &#123;</span><br><span class="line">        match =&gt; &#123; &quot;message&quot; =&gt; &quot;%&#123;COMBINEDAPACHELOG&#125;&quot; &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">    stdout &#123; codec =&gt; rubydebug &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>reload或者重启后，在filebeat节点上删除注册文件之后，在重新启动filebeat，logstash端的显示为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">     &quot;@timestamp&quot; =&gt; 2019-07-29T08:53:35.835Z,</span><br><span class="line">        &quot;message&quot; =&gt; &quot;192.1.76.62 - - [04/Jan/2015:05:30:37 +0000] \&quot;GET /style2.css HTTP/1.1\&quot; 200 4877 \&quot;http://www.semicomplete.com/projects/xdotool/\&quot; \&quot;Mozilla/5.0 (X11; Linux x86_64; rv:24.0) Gecko/20140205 Firefox/24.0 Iceweasel/24.3.0\&quot;&quot;,</span><br><span class="line">          &quot;ident&quot; =&gt; &quot;-&quot;,</span><br><span class="line">     &quot;prospector&quot; =&gt; &#123;</span><br><span class="line">        &quot;type&quot; =&gt; &quot;log&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">      &quot;timestamp&quot; =&gt; &quot;04/Jan/2015:05:30:37 +0000&quot;,</span><br><span class="line">       &quot;clientip&quot; =&gt; &quot;192.1.76.62&quot;,</span><br><span class="line">       &quot;referrer&quot; =&gt; &quot;\&quot;http://www.semicomplete.com/projects/xdotool/\&quot;&quot;,</span><br><span class="line">           &quot;verb&quot; =&gt; &quot;GET&quot;,</span><br><span class="line">         &quot;source&quot; =&gt; &quot;/home/appdeploy/logstash-tutorial.log&quot;,</span><br><span class="line">           &quot;beat&quot; =&gt; &#123;</span><br><span class="line">        &quot;hostname&quot; =&gt; &quot;node001&quot;,</span><br><span class="line">         &quot;version&quot; =&gt; &quot;6.2.3&quot;,</span><br><span class="line">            &quot;name&quot; =&gt; &quot;node001&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">       &quot;@version&quot; =&gt; &quot;1&quot;,</span><br><span class="line">           &quot;host&quot; =&gt; &quot;node001&quot;,</span><br><span class="line">       &quot;response&quot; =&gt; &quot;200&quot;,</span><br><span class="line">          &quot;bytes&quot; =&gt; &quot;4877&quot;,</span><br><span class="line">          &quot;agent&quot; =&gt; &quot;\&quot;Mozilla/5.0 (X11; Linux x86_64; rv:24.0) Gecko/20140205 Firefox/24.0 Iceweasel/24.3.0\&quot;&quot;,</span><br><span class="line">        &quot;request&quot; =&gt; &quot;/style2.css&quot;,</span><br><span class="line">         &quot;offset&quot; =&gt; 24898,</span><br><span class="line">           &quot;tags&quot; =&gt; [</span><br><span class="line">        [0] &quot;beats_input_codec_plain_applied&quot;</span><br><span class="line">    ],</span><br><span class="line">           &quot;auth&quot; =&gt; &quot;-&quot;,</span><br><span class="line">    &quot;httpversion&quot; =&gt; &quot;1.1&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>%{COMBINEDAPACHELOG}包含的格式是：</p>
<table>
<thead>
<tr>
<th><strong>Information</strong></th>
<th><strong>Field Name</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>IP Address</td>
<td><code>clientip</code></td>
</tr>
<tr>
<td>User ID</td>
<td><code>ident</code></td>
</tr>
<tr>
<td>User Authentication</td>
<td><code>auth</code></td>
</tr>
<tr>
<td>timestamp</td>
<td><code>timestamp</code></td>
</tr>
<tr>
<td>HTTP Verb</td>
<td><code>verb</code></td>
</tr>
<tr>
<td>Request body</td>
<td><code>request</code></td>
</tr>
<tr>
<td>HTTP Version</td>
<td><code>httpversion</code></td>
</tr>
<tr>
<td>HTTP Status Code</td>
<td><code>response</code></td>
</tr>
<tr>
<td>Bytes served</td>
<td><code>bytes</code></td>
</tr>
<tr>
<td>Referrer URL</td>
<td><code>referrer</code></td>
</tr>
<tr>
<td>User agent</td>
<td><code>agent</code></td>
</tr>
</tbody>
</table>
<p>注意：</p>
<ul>
<li>使用了grok之后，生成了我们需要的自定义字段之后，发往output的这个event依旧包含这个原始的未被拆分的message</li>
</ul>
<h3 id="设置output为es"><a href="#设置output为es" class="headerlink" title="设置output为es"></a>设置output为es</h3><p>在配置文件中，配置输出为es:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">output &#123;</span><br><span class="line">    elasticsearch &#123;</span><br><span class="line">        hosts =&gt; [ &quot;localhost:9200&quot; ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在整体的配置为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[elk@node004 logstash-6.2.3]$ cat config/first-pipeline.conf</span><br><span class="line">input &#123;</span><br><span class="line">    beats &#123;</span><br><span class="line">        port =&gt; &quot;5144&quot;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">    grok &#123;</span><br><span class="line">        match =&gt; &#123; &quot;message&quot; =&gt; &quot;%&#123;COMBINEDAPACHELOG&#125;&quot; &#125;</span><br><span class="line">&#125;</span><br><span class="line">    geoip &#123;</span><br><span class="line">        source =&gt; &quot;clientip&quot;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">    elasticsearch &#123;</span><br><span class="line">        hosts =&gt; [ &quot;192.168.100.113:9500&quot; ]</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="启动参数"><a href="#启动参数" class="headerlink" title="启动参数"></a>启动参数</h3><p>主要需要关注的参数有：</p>
<ul>
<li>-f：指定配置文件</li>
<li>-w：指定pipeline的工作进程数量。</li>
<li>-b：指定每个工作线程最大处理的event数量，默认是125。调大这个数量也就以为着更大的内存消耗，这个需要参考JVM参数进行配置。</li>
<li><p>—pipeline.unsafe_shutdown：强制logstash在还有event没有处理完成的情况下就退出。</p>
</li>
<li><p>-r, —config.reload.automatic：在配置文件修改之后，自动reload配置文件</p>
</li>
</ul>
<h3 id="提取字段已经转变数据"><a href="#提取字段已经转变数据" class="headerlink" title="提取字段已经转变数据"></a>提取字段已经转变数据</h3><p>参考链接：<a href="https://www.elastic.co/guide/en/logstash/6.2/field-extraction.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/logstash/6.2/field-extraction.html</a></p>
<p>当输入是通用的日志格式时，我们可以使用grok去进行拆解</p>
<p>当输出是不规则的日志格式时，我们可以使用dissect去自定义我们的字段</p>
<h2 id="logstash的-metadata字段"><a href="#logstash的-metadata字段" class="headerlink" title="logstash的@metadata字段"></a>logstash的@metadata字段</h2><p>参考链接：<a href="https://www.elastic.co/guide/en/logstash/6.2/event-dependent-configuration.html#metadata" target="_blank" rel="noopener">https://www.elastic.co/guide/en/logstash/6.2/event-dependent-configuration.html#metadata</a></p>
<p>每一种类型的input，logstash都会生成对应的@metadata字段，具体的信息在input部分会有记录</p>
<p>默认情况下，如果不进行特殊设置，我们是看不到@metadata的内容的：</p>
<p>添加：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; metadata =&gt; true &#125;</span><br></pre></td></tr></table></figure>
<p>在调试模式下，output的设置是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">output &#123;</span><br><span class="line">    stdout &#123; codec =&gt; rubydebug &#123; metadata =&gt; true &#125; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在input为filebeat时，输出为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  &quot;@metadata&quot; =&gt; &#123;</span><br><span class="line">          &quot;beat&quot; =&gt; &quot;filebeat&quot;,</span><br><span class="line">       &quot;version&quot; =&gt; &quot;6.2.3&quot;,</span><br><span class="line">          &quot;type&quot; =&gt; &quot;doc&quot;,</span><br><span class="line">    &quot;ip_address&quot; =&gt; &quot;192.168.100.113&quot;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<h2 id="input部分"><a href="#input部分" class="headerlink" title="input部分"></a>input部分</h2><h3 id="Common-option"><a href="#Common-option" class="headerlink" title="Common option"></a>Common option</h3><p>下面这些是通用配置，在所有的input中都支持</p>
<table>
<thead>
<tr>
<th>Setting</th>
<th>Input type</th>
<th>Required</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://www.elastic.co/guide/en/logstash/6.2/plugins-inputs-kafka.html#plugins-inputs-kafka-add_field" target="_blank" rel="noopener"><code>add_field</code></a></td>
<td><a href="http://www.elastic.co/guide/en/logstash/6.2/configuration-file-structure.html#hash" target="_blank" rel="noopener">hash</a></td>
<td>No</td>
</tr>
<tr>
<td><a href="https://www.elastic.co/guide/en/logstash/6.2/plugins-inputs-kafka.html#plugins-inputs-kafka-codec" target="_blank" rel="noopener"><code>codec</code></a></td>
<td><a href="http://www.elastic.co/guide/en/logstash/6.2/configuration-file-structure.html#codec" target="_blank" rel="noopener">codec</a></td>
<td>No</td>
</tr>
<tr>
<td><a href="https://www.elastic.co/guide/en/logstash/6.2/plugins-inputs-kafka.html#plugins-inputs-kafka-enable_metric" target="_blank" rel="noopener"><code>enable_metric</code></a></td>
<td><a href="http://www.elastic.co/guide/en/logstash/6.2/configuration-file-structure.html#boolean" target="_blank" rel="noopener">boolean</a></td>
<td>No</td>
</tr>
<tr>
<td><a href="https://www.elastic.co/guide/en/logstash/6.2/plugins-inputs-kafka.html#plugins-inputs-kafka-id" target="_blank" rel="noopener"><code>id</code></a></td>
<td><a href="http://www.elastic.co/guide/en/logstash/6.2/configuration-file-structure.html#string" target="_blank" rel="noopener">string</a></td>
<td>No</td>
</tr>
<tr>
<td><a href="https://www.elastic.co/guide/en/logstash/6.2/plugins-inputs-kafka.html#plugins-inputs-kafka-tags" target="_blank" rel="noopener"><code>tags</code></a></td>
<td><a href="http://www.elastic.co/guide/en/logstash/6.2/configuration-file-structure.html#array" target="_blank" rel="noopener">array</a></td>
<td>No</td>
</tr>
<tr>
<td><a href="https://www.elastic.co/guide/en/logstash/6.2/plugins-inputs-kafka.html#plugins-inputs-kafka-type" target="_blank" rel="noopener"><code>type</code></a></td>
<td><a href="http://www.elastic.co/guide/en/logstash/6.2/configuration-file-structure.html#string" target="_blank" rel="noopener">string</a></td>
<td>No</td>
</tr>
</tbody>
</table>
<h3 id="beats"><a href="#beats" class="headerlink" title="beats"></a>beats</h3><p>参考配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">  beats &#123;</span><br><span class="line">    port =&gt; 5044</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  elasticsearch &#123;</span><br><span class="line">    hosts =&gt; &quot;localhost:9200&quot;</span><br><span class="line">    manage_template =&gt; false</span><br><span class="line">    index =&gt; &quot;%&#123;[@metadata][beat]&#125;-%&#123;[@metadata][version]&#125;-%&#123;+YYYY.MM.dd&#125;&quot;</span><br><span class="line">    document_type =&gt; &quot;%&#123;[@metadata][type]&#125;&quot; </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="kafka-1"><a href="#kafka-1" class="headerlink" title="kafka"></a>kafka</h3><p>本质上是logstash启动一个kafka的客户端，因为存在一定的版本兼容性问题，这里需要注意</p>
<p>在kafka中，主要关注这些参数：</p>
<ul>
<li><p>auto_offset_reset</p>
<blockquote>
<p>当没有最初始的偏移量或者偏移量超出范围了，这个时候，做什么操作</p>
<ul>
<li>earliest：reset偏移量为最早的</li>
<li>latest：reset偏移量为最晚的，也就是最新的。</li>
</ul>
</blockquote>
</li>
<li><p>bootstrap_servers</p>
<blockquote>
<p>kafka集群的地址。格式是：host1:port1,host2:port2</p>
</blockquote>
</li>
<li><p>group_id</p>
<blockquote>
<p>默认值是logstash。设置消费组的名称。</p>
</blockquote>
</li>
<li><p>session_timeout_ms</p>
<blockquote>
<p>如果poll_timeout_ms时间（等待kafka推送消息的超时时间，默认是100ms）超时，过多长时间之后，这个消费者将会被标记为dead。</p>
</blockquote>
</li>
<li><p>request_timeout_ms</p>
<blockquote>
<p>logstash上的kafka客户端等待响应的超时时间。</p>
</blockquote>
</li>
<li><p>max_poll_records</p>
<blockquote>
<p>单次调用的最大值</p>
</blockquote>
</li>
<li><p>consumer_threads</p>
<blockquote>
<p>默认值为1。最理想的情况是线程总数与topic的partition总数相同。如果大于partition总数，则会产生线程空闲，导致资源浪费。</p>
</blockquote>
</li>
<li><p>topics</p>
<blockquote>
<p>监听的topic列表，默认值是logstash。</p>
</blockquote>
</li>
</ul>
<h2 id="filter部分"><a href="#filter部分" class="headerlink" title="filter部分"></a>filter部分</h2><h3 id="grok"><a href="#grok" class="headerlink" title="grok"></a>grok</h3><p>解析非结构化的日志，将日志拆分成为结构化的可查询的字段数据。</p>
<p>grok中预先定义了很多的正则表达式，在使用的时候只需要调用即可。</p>
<p>grok 表达式的打印复制格式的完整语法是下面这样的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%&#123;PATTERN_NAME:capture_name:data_type&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>PATTERN_NAME。代表匹配值的类型,例如3.44可以用NUMBER类型所匹配,127.0.0.1可以使用IP类型匹配。 </li>
<li>capture_name。代表存储该值的一个变量名称,例如 3.44 可能是一个事件的持续时间,127.0.0.1可能是请求的client地址。所以这两个值可以用 %{NUMBER:duration} %{IP:client_ip} 来匹配。</li>
</ul>
<p>案例1:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">input &#123;stdin&#123;&#125;&#125;</span><br><span class="line">filter &#123;</span><br><span class="line">    grok &#123;</span><br><span class="line">        match =&gt; &#123;</span><br><span class="line">            &quot;message&quot; =&gt; &quot;%&#123;WORD&#125; %&#123;NUMBER:request_time:float&#125; %&#123;WORD&#125;&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">output &#123;stdout&#123;&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>运行如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">         &quot;message&quot; =&gt; &quot;begin 123.456 end&quot;,</span><br><span class="line">        &quot;@version&quot; =&gt; &quot;1&quot;,</span><br><span class="line">      &quot;@timestamp&quot; =&gt; &quot;2014-08-09T12:23:36.634Z&quot;,</span><br><span class="line">            &quot;host&quot; =&gt; &quot;raochenlindeMacBook-Air.local&quot;,</span><br><span class="line">    &quot;request_time&quot; =&gt; 123.456</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>把 request_time 变成数值类型。如果不使用这个，使用下面这种，那么将会拆分为字符串</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">input &#123;stdin&#123;&#125;&#125;</span><br><span class="line">filter &#123;</span><br><span class="line">    grok &#123;</span><br><span class="line">        match =&gt; &#123;</span><br><span class="line">            &quot;message&quot; =&gt; &quot;\s+(?&lt;request_time&gt;\d+(?:\.\d+)?)\s+&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">output &#123;stdout&#123;&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>注意：</p>
<p>grok match本质是一个正则匹配,默认出来的数据都是String.有些时候我们知道某个值其实是个数据类型,这时候可以直接指定数据类型. 不过match中仅支持直接转换成int ,float,语法是 %{NUMBER:response_time:int}</p>
<p>案例2：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">  grok &#123;</span><br><span class="line">    match =&gt; &#123; &quot;message&quot; =&gt; &quot;%&#123;IP:client&#125; %&#123;WORD:method&#125; %&#123;URIPATHPARAM:request&#125; %&#123;NUMBER:bytes&#125; %&#123;NUMBER:duration&#125;&quot; &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以下是filter结果：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">● client: <span class="number">55.3</span><span class="number">.244</span><span class="number">.1</span></span><br><span class="line">● method: GET</span><br><span class="line">● request: /index.html</span><br><span class="line">● bytes: <span class="number">15824</span></span><br><span class="line">● duration: <span class="number">0.043</span></span><br></pre></td></tr></table></figure>
<h4 id="自定义pattern"><a href="#自定义pattern" class="headerlink" title="自定义pattern"></a>自定义pattern</h4><p><strong>引入文件方法</strong></p>
<p>很多时候logstash grok没办法提供你所需要的匹配类型，这个时候我们可以使用自定义</p>
<p>grok里面的match的message，其实是定义在<a href="https://github.com/logstash-plugins/logstash-patterns-core/tree/master/patterns" target="_blank" rel="noopener">这里</a>的各种pattern。<br>我们可以自定义pattern。</p>
<p>形式如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">USERNAME [a-zA-Z0-9._-]+</span><br><span class="line">USER %&#123;USERNAME&#125;</span><br><span class="line">EMAILLOCALPART [a-zA-Z][a-zA-Z0-9_.+-=:]+</span><br><span class="line">EMAILADDRESS %&#123;EMAILLOCALPART&#125;@%&#123;HOSTNAME&#125;</span><br><span class="line">INT (?:[+-]?(?:[0-9]+))</span><br></pre></td></tr></table></figure>
<p>将这些pattern保存在文件中，然后在logstash的config中制定读取pattern的目录即可。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">  grok &#123;</span><br><span class="line">    patterns_dir =&gt; [&quot;/usr/local/logstash/patterns&quot;]</span><br><span class="line">			match =&gt; &#123; &quot;message&quot; =&gt; &quot;%&#123;USER: user&#125; %&#123;INT: age&#125; %&#123;EMAILADDRESS: email&#125;&quot;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样，我们输出的时候可以获得到message,user,age,email这几个field。</p>
<p>配置文件内即时配置方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">语法：(?&lt;field_name&gt;the pattern here)</span><br></pre></td></tr></table></figure>
<p>就是上面的这个案例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">input &#123;stdin&#123;&#125;&#125;</span><br><span class="line">filter &#123;</span><br><span class="line">    grok &#123;</span><br><span class="line">        match =&gt; &#123;</span><br><span class="line">            &quot;message&quot; =&gt; &quot;\s+(?&lt;request_time&gt;\d+(?:\.\d+)?)\s+&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">output &#123;stdout&#123;&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>拆分出来，就是这个：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">?&lt;request_time&gt;\d+(?:\.\d+)?</span><br><span class="line"></span><br><span class="line">\d+(?:\.\d+)? 这个就是这个字段的匹配规则</span><br></pre></td></tr></table></figure>
<p>\s：匹配任何不可见字符，包括空格、制表符、换页符等等。等价于[ \f\n\r\t\v]。+表示匹配次数为1次或者多次</p>
<p>(?<request_time>  )：这个是grok语法,request_time表示要将捕获的字符定义成的字段名</request_time></p>
<p>\d+：匹配一个或者多个数字</p>
<p>(?:.\d+)：为正则表达式，</p>
<p>(?: pattern):非获取匹配，匹配pattern但不获取匹配结果，不进行存储供以后使用。这在使用或字符“(|)”来组合一个模式的各个部分是很有用。例如“industr(?:y|ies)”就是一个比“industry|industries”更简略的表达式。</p>
<p>.\d+：表示点后面跟一个或者多个 数字，(?:.\d+)?表示点后面跟一个或多个数字这种情况出现0次或者多次，如果为0次，则request_time为一个整数。所以匹配到的结果可能为123.456或者123或者123.4.5.6，这些都满足条件</p>
<p>注意：</p>
<p>()表示捕获分组，()会把每个分组里的匹配的值保存起来，使用$n(n是一个数字，表示第n个捕获组的内容)<br>(?:)表示非捕获分组，和捕获分组唯一的区别在于，非捕获分组匹配的值不会保存起来</p>
<h4 id="overwrite"><a href="#overwrite" class="headerlink" title="overwrite"></a>overwrite</h4><p>如果原本的字段需要重写掉，那么：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">  grok &#123;</span><br><span class="line">    match =&gt; &#123; &quot;message&quot; =&gt; &quot;%&#123;SYSLOGBASE&#125; %&#123;DATA:message&#125;&quot; &#125;</span><br><span class="line">    overwrite =&gt; [ &quot;message&quot; ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="add-field"><a href="#add-field" class="headerlink" title="add_field"></a>add_field</h4><h4 id="remove-field"><a href="#remove-field" class="headerlink" title="remove_field"></a>remove_field</h4><p>#### </p>
<h3 id="dissect"><a href="#dissect" class="headerlink" title="dissect"></a>dissect</h3><p>dissect主要用于切割操作。dissect不使用正则表达式去进行匹配，因此，它的处理速度是非常快的。</p>
<p>如果你的内容每一行都是比较规则的，那么grok是更合适的。</p>
<p>分隔字段的这个动作，我们叫做解刨<strong>dissection</strong></p>
<p>语法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%&#123;a&#125; - %&#123;b&#125; - %&#123;c&#125;</span><br></pre></td></tr></table></figure>
<p>{}内的是拆分之后的字段名称</p>
<p>一个案例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">  dissect &#123;</span><br><span class="line">    mapping =&gt; &#123;</span><br><span class="line">      &quot;message&quot; =&gt; &quot;%&#123;ts&#125; %&#123;+ts&#125; %&#123;+ts&#125; %&#123;src&#125; %&#123;&#125; %&#123;prog&#125;[%&#123;pid&#125;]: %&#123;msg&#125;&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="字段追加"><a href="#字段追加" class="headerlink" title="字段追加"></a>字段追加</h4><p>使用+号</p>
<h3 id="mutate"><a href="#mutate" class="headerlink" title="mutate"></a>mutate</h3><p>mutate过滤器能够允许你修改、优化你的event。包括：rename、remove、replace、modify字段</p>
<h4 id="replace"><a href="#replace" class="headerlink" title="replace"></a>replace</h4><p>案例为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">    mutate &#123;</span><br><span class="line">        replace =&gt; &#123; &quot;type&quot; =&gt; &quot;nginx&quot;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="通用参数"><a href="#通用参数" class="headerlink" title="通用参数"></a>通用参数</h3><p>参考链接：<a href="https://www.elastic.co/guide/en/logstash/6.2/plugins-filters-grok.html#plugins-filters-grok-common-options" target="_blank" rel="noopener">https://www.elastic.co/guide/en/logstash/6.2/plugins-filters-grok.html#plugins-filters-grok-common-options</a></p>
<p>The following configuration options are supported by all filter plugins:</p>
<table>
<thead>
<tr>
<th>Setting</th>
<th>Input type</th>
<th>Required</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://www.elastic.co/guide/en/logstash/6.2/plugins-filters-dissect.html#plugins-filters-dissect-add_field" target="_blank" rel="noopener"><code>add_field</code></a></td>
<td><a href="http://www.elastic.co/guide/en/logstash/6.2/configuration-file-structure.html#hash" target="_blank" rel="noopener">hash</a></td>
<td>No</td>
</tr>
<tr>
<td><a href="https://www.elastic.co/guide/en/logstash/6.2/plugins-filters-dissect.html#plugins-filters-dissect-add_tag" target="_blank" rel="noopener"><code>add_tag</code></a></td>
<td><a href="http://www.elastic.co/guide/en/logstash/6.2/configuration-file-structure.html#array" target="_blank" rel="noopener">array</a></td>
<td>No</td>
</tr>
<tr>
<td><a href="https://www.elastic.co/guide/en/logstash/6.2/plugins-filters-dissect.html#plugins-filters-dissect-enable_metric" target="_blank" rel="noopener"><code>enable_metric</code></a></td>
<td><a href="http://www.elastic.co/guide/en/logstash/6.2/configuration-file-structure.html#boolean" target="_blank" rel="noopener">boolean</a></td>
<td>No</td>
</tr>
<tr>
<td><a href="https://www.elastic.co/guide/en/logstash/6.2/plugins-filters-dissect.html#plugins-filters-dissect-id" target="_blank" rel="noopener"><code>id</code></a></td>
<td><a href="http://www.elastic.co/guide/en/logstash/6.2/configuration-file-structure.html#string" target="_blank" rel="noopener">string</a></td>
<td>No</td>
</tr>
<tr>
<td><a href="https://www.elastic.co/guide/en/logstash/6.2/plugins-filters-dissect.html#plugins-filters-dissect-periodic_flush" target="_blank" rel="noopener"><code>periodic_flush</code></a></td>
<td><a href="http://www.elastic.co/guide/en/logstash/6.2/configuration-file-structure.html#boolean" target="_blank" rel="noopener">boolean</a></td>
<td>No</td>
</tr>
<tr>
<td><a href="https://www.elastic.co/guide/en/logstash/6.2/plugins-filters-dissect.html#plugins-filters-dissect-remove_field" target="_blank" rel="noopener"><code>remove_field</code></a></td>
<td><a href="http://www.elastic.co/guide/en/logstash/6.2/configuration-file-structure.html#array" target="_blank" rel="noopener">array</a></td>
<td>No</td>
</tr>
<tr>
<td><a href="https://www.elastic.co/guide/en/logstash/6.2/plugins-filters-dissect.html#plugins-filters-dissect-remove_tag" target="_blank" rel="noopener"><code>remove_tag</code></a></td>
<td><a href="http://www.elastic.co/guide/en/logstash/6.2/configuration-file-structure.html#array" target="_blank" rel="noopener">array</a></td>
<td>No</td>
</tr>
</tbody>
</table>
<h3 id="if条件判断"><a href="#if条件判断" class="headerlink" title="if条件判断"></a>if条件判断</h3><p>参考链接：</p>
<p><a href="https://www.elastic.co/guide/en/logstash/6.2/event-dependent-configuration.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/logstash/6.2/event-dependent-configuration.html</a></p>
<h2 id="output部分"><a href="#output部分" class="headerlink" title="output部分"></a>output部分</h2><h3 id="kafka-2"><a href="#kafka-2" class="headerlink" title="kafka"></a>kafka</h3><p>只要关注的参数有：</p>
<ul>
<li><p>bootstrap_servers</p>
<blockquote>
<p>kafka集群的地址。格式是：host1:port1,host2:port2</p>
</blockquote>
</li>
<li><p>topic_id</p>
<blockquote>
<p>topic的名称</p>
</blockquote>
</li>
<li><p>compression_type</p>
<blockquote>
<p>默认值为none。取值范围为：none、gzip、snappy、lz4</p>
<p>在logstash向后端kafka传输数据时，可以对数据进行压缩。这里定义使用压缩的算法</p>
</blockquote>
</li>
<li><p>codec</p>
<blockquote>
<p>定义输出的编码，默认是明文plain。</p>
</blockquote>
</li>
</ul>
<p>一个案例如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">output &#123;</span><br><span class="line">    kafka &#123;</span><br><span class="line">        bootstrap_servers =&gt; &quot;172.24.48.63:19092,172.24.48.64:19092,172.24.48.65:19092&quot;</span><br><span class="line">        topic_id =&gt; &quot;%&#123;topicname&#125;&quot;</span><br><span class="line">        compression_type =&gt; &quot;lz4&quot;</span><br><span class="line">        codec =&gt; plain &#123;</span><br><span class="line">           format =&gt; &quot;%&#123;topicinfo&#125;&quot;</span><br><span class="line">        &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h3 id="Elasticsearch"><a href="#Elasticsearch" class="headerlink" title="Elasticsearch"></a>Elasticsearch</h3><p>一个实际的案例如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">    kafka &#123;</span><br><span class="line">        codec =&gt; &quot;plain&quot;</span><br><span class="line">        group_id =&gt; &quot;kafkatoes&quot;</span><br><span class="line">        bootstrap_servers =&gt; &quot;172.24.48.76:19092,172.24.48.77:19092,172.24.48.78:19092&quot;</span><br><span class="line">        auto_offset_reset =&gt; &quot;earliest&quot;</span><br><span class="line">        consumer_threads =&gt; 4</span><br><span class="line">        topics =&gt; &quot;applog6&quot;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">filter  &#123;</span><br><span class="line">    dissect &#123;</span><br><span class="line">        mapping =&gt; &#123;</span><br><span class="line">            &quot;message&quot; =&gt; &quot;%&#123;type&#125; %&#123;host&#125; %&#123;logtime&#125; %&#123;+logtime&#125; %&#123;level&#125; %&#123;content&#125;&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    if &quot;_dissectfailure&quot; in [tags] &#123;</span><br><span class="line">      drop &#123; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    if [type] !~ &quot;^[A-Za-z]&quot; &#123;</span><br><span class="line">             drop &#123;&#125;</span><br><span class="line">          &#125;</span><br><span class="line">    if [logtime] !~ &quot;^[0-9]&#123;4&#125;-[0-9]&#123;2&#125;-[0-9]&#123;2&#125;&quot; &#123;</span><br><span class="line">             drop &#123;&#125;</span><br><span class="line">          &#125;</span><br><span class="line">    mutate &#123;</span><br><span class="line">        add_field =&gt; &#123;</span><br><span class="line">            &quot;[@metadata][type]&quot; =&gt; &quot;%&#123;type&#125;&quot;</span><br><span class="line">        &#125;</span><br><span class="line">        remove_field =&gt; [&quot;type&quot;]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">       date  &#123;</span><br><span class="line">        match =&gt; [&quot;logtime&quot;, &quot;yyyy-MM-dd HH:mm:ss,SSS&quot;, &quot;yyyy-MM-dd HH:mm:ss&quot;, &quot;yyyy-MM-dd HH:mm:ss.SSS&quot;, &quot;yyyy-MM-dd HH:mm:ss:SSS&quot;, &quot;ISO8601&quot;]</span><br><span class="line">        #timezone =&gt; &quot;+08:00&quot;</span><br><span class="line">        remove_field =&gt; [&quot;message&quot;,&quot;logtime&quot;,&quot;@version&quot;]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">output &#123;</span><br><span class="line">     elasticsearch &#123;</span><br><span class="line">        hosts =&gt; [&quot;10.10.10.86:9200&quot;,&quot;10.10.10.87:9200&quot;,&quot;10.10.10.88:9200&quot;]</span><br><span class="line">        index =&gt; &quot;%&#123;[@metadata][type]&#125;-logstash-%&#123;+YYYY.MM.dd&#125;&quot;</span><br><span class="line">        template_overwrite =&gt; true</span><br><span class="line">        document_type =&gt; &quot;doc&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一些参数说明：</p>
<ul>
<li><p>template_overwrite</p>
<blockquote>
<p>布尔类型，取值为true|false。</p>
<p>The template_overwrite option will always overwrite the indicated template in Elasticsearch with either the one indicated by template or the included one. This option is set to false by default. If you always want to stay up to date with the template provided by Logstash, this option could be very useful to you. Likewise, if you have your own template file managed by puppet, for example, and you wanted to be able to update it regularly, this option could help there as well.</p>
<p>Please note that if you are using your own customized version of the Logstash template (logstash), setting this to true will make Logstash to overwrite the “logstash” template (i.e. removing all customized settings)</p>
</blockquote>
</li>
<li><p>document_type</p>
</li>
</ul>
<h3 id="file"><a href="#file" class="headerlink" title="file"></a>file</h3><p>官网的案例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">output &#123;</span><br><span class="line"> file &#123;</span><br><span class="line">   path =&gt; ...</span><br><span class="line">   codec =&gt; line &#123; format =&gt; &quot;custom format: %&#123;message&#125;&quot;&#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一个实际的案例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">output &#123;</span><br><span class="line">  if [logdate] =~ &quot;^[0-9]&#123;4&#125;-[0-9]&#123;2&#125;-[0-9]&#123;2&#125;&quot; and [loghour] =~ &quot;^[0-9]&#123;2&#125;&quot;  &#123;</span><br><span class="line">    file &#123;</span><br><span class="line">        path =&gt; &quot;/nas/logs/%&#123;type&#125;/%&#123;logdate&#125;/%&#123;host&#125;/%&#123;type&#125;.log-%&#123;logdate&#125;-%&#123;loghour&#125;&quot;</span><br><span class="line">        codec =&gt; line &#123;</span><br><span class="line">            format =&gt; &quot;%&#123;logdate&#125; %&#123;loghour&#125;:%&#123;logms&#125; %&#123;content&#125;&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="codec部分"><a href="#codec部分" class="headerlink" title="codec部分"></a>codec部分</h2><p>codec插件，改变了event中的数据展示方式/格式，codecs本质上也是一个过滤器，可以作用在input和output阶段</p>
<p>Codec 是 logstash 从 1.3.0 版开始新引入的概念(<em>Codec</em> 来自 <em>Co</em>der/<em>dec</em>oder 两个单词的首字母缩写)。</p>
<p>在此之前，logstash 只支持纯文本形式输入，然后以<em>过滤器</em>处理它。但现在，我们可以在<em>输入</em> 期处理不同类型的数据，这全是因为有了 <strong>codec</strong> 设置。</p>
<p>Logstash 不只是一个<code>input | filter | output</code> 的数据流，而是一个 <code>input | decode | filter | encode | output</code> 的数据流！<em>codec</em> 就是用来 decode、encode 事件的。</p>
<p>简单说，就是在logstash读入的时候，通过codec编码解析日志为相应格式，从logstash输出的时候，通过codec解码成相应格式。</p>
<p>codec 的引入，使得 logstash 可以更好更方便的与其他有自定义数据格式的运维产品共存，比如 graphite、fluent、netflow、collectd，以及使用 msgpack、json、edn 等通用数据格式的其他产品等。</p>
<p>事实上，我们在第一个 “hello world” 用例中就已经用过 <em>codec</em> 了 —— <em>rubydebug</em> 就是一种 <em>codec</em>！虽然它一般只会用在 stdout 插件中，作为配置测试或者调试的工具。</p>
<h3 id="plain"><a href="#plain" class="headerlink" title="plain"></a>plain</h3><p>用于event之间没有分隔的文本</p>
<p>在消息队列时，例如kafka，input一般都是plain</p>
<p>format设置，指定输出的内容，例如在output是kafka时：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">output &#123;</span><br><span class="line">    kafka &#123;</span><br><span class="line">        bootstrap_servers =&gt; &quot;172.24.48.63:19092,172.24.48.64:19092,172.24.48.65:19092&quot;</span><br><span class="line">        topic_id =&gt; &quot;%&#123;topicname&#125;&quot;</span><br><span class="line">        compression_type =&gt; &quot;lz4&quot;</span><br><span class="line">        codec =&gt; plain &#123;</span><br><span class="line">           format =&gt; &quot;%&#123;topicinfo&#125;&quot;</span><br><span class="line">        &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="line"><a href="#line" class="headerlink" title="line"></a>line</h3><h2 id="实际案例"><a href="#实际案例" class="headerlink" title="实际案例"></a>实际案例</h2><h3 id="公网服务器日志收集"><a href="#公网服务器日志收集" class="headerlink" title="公网服务器日志收集"></a>公网服务器日志收集</h3><p>公网服务器的filebeat，将日志发送到有对外IP的logstash，然后由logstash去处理数据，获取到数据之后，再将数据写入到kafka集群中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">[elk@node004 config]$ grep -v &apos;#&apos; httpdns.conf</span><br><span class="line">input &#123;</span><br><span class="line">    beats &#123;</span><br><span class="line">        port =&gt; &quot;5144&quot;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">    if [source] == &quot;/home/appdeploy/deploy/logs/httpdns/httpdns.log&quot; &#123;</span><br><span class="line">        mutate &#123;</span><br><span class="line">            add_field =&gt; &#123;</span><br><span class="line">                &quot;[@metadata][topic_name]&quot; =&gt; &quot;applog8&quot;</span><br><span class="line">                &quot;[@metadata][app_name]&quot; =&gt; &quot;httpdns&quot;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">    if [source] == &quot;/home/appdeploy/deploy/logs/httpdns/httpdns_error.log&quot; &#123;</span><br><span class="line">        mutate &#123;</span><br><span class="line">            add_field =&gt; &#123;</span><br><span class="line">                &quot;[@metadata][topic_name]&quot; =&gt; &quot;errorlog&quot;</span><br><span class="line">                &quot;[@metadata][app_name]&quot; =&gt; &quot;httpdns&quot;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">    if [source] == &quot;/home/appdeploy/deploy/logs/monitor/httpdns_monitor.log&quot; &#123;</span><br><span class="line">        mutate &#123;</span><br><span class="line">            add_field =&gt; &#123;</span><br><span class="line">                &quot;[@metadata][topic_name]&quot; =&gt; &quot;monitor&quot;</span><br><span class="line">                &quot;[@metadata][app_name]&quot; =&gt; &quot;monitor&quot;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">    if [source] == &quot;/var/log/secure&quot; &#123;</span><br><span class="line">        mutate &#123;</span><br><span class="line">            add_field =&gt; &#123;</span><br><span class="line">                &quot;[@metadata][topic_name]&quot; =&gt; &quot;oslog&quot;</span><br><span class="line">                &quot;[@metadata][app_name]&quot; =&gt; &quot;secure&quot;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">    if [source] == &quot;/var/log/messages&quot; &#123;</span><br><span class="line">        mutate &#123;</span><br><span class="line">            add_field =&gt; &#123;</span><br><span class="line">                &quot;[@metadata][topic_name]&quot; =&gt; &quot;oslog&quot;</span><br><span class="line">                &quot;[@metadata][app_name]&quot; =&gt; &quot;messages&quot;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">    if [source] == &quot;/var/log/cron&quot; &#123;</span><br><span class="line">        mutate &#123;</span><br><span class="line">            add_field =&gt; &#123;</span><br><span class="line">                &quot;[@metadata][topic_name]&quot; =&gt; &quot;oslog&quot;</span><br><span class="line">                &quot;[@metadata][app_name]&quot; =&gt; &quot;cron&quot;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">    if [source] == &quot;/var/log/maillog&quot; &#123;</span><br><span class="line">        mutate &#123;</span><br><span class="line">            add_field =&gt; &#123;</span><br><span class="line">                &quot;[@metadata][topic_name]&quot; =&gt; &quot;oslog&quot;</span><br><span class="line">                &quot;[@metadata][app_name]&quot; =&gt; &quot;maillog&quot;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">    if [source] == &quot;/var/log/kern.log&quot; &#123;</span><br><span class="line">        mutate &#123;</span><br><span class="line">            add_field =&gt; &#123;</span><br><span class="line">                &quot;[@metadata][topic_name]&quot; =&gt; &quot;oslog&quot;</span><br><span class="line">                &quot;[@metadata][app_name]&quot; =&gt; &quot;kern&quot;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  stdout &#123; codec =&gt; rubydebug &#123; metadata =&gt; true &#125; &#125;</span><br><span class="line">  file &#123;</span><br><span class="line">    path =&gt; &quot;/home/elk/filebeat-to-file&quot;</span><br><span class="line">    codec =&gt; line &#123; format =&gt; &quot;%&#123;[@metadata][topic_name]&#125; %&#123;[@metadata][app_name]&#125; %&#123;[beat][hostname]&#125; %&#123;message&#125;&quot;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">  kafka &#123;</span><br><span class="line">    bootstrap_servers =&gt; &quot;172.16.1.132:9092&quot;</span><br><span class="line">    topic_id =&gt; &quot;%&#123;[@metadata][topic_name]&#125;&quot;</span><br><span class="line">    compression_type =&gt; &quot;lz4&quot;</span><br><span class="line">    codec =&gt; plain &#123;</span><br><span class="line">       format =&gt; &quot;%&#123;[@metadata][app_name]&#125; %&#123;[beat][hostname]&#125; %&#123;message&#125;&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="nginx错误日志收集"><a href="#nginx错误日志收集" class="headerlink" title="nginx错误日志收集"></a>nginx错误日志收集</h3><p><strong>filebeat端配置：</strong></p>
<p>主配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[appdeploy@node001 filebeat6]$ grep -v &apos;#&apos; applogg.yml</span><br><span class="line">filebeat.shutdown_timeout: 10s</span><br><span class="line">filebeat.config.prospectors:</span><br><span class="line">  enabled: true</span><br><span class="line">  path: conf/*.yml</span><br><span class="line">  reload.enabled: true</span><br><span class="line">  reload.period: 10s</span><br><span class="line">output.kafka:</span><br><span class="line">  hosts: [&quot;172.16.1.132:9092&quot;]</span><br><span class="line">  topic: &apos;%&#123;[fields.log_topic]&#125;&apos;</span><br><span class="line">  key: &apos;%&#123;[fields.app_name]&#125; %&#123;[beat.hostname]&#125;&apos;</span><br><span class="line">  required_acks: 1</span><br><span class="line">  workers: 6</span><br><span class="line">  timeout: 120</span><br><span class="line">  compression: snappy</span><br><span class="line">  max_message_bytes: 10240000</span><br><span class="line">  codec.format:</span><br><span class="line">     string: &apos;%&#123;[fields.app_name]&#125; %&#123;[beat.hostname]&#125; %&#123;[message]&#125;&apos;</span><br></pre></td></tr></table></figure>
<p>子配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[appdeploy@node001 conf]$ cat nginx.yml</span><br><span class="line">- type: log</span><br><span class="line">  paths:</span><br><span class="line">    - /data1/logs/nginx/access-*.log</span><br><span class="line">  fields:</span><br><span class="line">    log_topic: nginx</span><br><span class="line">    app_name: nginx</span><br><span class="line">  scan_frequency: 5s</span><br><span class="line">  tail_files: true</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">[appdeploy@node001 conf]$ cat nginx_error.yml</span><br><span class="line">- type: log</span><br><span class="line">  paths:</span><br><span class="line">    - /usr/local/tengine/logs/error.log</span><br><span class="line">    - /data1/logs/nginx/error.log</span><br><span class="line">  fields:</span><br><span class="line">    log_topic: nginx_error</span><br><span class="line">    app_name: nginx_error</span><br><span class="line">  scan_frequency: 5s</span><br><span class="line">  tail_files: true</span><br></pre></td></tr></table></figure>
<p>启动命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohup ./filebeat -e -c applogg.yml &gt; start.log 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure>
<p><strong>logstash端配置</strong></p>
<p>落地到文件的配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">[elk@node004 config]$ cat nginx_errortofile.yml</span><br><span class="line">input&#123;</span><br><span class="line">    kafka &#123;</span><br><span class="line">        codec =&gt; &quot;plain&quot;</span><br><span class="line">        group_id =&gt; &quot;kafkatofile&quot;</span><br><span class="line">        bootstrap_servers =&gt; &quot;172.16.1.132:9092&quot;</span><br><span class="line">        auto_offset_reset =&gt; &quot;latest&quot;</span><br><span class="line">        consumer_threads =&gt; 5</span><br><span class="line">        topics =&gt; &quot;nginx_error&quot;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">    dissect &#123;</span><br><span class="line">        mapping =&gt; &#123;</span><br><span class="line">            &quot;message&quot; =&gt; &quot;%&#123;type&#125; %&#123;host&#125; %&#123;content&#125;&quot;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">    mutate &#123;</span><br><span class="line">        replace =&gt; &#123; &quot;type&quot; =&gt; &quot;nginx&quot;&#125;</span><br><span class="line">&#125;</span><br><span class="line">    grok &#123;</span><br><span class="line">        match =&gt; &#123; &quot;content&quot; =&gt; &quot;%&#123;YEAR:logyear&#125;/%&#123;MONTHNUM2:logmonth&#125;/%&#123;MONTHDAY:logday&#125; %&#123;HOUR:loghour&#125;:%&#123;MINUTE:logmin&#125;:%&#123;SECOND:logsec&#125; (?&lt;content1&gt;.+)&quot; &#125;</span><br><span class="line">&#125;</span><br><span class="line">    if &quot;_dissectfailure&quot; in [tags] &#123;</span><br><span class="line">          drop &#123; &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    if &quot;_grokparsefailure&quot; in [tags] &#123;</span><br><span class="line">          drop &#123; &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">    if [type] == &quot;nginx&quot; &#123;</span><br><span class="line">        file &#123;</span><br><span class="line">            path =&gt; &quot;/nas/logs/%&#123;type&#125;/%&#123;logyear&#125;-%&#123;logmonth&#125;-%&#123;logday&#125;/%&#123;host&#125;/error.log-%&#123;logyear&#125;-%&#123;logmonth&#125;-%&#123;logday&#125;-%&#123;loghour&#125;&quot;</span><br><span class="line">            codec =&gt; line &#123;</span><br><span class="line">                format =&gt; &quot;%&#123;content&#125;&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>落地的文件的时候，和nginx的access放在同一个目录下，所以把type转变成为nginx</p>
<p>写入到es的配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">[elk@node004 config]$ cat nginx_errortoes.yml</span><br><span class="line">input &#123;</span><br><span class="line">    kafka &#123;</span><br><span class="line">        codec =&gt; &quot;plain&quot;</span><br><span class="line">        group_id =&gt; &quot;kafkatoes&quot;</span><br><span class="line">        bootstrap_servers =&gt; &quot;172.16.1.132:9092&quot;</span><br><span class="line">        auto_offset_reset =&gt; &quot;latest&quot;</span><br><span class="line">        consumer_threads =&gt; 5</span><br><span class="line">        topics =&gt; &quot;nginx_error&quot;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter  &#123;</span><br><span class="line">    dissect &#123;</span><br><span class="line">        mapping =&gt; &#123; &quot;message&quot; =&gt; &quot;%&#123;type&#125; %&#123;host&#125; %&#123;logtime&#125; %&#123;+logtime&#125; %&#123;content&#125;&quot; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    mutate &#123;</span><br><span class="line">        add_field =&gt; &#123;</span><br><span class="line">            &quot;[@metadata][type]&quot; =&gt; &quot;%&#123;type&#125;&quot;</span><br><span class="line">        &#125;</span><br><span class="line">        remove_field =&gt; [&quot;type&quot;,&quot;@version&quot;,&quot;message&quot;]</span><br><span class="line">    &#125;</span><br><span class="line">    date &#123;</span><br><span class="line">        match =&gt; [&quot;logtime&quot;, &quot;yyyy/MM/dd HH:mm:ss&quot;]</span><br><span class="line">        remove_field =&gt; [&quot;logtime&quot;]</span><br><span class="line">    &#125;</span><br><span class="line">    if &quot;_dissectfailure&quot; in [tags] &#123;</span><br><span class="line">      drop &#123; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    if &quot;_dateparsefailure&quot; in [tags] &#123;</span><br><span class="line">      drop &#123; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">     stdout &#123; codec =&gt; rubydebug &#123; metadata =&gt; true &#125; &#125;</span><br><span class="line">     elasticsearch &#123;</span><br><span class="line">        hosts =&gt; [&quot;172.16.1.128:9500&quot;]</span><br><span class="line">        index =&gt; &quot;%&#123;[@metadata][type]&#125;-logstash-%&#123;+YYYY.MM.dd&#125;&quot;</span><br><span class="line">        template_overwrite =&gt; true</span><br><span class="line">        document_type =&gt; &quot;doc&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>索引的名称是：nginx_error-logstash-年月日</p>
<p>在es中创建索引模板：</p>
<p>例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">PUT  _template/nginx_error</span><br><span class="line">&#123;</span><br><span class="line">	 &quot;order&quot;: 0,</span><br><span class="line">    &quot;template&quot;: &quot;nginx_error-logstash*&quot;,</span><br><span class="line">    &quot;settings&quot;:&#123;</span><br><span class="line">    &quot;index&quot; : &#123;</span><br><span class="line">      &quot;refresh_interval&quot;: &quot;5s&quot;,</span><br><span class="line">      &quot;number_of_shards&quot;: &quot;5&quot;,</span><br><span class="line">      &quot;number_of_replicas&quot;: &quot;1&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;mappings&quot;:&#123;</span><br><span class="line">  &quot;doc&quot;: &#123;</span><br><span class="line">        &quot;properties&quot;: &#123;</span><br><span class="line">          &quot;host&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;content&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;text&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line">GET _template/nginxlog</span><br><span class="line">&#123;</span><br><span class="line">  &quot;nginxlog&quot; : &#123;</span><br><span class="line">    &quot;order&quot; : 0,</span><br><span class="line">    &quot;index_patterns&quot; : [</span><br><span class="line">      &quot;nginx*-logstash-*&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;settings&quot; : &#123;</span><br><span class="line">      &quot;index&quot; : &#123;</span><br><span class="line">        &quot;mapping&quot; : &#123;</span><br><span class="line">          &quot;total_fields&quot; : &#123;</span><br><span class="line">            &quot;limit&quot; : &quot;2000&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;refresh_interval&quot; : &quot;60s&quot;,</span><br><span class="line">        &quot;number_of_shards&quot; : &quot;6&quot;,</span><br><span class="line">        &quot;translog&quot; : &#123;</span><br><span class="line">          &quot;sync_interval&quot; : &quot;10s&quot;,</span><br><span class="line">          &quot;durability&quot; : &quot;async&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;number_of_replicas&quot; : &quot;0&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;mappings&quot; : &#123;</span><br><span class="line">      &quot;doc&quot; : &#123;</span><br><span class="line">        &quot;dynamic_templates&quot; : [</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;strings_as_keywords&quot; : &#123;</span><br><span class="line">              &quot;match_mapping_type&quot; : &quot;string&quot;,</span><br><span class="line">              &quot;mapping&quot; : &#123;</span><br><span class="line">                &quot;type&quot; : &quot;keyword&quot;,</span><br><span class="line">                &quot;doc_values&quot; : &quot;false&quot;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        ],</span><br><span class="line">        &quot;properties&quot; : &#123;</span><br><span class="line">          &quot;geoip&quot; : &#123;</span><br><span class="line">            &quot;properties&quot; : &#123;</span><br><span class="line">              &quot;city_name&quot; : &#123;</span><br><span class="line">                &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">              &#125;,</span><br><span class="line">              &quot;country_name&quot; : &#123;</span><br><span class="line">                &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">              &#125;,</span><br><span class="line">              &quot;latitude&quot; : &#123;</span><br><span class="line">                &quot;type&quot; : &quot;float&quot;</span><br><span class="line">              &#125;,</span><br><span class="line">              &quot;location&quot; : &#123;</span><br><span class="line">                &quot;type&quot; : &quot;geo_point&quot;</span><br><span class="line">              &#125;,</span><br><span class="line">              &quot;longitude&quot; : &#123;</span><br><span class="line">                &quot;type&quot; : &quot;float&quot;</span><br><span class="line">              &#125;,</span><br><span class="line">              &quot;region_name&quot; : &#123;</span><br><span class="line">                &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;remote_user&quot; : &#123;</span><br><span class="line">            &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;request_time&quot; : &#123;</span><br><span class="line">            &quot;type&quot; : &quot;long&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;status&quot; : &#123;</span><br><span class="line">            &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;tags&quot; : &#123;</span><br><span class="line">            &quot;type&quot; : &quot;keyword&quot;,</span><br><span class="line">            &quot;index&quot; : false</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;type&quot; : &#123;</span><br><span class="line">            &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;upstream&quot; : &#123;</span><br><span class="line">            &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;upstream_response_time&quot; : &#123;</span><br><span class="line">            &quot;type&quot; : &quot;float&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;url_path&quot; : &#123;</span><br><span class="line">            &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;user_agent&quot; : &#123;</span><br><span class="line">            &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;verb&quot; : &#123;</span><br><span class="line">            &quot;type&quot; : &quot;keyword&quot;,</span><br><span class="line">            &quot;index&quot; : false</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;host&quot; : &#123;</span><br><span class="line">            &quot;index&quot; : &quot;true&quot;,</span><br><span class="line">            &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;client&quot; : &#123;</span><br><span class="line">            &quot;index&quot; : &quot;true&quot;,</span><br><span class="line">            &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;parameters.day&quot; : &#123;</span><br><span class="line">            &quot;fielddata&quot; : true,</span><br><span class="line">            &quot;type&quot; : &quot;text&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;parameters.shopId&quot; : &#123;</span><br><span class="line">            &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;parameters.cityId&quot; : &#123;</span><br><span class="line">            &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;parameters.userId&quot; : &#123;</span><br><span class="line">            &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;parameters.riderId&quot; : &#123;</span><br><span class="line">            &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;http_host&quot; : &#123;</span><br><span class="line">            &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;parameters.createTimeEnd&quot; : &#123;</span><br><span class="line">            &quot;fielddata&quot; : true,</span><br><span class="line">            &quot;type&quot; : &quot;text&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;parameters.createTimeStart&quot; : &#123;</span><br><span class="line">            &quot;fielddata&quot; : true,</span><br><span class="line">            &quot;type&quot; : &quot;text&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;aliases&quot; : &#123; &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>启动命令为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohup ./bin/logstash -f config/nginxtofile.yml --config.reload.automatic  &gt; start.log 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure>
<p>也可以不输出到start.log中，直接输出到/dev/null</p>
<h1 id="Elasticsearch部署"><a href="#Elasticsearch部署" class="headerlink" title="Elasticsearch部署"></a>Elasticsearch部署</h1><p>参考链接：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.1/getting-started.html#getting-started" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/5.1/getting-started.html#getting-started</a></p>
<h2 id="ES工作原理"><a href="#ES工作原理" class="headerlink" title="ES工作原理"></a>ES工作原理</h2><h3 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h3><p><strong>Near Realtime (NRT)</strong></p>
<blockquote>
<p>ES是一个接近实时的搜索平台，也就是说有些许的延迟，从索引文件到能够检索出结果的延迟一般在秒内</p>
</blockquote>
<p><strong>Cluser</strong></p>
<blockquote>
<p>集群由一个或多个node节点组成，这些节点协同存储所有的条目数据，并且都支持检索的功能以提高性能。</p>
<p>一个集群由一个唯一的名称标识，<strong>默认为：elasticsearch</strong>。一个节点只能够属于一个集群</p>
</blockquote>
<p><strong>Node</strong></p>
<blockquote>
<p>集群中的每一个服务器/服务节点叫做node。在一个集群中，每一个node都通过一个唯一的名称去标识(默认是一个随机的UUID)。每一个node会加到一个es集群当中，默认的集群名称是elasticsearch，可以指定集群的名称以创建多个不同的es集群。</p>
<p>一个集群可以只有一个node节点</p>
</blockquote>
<p><strong>Index</strong></p>
<blockquote>
<p>索引是一批收集的拥有相似特征的<strong>文件集合</strong>。</p>
<p>索引通过不同的名称去标识(必须为小写)，这个索引名称用于后续的检索、更新、删除文件内容等操作</p>
</blockquote>
<p><strong>Type</strong></p>
<blockquote>
<p>在一个索引中，可以定义一个或多个type类型，type就相当于是索引数据的分类字段。例如你的索引内容一个博客系统，你可以分别定义用户字段、评论字段、内容字段。</p>
<p>在5版本中有，6版本中只能设置一个，7版本中废弃。</p>
<p>index相当于是一个数据库，type相当于是表。</p>
</blockquote>
<p><strong>Document</strong></p>
<blockquote>
<p>document是存储信息以及创建索引的基本单元。document通常是以JSON的方式存在的。document其实也可以理解是一段内容</p>
<p>注意：document在索引中存在时，必须被分配或者说指定给某一个type</p>
<p>document是一条记录，其中包含各个字段。</p>
</blockquote>
<p><strong>Shard &amp; Replicas</strong></p>
<blockquote>
<p>每一个索引可以存储大量的数据。这些数据在落地到物理磁盘上时，很有可能超出单个node的限制。为了解决这个问题，ES提供了把索引分割的功能，每一个被分割出来的部分我们叫做shard分片。</p>
<p>在创建index的时候，我们可以指定分片的数量。</p>
<p>副本是为了提供分片的高可用，并且在查询的时候可以并行执行</p>
<p>这一部分比较核心，我们会有单独的篇幅讲解。</p>
</blockquote>
<h3 id="集群状态"><a href="#集群状态" class="headerlink" title="集群状态"></a>集群状态</h3><p>ES集群有3种状态：green，yellow，red。其中green状态表明集群是健康的。yellow表示集群可用，但是有部分索引的shard有异常。red状态表示集群有索引异常。</p>
<h2 id="ES安装配置"><a href="#ES安装配置" class="headerlink" title="ES安装配置"></a>ES安装配置</h2><h3 id="基础环境配置"><a href="#基础环境配置" class="headerlink" title="基础环境配置"></a>基础环境配置</h3><p><strong>JAVA配置</strong></p>
<p>ES的运行需要java作为基础，最低版本要求为java 8。</p>
<p>根据以下命令操作：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 ~]# tar -zxvf jdk1.8.0_77.tar.gz  -C /usr/local/</span><br><span class="line">[root@node001 ~]# ln -s /usr/local/jdk1.8.0_77 /usr/local/jdk</span><br><span class="line">[root@node001 ~]# vim /etc/profile	# 在文件末尾添加一下内容</span><br><span class="line">JAVA_HOME=/usr/local/jdk</span><br><span class="line">PATH=$JAVA_HOME/bin:$PATH</span><br><span class="line">CLASSPATH=.:$JAVA_HOME/lib</span><br><span class="line">JRE_HOME=$JAVA_HOME/jre</span><br><span class="line">export JAVA_HOME PATH CLASSPATH JRE_HOME</span><br><span class="line"></span><br><span class="line">[root@node001 ~]# source /etc/profile</span><br><span class="line">[root@node001 ~]# java -version</span><br><span class="line">java version &quot;1.8.0_77&quot;</span><br><span class="line">Java(TM) SE Runtime Environment (build 1.8.0_77-b03)</span><br><span class="line">Java HotSpot(TM) 64-Bit Server VM (build 25.77-b03, mixed mode)</span><br></pre></td></tr></table></figure>
<p><strong>系统环境配置</strong></p>
<ol>
<li>打开服务器的/etc/sysctl.conf文件，增加下面内容：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 ~]# vim /etc/sysctl.conf</span><br><span class="line">fs.file-max=65536</span><br><span class="line">vm.max_map_count=655360</span><br><span class="line">vm.zone_reclaim_mode=0</span><br></pre></td></tr></table></figure>
<p>保存后，执行命令: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 ~]# sysctl  -p</span><br></pre></td></tr></table></figure>
<ol>
<li>创建elk用户，创建数据目录，设置数据目录的权限</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 ~]# useradd  elk</span><br><span class="line">[root@node001 ~]# su - elk</span><br><span class="line">[elk@node001 ~]$ mkdir data</span><br></pre></td></tr></table></figure>
<p>注意，一般我们会将数据目录放在其他盘中，这个时候需要注意权限问题，此时的操作类型：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 ~]# mkdir  -p /data1/elk</span><br><span class="line">[root@node001 ~]# chown -R elk:elk /data1/elk</span><br></pre></td></tr></table></figure>
<ol>
<li>配置/etc/security/limits.conf，修改文件描述符以及进程数限制</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 ~]# vim /etc/security/limits.conf</span><br><span class="line">* soft nofile 655360</span><br><span class="line">* hard nofile 655360</span><br><span class="line">elk soft memlock unlimited</span><br><span class="line">elk hard memlock unlimited</span><br><span class="line"></span><br><span class="line">[root@node001 ~]# vim  /etc/security/limits.d/90-nproc.conf</span><br><span class="line">*       soft    nproc   65536</span><br><span class="line">root       soft    nproc     unlimited</span><br><span class="line"></span><br><span class="line"># *       hard    nproc   65536	这个可选</span><br></pre></td></tr></table></figure>
<p>注意：在limits.conf文件中的nproc的设置和/etc/security/limits.d/90-nproc.conf中proc设置有关</p>
<ul>
<li>当在limits.conf中使用*号让全局用户生效的时候，生效的nproc的值大小受后者制约</li>
<li>当在limits.conf中指定用户时，生效的nproc值不受该文件制约</li>
</ul>
<h3 id="下载-1"><a href="#下载-1" class="headerlink" title="下载"></a>下载</h3><p>执行以下命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[elk@node001 ~]$ curl -L -O https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-5.1.2.tar.gz</span><br><span class="line">[elk@node001 ~]$ tar -xvf elasticsearch-5.1.2.tar.gz</span><br></pre></td></tr></table></figure>
<p>在做测试时，我们可以不经过任何配置直接启动，执行以下命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[elk@node001 ~]$ cd elasticsearch-5.1.2/bin</span><br><span class="line">[elk@node001 bin]$ ./elasticsearch</span><br></pre></td></tr></table></figure>
<p>如果需要使用守护进程方式启动，执行以下命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[elk@node001 bin]$ ./elasticsearch -d -p pid.file</span><br><span class="line">[elk@node001 bin]$ cat pid.file</span><br><span class="line">3104</span><br><span class="line">注：-p可以指定将pid记录到某一个文件中</span><br></pre></td></tr></table></figure>
<h3 id="ES配置及配置文件详解"><a href="#ES配置及配置文件详解" class="headerlink" title="ES配置及配置文件详解"></a>ES配置及配置文件详解</h3><p>Elasticsearch loads its configuration from the <code>$ES_HOME/config/elasticsearch.yml</code> file by default. The format of this config file is explained in <a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.1/settings.html" target="_blank" rel="noopener"><em>Configuring Elasticsearch</em></a>.</p>
<p>Any settings that can be specified in the config file can also be specified on the command line, using the <code>-E</code> syntax as follows:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/elasticsearch -d -Ecluster.name=my_cluster -Enode.name=node_1</span><br></pre></td></tr></table></figure>
<p>ES在启动的时候，默认会从ES目录下的config目录下，读取elasticsearch.yml文件。</p>
<p>但是，除了从配置文件读取之外，也可以在启动的时候，手动的指定一些配置。</p>
<p>注意：</p>
<ul>
<li>建议都从elasticsearch.yml配置文件中读取，不建议命令行指定。</li>
<li>建议将配置文件目录、数据目录、日志目录进行分离。</li>
</ul>
<h4 id="ES目录结构"><a href="#ES目录结构" class="headerlink" title="ES目录结构"></a>ES目录结构</h4><p>解压出来的es目录结构如下所示</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[elk@node001 elasticsearch-5.1.2]$ pwd</span><br><span class="line">/home/elk/elasticsearch-5.1.2</span><br><span class="line">[elk@node001 elasticsearch-5.1.2]$ ll</span><br><span class="line">total 56</span><br><span class="line">drwxr-xr-x.  2 elk elk  4096 Jun 28 15:56 bin</span><br><span class="line">drwxr-xr-x.  3 elk elk  4096 Jun 20 17:16 config</span><br><span class="line">drwxrwxr-x.  3 elk elk  4096 Jun 20 17:16 data</span><br><span class="line">drwxr-xr-x.  2 elk elk  4096 Jan 12  2017 lib</span><br><span class="line">-rw-r--r--.  1 elk elk 11358 Jan 12  2017 LICENSE.txt</span><br><span class="line">drwxrwxr-x.  2 elk elk  4096 Jun 28 15:20 logs</span><br><span class="line">drwxr-xr-x. 12 elk elk  4096 Jan 12  2017 modules</span><br><span class="line">-rw-r--r--.  1 elk elk   150 Jan 12  2017 NOTICE.txt</span><br><span class="line">drwxr-xr-x.  2 elk elk  4096 Jan 12  2017 plugins</span><br><span class="line">-rw-r--r--.  1 elk elk  9108 Jan 12  2017 README.textile</span><br></pre></td></tr></table></figure>
<p>下面是官方的定义：</p>
<table>
<thead>
<tr>
<th style="text-align:left">Type</th>
<th style="text-align:left">Description</th>
<th style="text-align:left">Default Location</th>
<th style="text-align:left">Setting</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><strong>home</strong></td>
<td style="text-align:left">Elasticsearch home directory or <code>$ES_HOME</code></td>
<td style="text-align:left">Directory created by unpacking the archive</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left"><strong>bin</strong></td>
<td style="text-align:left">Binary scripts including <code>elasticsearch</code> to start a node and <code>elasticsearch-plugin</code> to install plugins</td>
<td style="text-align:left"><code>$ES_HOME/bin</code></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left"><strong>conf</strong></td>
<td style="text-align:left">Configuration files including <code>elasticsearch.yml</code></td>
<td style="text-align:left"><code>$ES_HOME/config</code></td>
<td style="text-align:left"><code>path.conf</code></td>
</tr>
<tr>
<td style="text-align:left"><strong>data</strong></td>
<td style="text-align:left">The location of the data files of each index / shard allocated on the node. Can hold multiple locations.</td>
<td style="text-align:left"><code>$ES_HOME/data</code></td>
<td style="text-align:left"><code>path.data</code></td>
</tr>
<tr>
<td style="text-align:left"><strong>logs</strong></td>
<td style="text-align:left">Log files location.</td>
<td style="text-align:left"><code>$ES_HOME/logs</code></td>
<td style="text-align:left"><code>path.logs</code></td>
</tr>
<tr>
<td style="text-align:left"><strong>plugins</strong></td>
<td style="text-align:left">Plugin files location. Each plugin will be contained in a subdirectory.</td>
<td style="text-align:left"><code>$ES_HOME/plugins</code></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left"><strong>repo</strong></td>
<td style="text-align:left">Shared file system repository locations. Can hold multiple locations. A file system repository can be placed in to any subdirectory of any directory specified here.</td>
<td style="text-align:left">Not configured</td>
<td style="text-align:left"><code>path.repo</code></td>
</tr>
<tr>
<td style="text-align:left"><strong>script</strong></td>
<td style="text-align:left">Location of script files.</td>
<td style="text-align:left"><code>$ES_HOME/scripts</code></td>
<td style="text-align:left"><code>path.scripts</code></td>
</tr>
</tbody>
</table>
<h4 id="如何配置ES"><a href="#如何配置ES" class="headerlink" title="如何配置ES"></a>如何配置ES</h4><p>Elasticsearch ships with good defaults and requires very little configuration. Most settings can be changed on a running cluster using the <a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.1/cluster-update-settings.html" target="_blank" rel="noopener"><em>Cluster Update Settings</em></a> API.</p>
<p>The configuration files should contain settings which are node-specific (such as <code>node.name</code> and paths), or settings which a node requires in order to be able to join a cluster, such as <code>cluster.name</code>and <code>network.host</code>.</p>
<p>注意：</p>
<ul>
<li>ES的大部分配置可以使用ES提供的接口在集群运行过程中动态的修改。</li>
<li>配置文件中应该要包含node节点相关的配置(例如node.name和path)，如果要加入es集群的话还需要添加集群相关的配置</li>
</ul>
<p><strong>配置文件：</strong></p>
<p>ES需要关注的配置文件有一下2个：</p>
<ul>
<li>elasticsearch.yml    # ES的主配置文件</li>
<li>log4j2.properties    # ES的日志相关配置</li>
</ul>
<p>默认这两个配置文件在$ES_HOME/config/路径下，但是，我们也可以在启动的时候手动指定配置文件的加载路径，启动命令为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/elasticsearch -Epath.conf=/path/to/my/config/</span><br></pre></td></tr></table></figure>
<p><strong>配置格式：</strong></p>
<p>ES的相关配置都是使用YAML语法格式，下面是两种配置方式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">path:</span><br><span class="line">    data: /var/lib/elasticsearch</span><br><span class="line">    logs: /var/log/elasticsearch</span><br></pre></td></tr></table></figure>
<p>等价于</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">path.data: /var/lib/elasticsearch</span><br><span class="line">path.logs: /var/log/elasticsearch</span><br></pre></td></tr></table></figure>
<p><strong>环境变量引用</strong></p>
<p>如果需要在配置文件中引入系统的环境变量，可以使用下面这种方式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">node.name:    $&#123;HOSTNAME&#125;</span><br><span class="line">network.host: $&#123;ES_NETWORK_HOST&#125;</span><br></pre></td></tr></table></figure>
<p><strong>根据提示输入配置</strong></p>
<p>ES的配置文件支持交互式的输入配置，可以配置在启动的时候手动输入对应的配置，配置方式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">node:</span><br><span class="line">  name: $&#123;prompt.text&#125;</span><br></pre></td></tr></table></figure>
<p>放前台启动es的时候，会有下面这种提示信息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Enter value for [node.name]:</span><br></pre></td></tr></table></figure>
<p>注意：这种方式在启动方式为后台守护进程启动时是无效的。</p>
<p><strong>设置默认配置</strong></p>
<p>一些默认配置如果不想让es自动生成，那么我们可以进行自定义，命令如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/elasticsearch -Edefault.node.name=My_Node</span><br></pre></td></tr></table></figure>
<p>注意：默认值只是在配置文件中没有配置，并且没有在命令行手动指定时生效。</p>
<p><strong>日志相关配置</strong></p>
<p>Elasticsearch uses <a href="http://logging.apache.org/log4j/2.x/" target="_blank" rel="noopener">Log4j 2</a> for logging. Log4j 2 can be configured using the log4j2.properties file. Elasticsearch exposes a single property <code>${sys:es.logs}</code> that can be referenced in the configuration file to determine the location of the log files; this will resolve to a prefix for the Elasticsearch log file at runtime.</p>
<p>For example, if your log directory (<code>path.logs</code>) is <code>/var/log/elasticsearch</code> and your cluster is named <code>production</code> then <code>${sys:es.logs}</code> will resolve to <code>/var/log/elasticsearch/production</code>.</p>
<p>ES使用java的log4J 2日志框架。ES在内部维护了一个变量：${sys:es.logs}，该变量记录的是es的集群名称</p>
<p>在输出日志时，这个日志框架将会调用这个变量生成对应的文件。</p>
<p>例如：</p>
<p>log4j2.properties配置文件是这个内容时</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">appender.rolling.type = RollingFile </span><br><span class="line">appender.rolling.name = rolling</span><br><span class="line">appender.rolling.fileName = $&#123;sys:es.logs&#125;.log</span><br></pre></td></tr></table></figure>
<p>例如es集群名称为：testes，那么生成的日志文件名称将会是：testes.log</p>
<p>下面拿配置文件中的一段配置进行举例说明：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">appender.rolling.type = RollingFile</span><br><span class="line">appender.rolling.name = rolling</span><br><span class="line">appender.rolling.fileName = $&#123;sys:es.logs&#125;.log</span><br><span class="line">appender.rolling.layout.type = PatternLayout</span><br><span class="line">appender.rolling.layout.pattern = [%d&#123;ISO8601&#125;][%-5p][%-25c&#123;1.&#125;] %marker%.-10000m%n</span><br><span class="line">appender.rolling.filePattern = $&#123;sys:es.logs&#125;-%d&#123;yyyy-MM-dd&#125;.log</span><br><span class="line">appender.rolling.policies.type = Policies</span><br><span class="line">appender.rolling.policies.time.type = TimeBasedTriggeringPolicy</span><br><span class="line">appender.rolling.policies.time.interval = 1</span><br><span class="line">appender.rolling.policies.time.modulate = true</span><br></pre></td></tr></table></figure>
<p>注意：</p>
<ul>
<li>appender.rolling.filePattern。给这个配置参数赋值时，如果添加：.gz或者.zip这种后缀，那么在进行日志轮转的时候将会自动被压缩</li>
</ul>
<p><strong>deprecation log </strong></p>
<p>In addition to regular logging, Elasticsearch allows you to enable logging of deprecated actions. For example this allows you to determine early, if you need to migrate certain functionality in the future. By default, deprecation logging is enabled at the WARN level, the level at which all deprecation log messages will be emitted.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">logger.deprecation.level = warn</span><br></pre></td></tr></table></figure>
<p>This will create a daily rolling deprecation log file in your log directory. Check this file regularly, especially when you intend to upgrade to a new major version.</p>
<p>The default logging configuration has set the roll policy for the deprecation logs to roll and compress after 1 GB, and to preserve a maximum of five log files (four rolled logs, and the active log).</p>
<p>You can disable it in the <code>config/log4j2.properties</code> file by setting the deprecation log level to <code>error</code>.</p>
<p>在ES中，还专门定义了这么一个日志文件：查看被废弃或者被修改的功能的调用日志</p>
<p>当你在调用ES时，如果涉及到一些在后续版本中要废弃或者要修改的配置项时，ES将会将该内容，以便管理员知悉并判断是否需要升级<br>例如 _all 即将被废弃，如果你某一个索引启用了 _all，则可能会有一条 deprecation log；<br>通过这个日志的内容，可以指导你决定是否迁移到新的版本</p>
<h4 id="重要配置参数说明"><a href="#重要配置参数说明" class="headerlink" title="重要配置参数说明"></a>重要配置参数说明</h4><h5 id="path-data和path-logs"><a href="#path-data和path-logs" class="headerlink" title="path.data和path.logs"></a><strong>path.data和path.logs</strong></h5><p>在默认情况下，数据目录和日志目录在es的主目录下，如果我们修改了路径，那么在升级es版本的时候，这些目录可能被删除</p>
<p>但是，实际情况是，我们一般都会把这两个目录自定义出来</p>
<p>如果数据目录只需要一个，那么可以是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">path:</span><br><span class="line">  logs: /var/log/elasticsearch</span><br><span class="line">  data: /var/data/elasticsearch</span><br></pre></td></tr></table></figure>
<p>但是，es的数据目录可以设置为多个，如果我们有这方面的需求，我们可以设置为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">path:</span><br><span class="line">  data:</span><br><span class="line">    - /mnt/elasticsearch_1</span><br><span class="line">    - /mnt/elasticsearch_2</span><br><span class="line">    - /mnt/elasticsearch_3</span><br></pre></td></tr></table></figure>
<p>注意：一个索引的分片只会存储在某一个目录中，不会分散存储。</p>
<h5 id="cluster-name"><a href="#cluster-name" class="headerlink" title="cluster.name"></a><strong>cluster.name</strong></h5><p>一个es节点只能加入到一个es集群当中，es集群的默认名称为：elasticsearch。在实际使用时，你应该将它修改为符合用途的名称</p>
<p>例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cluster.name: logging-prod</span><br></pre></td></tr></table></figure>
<h5 id="node-name"><a href="#node-name" class="headerlink" title="node.name"></a><strong>node.name</strong></h5><p>如果在配置文件中没有配置，es默认将会分配一个随机的7个字符对节点进行标识。</p>
<p>注意，一旦分配，在这个node后续重启时，也将使用这个字符串，不会再重新生成。</p>
<p>这个配置参数建议是最好进行配置，配置方式例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node.name: prod-data-2</span><br></pre></td></tr></table></figure>
<p>如果想把node的名称定义为系统的主机名，es也提供了这个功能，使用这种方式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node.name: $&#123;HOSTNAME&#125;</span><br></pre></td></tr></table></figure>
<h5 id="bootstrap-memory-lock"><a href="#bootstrap-memory-lock" class="headerlink" title="bootstrap.memory_lock"></a><strong>bootstrap.memory_lock</strong></h5><p>It is vitally important to the health of your node that none of the JVM is ever swapped out to disk. One way of achieving that is set the <code>bootstrap.memory_lock</code> setting to <code>true</code>.</p>
<p>For this setting to have effect, other system settings need to be configured first. See <a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.1/setup-configuration-memory.html#mlockall" target="_blank" rel="noopener">Enable <code>bootstrap.memory_lock</code></a> for more details about how to set up memory locking correctly.</p>
<p>我们一般称之为锁内存配置。这个在ES中是及其重要的一个参数，开启了该参数后，能够保证，JVM内存被锁定在内存中，其中的数据永远不会被添加到swap交换分区中。</p>
<p>注意：如要要正确的开启这个参数，对系统的一些配置有要求。可以点击这个链接进行查看</p>
<p>开启配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bootstrap.memory_lock: true</span><br></pre></td></tr></table></figure>
<p>在es启动之后，我们可以通过下面的接口来确认是否正确开启：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET _nodes?filter_path=**.mlockall</span><br></pre></td></tr></table></figure>
<p>If you see that <code>mlockall</code> is <code>false</code>, then it means that the <code>mlockall</code> request has failed. You will also see a line with more information in the logs with the words <code>Unable to lock JVM Memory</code>.</p>
<p>The most probable reason, on Linux/Unix systems, is that the user running Elasticsearch doesn’t have permission to lock memory. This can be granted as follows:</p>
<p>如果接口的返回结果是false，那么，我们可以在日志文件中根据关键字：”Unable to lock JVM Memory”进行搜索，查看具体原因</p>
<p>有许多原因会导致开启失败，罗列为：</p>
<ul>
<li><p>Set <a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.1/setting-system-settings.html#ulimit" target="_blank" rel="noopener"><code>ulimit -l unlimited</code></a> as root before starting Elasticsearch, or set <code>memlock</code> to <code>unlimited</code> in<a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.1/setting-system-settings.html#limits.conf" target="_blank" rel="noopener"><code>/etc/security/limits.conf</code></a>.</p>
<p>需要打开涉及用户对内存的限制，如果没有配置，需要按照下方格式配置，这一部分我们在上面的基础环境配置时有记录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">elk soft memlock unlimited</span><br><span class="line">elk hard memlock unlimited</span><br></pre></td></tr></table></figure>
</li>
<li><p>Another possible reason why <code>mlockall</code> can fail is that the temporary directory (usually <code>/tmp</code>) is mounted with the <code>noexec</code> option. This can be solved by specifying a new temp directory using the <code>ES_JAVA_OPTS</code> environment variable:</p>
<p>如果系统在挂载临时目录(通常为/tmp)时，添加了noexec（禁止执行二进制文件）参数，也会引起这个问题，我们可以通过自定义临时目录进行解决，配置为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export ES_JAVA_OPTS=&quot;$ES_JAVA_OPTS -Djava.io.tmpdir=/path/to/temp/dir&quot;</span><br><span class="line">./bin/elasticsearch</span><br></pre></td></tr></table></figure>
<p>如果想永久生效，可以把这个配置记录到<code>jvm.options</code>配置文件中。</p>
</li>
</ul>
<p>注意：因为我们是源码包安装形式，所以这里我们不关注通过rpm包以及yum等管理工具安装的情况</p>
<p>锁内存问题分析：</p>
<blockquote>
<p>大多数操作系统都会将在内存中没有使用的数据转移到swap中，如果没有配置上述的参数，那么在es运行过程中，那么可能就会出现es占用的java堆内存中的数据被转移到swap中，也就是磁盘上。</p>
<p>我们知道，磁盘的读写性能和内存有非常大的差距，当在执行gc的时候，可能会导致gc时间从ms级别变成min级别，这么长的gc时间是绝对不能接受的，很有可能就会导致这个node节点响应变慢，甚至从集群中脱离。</p>
</blockquote>
<p>通过上面的问题分析，我们知道，以下方式也是能杜绝这个问题</p>
<ul>
<li>安装系统时不设置swap</li>
<li>如有swap，关闭swap</li>
<li>降低使用swap的倾向</li>
</ul>
<p>关闭swap的操作如下：</p>
<ul>
<li><p>临时生效，执行命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo swapoff -a</span><br></pre></td></tr></table></figure>
</li>
<li><p>永久生效，也就是系统重启后还生效</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">编辑/etc/fstab文件，将挂载swap的配置注释</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>降低使用swap的倾向：</p>
<ul>
<li><p>临时生效，执行命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysctl -w vm.swappiness=1</span><br></pre></td></tr></table></figure>
</li>
<li><p>永久生效，也就是系统重启后还生效：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;vm.swappiness = 1&quot; &gt;&gt; /etc/sysctl.conf</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h5 id="network-host"><a href="#network-host" class="headerlink" title="network.host"></a><strong>network.host</strong></h5><p>默认情况下，es将服务监听在本机的回环地址，我们可以使用下列参数修改监听地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">network.host: 192.168.1.10</span><br></pre></td></tr></table></figure>
<p>注意：</p>
<p>默认情况下，es假定你是工作在开发模式，假如你有一些配置没有配置正确，es也能正常启动，并且将这些配置记录到日志文件中(日志级别为warning)</p>
<p>但是，一旦你配置了网络相关的配置，例如network.host，那么es将判断你从开发者模式提升为生产模式，这个时候如果有一些配置没有配置正确，那么es将产生异常，并且启动失败。</p>
<p>这种一种非常重要的安全机制，能够确保你不会因为错误的配置而导致数据丢失。</p>
<p>下面是当作为生产模式运行时，具体要检测的依赖配置</p>
<p>Ideally, Elasticsearch should run alone on a server and use all of the resources available to it. In order to do so, you need to configure your operating system to allow the user running Elasticsearch to access more resources than allowed by default.</p>
<p>The following settings <strong>must</strong> be addressed before going to production:</p>
<ul>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.1/heap-size.html" target="_blank" rel="noopener">Set JVM heap size</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.1/setup-configuration-memory.html" target="_blank" rel="noopener">Disable swapping</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.1/file-descriptors.html" target="_blank" rel="noopener">Increase file descriptors</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.1/vm-max-map-count.html" target="_blank" rel="noopener">Ensure sufficient virtual memory</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.1/max-number-of-threads.html" target="_blank" rel="noopener">Ensure sufficient threads</a></li>
</ul>
<p>网络相关的配置，除了这个常见的监听地址的配置，还有很多，我们在下面会进行汇总讲解</p>
<h5 id="discovery-zen-ping-unicast-hosts"><a href="#discovery-zen-ping-unicast-hosts" class="headerlink" title="discovery.zen.ping.unicast.hosts"></a><strong>discovery.zen.ping.unicast.hosts</strong></h5><p>当在组成一个es集群的时候，需要添加其他集群节点，这个时候需要如下的配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">discovery.zen.ping.unicast.hosts:</span><br><span class="line">   - 192.168.1.10:9300</span><br><span class="line">   - 192.168.1.11 </span><br><span class="line">   - seeds.mydomain.com</span><br></pre></td></tr></table></figure>
<p>注意：</p>
<ul>
<li>如果没有指定端口，则默认为：transport.profiles.default.port和transport.tcp.port(这里指的是TCP端口)</li>
<li>如果一个主机名映射了多个ip，那么会把解析出来的所有ip都添加进来</li>
</ul>
<h5 id="discovery-zen-minimum-master-nodes"><a href="#discovery-zen-minimum-master-nodes" class="headerlink" title="discovery.zen.minimum_master_nodes"></a><strong>discovery.zen.minimum_master_nodes</strong></h5><p>为了防止数据的丢失，需要确保每一个主节点都知晓：组成一个集群最少可以有几个主节点</p>
<p>如果没有这个配置，当集群遭遇到网络问题导致各个集群节点之间的通信出现问题时，整个集群可能会变成2个独立的集群，这个现象我们称之为：a split brain(脑裂)，这会导致数据的丢失。</p>
<p>配置规则：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(master_eligible_nodes / 2) + 1</span><br></pre></td></tr></table></figure>
<p>举例说明，例如当前集群有3个节点，那么配置就应该是(3 / 2) + 1或者2(注意，我们是取整数)：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">discovery.zen.minimum_master_nodes: 2</span><br></pre></td></tr></table></figure>
<p>除了在配置文件中配置，在运行过程中，我们可以通过接口临时修改</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PUT _cluster/settings</span><br><span class="line">&#123;</span><br><span class="line">  &quot;transient&quot;: &#123;</span><br><span class="line">    &quot;discovery.zen.minimum_master_nodes&quot;: 2</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>a split brain详解：</p>
<blockquote>
<p>假定集群有2个节点，minimum_master_nodes的值设置为1，当网络出现问题时，每个节点都会把自己提升为集群的主节点(认为另一个节点已经终止)，结果就是会产生2个集群。</p>
<p>当网络恢复时，节点不会重新加入集群。只有当节点重启的时候，才会重新加入集群，但是，重启节点上的数据会丢失。</p>
<p>也正是因为这个原因，所以，我们的集群主节点最好是3个以上</p>
</blockquote>
<h5 id="网络相关配置汇总"><a href="#网络相关配置汇总" class="headerlink" title="网络相关配置汇总"></a>网络相关配置汇总</h5><p>es配置文件中，有以下网络相关配置</p>
<ul>
<li><strong>network.host</strong>。略。</li>
<li><p><strong>discovery.zen.ping.unicast.hosts</strong>。略</p>
</li>
<li><p><strong>http.port</strong></p>
<p>Port to bind to for incoming HTTP requests. Accepts a single value or a range. If a range is specified, the node will bind to the first available port in the range.</p>
<p>Defaults to <code>9200-9300</code>.</p>
<p>设置节点的http端口，提供接口处理相对应的请求，可以赋值为单个值或者一个范围，如果是一个范围，那么将会使用第一个值。</p>
</li>
<li><p><strong>transport.tcp.port</strong></p>
<p>Port to bind for communication between nodes. Accepts a single value or a range. If a range is specified, the node will bind to the first available port in the range.</p>
<p>Defaults to <code>9300-9400</code>.</p>
<p>设置节点的TCP接口，用于集群之间的通信，和上面类似，可以赋值为单个值或者一个范围，如果是一个范围，那么将会使用第一个值。</p>
</li>
</ul>
<h2 id="ES的启动引导检查"><a href="#ES的启动引导检查" class="headerlink" title="ES的启动引导检查"></a>ES的启动引导检查</h2><p>在ES的早期版本，一些es和系统配置不符合要求时，只是输出到日志文件中，供用户查看，但是考虑到很多用户不去看这些日志文件，因此，在后续版本中，es把这些检查放到了启动过程中，当有配置不符合要求时，就是在启动过程中显示出来(注意，只针对生产模式，开发模式只是记录日志)</p>
<p>下面是一些检测指标，对应的详细配置会在下面的<strong>重要的系统配置</strong>中说明</p>
<ul>
<li><p>Heap size check</p>
<p>JVM初始值和最大值必须要设置一致。</p>
</li>
<li><p>File descriptor check</p>
<p>ES需要大量的文件描述符(Linux中一切皆文件)，是否&gt;=65535</p>
</li>
<li><p>Memory lock check</p>
<p>锁内存配置是否开启。这个在前面的配置参数中有说明了。</p>
</li>
<li><p>Maximum number of threads check</p>
<p>最大线程数限制。ES将接收到处理请求拆分成为多个步骤，每个步骤都会使用不同的线程池。</p>
<p>因此，ES需要创建大量的线程，在启动前的check操作能够保证es在运行过程中有足够多的资源。</p>
<p>系统需要保证用户至少能创建2048个线程。</p>
<p>这个的配置在/etc/security/limits.conf和/etc/security/limits.d/90-nproc.conf配置文件中，参数是nproc，建议配置&gt;=65536</p>
</li>
<li><p>Maximum size virtual memory check</p>
<p>虚拟内存限制。需要把内存限制打开</p>
<p>这个的配置在/etc/security/limits.conf配置文件中，参数是memlock，设置为unlimited</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[elk@node001 logs]$ cat /etc/security/limits.conf</span><br><span class="line">elk soft memlock unlimited</span><br><span class="line">elk hard memlock unlimited</span><br></pre></td></tr></table></figure>
<p>vm.max_map_count</p>
</li>
<li><p>还是内存相关的配置，这个是内存参数配置。</p>
<p>配置文件：/etc/sysctl.conf，配置参数：vm.max_map_count，默认值是262144，建议配置&gt;=655360</p>
</li>
</ul>
<h2 id="重要的系统配置"><a href="#重要的系统配置" class="headerlink" title="重要的系统配置"></a>重要的系统配置</h2><h3 id="JVM堆内存"><a href="#JVM堆内存" class="headerlink" title="JVM堆内存"></a>JVM堆内存</h3><p>ES的JVM内存配置有以下注意事项</p>
<ul>
<li>每个节点的Xms和Xmx设置为相等的值</li>
<li>更大的内存设置可能会导致gc时间变长，需要考虑一个平衡</li>
<li>JVM最大内存设置不要超过系统物理内存的一半，需要确保给内核文件系统缓存留有足够的物理内存</li>
<li>上限不要超过32GB</li>
<li>26G是一个非常合理设置</li>
</ul>
<h3 id="文件描述符"><a href="#文件描述符" class="headerlink" title="文件描述符"></a>文件描述符</h3><p>当文件描述符不足时，造成的后果将会是灾难性的，可以造成数据的丢失。</p>
<p>这个的配置在/etc/security/limits.conf配置文件中，参数是nofile，建议配置&gt;=65536</p>
<p>确保为启动es服务的用户设置的值&gt;=65536</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[elk@node001 logs]$ cat /etc/security/limits.conf</span><br><span class="line">* soft nofile 65536</span><br><span class="line">* hard nofile 65536</span><br></pre></td></tr></table></figure>
<p>可以不需要登录服务器，通过以下接口获取当前的配置值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET _nodes/stats/process?filter_path=**.max_file_descriptors</span><br></pre></td></tr></table></figure>
<h3 id="关闭swap"><a href="#关闭swap" class="headerlink" title="关闭swap"></a>关闭swap</h3><p>这部分在es的配置讲解部分（bootstrap.memory_lock部分）记录了</p>
<h3 id="虚拟内存"><a href="#虚拟内存" class="headerlink" title="虚拟内存"></a>虚拟内存</h3><p>和ES使用内存映射系统有关，需要我们优化内核参数</p>
<p>默认值为262144</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[elk@node001 logs]$ sysctl  -a | grep vm.max_map_count</span><br><span class="line">vm.max_map_count = 262144</span><br></pre></td></tr></table></figure>
<p>建议配置为&gt;=655360</p>
<ul>
<li><p>临时生效，执行命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysctl -w vm.max_map_count=655360</span><br></pre></td></tr></table></figure>
</li>
<li><p>永久生效，也就是系统重启后还生效：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;vm.max_map_count = 655360&quot; &gt;&gt; /etc/sysctl.conf</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="最大线程数"><a href="#最大线程数" class="headerlink" title="最大线程数"></a>最大线程数</h3><p>其实也就是最大进程数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[elk@node001 logs]$ cat /etc/security/limits.d/90-nproc.conf</span><br><span class="line">*       soft    nproc   65536</span><br><span class="line">*       hard    nproc   65536</span><br></pre></td></tr></table></figure>
<p>注意：如果设置为所有用户生效，则需要修改90-nproc.conf配置文件，如果是指定某个用户生效，则修改/etc/security/limits.conf即可，例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[elk@node001 logs]$ cat /etc/security/limits.conf</span><br><span class="line">elk       soft    nproc   65536</span><br><span class="line">elk       hard    nproc   65536</span><br></pre></td></tr></table></figure>
<h2 id="ES集群部署"><a href="#ES集群部署" class="headerlink" title="ES集群部署"></a>ES集群部署</h2><h3 id="ES集群配置"><a href="#ES集群配置" class="headerlink" title="ES集群配置"></a>ES集群配置</h3><p>在使用最简化的3节点时，master和data参数都设置为true</p>
<p>下面以一个节点的配置为例，每个节点上的配置基本相同，就只有监听的ip不一致。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"> cluster.name: testelk</span><br><span class="line">http.port: 9500</span><br><span class="line">transport.tcp.port: 9600-9700</span><br><span class="line">path:</span><br><span class="line"> logs: /home/elk/logs-5.3.0</span><br><span class="line"> data: /home/elk/data-5.3.0</span><br><span class="line">node.master: true</span><br><span class="line">node.data: true</span><br><span class="line">node.name: node001</span><br><span class="line">network.host: 192.168.100.113</span><br><span class="line">bootstrap.memory_lock: true</span><br><span class="line">discovery.zen.ping.unicast.hosts: [&quot;192.168.100.113&quot;, &quot;192.168.101.172&quot;, &quot;192.168.103.133&quot;]</span><br><span class="line">discovery.zen.minimum_master_nodes: 2</span><br><span class="line">transport.tcp.compress: true</span><br><span class="line">http.cors.enabled: true</span><br><span class="line">http.cors.allow-origin: &quot;*&quot;</span><br><span class="line">thread_pool:</span><br><span class="line">  search:</span><br><span class="line">    size: 200</span><br><span class="line">    queue_size: 2000</span><br><span class="line">  bulk:</span><br><span class="line">    queue_size: 2000</span><br></pre></td></tr></table></figure>
<h3 id="kibana配置"><a href="#kibana配置" class="headerlink" title="kibana配置"></a>kibana配置</h3><h2 id="Mapping"><a href="#Mapping" class="headerlink" title="Mapping"></a>Mapping</h2><p>mapping的作用是定义document，包括：</p>
<ul>
<li>包含哪些字段</li>
<li>哪些字段需要存储</li>
<li>哪些字段能被索引</li>
</ul>
<p>例如：</p>
<ul>
<li>哪一个字符串字段被定义为full text fields</li>
<li>哪个字段包含数字、日志、地理位置</li>
<li>是否所有的字段都能被索引(通过<code>_all</code>参数)</li>
<li>日期格式</li>
<li>自定义规则</li>
</ul>
<p>每一个索引拥有一个或者多个的mapping type，这些mapping通常用于区分不同逻辑组的document，例如：用户相关的document通常type设置为user，博客相关的document通常type设置为blog。每一个type可以定义一个mapping</p>
<h3 id="mapping-type"><a href="#mapping-type" class="headerlink" title="mapping type"></a>mapping type</h3><p>每一个mapping类型都会有以下的字段：</p>
<ul>
<li><p>元类型字段</p>
<p>mapping的元类型字段，主要是作用于定义document的元字段，例如：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.1/mapping-index-field.html" target="_blank" rel="noopener"><code>_index</code></a>, <a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.1/mapping-type-field.html" target="_blank" rel="noopener"><code>_type</code></a>, <a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.1/mapping-id-field.html" target="_blank" rel="noopener"><code>_id</code></a>, and <a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.1/mapping-source-field.html" target="_blank" rel="noopener"><code>_source</code></a> fields.</p>
</li>
<li><p>字段或者自定义属性</p>
<p>每一个mapping类型都包含一组字段。例如user type包含<code>title</code>, <code>name</code>, and <code>age</code> fields，a <code>blogpost</code> type might contain <code>title</code>, <code>body</code>, <code>user_id</code>and <code>created</code> fields</p>
</li>
</ul>
<p>注意：在一个索引中，两个不同的type中如果有一个同名的字段，那么这个字段必须使用相同的mapping</p>
<h3 id="字段数据类型"><a href="#字段数据类型" class="headerlink" title="字段数据类型"></a>字段数据类型</h3><p>有以下数据类型可以供字段选择</p>
<ul>
<li>基础类型：like text, keyword, date, long, double, boolean or ip.</li>
<li>json类型： object or nested.</li>
<li>专门的类型：like geo_point, geo_shape, or completion.</li>
</ul>
<h3 id="动态mapping"><a href="#动态mapping" class="headerlink" title="动态mapping"></a>动态mapping</h3><p>mapping type以及具体的字段在使用的时候，可以不需要提前指定配置，而是可以动态自动生成。</p>
<p>自动发现并且给字段添加相对应的类型我们称之为：”<em>dynamic mapping</em>“</p>
<p>动态mapping规则可以根据你的需求进行下自定义，有以下几种：</p>
<ul>
<li><p><code>_default_</code> mapping</p>
<p>为新的mapping配置基础的mapping配置。相当于是继承关系</p>
</li>
<li><p>Dynamic field mappings</p>
<p>这个规则管理动态字段发现</p>
</li>
<li><p>Dynamic templates</p>
<p>动态添加字段</p>
</li>
</ul>
<h4 id="default-mapping"><a href="#default-mapping" class="headerlink" title="_default_ mapping"></a><code>_default_</code> mapping</h4><p>default mapping的作用是定义一些全局的配置，在后续的多个mapping定义的时候如果没有手动的指定这个配置，那么会继承这个默认配置。</p>
<p>例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">PUT my_index</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;_default_&quot;: &#123; </span><br><span class="line">      &quot;_all&quot;: &#123;</span><br><span class="line">        &quot;enabled&quot;: false</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;user&quot;: &#123;&#125;, </span><br><span class="line">    &quot;blogpost&quot;: &#123; </span><br><span class="line">      &quot;_all&quot;: &#123;</span><br><span class="line">        &quot;enabled&quot;: true</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>设置全局的配置：将_all字段的标志位设置为false</p>
<ul>
<li>user这个type的mapping将会继承这个配置</li>
<li>blogpost这个type的mapping将会重写这个配置为true</li>
</ul>
<p>注意：尽管这个配置可以在索引已经存在的情况下执行，但是执行之后只是影响后来生成的mapping。</p>
<p>同样的，这个功能也可以用于索引的模板中</p>
<p>例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">PUT _template/logging</span><br><span class="line">&#123;</span><br><span class="line">  &quot;template&quot;:   &quot;logs-*&quot;, </span><br><span class="line">  &quot;settings&quot;: &#123; &quot;number_of_shards&quot;: 1 &#125;, </span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;_default_&quot;: &#123;</span><br><span class="line">      &quot;_all&quot;: &#123; </span><br><span class="line">        &quot;enabled&quot;: false</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;dynamic_templates&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;strings&quot;: &#123; </span><br><span class="line">            &quot;match_mapping_type&quot;: &quot;string&quot;,</span><br><span class="line">            &quot;mapping&quot;: &#123;</span><br><span class="line">              &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">              &quot;fields&quot;: &#123;</span><br><span class="line">                &quot;raw&quot;: &#123;</span><br><span class="line">                  &quot;type&quot;:  &quot;keyword&quot;,</span><br><span class="line">                  &quot;ignore_above&quot;: 256</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">测试：</span><br><span class="line">PUT logs-2015.10.01/event/1</span><br><span class="line">&#123; &quot;message&quot;: &quot;error:16&quot; &#125;</span><br></pre></td></tr></table></figure>
<h3 id="明确mapping-Explicit-mappings"><a href="#明确mapping-Explicit-mappings" class="headerlink" title="明确mapping- Explicit mappings"></a>明确mapping- Explicit mappings</h3><p>实际情况下，我们会比es更了解我们的数据，因此，我们可以在创建索引的时候就定义好mapping</p>
<p>我们可以：</p>
<ul>
<li>在创建索引的时候，初始化定义mapping </li>
<li>当索引已存在时，可以新增字段</li>
</ul>
<p>注意：不能更新现有的mapping的字段，更新通过下面的方式</p>
<h3 id="更新已存在的mapping"><a href="#更新已存在的mapping" class="headerlink" title="更新已存在的mapping"></a>更新已存在的mapping</h3><p>已经存在的mapping中的字段是不能直接被update的，如果修改mapping则意味着现有索引中的document都会成为无效数据，因此，如果我们想要更新mapping：</p>
<ol>
<li>新建一个mapping</li>
<li>重建索引</li>
<li>reindex：索引数据迁移</li>
</ol>
<h3 id="字段共享mapping"><a href="#字段共享mapping" class="headerlink" title="字段共享mapping"></a>字段共享mapping</h3><p>不同的mapping通常用于划分和组织字段组，但是以下的这些字段不会只作用于单个mapping局部</p>
<ul>
<li>字段的名称相同</li>
<li>位于同一个索引中</li>
<li>在不同的mapping  type中</li>
<li>mapping内部有相同的字段</li>
<li>必须拥有相同的mapping</li>
</ul>
<p>举例说明：</p>
<blockquote>
<p>如果title字段同时存在于user和blogpost这两个mapping type中，那么这个字段在两个mapping type中就必须保持一致的mapping</p>
<p>但是存在这些例外，直接看官方原文即可：</p>
<p>The only exceptions to this rule are the <a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.1/copy-to.html" target="_blank" rel="noopener"><code>copy_to</code></a>, <a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.1/dynamic.html" target="_blank" rel="noopener"><code>dynamic</code></a>, <a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.1/enabled.html" target="_blank" rel="noopener"><code>enabled</code></a>, <a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.1/ignore-above.html" target="_blank" rel="noopener"><code>ignore_above</code></a>, <a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.1/include-in-all.html" target="_blank" rel="noopener"><code>include_in_all</code></a>, and <a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.1/properties.html" target="_blank" rel="noopener"><code>properties</code></a> parameters, which may have different settings per field.</p>
</blockquote>
<h3 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h3><p>下面是一个案例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">PUT my_index </span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;user&quot;: &#123; </span><br><span class="line">      &quot;_all&quot;:       &#123; &quot;enabled&quot;: false  &#125;, </span><br><span class="line">      &quot;properties&quot;: &#123; </span><br><span class="line">        &quot;title&quot;:    &#123; &quot;type&quot;: &quot;text&quot;  &#125;, </span><br><span class="line">        &quot;name&quot;:     &#123; &quot;type&quot;: &quot;text&quot;  &#125;, </span><br><span class="line">        &quot;age&quot;:      &#123; &quot;type&quot;: &quot;integer&quot; &#125;  </span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;blogpost&quot;: &#123; </span><br><span class="line">      &quot;_all&quot;:       &#123; &quot;enabled&quot;: false  &#125;, </span><br><span class="line">      &quot;properties&quot;: &#123; </span><br><span class="line">        &quot;title&quot;:    &#123; &quot;type&quot;: &quot;text&quot;  &#125;, </span><br><span class="line">        &quot;body&quot;:     &#123; &quot;type&quot;: &quot;text&quot;  &#125;, </span><br><span class="line">        &quot;user_id&quot;:  &#123;</span><br><span class="line">          &quot;type&quot;:   &quot;keyword&quot; </span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;created&quot;:  &#123;</span><br><span class="line">          &quot;type&quot;:   &quot;date&quot;, </span><br><span class="line">          &quot;format&quot;: &quot;strict_date_optional_time||epoch_millis&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="元数据类型字段"><a href="#元数据类型字段" class="headerlink" title="元数据类型字段"></a>元数据类型字段</h3><h3 id="字段数据类型-1"><a href="#字段数据类型-1" class="headerlink" title="字段数据类型"></a>字段数据类型</h3><h4 id="keyword数据类型"><a href="#keyword数据类型" class="headerlink" title="keyword数据类型"></a>keyword数据类型</h4><p>这个数据类型适用于例如：</p>
<ul>
<li>email addresses  email地址</li>
<li>Hostnames 主机名</li>
<li>Status code  状态码</li>
<li>zip codes  编码</li>
<li>tags  指定的标志</li>
</ul>
<p>这种数据类型，主要的作用是过滤功能(例如博客文章中可以通过status为<em>published</em>已发布的来进行过滤)、sort排序功能、以及聚合。</p>
<p>keyword是唯一一种类型：他们的值可以被检索</p>
<p>下面是一个例子：创建索引的实时设定mapping，mapping中包含一个字段属性，其类型为keyword</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">PUT my_index</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;my_type&quot;: &#123;</span><br><span class="line">      &quot;properties&quot;: &#123;</span><br><span class="line">        &quot;tags&quot;: &#123;</span><br><span class="line">          &quot;type&quot;:  &quot;keyword&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>keyword中有以下这些参数，需要重点关注一下：</p>
<ul>
<li><p>ignore_above</p>
<blockquote>
<p>参考链接：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.3/ignore-above.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/5.3/ignore-above.html</a></p>
</blockquote>
</li>
</ul>
<h4 id="Text数据类型"><a href="#Text数据类型" class="headerlink" title="Text数据类型"></a>Text数据类型</h4><p>顾名思义，这个数据类型主要是作用于例如：邮件内容、产品描述信息等不规则的并且数据量较大的文本内容。</p>
<p>案例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">PUT my_index</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;my_type&quot;: &#123;</span><br><span class="line">      &quot;properties&quot;: &#123;</span><br><span class="line">        &quot;full_name&quot;: &#123;</span><br><span class="line">          &quot;type&quot;:  &quot;text&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="二级字段类型-fields配置"><a href="#二级字段类型-fields配置" class="headerlink" title="二级字段类型-fields配置"></a>二级字段类型-fields配置</h3><p>参考连接：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.3/multi-fields.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/5.3/multi-fields.html</a></p>
<h2 id="ES-API"><a href="#ES-API" class="headerlink" title="ES API"></a>ES API</h2><h3 id="API约定及惯例"><a href="#API约定及惯例" class="headerlink" title="API约定及惯例"></a>API约定及惯例</h3><h4 id="multiple-indices"><a href="#multiple-indices" class="headerlink" title="multiple indices"></a>multiple indices</h4><p>大部分涉及索引的api都支持匹配多个index操作,有如下这些方式实现</p>
<ul>
<li>多个索引：test1,test2,test3</li>
<li>所有索引：_all</li>
<li>通配符匹配：例如：<code>test*</code>、<code>*test</code> 、 <code>te*t</code> 、 <code>*test*</code></li>
<li>加减： “add” (<code>+</code>) and “remove” (<code>-</code>), for example: <code>+test*,-test3</code>.</li>
</ul>
<p>All multi indices API support the following url query string parameters:</p>
<p>使用这种方式的api都有一下参数</p>
<ul>
<li><p><strong>ignore_unavailable</strong></p>
<p>是否忽略不可用(不存在或者异常的)的索引，取值为true|false</p>
</li>
<li><p><strong>allow_no_indices</strong></p>
<p>控制当使用通配符匹配时，如果没有结果，是否返回fail。取值为true|false</p>
<p>不止针对通配符情况，也支持_all以及不指定任何index的情况</p>
<p>这个配置同样支持aliases</p>
</li>
<li><p><strong>expand_wildcards</strong></p>
<p>取值为open|closed|(open,closed)</p>
<p>控制通配符匹配到的索引，当设置为open时，将只会匹配到open的索引，也就是正常的索引，当设置为closed时，将只会匹配到closed的索引。</p>
<p>也可以设置为open+closed，以匹配所以的索引</p>
<p>注意：如果设置为none，这个功能将会被disable。如果设置为all，那么等价于open+closed</p>
</li>
</ul>
<p>注意：只作用于单个索引的api（例如document api等等），没有上面这些参数</p>
<h4 id="Date-math-support-in-index-names"><a href="#Date-math-support-in-index-names" class="headerlink" title="Date math support in index names"></a>Date math support in index names</h4><p>后续涉及时再进行补充。</p>
<h4 id="Common-option-1"><a href="#Common-option-1" class="headerlink" title="Common option"></a>Common option</h4><p>通用选项。</p>
<h4 id="URL-based-access-control"><a href="#URL-based-access-control" class="headerlink" title="URL-based access control"></a>URL-based access control</h4><p>后续补充</p>
<h3 id="Document-APIs"><a href="#Document-APIs" class="headerlink" title="Document APIs"></a>Document APIs</h3><h4 id="Reading-and-Writing-documents-读写document"><a href="#Reading-and-Writing-documents-读写document" class="headerlink" title="Reading and Writing documents-读写document"></a>Reading and Writing documents-读写document</h4><p>链接：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.1/docs-replication.html#_introduction" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/5.1/docs-replication.html#_introduction</a></p>
<p>每一个索引在ES中都会被分割成为shard分片，并且每一个shard都会有不等的copies副本。</p>
<p>当有多个副本的时候，这多个副本，我们就称之为<strong>replication group</strong>-副本组，当document有新增或者删除的时候，我们需要保证这个组中的每个副本的数据和分片是同步的，防止出现数据不一致的情况</p>
<p>保证分片和副本之间的数据同步的进程，我们称之为：<em>data replication model</em></p>
<h5 id="基础写模型-Basic-write-model"><a href="#基础写模型-Basic-write-model" class="headerlink" title="基础写模型- Basic write model"></a>基础写模型- Basic write model</h5><p>ES接收索引写请求，首先根据路由服务（根据document为处理依据），将请求转发给副本组。</p>
<p>副本组收到请求之后，这个请求将会被转发给副本组中的主分片(每个副本组中还会区分主从关系)，这个副本主分片转发请求给其他的副本，</p>
<p>主分片按照下面的流程处理：</p>
<ol>
<li>检验请求是否符合标准，拒绝无效的请求</li>
<li>在本地执行这个操作(写document的操作)</li>
<li>转发这个请求给所有的副本，这个过程是同步的，而不是异步</li>
<li>一旦所有的副本都执行完毕，并且返回结构给主分片，主分片返回ack给客户端。</li>
</ol>
<h5 id="写失败处理"><a href="#写失败处理" class="headerlink" title="写失败处理"></a>写失败处理</h5><p>暂时略</p>
<h5 id="基础读模型"><a href="#基础读模型" class="headerlink" title="基础读模型"></a>基础读模型</h5><p>读操作的时候，可以是非常轻量级的根据document的id进行，也可以是非常重的请求(非常复杂的聚合条件)</p>
<p>当一个node节点接收到一个读请求时，这个node负责转发这个请求给具有相关分片的node，并且收集响应，然后返回给客户端，我们称这样的node为坐标node(<em>coordinating node</em>)</p>
<p>这个node的基本的工作流为：</p>
<ul>
<li>解析请求，获取这个请求涉及哪些分片，因为很多读请求会涉及到多个索引，他们也就需要读取到多个分片</li>
<li>从对应分片的副本组中选择一个活跃状态的副本，这个副本可以使主或者从角色，默认情况下，es会轮询调度到这些副本</li>
<li>发送请求到这个指定的副本</li>
<li>坐标node，汇总所有副本返回的结果，然后响应客户端。</li>
</ul>
<h5 id="读失败处理"><a href="#读失败处理" class="headerlink" title="读失败处理"></a>读失败处理</h5><p>暂时略</p>
<h4 id="新建document"><a href="#新建document" class="headerlink" title="新建document"></a>新建document</h4><p>案例：</p>
<p>新建一个document</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PUT twitter/tweet/1</span><br><span class="line">&#123;</span><br><span class="line">    &quot;user&quot; : &quot;kimchy&quot;,</span><br><span class="line">    &quot;post_date&quot; : &quot;2009-11-15T14:12:12&quot;,</span><br><span class="line">    &quot;message&quot; : &quot;trying out Elasticsearch&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行之后，es的响应返回为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;_shards&quot; : &#123;</span><br><span class="line">        &quot;total&quot; : 3,</span><br><span class="line">        &quot;failed&quot; : 0,</span><br><span class="line">        &quot;successful&quot; : 3</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;_index&quot; : &quot;twitter&quot;,</span><br><span class="line">    &quot;_type&quot; : &quot;tweet&quot;,</span><br><span class="line">    &quot;_id&quot; : &quot;1&quot;,</span><br><span class="line">    &quot;_version&quot; : 1,</span><br><span class="line">    &quot;created&quot; : true,</span><br><span class="line">    &quot;result&quot; : created</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因为，这个索引之前在创建的时候设置为3个分片，所以这里的shard为3，_shards这一个块展示的是复制过程相关的结果信息，success表示所有的副本都是成功状态的。</p>
<p>分片数量可以根据索引相关的接口的进行查询：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[elk@node003 ~]$ curl http://192.168.103.133:9500/_cat/indices?v</span><br><span class="line">health status index           uuid                   pri rep docs.count docs.deleted store.size pri.store.size</span><br><span class="line">green  open   twitter         2Gxyl8acRa222-gdYhE4ig   3   2          1            0     14.1kb          4.7kb</span><br><span class="line">green  open   .kibana         JjZFr5NvTXSOUv6DjwyF0w   1   1          1            0      6.3kb          3.1kb</span><br><span class="line">green  open   logs-2015.10.01 Ubo73cz5RRO4ipU33zdCqQ   1   1          0            0       318b           159b</span><br></pre></td></tr></table></figure>
<p>不手动指定id，使用自动增长的序列号(注意使用POST代替PUT)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST twitter/tweet/</span><br><span class="line">&#123;</span><br><span class="line">    &quot;user&quot; : &quot;kimchy&quot;,</span><br><span class="line">    &quot;post_date&quot; : &quot;2009-11-15T14:12:12&quot;,</span><br><span class="line">    &quot;message&quot; : &quot;trying out Elasticsearch&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>返回结果为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;_index&quot; : &quot;twitter&quot;,</span><br><span class="line">  &quot;_type&quot; : &quot;tweet&quot;,</span><br><span class="line">  &quot;_id&quot; : &quot;AWu2sgI5Rw8iDPJNYgMY&quot;,</span><br><span class="line">  &quot;_version&quot; : 1,</span><br><span class="line">  &quot;result&quot; : &quot;created&quot;,</span><br><span class="line">  &quot;_shards&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : 3,</span><br><span class="line">    &quot;successful&quot; : 3,</span><br><span class="line">    &quot;failed&quot; : 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;created&quot; : true</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，document的为：AWu2sgI5Rw8iDPJNYgMY</p>
<h4 id="查询document"><a href="#查询document" class="headerlink" title="查询document"></a>查询document</h4><p>根据document的id进行查询</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">GET twitter/tweet/0</span><br><span class="line"></span><br><span class="line">[elk@node003 ~]$ curl http://192.168.103.133:9500/twitter/tweet/1?pretty</span><br><span class="line">&#123;</span><br><span class="line">  &quot;_index&quot; : &quot;twitter&quot;,</span><br><span class="line">  &quot;_type&quot; : &quot;tweet&quot;,</span><br><span class="line">  &quot;_id&quot; : &quot;1&quot;,</span><br><span class="line">  &quot;_version&quot; : 1,</span><br><span class="line">  &quot;found&quot; : true,</span><br><span class="line">  &quot;_source&quot; : &#123;</span><br><span class="line">    &quot;user&quot; : &quot;kimchy&quot;,</span><br><span class="line">    &quot;post_date&quot; : &quot;2009-11-15T14:12:12&quot;,</span><br><span class="line">    &quot;message&quot; : &quot;trying out Elasticsearch&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="删除document"><a href="#删除document" class="headerlink" title="删除document"></a>删除document</h4><p>基础document的id进行删除</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">格式例如：curl -XDELETE &apos;http://localhost:9200/twitter/tweet/1&apos;</span><br></pre></td></tr></table></figure>
<h3 id="Indices-APIs-索引api"><a href="#Indices-APIs-索引api" class="headerlink" title="Indices APIs-索引api"></a>Indices APIs-索引api</h3><h4 id="创建索引"><a href="#创建索引" class="headerlink" title="创建索引"></a><strong>创建索引</strong></h4><p>例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">PUT twitter</span><br><span class="line">&#123;</span><br><span class="line">    &quot;settings&quot; : &#123;</span><br><span class="line">        &quot;index&quot; : &#123;</span><br><span class="line">            &quot;number_of_shards&quot; : 3, </span><br><span class="line">            &quot;number_of_replicas&quot; : 2 </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">或者可以省略index</span><br><span class="line">PUT twitter</span><br><span class="line">&#123;</span><br><span class="line">    &quot;settings&quot; : &#123;</span><br><span class="line">        &quot;number_of_shards&quot; : 3,</span><br><span class="line">        &quot;number_of_replicas&quot; : 2</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>创建索引并指定mapping</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">PUT test</span><br><span class="line">&#123;</span><br><span class="line">    &quot;settings&quot; : &#123;</span><br><span class="line">        &quot;number_of_shards&quot; : 1</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;mappings&quot; : &#123;</span><br><span class="line">        &quot;type1&quot; : &#123;</span><br><span class="line">            &quot;properties&quot; : &#123;</span><br><span class="line">                &quot;field1&quot; : &#123; &quot;type&quot; : &quot;text&quot; &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>创建索引并设置alias</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">PUT test</span><br><span class="line">&#123;</span><br><span class="line">    &quot;aliases&quot; : &#123;</span><br><span class="line">        &quot;alias_1&quot; : &#123;&#125;,</span><br><span class="line">        &quot;alias_2&quot; : &#123;</span><br><span class="line">            &quot;filter&quot; : &#123;</span><br><span class="line">                &quot;term&quot; : &#123;&quot;user&quot; : &quot;kimchy&quot; &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;routing&quot; : &quot;kimchy&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="删除索引"><a href="#删除索引" class="headerlink" title="删除索引"></a><strong>删除索引</strong></h4><p>执行下面的接口：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE /twitter</span><br></pre></td></tr></table></figure>
<p>索引可以是：</p>
<ul>
<li>单个索引</li>
<li>_all 所有索引</li>
<li>通配符表达式，例如添加*等</li>
</ul>
<p>因为可以批量的删除，所以存在一定的风险，当我们希望关闭这个功能的时候，设置action.destructive_requires_name的值为true。这个配置也可以在集群运行过程中被修改。</p>
<h4 id="查看索引"><a href="#查看索引" class="headerlink" title="查看索引"></a><strong>查看索引</strong></h4><p>接口为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET twitter</span><br></pre></td></tr></table></figure>
<p>查看twitter索引，注意可以使用通配符、alias、_all等匹配多个索引</p>
<p>过滤索引的特殊配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GET twitter/_settings</span><br><span class="line">GET twitter/_mappings</span><br><span class="line">GET twitter/_aliases</span><br></pre></td></tr></table></figure>
<h4 id="索引是否存在"><a href="#索引是否存在" class="headerlink" title="索引是否存在"></a><strong>索引是否存在</strong></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HEAD twitter</span><br></pre></td></tr></table></figure>
<p>接口返回404为不存在，200则为存在。</p>
<h4 id="put-mapping-mapping的新增"><a href="#put-mapping-mapping的新增" class="headerlink" title="put mapping-mapping的新增"></a><strong>put mapping-mapping的新增</strong></h4><p>我们可以实现：</p>
<ul>
<li><p>在现有的索引上新增type的mapping</p>
</li>
<li><p>创建索引时指定mapping</p>
</li>
<li>在现有的mapping基础上新增字段</li>
</ul>
<p>案例如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"># 创建索引时指定mapping</span><br><span class="line">PUT twitter </span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;tweet&quot;: &#123;</span><br><span class="line">      &quot;properties&quot;: &#123;</span><br><span class="line">        &quot;message&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;text&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 在现有索引上新增mapping type</span><br><span class="line">PUT twitter/_mapping/user </span><br><span class="line">&#123;</span><br><span class="line">  &quot;properties&quot;: &#123;</span><br><span class="line">    &quot;name&quot;: &#123;</span><br><span class="line">      &quot;type&quot;: &quot;text&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 现有mapping上新增字段</span><br><span class="line">PUT twitter/_mapping/tweet </span><br><span class="line">&#123;</span><br><span class="line">  &quot;properties&quot;: &#123;</span><br><span class="line">    &quot;user_name&quot;: &#123;</span><br><span class="line">      &quot;type&quot;: &quot;text&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="get-mapping"><a href="#get-mapping" class="headerlink" title="get mapping"></a><strong>get mapping</strong></h4><p>语法格式为：host:port/{index}/_mapping/{type}</p>
<p>案例为:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">GET /_mapping/tweet,kimchy</span><br><span class="line">=</span><br><span class="line">GET /_all/_mapping/tweet,book</span><br><span class="line"></span><br><span class="line">GET /_all/_mapping</span><br><span class="line">=</span><br><span class="line">GET /_mapping</span><br></pre></td></tr></table></figure>
<h4 id="获取具体字段的mapping"><a href="#获取具体字段的mapping" class="headerlink" title="获取具体字段的mapping"></a><strong>获取具体字段的mapping</strong></h4><p>语法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /twitter/_mapping/tweet/field/field1,field2,...</span><br></pre></td></tr></table></figure>
<h4 id="判断mapping-type是否存在"><a href="#判断mapping-type是否存在" class="headerlink" title="判断mapping type是否存在"></a><strong>判断mapping type是否存在</strong></h4><p>语法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HEAD twitter/_mapping/tweet</span><br></pre></td></tr></table></figure>
<p>返回值为404或者200</p>
<h4 id="索引别名-index-aliases"><a href="#索引别名-index-aliases" class="headerlink" title="索引别名-index aliases"></a><strong>索引别名-index aliases</strong></h4><p>索引别名允许给索引重新定义一个名称，当在调用这个alias的时候，es会自动的把这个alias转换为真实的index,</p>
<p>一个alias可以被映射到多个index上，</p>
<p>添加alias:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">POST /_aliases</span><br><span class="line">&#123;</span><br><span class="line">    &quot;actions&quot; : [</span><br><span class="line">        &#123; &quot;add&quot; : &#123; &quot;index&quot; : &quot;test1&quot;, &quot;alias&quot; : &quot;alias1&quot; &#125; &#125;,</span><br><span class="line">        &#123; &quot;add&quot; : &#123; &quot;index&quot; : &quot;test2&quot;, &quot;alias&quot; : &quot;alias1&quot; &#125; &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">或者</span><br><span class="line">POST /_aliases</span><br><span class="line">&#123;</span><br><span class="line">    &quot;actions&quot; : [</span><br><span class="line">        &#123; &quot;add&quot; : &#123; &quot;indices&quot; : [&quot;test1&quot;, &quot;test2&quot;], &quot;alias&quot; : &quot;alias1&quot; &#125; &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">或者</span><br><span class="line">POST /_aliases</span><br><span class="line">&#123;</span><br><span class="line">    &quot;actions&quot; : [</span><br><span class="line">        &#123; &quot;add&quot; : &#123; &quot;index&quot; : &quot;test*&quot;, &quot;alias&quot; : &quot;all_test_indices&quot; &#125; &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="获取索引alias"><a href="#获取索引alias" class="headerlink" title="获取索引alias"></a><strong>获取索引alias</strong></h4><p>语法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">语法格式：/&#123;index&#125;/_alias/&#123;alias&#125;</span><br><span class="line">例如：GET /logs_20162801/_alias/*</span><br></pre></td></tr></table></figure>
<p>在所有index中搜索alias为2016</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /_alias/2016</span><br></pre></td></tr></table></figure>
<p>下面的方式可以检查alias是否存在：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">HEAD /_alias/2016</span><br><span class="line">HEAD /_alias/20*</span><br><span class="line">HEAD /logs_20162801/_alias/*</span><br></pre></td></tr></table></figure>
<h4 id="索引模板"><a href="#索引模板" class="headerlink" title="索引模板"></a><strong>索引模板</strong></h4><p>作用：新建的index能够继承这一套的配置</p>
<p>模板中包括setting、mapping等配置，以及控制哪些index可以继承这个模板配置。</p>
<p>例如：</p>
<p>新建索引模板：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">PUT _template/template_1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;template&quot;: &quot;te*&quot;,</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;number_of_shards&quot;: 1</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;type1&quot;: &#123;</span><br><span class="line">      &quot;_source&quot;: &#123;</span><br><span class="line">        &quot;enabled&quot;: false</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;properties&quot;: &#123;</span><br><span class="line">        &quot;host_name&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;created_at&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;date&quot;,</span><br><span class="line">          &quot;format&quot;: &quot;EEE MMM dd HH:mm:ss Z YYYY&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一个生产案例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line">PUT _template/realtime_baobei_order</span><br><span class="line">&#123;</span><br><span class="line">  &quot;order&quot;: 0,</span><br><span class="line">  &quot;template&quot;: &quot;realtime_baobei_order-*&quot;,</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;index&quot;: &#123;</span><br><span class="line">        &quot;max_result_window&quot;: &quot;30000&quot;,</span><br><span class="line">        &quot;codec&quot;: &quot;best_compression&quot;,</span><br><span class="line">        &quot;refresh_interval&quot;: &quot;-1&quot;,</span><br><span class="line">        &quot;number_of_shards&quot;: &quot;6&quot;,</span><br><span class="line">        &quot;number_of_replicas&quot;: &quot;0&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;aliases&quot;: &#123;&#125;,</span><br><span class="line">    &quot;mappings&quot;: &#123;</span><br><span class="line">      &quot;order&quot;:&#123;</span><br><span class="line">        &quot;properties&quot;: &#123;</span><br><span class="line">            &quot;cancel_reason&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;long&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;cook_tm&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;date&quot;,</span><br><span class="line">          &quot;format&quot;: &quot;yyyy-MM-dd HH:mm:ss||yyyy-MM-dd||epoch_millis&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;customer_name&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;customer_tel&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;expect_send_tm&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;date&quot;,</span><br><span class="line">            &quot;format&quot;: &quot;yyyy-MM-dd HH:mm:ss||yyyy-MM-dd||epoch_millis&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;finish_tm&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;date&quot;,</span><br><span class="line">            &quot;format&quot;: &quot;yyyy-MM-dd HH:mm:ss||yyyy-MM-dd||epoch_millis&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;food_agg&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;id&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;long&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;join_expire_tm&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;date&quot;,</span><br><span class="line">            &quot;format&quot;: &quot;yyyy-MM-dd HH:mm:ss||yyyy-MM-dd||epoch_millis&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;leave_shop_tm&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;date&quot;,</span><br><span class="line">            &quot;format&quot;: &quot;yyyy-MM-dd HH:mm:ss||yyyy-MM-dd||epoch_millis&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;location_id&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;long&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;location_name&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;order_id&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;long&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;package_id&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;long&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;pay_tm&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;date&quot;,</span><br><span class="line">            &quot;format&quot;: &quot;yyyy-MM-dd HH:mm:ss||yyyy-MM-dd||epoch_millis&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;place_tm&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;date&quot;,</span><br><span class="line">            &quot;format&quot;: &quot;yyyy-MM-dd HH:mm:ss||yyyy-MM-dd||epoch_millis&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;pt&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;remark&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;serial_id&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;settment_cost_1&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;float&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;settment_cost_2&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;float&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;settment_cost_4&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;float&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;settment_cost_5&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;float&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;settment_cost_6&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;float&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;settment_cost_7&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;float&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;settment_cost_998&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;float&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;settment_cost_999&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;float&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;shop_id&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;long&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;shop_name&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;shop_tel&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;status&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;long&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;user_id&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;long&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>
<p>删除索引模板：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE /_template/template_1</span><br></pre></td></tr></table></figure>
<p>查看索引模板信息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GET /_template/template_1</span><br><span class="line">GET /_template/temp*</span><br><span class="line">GET /_template/template_1,template_2</span><br><span class="line">获取所有的模板：</span><br><span class="line">GET /_template</span><br></pre></td></tr></table></figure>
<p>判断索引模板是否存在：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HEAD _template/template_1</span><br></pre></td></tr></table></figure>
<h4 id="索引状态"><a href="#索引状态" class="headerlink" title="索引状态"></a><strong>索引状态</strong></h4><p>语法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 查看所有的索引的状态</span><br><span class="line">GET /_stats</span><br><span class="line"></span><br><span class="line"># 查看指定索引的状态</span><br><span class="line">GET /index1,index2/_stats</span><br></pre></td></tr></table></figure>
<h4 id="refresh"><a href="#refresh" class="headerlink" title="refresh"></a><strong>refresh</strong></h4><p>例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 刷新一个index</span><br><span class="line">POST /twitter/_refresh</span><br><span class="line"># 刷新多个index</span><br><span class="line">POST /kimchy,elasticsearch/_refresh</span><br><span class="line"># 刷新所有的index</span><br><span class="line">POST /_refresh</span><br></pre></td></tr></table></figure>
<h3 id="cat-apis"><a href="#cat-apis" class="headerlink" title="cat apis"></a>cat apis</h3><h4 id="作用"><a href="#作用" class="headerlink" title="作用"></a>作用</h4><p>尽管json格式是一种非常好的数据格式，但是在shh终端上，不利于人类的可读，在终端界面，我们需要线性的显示。那么cat api就是干这个的，它可以把输出转换为方便人类查看的格式</p>
<h4 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h4><p>在cat api中，支持一下参数</p>
<ul>
<li><p>verbose。输出全量信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 无参数</span><br><span class="line">[elk@node003 bin]$ curl http://192.168.103.133:9500/_cat/master</span><br><span class="line">Mb1156xHRuSYgSZ3RG1n8Q 192.168.101.172 192.168.101.172 node002</span><br><span class="line"></span><br><span class="line"># 有参数</span><br><span class="line">[elk@node003 bin]$ curl http://192.168.103.133:9500/_cat/master?v</span><br><span class="line">id                     host            ip              node</span><br><span class="line">Mb1156xHRuSYgSZ3RG1n8Q 192.168.101.172 192.168.101.172 node002</span><br></pre></td></tr></table></figure>
</li>
<li><p>help，每一个方法都可以使用help查看可以获得哪些输出信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[elk@node003 bin]$ curl http://192.168.103.133:9500/_cat/master?help</span><br><span class="line">id   |   | node id</span><br><span class="line">host | h | host name</span><br><span class="line">ip   |   | ip address</span><br><span class="line">node | n | node name</span><br></pre></td></tr></table></figure>
</li>
<li><p>Headers，可以指定要输出的字段，例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># 获取支持的字段信息</span><br><span class="line">[elk@node003 bin]$ curl http://192.168.103.133:9500/_cat/nodes?help</span><br><span class="line"></span><br><span class="line"># 默认的全量输出</span><br><span class="line">[elk@node003 bin]$ curl http://192.168.103.133:9500/_cat/nodes?v</span><br><span class="line">ip              heap.percent ram.percent cpu load_1m load_5m load_15m node.role master name</span><br><span class="line">192.168.103.133           12          97   0    0.39    0.37     0.26 mdi       -      node003</span><br><span class="line">192.168.100.113           12          96   0    0.16    0.29     0.22 mdi       -      node001</span><br><span class="line">192.168.101.172           14          96   1    0.40    0.37     0.25 mdi       *      node002</span><br><span class="line"></span><br><span class="line"># 指定字段输出</span><br><span class="line">[elk@node003 bin]$ curl http://192.168.103.133:9500/_cat/nodes?h=ip,port,heapPercent,name</span><br><span class="line">192.168.103.133 9600 12 node003</span><br><span class="line">192.168.100.113 9600 12 node001</span><br><span class="line">192.168.101.172 9600 14 node002</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="具体接口"><a href="#具体接口" class="headerlink" title="具体接口"></a>具体接口</h4><p>链接：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.1/cat.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/5.1/cat.html</a></p>
<h3 id="ES常用API"><a href="#ES常用API" class="headerlink" title="ES常用API"></a>ES常用API</h3><ul>
<li><p>集群健康状态：GET /_cat/health?v</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[elk@node001 ~]$ curl http://127.0.0.1:9200/_cat/health?v</span><br><span class="line">epoch      timestamp cluster       status node.total node.data shards pri relo init unassign pending_tasks max_task_wait_time active_shards_percent</span><br><span class="line">1561023164 17:32:44  elasticsearch green           1         1      0   0    0    0        0             0                  -                100.0%</span><br></pre></td></tr></table></figure>
</li>
<li><p>集群节点：GET /_cat/nodes?v</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[elk@node001 ~]$ curl http://127.0.0.1:9200/_cat/nodes?v</span><br><span class="line">ip        heap.percent ram.percent cpu load_1m load_5m load_15m node.role master name</span><br><span class="line">127.0.0.1           10          96   0    0.00    0.06     0.08 mdi       *      Jd3JKT1</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建索引：PUT /customer?pretty</p>
</li>
<li><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[elk@node001 ~]$ curl -X PUT  http://127.0.0.1:9200/customer?pretty</span><br><span class="line">&#123;</span><br><span class="line">  &quot;acknowledged&quot; : true,</span><br><span class="line">  &quot;shards_acknowledged&quot; : true</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看所有的索引：GET /_cat/indices?v</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[elk@node001 ~]$ curl -X GET http://127.0.0.1:9200/_cat/indices?v</span><br><span class="line">health status index    uuid                   pri rep docs.count docs.deleted store.size pri.store.size</span><br><span class="line">yellow open   customer cDDJVvowS-uZs0um21huWw   5   1          0            0       650b           650b</span><br></pre></td></tr></table></figure>
</li>
<li><p>传输document到index中：PUT /customer/external/1?pretty</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 ~]# curl -X PUT http://127.0.0.1:9200/customer/external/1?pretty -d &apos;&#123;&quot;name&quot;:&quot;John Doe&quot;&#125;&apos;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;_index&quot; : &quot;customer&quot;,</span><br><span class="line">  &quot;_type&quot; : &quot;external&quot;,</span><br><span class="line">  &quot;_id&quot; : &quot;1&quot;,</span><br><span class="line">  &quot;_version&quot; : 1,</span><br><span class="line">  &quot;result&quot; : &quot;created&quot;,</span><br><span class="line">  &quot;_shards&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : 2,</span><br><span class="line">    &quot;successful&quot; : 1,</span><br><span class="line">    &quot;failed&quot; : 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;created&quot; : true</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意：customer是index索引，external是type，1是id。POST方式是自增id，put方式必须要加上id。</p>
<p>这个操作，相当于是给这个索引新增一行数据</p>
</li>
<li><p>查看document：/customer/external/1?pretty</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 ~]# curl -X GET http://127.0.0.1:9200/customer/external/1?pretty</span><br><span class="line">&#123;</span><br><span class="line">  &quot;_index&quot; : &quot;customer&quot;,</span><br><span class="line">  &quot;_type&quot; : &quot;external&quot;,</span><br><span class="line">  &quot;_id&quot; : &quot;1&quot;,</span><br><span class="line">  &quot;_version&quot; : 1,</span><br><span class="line">  &quot;found&quot; : true,</span><br><span class="line">  &quot;_source&quot; : &#123;</span><br><span class="line">    &quot;name&quot; : &quot;John Doe&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>查看id为1的document的具体内容</p>
</li>
<li><p>删除索引：DELETE /customer?pretty</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 ~]# curl -X DELETE  http://127.0.0.1:9200/customer?pretty</span><br><span class="line">&#123;</span><br><span class="line">  &quot;acknowledged&quot; : true</span><br><span class="line">&#125;</span><br><span class="line">[root@node001 ~]# curl -X GET http://127.0.0.1:9200/_cat/indices?v</span><br><span class="line">health status index uuid pri rep docs.count docs.deleted store.size pri.store.size</span><br></pre></td></tr></table></figure>
<p>注意：上面这些接口路径中的?pretty均可以省略，这个的作用只是为了显示美观，没有实际意义。</p>
</li>
<li><p>更新document：POST /customer/external/1/_update?pretty</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 ~]# curl -X POST  http://127.0.0.1:9200/customer/external/1?pretty -d &apos;&#123;&quot;doc&quot;:&quot;John Doe&quot;&#125;&apos;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;_index&quot; : &quot;customer&quot;,</span><br><span class="line">  &quot;_type&quot; : &quot;external&quot;,</span><br><span class="line">  &quot;_id&quot; : &quot;1&quot;,</span><br><span class="line">  &quot;_version&quot; : 2,</span><br><span class="line">  &quot;result&quot; : &quot;updated&quot;,</span><br><span class="line">  &quot;_shards&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : 2,</span><br><span class="line">    &quot;successful&quot; : 1,</span><br><span class="line">    &quot;failed&quot; : 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;created&quot; : false</span><br><span class="line">&#125;</span><br><span class="line">[root@node001 ~]#  curl -X GET http://127.0.0.1:9200/customer/external/1?pretty</span><br><span class="line">&#123;</span><br><span class="line">  &quot;_index&quot; : &quot;customer&quot;,</span><br><span class="line">  &quot;_type&quot; : &quot;external&quot;,</span><br><span class="line">  &quot;_id&quot; : &quot;1&quot;,</span><br><span class="line">  &quot;_version&quot; : 2,</span><br><span class="line">  &quot;found&quot; : true,</span><br><span class="line">  &quot;_source&quot; : &#123;</span><br><span class="line">    &quot;doc&quot; : &quot;John Doe&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意：这里所说的更新操作，实际上在ES内部部署更新替换，而是删除之后再重新创建</p>
</li>
<li><p>删除document：DELETE /customer/external/2?pretty</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 ~]#  curl -X DELETE http://127.0.0.1:9200/customer/external/1?pretty</span><br><span class="line">&#123;</span><br><span class="line">  &quot;found&quot; : true,</span><br><span class="line">  &quot;_index&quot; : &quot;customer&quot;,</span><br><span class="line">  &quot;_type&quot; : &quot;external&quot;,</span><br><span class="line">  &quot;_id&quot; : &quot;1&quot;,</span><br><span class="line">  &quot;_version&quot; : 6,</span><br><span class="line">  &quot;result&quot; : &quot;deleted&quot;,</span><br><span class="line">  &quot;_shards&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : 2,</span><br><span class="line">    &quot;successful&quot; : 1,</span><br><span class="line">    &quot;failed&quot; : 0</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@node001 ~]#  curl -X GET http://127.0.0.1:9200/customer/external/1?pretty</span><br><span class="line">&#123;</span><br><span class="line">  &quot;_index&quot; : &quot;customer&quot;,</span><br><span class="line">  &quot;_type&quot; : &quot;external&quot;,</span><br><span class="line">  &quot;_id&quot; : &quot;1&quot;,</span><br><span class="line">  &quot;found&quot; : false</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看node上有哪些shard</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://172.16.1.129:9500/_cat/shards|  grep node004</span><br></pre></td></tr></table></figure>
</li>
<li><p>关闭打开索引</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">关闭：curl -XPOST localhost:9200/xxx_indices/_close</span><br><span class="line">打开：</span><br></pre></td></tr></table></figure>
</li>
<li><p>关闭集群的reroute-(有新节点新增之后，不要立马挪动shards)</p>
<p>这里是控制集群中的shard的移动，一般是在新增节点之后，如果不想马上就进行shards的挪动，那么可以暂停这个功能</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">PUT _cluster/settings</span><br><span class="line">&#123;</span><br><span class="line">  &quot;persistent&quot;: &#123;</span><br><span class="line">    &quot;cluster.routing.allocation.enable&quot;: &quot;none&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">如果想取消，那么设置为null即可。</span><br></pre></td></tr></table></figure>
</li>
<li><p>集群统计信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET _cluster/stats</span><br></pre></td></tr></table></figure>
<p>包括索引数量、shard的数量、主、副shard的比例等等、docs的数量、存储使用量、插件情况</p>
</li>
<li><p>cluster reroute</p>
<p>参考链接：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/6.3/cluster-reroute.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/6.3/cluster-reroute.html</a></p>
<p>主要是涉及集群的一些内部路由，主要是shards分片的移动（move）、重新分片未分配的副本分片（allocate_replica）。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">POST /_cluster/reroute</span><br><span class="line">&#123;</span><br><span class="line">    &quot;commands&quot; : [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;move&quot; : &#123;</span><br><span class="line">                &quot;index&quot; : &quot;test&quot;, &quot;shard&quot; : 0,</span><br><span class="line">                &quot;from_node&quot; : &quot;node1&quot;, &quot;to_node&quot; : &quot;node2&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;allocate_replica&quot; : &#123;</span><br><span class="line">                &quot;index&quot; : &quot;test&quot;, &quot;shard&quot; : 1,</span><br><span class="line">                &quot;node&quot; : &quot;node3&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改副本分片数量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PUT applog-prod-2016.12.18/_settings</span><br><span class="line">&#123;</span><br><span class="line">  &quot;index&quot;:&#123;</span><br><span class="line">    &quot;number_of_replicas&quot;:0</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看每个node上的task</p>
<p>参考链接：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/6.3/tasks.html#_current_tasks_information" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/6.3/tasks.html#_current_tasks_information</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GET _tasks </span><br><span class="line">GET _tasks?nodes=nodeId1,nodeId2 </span><br><span class="line">GET _tasks?nodes=nodeId1,nodeId2&amp;actions=cluster:*</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>cluster allocation explain API</p>
<p>集群内部分配相关的解释api，可以解释未分配shard的原因等等，在诊断shard问题的时候非常有用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"> </span><br></pre></td></tr></table></figure>
</li>
<li><p>分片迁移</p>
<p>参考链接：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.3/cluster-reroute.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/5.3/cluster-reroute.html</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">POST /_cluster/reroute</span><br><span class="line">&#123;</span><br><span class="line">    &quot;commands&quot; : [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;move&quot; : &#123;</span><br><span class="line">                &quot;index&quot; : &quot;test&quot;, &quot;shard&quot; : 0,</span><br><span class="line">                &quot;from_node&quot; : &quot;node1&quot;, &quot;to_node&quot; : &quot;node2&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;allocate_replica&quot; : &#123;</span><br><span class="line">                &quot;index&quot; : &quot;test&quot;, &quot;shard&quot; : 1,</span><br><span class="line">                &quot;node&quot; : &quot;node3&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>更新索引模板</p>
<p>例如更新索引名称的匹配规则：从<code>nginx*-logstash-*</code> 修改为<code>nginx-logstash-*</code></p>
<p>直接使用PUT的话将会是覆盖操作</p>
<p>操作如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"> </span><br></pre></td></tr></table></figure>
</li>
<li><p>更新monitor的索引保存天数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PUT _cluster/settings</span><br><span class="line">&#123;&quot;persistent&quot;: &#123;&quot;xpack.monitoring.history.duration&quot;:&quot;1d&quot;&#125;&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="Search-api"><a href="#Search-api" class="headerlink" title="Search api"></a>Search api</h3><p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.1/_the_search_api.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/5.1/_the_search_api.html</a></p>
<p>ES检索相关-【这部分相当重要】</p>
<p>这个api允许你执行一些查询请求，</p>
<h4 id="参数形式"><a href="#参数形式" class="headerlink" title="参数形式"></a>参数形式</h4><p>查找twitter索引下的tweet,user这2个type中user为kimchy的document</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">GET /twitter/tweet,user/_search?q=user:kimchy</span><br><span class="line">实际执行为：</span><br><span class="line"></span><br><span class="line">[elk@node003 ~]$ curl http://192.168.103.133:9500/twitter/tweet,user/_search?q=user:kimchy</span><br><span class="line">&#123;&quot;took&quot;:31,&quot;timed_out&quot;:false,&quot;_shards&quot;:&#123;&quot;total&quot;:3,&quot;successful&quot;:3,&quot;failed&quot;:0&#125;,&quot;hits&quot;:&#123;&quot;total&quot;:3,&quot;max_score&quot;:0.2876821,&quot;hits&quot;:[&#123;&quot;_index&quot;:&quot;twitter&quot;,&quot;_type&quot;:&quot;tweet&quot;,&quot;_id&quot;:&quot;AWu2sYdrRw8iDPJNYgMX&quot;,&quot;_score&quot;:0.2876821,&quot;_source&quot;:&#123;</span><br><span class="line">    &quot;user&quot; : &quot;kimchy&quot;,</span><br><span class="line">    &quot;post_date&quot; : &quot;2009-11-15T14:12:12&quot;,</span><br><span class="line">    &quot;message&quot; : &quot;trying out Elasticsearch&quot;</span><br><span class="line">&#125;&#125;,&#123;&quot;_index&quot;:&quot;twitter&quot;,&quot;_type&quot;:&quot;tweet&quot;,&quot;_id&quot;:&quot;AWu2sgI5Rw8iDPJNYgMY&quot;,&quot;_score&quot;:0.2876821,&quot;_source&quot;:&#123;</span><br><span class="line">    &quot;user&quot; : &quot;kimchy&quot;,</span><br><span class="line">    &quot;post_date&quot; : &quot;2009-11-15T14:12:12&quot;,</span><br><span class="line">    &quot;message&quot; : &quot;trying out Elasticsearch&quot;</span><br><span class="line">&#125;&#125;,&#123;&quot;_index&quot;:&quot;twitter&quot;,&quot;_type&quot;:&quot;tweet&quot;,&quot;_id&quot;:&quot;1&quot;,&quot;_score&quot;:0.2876821,&quot;_source&quot;:&#123;</span><br><span class="line">    &quot;user&quot; : &quot;kimchy&quot;,</span><br><span class="line">    &quot;post_date&quot; : &quot;2009-11-15T14:12:12&quot;,</span><br><span class="line">    &quot;message&quot; : &quot;trying out Elasticsearch&quot;</span><br><span class="line">&#125;&#125;]&#125;&#125;[elk@node003 ~]$</span><br></pre></td></tr></table></figure>
<p>查找所有索引中type为tweet的内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /_all/tweet/_search?q=tag:wow</span><br></pre></td></tr></table></figure>
<p>查找所有索引所有type</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /_search?q=tag:wow</span><br></pre></td></tr></table></figure>
<h4 id="请求体形式"><a href="#请求体形式" class="headerlink" title="请求体形式"></a>请求体形式</h4><p>除了上面的在url请求中携带参数去search，es还支持在get请求使用body的方式</p>
<p>例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET /twitter/tweet/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot; : &#123;</span><br><span class="line">        &quot;term&quot; : &#123; &quot;user&quot; : &quot;kimchy&quot; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行后的输出和上面是一致的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[elk@node003 ~]$ curl -XGET http://192.168.103.133:9500/twitter/tweet/_search -d &apos;&#123;</span><br><span class="line">    &quot;query&quot; : &#123;</span><br><span class="line">        &quot;term&quot; : &#123; &quot;user&quot; : &quot;kimchy&quot; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;&apos;</span><br><span class="line">&#123;&quot;took&quot;:48,&quot;timed_out&quot;:false,&quot;_shards&quot;:&#123;&quot;total&quot;:3,&quot;successful&quot;:3,&quot;failed&quot;:0&#125;,&quot;hits&quot;:&#123;&quot;total&quot;:3,&quot;max_score&quot;:0.2876821,&quot;hits&quot;:[&#123;&quot;_index&quot;:&quot;twitter&quot;,&quot;_type&quot;:&quot;tweet&quot;,&quot;_id&quot;:&quot;AWu2sYdrRw8iDPJNYgMX&quot;,&quot;_score&quot;:0.2876821,&quot;_source&quot;:&#123;</span><br><span class="line">    &quot;user&quot; : &quot;kimchy&quot;,</span><br><span class="line">    &quot;post_date&quot; : &quot;2009-11-15T14:12:12&quot;,</span><br><span class="line">    &quot;message&quot; : &quot;trying out Elasticsearch&quot;</span><br><span class="line">&#125;&#125;,&#123;&quot;_index&quot;:&quot;twitter&quot;,&quot;_type&quot;:&quot;tweet&quot;,&quot;_id&quot;:&quot;AWu2sgI5Rw8iDPJNYgMY&quot;,&quot;_score&quot;:0.2876821,&quot;_source&quot;:&#123;</span><br><span class="line">    &quot;user&quot; : &quot;kimchy&quot;,</span><br><span class="line">    &quot;post_date&quot; : &quot;2009-11-15T14:12:12&quot;,</span><br><span class="line">    &quot;message&quot; : &quot;trying out Elasticsearch&quot;</span><br><span class="line">&#125;&#125;,&#123;&quot;_index&quot;:&quot;twitter&quot;,&quot;_type&quot;:&quot;tweet&quot;,&quot;_id&quot;:&quot;1&quot;,&quot;_score&quot;:0.2876821,&quot;_source&quot;:&#123;</span><br><span class="line">    &quot;user&quot; : &quot;kimchy&quot;,</span><br><span class="line">    &quot;post_date&quot; : &quot;2009-11-15T14:12:12&quot;,</span><br><span class="line">    &quot;message&quot; : &quot;trying out Elasticsearch&quot;</span><br><span class="line">&#125;&#125;]&#125;&#125;[elk@node003 ~]$</span><br></pre></td></tr></table></figure>
<h4 id="count"><a href="#count" class="headerlink" title="count"></a>count</h4><p>只获取搜索结果的条数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[elk@node003 ~]$ curl http://192.168.103.133:9500/twitter/tweet/_count?q=user:kimchy</span><br><span class="line">&#123;&quot;count&quot;:3,&quot;_shards&quot;:&#123;&quot;total&quot;:3,&quot;successful&quot;:3,&quot;failed&quot;:0&#125;&#125;[elk@node003 ~]$</span><br></pre></td></tr></table></figure>
<h3 id="Cluster-api-集群api"><a href="#Cluster-api-集群api" class="headerlink" title="Cluster api-集群api"></a>Cluster api-集群api</h3><h2 id="Analyis-分词"><a href="#Analyis-分词" class="headerlink" title="Analyis-分词"></a>Analyis-分词</h2><p>在安装完插件之后，如果不确定插件的名称，可以通过这个接口查看信息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET /_nodes</span><br><span class="line"># 插件部分的内容</span><br><span class="line">      &quot;plugins&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;name&quot;: &quot;analysis-ik&quot;,</span><br><span class="line">          &quot;version&quot;: &quot;5.1.2&quot;,</span><br><span class="line">          &quot;description&quot;: &quot;IK Analyzer for Elasticsearch&quot;,</span><br><span class="line">          &quot;classname&quot;: &quot;org.elasticsearch.plugin.analysis.ik.AnalysisIkPlugin&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br></pre></td></tr></table></figure>
<h3 id="Ik分词器"><a href="#Ik分词器" class="headerlink" title="Ik分词器"></a>Ik分词器</h3><p>IK分词器，是一个针对中文的分词器。</p>
<p>IK分词器github项目地址：<a href="https://link.zhihu.com/?target=https%3A//github.com/medcl/elasticsearch-analysis-ik" target="_blank" rel="noopener">medcl/elasticsearch-analysis-ik</a></p>
<p>IK分词器有两种分词模式：ik_max_word和ik_smart模式。</p>
<ul>
<li><p>ik_max_word</p>
<p>会将文本做最细粒度的拆分，比如会将“中华人民共和国人民大会堂”拆分为“中华人民共和国、中华人民、中华、华人、人民共和国、人民、共和国、大会堂、大会、会堂等词语。</p>
</li>
<li><p>ik_smart</p>
<p>会做最粗粒度的拆分，比如会将“中华人民共和国人民大会堂”拆分为中华人民共和国、人民大会堂。</p>
</li>
</ul>
<p>测试：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST /_analyze</span><br><span class="line">&#123;&quot;text&quot;:&quot;中华人民共和国人民大会堂&quot;,&quot;analyzer&quot;:&quot;ik_smart&quot; &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">POST /_analyze</span><br><span class="line">&#123;&quot;text&quot;:&quot;中华人民共和国人民大会堂&quot;,&quot;analyzer&quot;:&quot;ik_max_word&quot; &#125;</span><br></pre></td></tr></table></figure>
<p>两种分词器使用的最佳实践是：</p>
<ul>
<li>索引时用ik_max_word</li>
<li>在搜索时用ik_smart</li>
</ul>
<p>即：索引时最大化的将文章内容分词，搜索时更精确的搜索到想要的结果。</p>
<h2 id="插件管理"><a href="#插件管理" class="headerlink" title="插件管理"></a>插件管理</h2><p>如何看es中安装了哪些插件？</p>
<p>GET _cat/plugins</p>
<h2 id="Index-Modules-索引模块"><a href="#Index-Modules-索引模块" class="headerlink" title="Index Modules-索引模块"></a>Index Modules-索引模块</h2><h3 id="slow-log"><a href="#slow-log" class="headerlink" title="slow log"></a>slow log</h3><p>slow log分为两种</p>
<ul>
<li>search slow log</li>
<li>index slow log</li>
</ul>
<p><strong>search slow log</strong></p>
<p>es支持记录分片级别的查询（包括query和fetch两个阶段）慢查询日志。</p>
<p>慢查询的阈值设置</p>
<p>在search中分为query和fetch两个部分</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">index.search.slowlog.threshold.query.warn: 10s</span><br><span class="line">index.search.slowlog.threshold.query.info: 5s</span><br><span class="line">index.search.slowlog.threshold.query.debug: 2s</span><br><span class="line">index.search.slowlog.threshold.query.trace: 500ms</span><br><span class="line"></span><br><span class="line">index.search.slowlog.threshold.fetch.warn: 1s</span><br><span class="line">index.search.slowlog.threshold.fetch.info: 800ms</span><br><span class="line">index.search.slowlog.threshold.fetch.debug: 500ms</span><br><span class="line">index.search.slowlog.threshold.fetch.trace: 200ms</span><br></pre></td></tr></table></figure>
<p>上面的这些配置可以在配置文件中指定，也可以通过接口去动态的设置</p>
<p>在默认情况下，上面这些参数没有一个是enabled的（默认值是 <code>-1</code>），提供的日志级别(<code>warn</code>, <code>info</code>, <code>debug</code>, <code>trace</code>)允许我们灵活的控制哪些级别是我们要打印输出的</p>
<p>上面这些配置并不是所有的都必须要设置。</p>
<p>上面是定义慢查询的阈值，除了这里，我们还需要再日志文件中进行配置</p>
<p>注意：日志中记录的shard级别的日志，也就是分片级别，这就意味着，这个es实例的日志可能不是一个完整的查询，而只是查询的一部分。使用这种方式的好处是可以毕竟精细的看到是哪一个节点的问题。</p>
<p>默认的日志配置（log4j2.properties）如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">appender.index_search_slowlog_rolling.type = RollingFile</span><br><span class="line">appender.index_search_slowlog_rolling.name = index_search_slowlog_rolling</span><br><span class="line">appender.index_search_slowlog_rolling.fileName = $&#123;sys:es.logs&#125;_index_search_slowlog.log</span><br><span class="line">appender.index_search_slowlog_rolling.layout.type = PatternLayout</span><br><span class="line">appender.index_search_slowlog_rolling.layout.pattern = [%d&#123;ISO8601&#125;][%-5p][%-25c] %marker%.-10000m%n</span><br><span class="line">appender.index_search_slowlog_rolling.filePattern = $&#123;sys:es.logs&#125;_index_search_slowlog-%d&#123;yyyy-MM-dd&#125;.log</span><br><span class="line">appender.index_search_slowlog_rolling.policies.type = Policies</span><br><span class="line">appender.index_search_slowlog_rolling.policies.time.type = TimeBasedTriggeringPolicy</span><br><span class="line">appender.index_search_slowlog_rolling.policies.time.interval = 1</span><br><span class="line">appender.index_search_slowlog_rolling.policies.time.modulate = true</span><br><span class="line"></span><br><span class="line">logger.index_search_slowlog_rolling.name = index.search.slowlog</span><br><span class="line">logger.index_search_slowlog_rolling.level = trace</span><br><span class="line">logger.index_search_slowlog_rolling.appenderRef.index_search_slowlog_rolling.ref = index_search_slowlog_rolling</span><br><span class="line">logger.index_search_slowlog_rolling.additivity = false</span><br></pre></td></tr></table></figure>
<p>这里的配置根据版本的不同可能会不同</p>
<p><strong>index low log</strong></p>
<p>Indexing slow log的相关内容和上面的类似，文件名称也是以_index_indexing_slowlog.log结尾</p>
<p>阈值的配置如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">index.indexing.slowlog.threshold.index.warn: 10s</span><br><span class="line">index.indexing.slowlog.threshold.index.info: 5s</span><br><span class="line">index.indexing.slowlog.threshold.index.debug: 2s</span><br><span class="line">index.indexing.slowlog.threshold.index.trace: 500ms</span><br><span class="line">index.indexing.slowlog.level: info</span><br><span class="line">index.indexing.slowlog.source: 1000</span><br></pre></td></tr></table></figure>
<p>这些配置也是一样，可以在配置文件中设置，也可以通过接口进行设置。</p>
<p>注意：</p>
<ul>
<li>在默认情况下，es将只会把 _source 中的前1000个字符输出到日志文件中。如果有额外的需求，我们可以通过接口去进行设置。如果设置为false或者0，那么es将会忽略整个<code>source</code>。如果设置为true，那么将会无视size的限制。</li>
<li>最原始状态的<code>_source</code>将会被重新格式化，以便能够输出为单行的格式。如果document的格式非常重要，不能被重新格式化，那么我们可以将index.indexing.slowlog.reformat设置为false。</li>
</ul>
<p>同样的，我们也需要在日志文件中进行设置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">appender.index_indexing_slowlog_rolling.type = RollingFile</span><br><span class="line">appender.index_indexing_slowlog_rolling.name = index_indexing_slowlog_rolling</span><br><span class="line">appender.index_indexing_slowlog_rolling.fileName = $&#123;sys:es.logs&#125;_index_indexing_slowlog.log</span><br><span class="line">appender.index_indexing_slowlog_rolling.layout.type = PatternLayout</span><br><span class="line">appender.index_indexing_slowlog_rolling.layout.pattern = [%d&#123;ISO8601&#125;][%-5p][%-25c] %marker%.10000m%n</span><br><span class="line">appender.index_indexing_slowlog_rolling.filePattern = $&#123;sys:es.logs&#125;_index_indexing_slowlog-%d&#123;yyyy-MM-dd&#125;.log</span><br><span class="line">appender.index_indexing_slowlog_rolling.policies.type = Policies</span><br><span class="line">appender.index_indexing_slowlog_rolling.policies.time.type = TimeBasedTriggeringPolicy</span><br><span class="line">appender.index_indexing_slowlog_rolling.policies.time.interval = 1</span><br><span class="line">appender.index_indexing_slowlog_rolling.policies.time.modulate = true</span><br><span class="line"></span><br><span class="line">logger.index_indexing_slowlog.name = index.indexing.slowlog.index</span><br><span class="line">logger.index_indexing_slowlog.level = trace</span><br><span class="line">logger.index_indexing_slowlog.appenderRef.index_indexing_slowlog_rolling.ref = index_indexing_slowlog_rolling</span><br><span class="line">logger.index_indexing_slowlog.additivity = false</span><br></pre></td></tr></table></figure>
<p>这里的配置根据版本的不同可能会不同</p>
<h3 id="slow-log实际案例"><a href="#slow-log实际案例" class="headerlink" title="slow log实际案例"></a>slow log实际案例</h3><p>我们可以通过api去动态的调整</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PUT /my_index/_settings</span><br><span class="line">&#123;</span><br><span class="line">    &quot;index.search.slowlog.threshold.query.warn&quot; : &quot;10s&quot;, </span><br><span class="line">    &quot;index.search.slowlog.threshold.fetch.debug&quot;: &quot;500ms&quot;, </span><br><span class="line">    &quot;index.indexing.slowlog.threshold.index.info&quot;: &quot;5s&quot; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里设置的是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">查询慢于 10 秒输出一个 WARN 日志。</span><br><span class="line">获取慢于 500 毫秒输出一个 DEBUG 日志。</span><br><span class="line">索引慢于 5 秒输出一个 INFO 日志。</span><br></pre></td></tr></table></figure>
<p>实际案例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">PUT testindex/_settings</span><br><span class="line">&#123;</span><br><span class="line">    &quot;index.search.slowlog.threshold.query.info&quot; : &quot;200ms&quot;, </span><br><span class="line">    &quot;index.search.slowlog.threshold.query.warn&quot; : &quot;500ms&quot;,</span><br><span class="line">    &quot;index.search.slowlog.threshold.fetch.info&quot;: &quot;200ms&quot;, </span><br><span class="line">    &quot;index.search.slowlog.threshold.fetch.warn&quot;: &quot;500ms&quot;, </span><br><span class="line">    &quot;index.indexing.slowlog.threshold.index.info&quot;: &quot;800ms&quot;,</span><br><span class="line">    &quot;index.indexing.slowlog.threshold.index.warn&quot;: &quot;1s&quot; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="查询DSL"><a href="#查询DSL" class="headerlink" title="查询DSL"></a>查询DSL</h2><h3 id="查询语句以及过滤语句"><a href="#查询语句以及过滤语句" class="headerlink" title="查询语句以及过滤语句"></a>查询语句以及过滤语句</h3><p>查询语句的处理行为取决于这个语句是在查询上下文中还是在过滤上下文中</p>
<p>两个的匹配级别不一样</p>
<ul>
<li><strong>Query context</strong>：关注于document和查询语句的匹配程度，也就是说目的是匹配出document</li>
<li><strong>Filter context</strong>：关注于document中的一些字段的过滤，例如过滤出document之后，过滤status字段为<em>published</em>的、<em>timestamp</em>字段的范围在2015到2016之间的</li>
</ul>
<p>案例:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">GET /_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123; </span><br><span class="line">    &quot;bool&quot;: &#123; </span><br><span class="line">      &quot;must&quot;: [</span><br><span class="line">        &#123; &quot;match&quot;: &#123; &quot;title&quot;:   &quot;Search&quot;        &#125;&#125;, </span><br><span class="line">        &#123; &quot;match&quot;: &#123; &quot;content&quot;: &quot;Elasticsearch&quot; &#125;&#125;  </span><br><span class="line">      ],</span><br><span class="line">      &quot;filter&quot;: [ </span><br><span class="line">        &#123; &quot;term&quot;:  &#123; &quot;status&quot;: &quot;published&quot; &#125;&#125;, </span><br><span class="line">        &#123; &quot;range&quot;: &#123; &quot;publish_date&quot;: &#123; &quot;gte&quot;: &quot;2015-01-01&quot; &#125;&#125;&#125; </span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="full-text-query-全文查询"><a href="#full-text-query-全文查询" class="headerlink" title="full-text query-全文查询"></a>full-text query-全文查询</h3><h3 id="Term-Query-术语查询"><a href="#Term-Query-术语查询" class="headerlink" title="Term Query-术语查询"></a>Term Query-术语查询</h3><p>term 查询可以包含指定术语的document</p>
<p>例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST _search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;term&quot; : &#123; &quot;user&quot; : &quot;Kimchy&quot; &#125; </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在查询的时候可以给查询添加添加优先级，也就是紧急程度：boost字段</p>
<p>例如:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">GET _search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;should&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;term&quot;: &#123;</span><br><span class="line">            &quot;status&quot;: &#123;</span><br><span class="line">              &quot;value&quot;: &quot;urgent&quot;,</span><br><span class="line">              &quot;boost&quot;: 2.0 </span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;term&quot;: &#123;</span><br><span class="line">            &quot;status&quot;: &quot;normal&quot; </span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>默认语句的boost值为1.0</p>
<p>注意: </p>
<blockquote>
<p>在es中，在进行查询的时候，会把text类型的字段进行分割，例如：</p>
<p>“Quick Brown Fox!” 会被切割成术语：[<code>quick</code>, <code>brown</code>, <code>fox</code>]</p>
<p>因此，在进行term查询的时候，使用完整的字符串是查不到东西的</p>
</blockquote>
<p>例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"># 生成数据</span><br><span class="line">PUT my_index</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;my_type&quot;: &#123;</span><br><span class="line">      &quot;properties&quot;: &#123;</span><br><span class="line">        &quot;full_text&quot;: &#123;</span><br><span class="line">          &quot;type&quot;:  &quot;text&quot; </span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;exact_value&quot;: &#123;</span><br><span class="line">          &quot;type&quot;:  &quot;keyword&quot; </span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT my_index/my_type/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;full_text&quot;:   &quot;Quick Foxes!&quot;, </span><br><span class="line">  &quot;exact_value&quot;: &quot;Quick Foxes!&quot;  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">查询数据</span><br><span class="line"></span><br><span class="line"># 查询成功</span><br><span class="line">GET my_index/my_type/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;term&quot;: &#123;</span><br><span class="line">      &quot;exact_value&quot;: &quot;Quick Foxes!&quot; </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 查询失败</span><br><span class="line">GET my_index/my_type/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;term&quot;: &#123;</span><br><span class="line">      &quot;full_text&quot;: &quot;Quick Foxes!&quot; </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 查询成功</span><br><span class="line">GET my_index/my_type/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;term&quot;: &#123;</span><br><span class="line">      &quot;full_text&quot;: &quot;foxes&quot; </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 查询成功</span><br><span class="line">GET my_index/my_type/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;full_text&quot;: &quot;Quick Foxes!&quot; </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意：match查询方式的处理逻辑和term的方式是不一样的,match是属于全文查询级别。</p>
<h2 id="批处理-Batch-Processing"><a href="#批处理-Batch-Processing" class="headerlink" title="批处理-Batch Processing"></a>批处理-Batch Processing</h2><p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.1/_batch_processing.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/5.1/_batch_processing.html</a></p>
<p>ES的批处理主要使用bulk api来实现。</p>
<h2 id="Modules-ES组件"><a href="#Modules-ES组件" class="headerlink" title="Modules-ES组件"></a>Modules-ES组件</h2><h3 id="node"><a href="#node" class="headerlink" title="node"></a>node</h3><p>集群中的每一个节点都能感知到其他节点，并且，在收到请求之后，能够转发请求到对应的node节点上。</p>
<p><strong>master node-主节点</strong></p>
<p>主节点主要用于集群的控制以及元数据的处理，例如索引的新增、删除、分片的分配信息等等</p>
<ul>
<li>创建或删除索引</li>
<li>跟踪哪些节点是集群的一部分</li>
<li>决定要分配给哪些节点哪些分片</li>
</ul>
<p>配置为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">node.master=true</span><br><span class="line">node.data=false</span><br><span class="line">node.ingest=false</span><br></pre></td></tr></table></figure>
<p>注意：</p>
<ul>
<li>虽然有多个节点开启了这个配置，但是一个集群只有一个主节点，其他的都是master候选节点</li>
</ul>
<p><strong>data node-数据节点</strong></p>
<p>数据节点保存数据(索引)分片，它负责数据相关操作，涉及：</p>
<ul>
<li><p>CRUD，以及搜索和聚合</p>
</li>
<li><p>因此，数据节点的CPU、内存、IO以及存储资源都消耗</p>
</li>
<li>如果数据节点的资源负载过高，则需要添加数据节点</li>
</ul>
<p>配置为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">node.master=false</span><br><span class="line">node.data=true</span><br><span class="line">node.ingest=false</span><br></pre></td></tr></table></figure>
<p><strong>client node-路由节点</strong></p>
<p>可以看做是一个负载均衡器，负责：</p>
<ul>
<li>处理路由请求</li>
<li>处理搜索聚合节点</li>
<li>分发批量索引请求</li>
</ul>
<p>设置为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">node.master=false</span><br><span class="line">node.data=false</span><br><span class="line">node.ingest=false</span><br></pre></td></tr></table></figure>
<p>如果es集群不是规模很大的话，我们一般不设置client节点，使用master提供类似的功能即可。</p>
<h3 id="线程池-Thread-Pool"><a href="#线程池-Thread-Pool" class="headerlink" title="线程池-Thread Pool"></a>线程池-Thread Pool</h3><p>es中，定义了许多种类的线程池，为的是更好的控制线程的内存消耗</p>
<p>注意：</p>
<ul>
<li><p>所有的线程池都会队列的方式，这将允许在线程池满了之后，之后的请求将会排队，而不是直接被丢弃。</p>
</li>
<li><p>线程池类型分类固定的数值的（fixed），可以自行动态调整的(也就是说有上下限)（scaling）</p>
</li>
<li>进程数量（available_processors）一般会自动识别，上限为32个，也就是在超过32核的机器上，最多使用32个进程。有这个限制的原因是防止产生太多的线程，如果你修改系统的ulimit上限，那么可以手动调整这个上限。可以使用node的api去check具体的进程数量</li>
</ul>
<p>固定数值的配置案例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">thread_pool:</span><br><span class="line">    index:</span><br><span class="line">        size: 30</span><br><span class="line">        queue_size: 1000</span><br></pre></td></tr></table></figure>
<p>注意：当queue_size设置为-1的时候，就意味着关闭队列功能，当线程池满了之后，后面来的请求都会被丢弃</p>
<p>弹性数值的配置案例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">thread_pool:</span><br><span class="line">    warmer:</span><br><span class="line">        core: 1</span><br><span class="line">        max: 8</span><br><span class="line">        keep_alive: 2m</span><br></pre></td></tr></table></figure>
<p>工作线程数量的范围是：core-max。keep_alive的作用是：当多长时间线程池没有任务后，不保持可用的工作线程</p>
<p>进程数量设置，如果需要手动指定，可以使用下列的配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">processors: 2</span><br></pre></td></tr></table></figure>
<p>目前有以下这些种类的线程池</p>
<ul>
<li><p>generic</p>
<p>可动态调整类型</p>
<p>通用操作，例如：用于后台的node发现</p>
</li>
<li><p>index</p>
<p>固定类型</p>
<p>用于索引的新增删除操作，size的数量是进程数量(available processors)，最大的数量是<code>1 + # of available processors</code>.队列长度queue_size默认为200</p>
</li>
<li><p>search </p>
<p>固定类型。</p>
<p>用于统计、检索等操作，默认配置值为：int((# of available_processors * 3) / 2) + 1，队列长度默认为1000。</p>
</li>
<li><p>下面还有很多略，看文档</p>
</li>
</ul>
<h3 id="zen-discovery-集群发现过程"><a href="#zen-discovery-集群发现过程" class="headerlink" title="zen discovery-集群发现过程"></a>zen discovery-集群发现过程</h3><p>暂时略</p>
<h2 id="ES的Merge功能"><a href="#ES的Merge功能" class="headerlink" title="ES的Merge功能"></a>ES的Merge功能</h2><p>参考链接：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/6.5/index-modules-merge.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/6.5/index-modules-merge.html</a></p>
<h3 id="基本概念："><a href="#基本概念：" class="headerlink" title="基本概念："></a>基本概念：</h3><p>ES中的shard分片，其实是lucene中的index索引。在lucene中，每一个index都会被分解成segments段，segments是index内部的基本存储单元</p>
<p>一些比较小的segment会被周期性的merge（合并）成为一个比较大的segment，为的是保持index的大小在一个稳定的范围，在合并之后将会删除这些小segment</p>
<p>segment是lucene索引的一种存储结构，每个segment都是一部分数据的完整索引，它是lucene每次flush或merge时候形成。每次flush就是将内存中的索引写出一个独立segment的过程。所以随着数据的不断增加，会形成越来越多的segment。因为segment是不可变的，删除操作不会改变segment内部数据，只是会在另外的地方记录某些数据删除，这样可能会导致segment中存在大量无用数据。搜索时，每个segment都需要一个reader来读取里面的数据，大量的segment会严重影响搜索效率。而merge过程，会将小的segment写到一起形成一个大的segment，减少其数量。同时重写过程会抛弃那些已经删除的数据。因此segment的merge是有利于查询效率的。</p>
<p>总结：大量的分段留在Lucene索引里面，意味着较慢的搜索和占用更多的内存。分段合并设计用来减少分段数量，但是合并动作是非常昂贵的，尤其是在低IO环境中，可能会受到存储性能上的限制。</p>
<h3 id="merge-scheduling"><a href="#merge-scheduling" class="headerlink" title="merge scheduling"></a>merge scheduling</h3><p>merge scheduler（并行调度方式）控制了我们在什么时候需要去执行merge操作。</p>
<p>merge使用单独的线程去实现，当到达了设定的最大线程数，余下到来的merge任务将会排队等候。</p>
<p>merge scheduler可以按照下面的这种方式进行动态的设置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">index.merge.scheduler.max_thread_count</span><br></pre></td></tr></table></figure>
<p>elasticsearch的merge其实就是lucene的merge机制。merge过程是lucene有一个后台线程，它会根据merge策略来决定是否进行merge，一旦merge的条件满足，就会启动后台merge。merge策略分为两种，这也是大多数大数据框架所采用的，segment的大小和segment中doc的数量。以这两个标准为基础实现了三种merge策略：TieredMergePolicy、LogDocMergePolicy 及LogByteSizeMergePolicy。elasticsearch这一部分就是对这三种合并策略的封装，并提供了对于的配置。</p>
<h3 id="forcemerge"><a href="#forcemerge" class="headerlink" title="forcemerge"></a>forcemerge</h3><p>参考链接：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/6.5/indices-forcemerge.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/6.5/indices-forcemerge.html</a></p>
<p>调用接口：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">POST /twitter/_forcemerge</span><br></pre></td></tr></table></figure>
<h3 id="merge优化"><a href="#merge优化" class="headerlink" title="merge优化"></a>merge优化</h3><p>merge的优化可以是整个集群的调整，也可以是某些索引的调整，一般建议是索引级别。</p>
<p>merge操作是一个很消耗性能的过程，特别是对于磁盘的IO</p>
<p>因为如果有某个节点的io出现问题时，通过热线程定位，发现是merge导致的时，可以针对当前比较大的索引，修改一下merge相关的配置。</p>
<h2 id="ES数据查询"><a href="#ES数据查询" class="headerlink" title="ES数据查询"></a>ES数据查询</h2><h3 id="routing参数"><a href="#routing参数" class="headerlink" title="routing参数"></a>routing参数</h3><p>在将document写入到es中的时候，默认的路由算法规则是根据document的id。</p>
<p>但是我们可以指定某个字段为路由值，确保这些doc分布在同一个shard上。</p>
<p>使用自定义路由规则的作用：</p>
<p>我们知道，正常的一次查询(search)，请求会被发给所有<code>shard</code>(不考虑副本)，然后等所有<code>shard</code>返回，再将结果聚合，返回给调用方。如果我们事先已经知道数据可能分布在哪些shard上，那么就可以减少不必要的请求。</p>
<p>参考链接：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.1/search.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/5.1/search.html</a></p>
<p>示例：</p>
<p>插入数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST /twitter/tweet?routing=kimchy</span><br><span class="line">&#123;</span><br><span class="line">    &quot;user&quot; : &quot;kimchy&quot;,</span><br><span class="line">    &quot;postDate&quot; : &quot;2009-11-15T14:12:12&quot;,</span><br><span class="line">    &quot;message&quot; : &quot;trying out Elasticsearch&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>检索数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">POST /twitter/tweet/_search?routing=kimchy</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;bool&quot; : &#123;</span><br><span class="line">            &quot;must&quot; : &#123;</span><br><span class="line">                &quot;query_string&quot; : &#123;</span><br><span class="line">                    &quot;query&quot; : &quot;some query string here&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;filter&quot; : &#123;</span><br><span class="line">                &quot;term&quot; : &#123; &quot;user&quot; : &quot;kimchy&quot; &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="search"><a href="#search" class="headerlink" title="search"></a>search</h3><p>The query can either be provided using a simple <a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.1/search-uri-request.html" target="_blank" rel="noopener">query string as a parameter</a>, or using a<a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.1/search-request-body.html" target="_blank" rel="noopener">request body</a>.</p>
<p>使用search api有2种方式，一种是把查询字符串作为URI参数传入，一种是在请求体中嵌入查询语句</p>
<h4 id="多索引及多type操作"><a href="#多索引及多type操作" class="headerlink" title="多索引及多type操作"></a>多索引及多type操作</h4><p>search api支持操作多个索引以及多个type</p>
<p>例如：</p>
<ul>
<li><p>在所有的type中检索数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /twitter/_search?q=user:kimchy</span><br></pre></td></tr></table></figure>
</li>
<li><p>index确定，type多个</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /twitter/tweet,user/_search?q=user:kimchy</span><br></pre></td></tr></table></figure>
</li>
<li><p>type确定，索引多个(这里的type是tweet)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GET /kimchy,elasticsearch/tweet/_search?q=tag:wow</span><br><span class="line"></span><br><span class="line">或者所有的index</span><br><span class="line">GET /_all/tweet/_search?q=tag:wow</span><br></pre></td></tr></table></figure>
</li>
<li><p>在所有的index和type下搜索</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /_search?q=tag:wow</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>注意：默认情况下，es拒绝超过涉及1000个shard的search请求，因为这么大的请求，会非常消耗coordinating node的cpu、内存等资源</p>
<p>当然，这个1000的值也是可以调整的，在cluster setting中，使用action.search.shard_count.limit参数。</p>
<h4 id="URI-search"><a href="#URI-search" class="headerlink" title="URI search"></a>URI search</h4><p>格式例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET twitter/tweet/_search?q=user:kimchy</span><br></pre></td></tr></table></figure>
<p>参数说明：</p>
<p>The parameters allowed in the URI are:</p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>q</code></td>
<td>The query string (maps to the <code>query_string</code> query, see <a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.1/query-dsl-query-string-query.html" target="_blank" rel="noopener"><em>Query String Query</em></a>for more details).</td>
</tr>
<tr>
<td><code>df</code></td>
<td>The default field to use when no field prefix is defined within the query.</td>
</tr>
<tr>
<td><code>analyzer</code></td>
<td>The analyzer name to be used when analyzing the query string.</td>
</tr>
<tr>
<td><code>analyze_wildcard</code></td>
<td>Should wildcard and prefix queries be analyzed or not. Defaults to <code>false</code>.</td>
</tr>
<tr>
<td><code>default_operator</code></td>
<td>The default operator to be used, can be <code>AND</code> or <code>OR</code>. Defaults to <code>OR</code>.</td>
</tr>
<tr>
<td><code>lenient</code></td>
<td>If set to true will cause format based failures (like providing text to a numeric field) to be ignored. Defaults to false.</td>
</tr>
<tr>
<td><code>explain</code></td>
<td>For each hit, contain an explanation of how scoring of the hits was computed.</td>
</tr>
<tr>
<td><code>_source</code></td>
<td>Set to <code>false</code> to disable retrieval of the <code>_source</code> field. You can also retrieve part of the document by using <code>_source_include</code> &amp; <code>_source_exclude</code> (see the <a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.1/search-request-source-filtering.html" target="_blank" rel="noopener">request body</a> documentation for more details)</td>
</tr>
<tr>
<td><code>stored_fields</code></td>
<td>The selective stored fields of the document to return for each hit, comma delimited. Not specifying any value will cause no fields to return.</td>
</tr>
<tr>
<td><code>sort</code></td>
<td>Sorting to perform. Can either be in the form of <code>fieldName</code>, or<code>fieldName:asc</code>/<code>fieldName:desc</code>. The fieldName can either be an actual field within the document, or the special <code>_score</code> name to indicate sorting based on scores. There can be several <code>sort</code> parameters (order is important).</td>
</tr>
<tr>
<td><code>track_scores</code></td>
<td>When sorting, set to <code>true</code> in order to still track scores and return them as part of each hit.</td>
</tr>
<tr>
<td><code>timeout</code></td>
<td>A search timeout, bounding the search request to be executed within the specified time value and bail with the hits accumulated up to that point when expired. Defaults to no timeout.</td>
</tr>
<tr>
<td><code>terminate_after</code></td>
<td>The maximum number of documents to collect for each shard, upon reaching which the query execution will terminate early. If set, the response will have a boolean field <code>terminated_early</code> to indicate whether the query execution has actually terminated_early. Defaults to no terminate_after.</td>
</tr>
<tr>
<td><code>from</code></td>
<td>The starting from index of the hits to return. Defaults to <code>0</code>.</td>
</tr>
<tr>
<td><code>size</code></td>
<td>The number of hits to return. Defaults to <code>10</code>.</td>
</tr>
<tr>
<td><code>search_type</code></td>
<td>The type of the search operation to perform. Can be<code>dfs_query_then_fetch</code> or <code>query_then_fetch</code>. Defaults to <code>query_then_fetch</code>. See <a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.1/search-request-search-type.html" target="_blank" rel="noopener"><em>Search Type</em></a> for more details on the different types of search that can be performed.</td>
</tr>
</tbody>
</table>
<h4 id="Request-body-search"><a href="#Request-body-search" class="headerlink" title="Request body search"></a>Request body search</h4><p>同样的，我们也可以使用在请求体中嵌入<strong>查询语句</strong>的方式来查询数据。</p>
<p>格式例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET /twitter/tweet/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot; : &#123;</span><br><span class="line">        &quot;term&quot; : &#123; &quot;user&quot; : &quot;kimchy&quot; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>支持下面这些参数</p>
<table>
<thead>
<tr>
<th><code>timeout</code></th>
<th>A search timeout, bounding the search request to be executed within the specified time value and bail with the hits accumulated up to that point when expired. Defaults to no timeout. See <a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.1/common-options.html#time-units" target="_blank" rel="noopener">Time units</a>.</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>from</code></td>
<td>To retrieve hits from a certain offset. Defaults to <code>0</code>.</td>
</tr>
<tr>
<td><code>size</code></td>
<td>The number of hits to return. Defaults to <code>10</code>. If you do not care about getting some hits back but only about the number of matches and/or aggregations, setting the value to <code>0</code> will help performance.</td>
</tr>
<tr>
<td><code>search_type</code></td>
<td>The type of the search operation to perform. Can be <code>dfs_query_then_fetch</code>or <code>query_then_fetch</code>. Defaults to <code>query_then_fetch</code>. See <a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.1/search-request-search-type.html" target="_blank" rel="noopener"><em>Search Type</em></a> for more.</td>
</tr>
<tr>
<td><code>request_cache</code></td>
<td>Set to <code>true</code> or <code>false</code> to enable or disable the caching of search results for requests where <code>size</code> is 0, ie aggregations and suggestions (no top hits returned). See <a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.1/shard-request-cache.html" target="_blank" rel="noopener">Shard request cache</a>.</td>
</tr>
<tr>
<td><code>terminate_after</code></td>
<td>The maximum number of documents to collect for each shard, upon reaching which the query execution will terminate early. If set, the response will have a boolean field <code>terminated_early</code> to indicate whether the query execution has actually terminated_early. Defaults to no terminate_after.</td>
</tr>
</tbody>
</table>
<p>注意：</p>
<ul>
<li><p>Both HTTP GET and HTTP POST can be used to execute search with body. Since not all clients support GET with body, POST is allowed as well.</p>
<p>也就是说，es接受HTTP的GET请求和POST请求携带这些参数。但是有些客户端不支持在使用GET时携带参数，那么可以使用POST</p>
</li>
<li><p>当我们仅仅需要知道是否有doc匹配，而不用关注具体的数据和数量时，为了加快检索速度，我们可以使用这些参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /_search?q=message:elasticsearch&amp;size=0&amp;terminate_after=1</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h5 id="From-size"><a href="#From-size" class="headerlink" title="From/size"></a>From/size</h5><p>我们可以结合使用from和size参数，来控制输出结果分页显示。</p>
<p>from控制开始显示的偏移量，size控制一次输出/读取的记录条数</p>
<p>from的默认值为0，size的默认值为10</p>
<p>from和size参数可以设置到URI中，也可以设置在request body中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">GET /_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;from&quot; : 0, &quot;size&quot; : 10,</span><br><span class="line">    &quot;query&quot; : &#123;</span><br><span class="line">        &quot;term&quot; : &#123; &quot;user&quot; : &quot;kimchy&quot; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意：</p>
<p><code>from</code> + <code>size</code> can not be more than the <code>index.max_result_window</code> index setting which defaults to 10,000. See the <a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.1/search-request-scroll.html" target="_blank" rel="noopener">Scroll</a> or <a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.1/search-request-search-after.html" target="_blank" rel="noopener">Search After</a> API for more efficient ways to do deep scrolling.</p>
<h5 id="sort"><a href="#sort" class="headerlink" title="sort"></a>sort</h5><p>sort允许我们从doc中获取我们指定的一些字段数据，并且还可以根据这些字段进行排序输出</p>
<p>例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">GET /nginx_count/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;sort&quot; : [</span><br><span class="line">        &#123; &quot;timestamp&quot; : &#123;&quot;order&quot; : &quot;asc&quot;&#125;&#125;,</span><br><span class="line">        &quot;city&quot;,</span><br><span class="line">        &#123; &quot;isp&quot; : &quot;desc&quot; &#125;,</span><br><span class="line">        &#123; &quot;province&quot; : &quot;desc&quot; &#125;,</span><br><span class="line">        &quot;_score&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;query&quot; : &#123;</span><br><span class="line">        &quot;term&quot; : &#123; &quot;count&quot; : 23  &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行后的输出是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;took&quot;: 15,</span><br><span class="line">  &quot;timed_out&quot;: false,</span><br><span class="line">  &quot;_shards&quot;: &#123;</span><br><span class="line">    &quot;total&quot;: 1,</span><br><span class="line">    &quot;successful&quot;: 1,</span><br><span class="line">    &quot;failed&quot;: 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;hits&quot;: &#123;</span><br><span class="line">    &quot;total&quot;: 268,</span><br><span class="line">    &quot;max_score&quot;: null,</span><br><span class="line">    &quot;hits&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;_index&quot;: &quot;nginx_count&quot;,</span><br><span class="line">        &quot;_type&quot;: &quot;doc&quot;,</span><br><span class="line">        &quot;_id&quot;: &quot;299&quot;,</span><br><span class="line">        &quot;_score&quot;: 1,</span><br><span class="line">        &quot;_source&quot;: &#123;</span><br><span class="line">          &quot;city&quot;: &quot;赣州市&quot;,</span><br><span class="line">          &quot;count&quot;: 23,</span><br><span class="line">          &quot;isp&quot;: &quot;移动&quot;,</span><br><span class="line">          &quot;province&quot;: &quot;江西省&quot;,</span><br><span class="line">          &quot;timestamp&quot;: 1567146209783,</span><br><span class="line">          &quot;domain&quot;: &quot;ops.nidianwo.com&quot;,</span><br><span class="line">          &quot;aliyun&quot;: 700,</span><br><span class="line">          &quot;shanghai&quot;: 900,</span><br><span class="line">          &quot;binjiang&quot;: 100</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;sort&quot;: [</span><br><span class="line">          1567146209783,</span><br><span class="line">          &quot;赣州市&quot;,</span><br><span class="line">          &quot;移动&quot;,</span><br><span class="line">          &quot;江西省&quot;,</span><br><span class="line">          1</span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      ......下面省略</span><br></pre></td></tr></table></figure>
<p>说明：</p>
<blockquote>
<p>在这里，获取timestamp、city、isp、province这4个信息，并且对匹配到的doc，再根据timestamp进行正向排序（也就是从小到大）</p>
</blockquote>
<h5 id="source-filtering"><a href="#source-filtering" class="headerlink" title="_source filtering"></a>_source filtering</h5><p>我们还可以对要输出的内容进行过滤</p>
<p>例如：</p>
<p>不输出所有的doc内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">GET /_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;_source&quot;: false,</span><br><span class="line">    &quot;query&quot; : &#123;</span><br><span class="line">        &quot;term&quot; : &#123; &quot;user&quot; : &quot;kimchy&quot; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>或者只输出匹配的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">GET /_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;_source&quot;: &quot;obj.*&quot;,</span><br><span class="line">    &quot;query&quot; : &#123;</span><br><span class="line">        &quot;term&quot; : &#123; &quot;user&quot; : &quot;kimchy&quot; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">或者</span><br><span class="line"></span><br><span class="line">GET /_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;_source&quot;: [ &quot;obj1.*&quot;, &quot;obj2.*&quot; ],</span><br><span class="line">    &quot;query&quot; : &#123;</span><br><span class="line">        &quot;term&quot; : &#123; &quot;user&quot; : &quot;kimchy&quot; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>还可以编写过滤条件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET /_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;_source&quot;: &#123;</span><br><span class="line">        &quot;includes&quot;: [ &quot;obj1.*&quot;, &quot;obj2.*&quot; ],</span><br><span class="line">        &quot;excludes&quot;: [ &quot;*.description&quot; ]</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;query&quot; : &#123;</span><br><span class="line">        &quot;term&quot; : &#123; &quot;user&quot; : &quot;kimchy&quot; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="search-template"><a href="#search-template" class="headerlink" title="search template"></a>search template</h4><p>链接：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.1/search-template.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/5.1/search-template.html</a></p>
<h3 id="DSL-查询语句"><a href="#DSL-查询语句" class="headerlink" title="DSL-查询语句"></a>DSL-查询语句</h3><p>ES提供了一个完整的基于json的查询DSL。</p>
<p>DSL主要分为两类：</p>
<ul>
<li>子句查询。查询条件是某个具体字段的具体的值。有match、term、range等</li>
<li>复合查询子句</li>
</ul>
<h4 id="score"><a href="#score" class="headerlink" title="_score"></a>_score</h4><p> 使用ES时，对于查询出的文档无疑会有文档相似度之别。而理想的排序是和查询条件相关性越高排序越靠前，而这个排序的依据就是<code>_score</code>。本文就是详解<code>_score</code>有关的信息，希望能对排序评分的理解有所帮助。</p>
<h4 id="query-and-filter-context"><a href="#query-and-filter-context" class="headerlink" title="query and filter context"></a>query and filter context</h4><p>DSL在两种不用的使用场景下，又具有不同的特性</p>
<p><strong>query context</strong></p>
<p>在这种模式下，es思考的问题是：“doc和这个查询子句的匹配程度如何？“</p>
<p>注意：是匹配程度</p>
<p>这个功能，通常用来获取数据</p>
<p><strong>filter context</strong></p>
<p>在这种模式下，es思考的问题是：”这个doc是否匹配这个查询子句”</p>
<p>注意：这个的答案是非常简单的：yes or no。不涉及其他的计算任务</p>
<p>这个功能，通常用来过滤数据</p>
<p>案例分析：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">GET /_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123; </span><br><span class="line">    &quot;bool&quot;: &#123; </span><br><span class="line">      &quot;must&quot;: [</span><br><span class="line">        &#123; &quot;match&quot;: &#123; &quot;title&quot;:   &quot;Search&quot;        &#125;&#125;, </span><br><span class="line">        &#123; &quot;match&quot;: &#123; &quot;content&quot;: &quot;Elasticsearch&quot; &#125;&#125;  </span><br><span class="line">      ],</span><br><span class="line">      &quot;filter&quot;: [ </span><br><span class="line">        &#123; &quot;term&quot;:  &#123; &quot;status&quot;: &quot;published&quot; &#125;&#125;, </span><br><span class="line">        &#123; &quot;range&quot;: &#123; &quot;publish_date&quot;: &#123; &quot;gte&quot;: &quot;2015-01-01&quot; &#125;&#125;&#125; </span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>说明：</p>
<ul>
<li>The <code>query</code> parameter indicates query context.</li>
<li>The <code>bool</code> and two <code>match</code> clauses are used in query context, which means that they are </li>
<li>used to score how well each document matches.</li>
<li>The <code>filter</code> parameter indicates filter context.</li>
<li>The <code>term</code> and <code>range</code> clauses are used in filter context. They will filter out documents </li>
<li>which do not match, but they will not affect the score for matching documents.</li>
</ul>
<h4 id="match-all-query"><a href="#match-all-query" class="headerlink" title="match all query"></a>match all query</h4><p>匹配所有的doc</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET /_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这个基础上，我们可以添加_score参数（默认是1.0）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET /_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;match_all&quot;: &#123; &quot;boost&quot; : 1.2 &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不匹配所有的doc</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET /_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;match_none&quot;: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="full-text-queries-text数据类型的全文内容检索"><a href="#full-text-queries-text数据类型的全文内容检索" class="headerlink" title="full text queries-text数据类型的全文内容检索"></a>full text queries-text数据类型的全文内容检索</h4><p>用于字段类型是text的信息，like the body of an email.</p>
<p>针对这种内容，我们还需要指定字段的分析器analyzer。</p>
<h5 id="match-query"><a href="#match-query" class="headerlink" title="match query"></a>match query</h5><p>参考链接：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.1/query-dsl-match-query.html#query-dsl-match-query-boolean" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/5.1/query-dsl-match-query.html#query-dsl-match-query-boolean</a></p>
<p><code>match</code> queries accept text/numerics/dates, analyzes them, and constructs a query. </p>
<p>例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET /_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;match&quot; : &#123;</span><br><span class="line">            &quot;message&quot; : &quot;this is a test&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>说明：</p>
<p>The <code>match</code> query is of type <code>boolean</code>. It means that the text provided is analyzed and the analysis process constructs a boolean query from the provided text. The <code>operator</code> flag can be set to <code>or</code> or <code>and</code> to control the boolean clauses (defaults to <code>or</code>). The minimum number of optional <code>should</code> clauses to match can be set using the <a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.1/query-dsl-minimum-should-match.html" target="_blank" rel="noopener"><code>minimum_should_match</code></a> parameter.</p>
<p>The <code>analyzer</code> can be set to control which analyzer will perform the analysis process on the text. It defaults to the field explicit mapping definition, or the default search analyzer.</p>
<p>The <code>lenient</code> parameter can be set to <code>true</code> to ignore exceptions caused by data-type mismatches, such as trying to query a numeric field with a text query string. Defaults to <code>false</code>.</p>
<p>深入案例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">GET /_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;match&quot; : &#123;</span><br><span class="line">            &quot;message&quot; : &#123;</span><br><span class="line">                &quot;query&quot; : &quot;to be or not to be&quot;,</span><br><span class="line">                &quot;operator&quot; : &quot;and&quot;,</span><br><span class="line">                &quot;zero_terms_query&quot;: &quot;all&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="multi-match-query"><a href="#multi-match-query" class="headerlink" title="multi match query"></a>multi match query</h5><p>The <code>multi_match</code> query builds on the <a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.1/query-dsl-match-query.html" target="_blank" rel="noopener"><code>match</code> query</a> to allow multi-field queries:</p>
<p>这种方式支持在多个字段中进行查询。</p>
<p>例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET /_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;multi_match&quot; : &#123;</span><br><span class="line">      &quot;query&quot;:    &quot;this is a test&quot;, </span><br><span class="line">      &quot;fields&quot;: [ &quot;subject&quot;, &quot;message&quot; ] </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Fields can be specified with wildcards, eg:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET /_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;multi_match&quot; : &#123;</span><br><span class="line">      &quot;query&quot;:    &quot;Will Smith&quot;,</span><br><span class="line">      &quot;fields&quot;: [ &quot;title&quot;, &quot;*_name&quot; ] </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="term-level-queries-术语级别查询"><a href="#term-level-queries-术语级别查询" class="headerlink" title="term level queries-术语级别查询"></a>term level queries-术语级别查询</h4><p>不同于上面的全文内容检测，这个是查询非常具体的值。</p>
<p>因此，这种查询，通常适用于结构化的数据，例如numbers, dates, and enums，而不是没有结构的text文本类型。</p>
<h5 id="term-query"><a href="#term-query" class="headerlink" title="term query"></a>term query</h5><p>例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST _search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;term&quot; : &#123; &quot;user&quot; : &quot;Kimchy&quot; &#125; </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>也可以再语句中加入boost参数，指定_score</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">GET _search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;should&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;term&quot;: &#123;</span><br><span class="line">            &quot;status&quot;: &#123;</span><br><span class="line">              &quot;value&quot;: &quot;urgent&quot;,</span><br><span class="line">              &quot;boost&quot;: 2.0 </span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;term&quot;: &#123;</span><br><span class="line">            &quot;status&quot;: &quot;normal&quot; </span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="terms-query"><a href="#terms-query" class="headerlink" title="terms query"></a>terms query</h5><p>可以定义多个术语：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET /_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;constant_score&quot; : &#123;</span><br><span class="line">            &quot;filter&quot; : &#123;</span><br><span class="line">                &quot;terms&quot; : &#123; &quot;user&quot; : [&quot;kimchy&quot;, &quot;elasticsearch&quot;]&#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="range-query"><a href="#range-query" class="headerlink" title="range query"></a>range query</h5><p>例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">GET _search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;range&quot; : &#123;</span><br><span class="line">            &quot;age&quot; : &#123;</span><br><span class="line">                &quot;gte&quot; : 10,</span><br><span class="line">                &quot;lte&quot; : 20,</span><br><span class="line">                &quot;boost&quot; : 2.0</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The <code>range</code> query accepts the following parameters:</p>
<table>
<thead>
<tr>
<th><code>gte</code></th>
<th>Greater-than or equal to</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>gt</code></td>
<td>Greater-than</td>
</tr>
<tr>
<td><code>lte</code></td>
<td>Less-than or equal to</td>
</tr>
<tr>
<td><code>lt</code></td>
<td>Less-than</td>
</tr>
<tr>
<td><code>boost</code></td>
<td>Sets the boost value of the query, defaults to <code>1.0</code></td>
</tr>
</tbody>
</table>
<p>date类型相关的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">GET _search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;range&quot; : &#123;</span><br><span class="line">            &quot;born&quot; : &#123;</span><br><span class="line">                &quot;gte&quot;: &quot;01/01/2012&quot;,</span><br><span class="line">                &quot;lte&quot;: &quot;2013&quot;,</span><br><span class="line">                &quot;format&quot;: &quot;dd/MM/yyyy||yyyy&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="exists-query"><a href="#exists-query" class="headerlink" title="exists query"></a>exists query</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET /_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;exists&quot; : &#123; &quot;field&quot; : &quot;user&quot; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>除此之外，还有非常多的类型，包括</p>
<ul>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.1/query-dsl-prefix-query.html" target="_blank" rel="noopener">Prefix Query</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.1/query-dsl-wildcard-query.html" target="_blank" rel="noopener">Wildcard Query</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.1/query-dsl-regexp-query.html" target="_blank" rel="noopener">Regexp Query</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.1/query-dsl-fuzzy-query.html" target="_blank" rel="noopener">Fuzzy Query</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.1/query-dsl-type-query.html" target="_blank" rel="noopener">Type Query</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.1/query-dsl-ids-query.html" target="_blank" rel="noopener">Ids Query</a></li>
</ul>
<h3 id="复合查询"><a href="#复合查询" class="headerlink" title="复合查询"></a>复合查询</h3><h4 id="bool-query"><a href="#bool-query" class="headerlink" title="bool query"></a>bool query</h4><p>主要是一些情况的判断，选项有：</p>
<table>
<thead>
<tr>
<th>Occur</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>must</code></td>
<td>The clause (query) must appear in matching documents and will contribute to the score.</td>
</tr>
<tr>
<td><code>filter</code></td>
<td>The clause (query) must appear in matching documents. However unlike <code>must</code> the score of the query will be ignored. Filter clauses are executed in <a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.1/query-filter-context.html" target="_blank" rel="noopener">filter context</a>, meaning that scoring is ignored and clauses are considered for caching.</td>
</tr>
<tr>
<td><code>should</code></td>
<td>The clause (query) should appear in the matching document. In a boolean query with no <code>must</code> or <code>filter</code> clauses, one or more <code>should</code> clauses must match a document. The minimum number of should clauses to match can be set using the<a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.1/query-dsl-minimum-should-match.html" target="_blank" rel="noopener"><code>minimum_should_match</code></a> parameter.</td>
</tr>
<tr>
<td><code>must_not</code></td>
<td>The clause (query) must not appear in the matching documents. Clauses are executed in <a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.1/query-filter-context.html" target="_blank" rel="noopener">filter context</a> meaning that scoring is ignored and clauses are considered for caching. Because scoring is ignored, a score of <code>0</code> for all documents is returned.</td>
</tr>
</tbody>
</table>
<p>下面是一个案例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">POST _search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot; : &#123;</span><br><span class="line">      &quot;must&quot; : &#123;</span><br><span class="line">        &quot;term&quot; : &#123; &quot;user&quot; : &quot;kimchy&quot; &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;filter&quot;: &#123;</span><br><span class="line">        &quot;term&quot; : &#123; &quot;tag&quot; : &quot;tech&quot; &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;must_not&quot; : &#123;</span><br><span class="line">        &quot;range&quot; : &#123;</span><br><span class="line">          &quot;age&quot; : &#123; &quot;gte&quot; : 10, &quot;lte&quot; : 20 &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;should&quot; : [</span><br><span class="line">        &#123; &quot;term&quot; : &#123; &quot;tag&quot; : &quot;wow&quot; &#125; &#125;,</span><br><span class="line">        &#123; &quot;term&quot; : &#123; &quot;tag&quot; : &quot;elasticsearch&quot; &#125; &#125;</span><br><span class="line">      ],</span><br><span class="line">      &quot;minimum_should_match&quot; : 1,</span><br><span class="line">      &quot;boost&quot; : 1.0</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="kibana查询数据"><a href="#kibana查询数据" class="headerlink" title="kibana查询数据"></a>kibana查询数据</h3><p>上面说的都是直接从es中检索数据，但是对于大多数用户来说，更多的还是通过kibana去做</p>
<h2 id="ES监控"><a href="#ES监控" class="headerlink" title="ES监控"></a>ES监控</h2><p>zabbix上的配置：</p>
<p>key：</p>
<p>集群相关接口：GET /_cat/health?v、/_cat/allocation?v、GET /_cat/master?v</p>
<ul>
<li>集群颜色状态（非绿色报警）：es_status[9002,cluster,status]</li>
<li>集群分片健康度（非100%报警）：es_status[9002,cluster,active_shards_percent]</li>
<li>集群节点总数（有变化报警）：es_status[9002,cluster,total_node]</li>
<li>集群data节点总数（有变化报警）：es_status[9002,cluster,total_datanode]</li>
<li>集群未分配的分片数量（大于0报警）：es_status[9002,cluster,unassigned_shards]</li>
<li>集群的磁盘存储空间（打到80%报警）：es_status[9002,cluster,disk_used_percent]</li>
<li>集群master节点（有变化报警）：es_status[9002,cluster,masternode]</li>
<li>集群的写入速度</li>
<li>集群的读写速度</li>
<li>线程池的监控，总数以及每个线程池的监控</li>
<li>gc的情况</li>
</ul>
<p>节点相关：</p>
<p>相关api：</p>
<ul>
<li>es_status[9002,node,xx]</li>
<li>JVM内存占用超过90</li>
<li>负载</li>
<li>cpu使用率</li>
<li>日志中有报错就报警</li>
</ul>
<p>索引相关：</p>
<ul>
<li><p>索引总数：</p>
</li>
<li><p>es_status[9002,index,]</p>
</li>
</ul>
<p>主机相关监控，流量，cpu什么的，怎么能按照一个集群的维度-添加到grafana中</p>
<p>可以添加一下监控，针对每一个es集群：</p>
<ol>
<li><p>集群的磁盘使用情况</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /_cat/allocation?v</span><br></pre></td></tr></table></figure>
</li>
<li><p>集群的健康性检查，例如红色和黄色、分片的状态等等</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /_cat/health?v</span><br></pre></td></tr></table></figure>
<p>集群的不健康可能是多种原因导致的，这里不区分具体的原因，如果有问题，则报警，收到报警之后再去查看具体是什么原因。</p>
<p>具体的指标有：</p>
<ul>
<li></li>
</ul>
</li>
</ol>
<ol>
<li><p>监控数据节点的负载情况</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1</span><br></pre></td></tr></table></figure>
</li>
<li><p>node的可用性监控</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1</span><br></pre></td></tr></table></figure>
</li>
<li><p>node的性能监控</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1</span><br></pre></td></tr></table></figure>
</li>
</ol>
<ol>
<li><p>集群负载情况</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1</span><br></pre></td></tr></table></figure>
</li>
<li><p>集群的索引监控</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dd</span><br></pre></td></tr></table></figure>
<p>监控指标主要是索引的请求速率、请求处理延迟、索引大小等、索引异常等</p>
</li>
<li><p>ES的jmx监控(因为是java进程)</p>
</li>
</ol>
<h2 id="ES调优"><a href="#ES调优" class="headerlink" title="ES调优"></a>ES调优</h2><p>refresh时间间隔：refresh_interval</p>
<p>replica数目设置：在bulk大量数据到ES集群的可以把副本数设置为0，在数据导入完成之后再设置为1或者你集群的适合的数目。</p>
<h2 id="ES常见问题"><a href="#ES常见问题" class="headerlink" title="ES常见问题"></a>ES常见问题</h2><h3 id="慢查慢写日志设置及收集"><a href="#慢查慢写日志设置及收集" class="headerlink" title="慢查慢写日志设置及收集"></a>慢查慢写日志设置及收集</h3><p><strong>设置</strong></p>
<h3 id="热线程"><a href="#热线程" class="headerlink" title="热线程"></a>热线程</h3><p>参考链接：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/6.5/cluster-nodes-hot-threads.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/6.5/cluster-nodes-hot-threads.html</a></p>
<p>当有一些节点的cpu、负载、io等有异常时，我们可以通过热线程来定位到具体的产生原因。</p>
<p>使用格式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[elk@es13.dwb.dgt ~]$ curl http://10.10.10.83:9200/_nodes/es13-data/hot_threads</span><br><span class="line"></span><br><span class="line">或者添加上时间，指定抓取多久时间内占用资源的热线程</span><br><span class="line">GET /_nodes/hot_threads&amp;interval=30s</span><br></pre></td></tr></table></figure>
<p>执行后的输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">[elk@es13.dwb.dgt ~]$ curl http://10.10.10.83:9200/_nodes/es13-data/hot_threads</span><br><span class="line">::: &#123;es13-data&#125;&#123;76c2DSkdRRqTyHUCoK1pyQ&#125;&#123;egVogFoJRzuFvJxUX1VnWQ&#125;&#123;10.10.10.83&#125;&#123;10.10.10.83:9300&#125;&#123;ml.machine_memory=270056525824, xpack.installed=true, ml.max_open_jobs=20, ml.enabled=true&#125;</span><br><span class="line">   Hot threads at 2019-07-23T07:21:24.850, interval=500ms, busiestThreads=3, ignoreIdleThreads=true:</span><br><span class="line"></span><br><span class="line">   54.7% (273.5ms out of 500ms) cpu usage by thread &apos;elasticsearch[es13-data][[app-publishing-logstash-2019.07.23][1]: Lucene Merge Thread #983]&apos;</span><br><span class="line">     2/10 snapshots sharing following 24 elements</span><br><span class="line">       sun.misc.Unsafe.park(Native Method)</span><br><span class="line">       java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:215)</span><br><span class="line">       java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.awaitNanos(AbstractQueuedSynchronizer.java:2078)</span><br><span class="line">       org.apache.lucene.index.MergePolicy$OneMergeProgress.pauseNanos(MergePolicy.java:156)</span><br><span class="line">       org.apache.lucene.index.MergeRateLimiter.maybePause(MergeRateLimiter.java:148)</span><br><span class="line">       org.apache.lucene.index.MergeRateLimiter.pause(MergeRateLimiter.java:93)</span><br><span class="line">       org.apache.lucene.store.RateLimitedIndexOutput.checkRate(RateLimitedIndexOutput.java:78)</span><br><span class="line">       org.apache.lucene.store.RateLimitedIndexOutput.writeBytes(RateLimitedIndexOutput.java:72)</span><br><span class="line">       org.apache.lucene.store.DataOutput.writeBytes(DataOutput.java:52)</span><br><span class="line">       org.apache.lucene.store.RAMOutputStream.writeTo(RAMOutputStream.java:90)</span><br><span class="line">       org.apache.lucene.codecs.blocktree.BlockTreeTermsWriter$TermsWriter.writeBlock(BlockTreeTermsWriter.java:820)</span><br><span class="line">       org.apache.lucene.codecs.blocktree.BlockTreeTermsWriter$TermsWriter.writeBlocks(BlockTreeTermsWriter.java:624)</span><br><span class="line">       org.apache.lucene.codecs.blocktree.BlockTreeTermsWriter$TermsWriter.pushTerm(BlockTreeTermsWriter.java:905)</span><br><span class="line">       org.apache.lucene.codecs.blocktree.BlockTreeTermsWriter$TermsWriter.write(BlockTreeTermsWriter.java:869)</span><br><span class="line">       org.apache.lucene.codecs.blocktree.BlockTreeTermsWriter.write(BlockTreeTermsWriter.java:343)</span><br><span class="line">       org.apache.lucene.codecs.FieldsConsumer.merge(FieldsConsumer.java:105)</span><br><span class="line">       org.apache.lucene.codecs.perfield.PerFieldPostingsFormat$FieldsWriter.merge(PerFieldPostingsFormat.java:164)</span><br><span class="line">       org.apache.lucene.index.SegmentMerger.mergeTerms(SegmentMerger.java:231)</span><br><span class="line">       org.apache.lucene.index.SegmentMerger.merge(SegmentMerger.java:116)</span><br><span class="line">       org.apache.lucene.index.IndexWriter.mergeMiddle(IndexWriter.java:4446)</span><br><span class="line">       org.apache.lucene.index.IndexWriter.merge(IndexWriter.java:4068)</span><br><span class="line">       org.apache.lucene.index.ConcurrentMergeScheduler.doMerge(ConcurrentMergeScheduler.java:625)</span><br><span class="line">       org.elasticsearch.index.engine.ElasticsearchConcurrentMergeScheduler.doMerge(ElasticsearchConcurrentMergeScheduler.java:99)</span><br><span class="line">       org.apache.lucene.index.ConcurrentMergeScheduler$MergeThread.run(ConcurrentMergeScheduler.java:662)</span><br><span class="line">     5/10 snapshots sharing following 11 elements</span><br><span class="line">       org.apache.lucene.index.FilterLeafReader$FilterTermsEnum.next(FilterLeafReader.java:189)</span><br><span class="line">       org.apache.lucene.codecs.blocktree.BlockTreeTermsWriter.write(BlockTreeTermsWriter.java:335)</span><br><span class="line">       org.apache.lucene.codecs.FieldsConsumer.merge(FieldsConsumer.java:105)</span><br><span class="line">       org.apache.lucene.codecs.perfield.PerFieldPostingsFormat$FieldsWriter.merge(PerFieldPostingsFormat.java:164)</span><br><span class="line">       org.apache.lucene.index.SegmentMerger.mergeTerms(SegmentMerger.java:231)</span><br><span class="line">       org.apache.lucene.index.SegmentMerger.merge(SegmentMerger.java:116)</span><br><span class="line">       org.apache.lucene.index.IndexWriter.mergeMiddle(IndexWriter.java:4446)</span><br><span class="line">       org.apache.lucene.index.IndexWriter.merge(IndexWriter.java:4068)</span><br><span class="line">       org.apache.lucene.index.ConcurrentMergeScheduler.doMerge(ConcurrentMergeScheduler.java:625)</span><br><span class="line">       org.elasticsearch.index.engine.ElasticsearchConcurrentMergeScheduler.doMerge(ElasticsearchConcurrentMergeScheduler.java:99)</span><br><span class="line">       org.apache.lucene.index.ConcurrentMergeScheduler$MergeThread.run(ConcurrentMergeScheduler.java:662)</span><br><span class="line">     2/10 snapshots sharing following 13 elements</span><br><span class="line">       org.apache.lucene.codecs.blocktree.BlockTreeTermsWriter$TermsWriter.writeBlocks(BlockTreeTermsWriter.java:633)</span><br><span class="line">       org.apache.lucene.codecs.blocktree.BlockTreeTermsWriter$TermsWriter.pushTerm(BlockTreeTermsWriter.java:905)</span><br><span class="line">       org.apache.lucene.codecs.blocktree.BlockTreeTermsWriter$TermsWriter.write(BlockTreeTermsWriter.java:869)</span><br><span class="line">       org.apache.lucene.codecs.blocktree.BlockTreeTermsWriter.write(BlockTreeTermsWriter.java:343)</span><br><span class="line">       org.apache.lucene.codecs.FieldsConsumer.merge(FieldsConsumer.java:105)</span><br><span class="line">       org.apache.lucene.codecs.perfield.PerFieldPostingsFormat$FieldsWriter.merge(PerFieldPostingsFormat.java:164)</span><br><span class="line">       org.apache.lucene.index.SegmentMerger.mergeTerms(SegmentMerger.java:231)</span><br><span class="line">       org.apache.lucene.index.SegmentMerger.merge(SegmentMerger.java:116)</span><br><span class="line">       org.apache.lucene.index.IndexWriter.mergeMiddle(IndexWriter.java:4446)</span><br><span class="line">       org.apache.lucene.index.IndexWriter.merge(IndexWriter.java:4068)</span><br><span class="line">       org.apache.lucene.index.ConcurrentMergeScheduler.doMerge(ConcurrentMergeScheduler.java:625)</span><br><span class="line">       org.elasticsearch.index.engine.ElasticsearchConcurrentMergeScheduler.doMerge(ElasticsearchConcurrentMergeScheduler.java:99)</span><br><span class="line">       org.apache.lucene.index.ConcurrentMergeScheduler$MergeThread.run(ConcurrentMergeScheduler.java:662)</span><br><span class="line">     unique snapshot</span><br><span class="line">       sun.nio.ch.FileDispatcherImpl.write0(Native Method)</span><br><span class="line">       sun.nio.ch.FileDispatcherImpl.write(FileDispatcherImpl.java:60)</span><br><span class="line">       sun.nio.ch.IOUtil.writeFromNativeBuffer(IOUtil.java:93)</span><br><span class="line">       sun.nio.ch.IOUtil.write(IOUtil.java:65)</span><br><span class="line">       sun.nio.ch.FileChannelImpl.write(FileChannelImpl.java:211)</span><br><span class="line">       java.nio.channels.Channels.writeFullyImpl(Channels.java:78)</span><br><span class="line">       java.nio.channels.Channels.writeFully(Channels.java:101)</span><br><span class="line">       java.nio.channels.Channels.access$000(Channels.java:61)</span><br><span class="line">       java.nio.channels.Channels$1.write(Channels.java:174)</span><br><span class="line">       org.apache.lucene.store.FSDirectory$FSIndexOutput$1.write(FSDirectory.java:417)</span><br><span class="line">       java.util.zip.CheckedOutputStream.write(CheckedOutputStream.java:73)</span><br><span class="line">       java.io.BufferedOutputStream.flushBuffer(BufferedOutputStream.java:82)</span><br><span class="line">       java.io.BufferedOutputStream.write(BufferedOutputStream.java:126)</span><br><span class="line">       org.apache.lucene.store.OutputStreamIndexOutput.writeBytes(OutputStreamIndexOutput.java:53)</span><br><span class="line">       org.elasticsearch.common.lucene.store.FilterIndexOutput.writeBytes(FilterIndexOutput.java:59)</span><br><span class="line">       org.apache.lucene.store.RateLimitedIndexOutput.writeBytes(RateLimitedIndexOutput.java:73)</span><br><span class="line">       org.apache.lucene.store.DataOutput.writeBytes(DataOutput.java:52)</span><br><span class="line">       org.apache.lucene.store.RAMOutputStream.writeTo(RAMOutputStream.java:90)</span><br><span class="line">       org.apache.lucene.codecs.blocktree.BlockTreeTermsWriter$TermsWriter.writeBlock(BlockTreeTermsWriter.java:820)</span><br><span class="line">       org.apache.lucene.codecs.blocktree.BlockTreeTermsWriter$TermsWriter.writeBlocks(BlockTreeTermsWriter.java:624)</span><br><span class="line">       org.apache.lucene.codecs.blocktree.BlockTreeTermsWriter$TermsWriter.pushTerm(BlockTreeTermsWriter.java:905)</span><br><span class="line">       org.apache.lucene.codecs.blocktree.BlockTreeTermsWriter$TermsWriter.write(BlockTreeTermsWriter.java:869)</span><br><span class="line">       org.apache.lucene.codecs.blocktree.BlockTreeTermsWriter.write(BlockTreeTermsWriter.java:343)</span><br><span class="line">       org.apache.lucene.codecs.FieldsConsumer.merge(FieldsConsumer.java:105)</span><br><span class="line">       org.apache.lucene.codecs.perfield.PerFieldPostingsFormat$FieldsWriter.merge(PerFieldPostingsFormat.java:164)</span><br><span class="line">       org.apache.lucene.index.SegmentMerger.mergeTerms(SegmentMerger.java:231)</span><br><span class="line">       org.apache.lucene.index.SegmentMerger.merge(SegmentMerger.java:116)</span><br><span class="line">       org.apache.lucene.index.IndexWriter.mergeMiddle(IndexWriter.java:4446)</span><br><span class="line">       org.apache.lucene.index.IndexWriter.merge(IndexWriter.java:4068)</span><br><span class="line">       org.apache.lucene.index.ConcurrentMergeScheduler.doMerge(ConcurrentMergeScheduler.java:625)</span><br><span class="line">       org.elasticsearch.index.engine.ElasticsearchConcurrentMergeScheduler.doMerge(ElasticsearchConcurrentMergeScheduler.java:99)</span><br><span class="line">       org.apache.lucene.index.ConcurrentMergeScheduler$MergeThread.run(ConcurrentMergeScheduler.java:662)</span><br><span class="line"></span><br><span class="line">    5.2% (26ms out of 500ms) cpu usage by thread &apos;elasticsearch[es13-data][[transport_server_worker.default]][T#16]&apos;</span><br><span class="line">     4/10 snapshots sharing following 2 elements</span><br><span class="line">       io.netty.util.concurrent.SingleThreadEventExecutor$5.run(SingleThreadEventExecutor.java:897)</span><br><span class="line">       java.lang.Thread.run(Thread.java:745)</span><br></pre></td></tr></table></figure>
<p>输出分析：</p>
<h3 id="节点多磁盘时分配不均匀"><a href="#节点多磁盘时分配不均匀" class="headerlink" title="节点多磁盘时分配不均匀"></a>节点多磁盘时分配不均匀</h3><p>问题：一个数据量比较大的索引分片分配到某一台机器上的时候，整体的资源是够的，但是某一块盘的使用率是比较高的</p>
<p>如下图所示</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[ops@es061.ecs.east1-g ~]$ df -h</span><br><span class="line">Filesystem      Size  Used Avail Use% Mounted on</span><br><span class="line">/dev/vda1        40G  5.9G   32G  16% /</span><br><span class="line">tmpfs            16G   12K   16G   1% /dev/shm</span><br><span class="line">/dev/vdb1       197G   59G  129G  32% /data1</span><br><span class="line">/dev/vdc1       197G  135G   53G  73% /data2</span><br></pre></td></tr></table></figure>
<p>可以看到，两块盘的使用率将近相差了40%。</p>
<p>我们知道，es分配数据，主要是根据索引的分片级别到es的节点上，如果这个分配不均匀，我们可以通过挪动shard进行均衡。</p>
<p>但是，如果是节点下面的多快磁盘，这个的分配策略又是什么呢？</p>
<p><strong>多硬盘时的分配策略</strong></p>
<blockquote>
<p>磁盘的IO不均匀是因为可能挂在了裸盘，并且配置了多个data.path的原因。  </p>
<p>一个shard只能分布在其中一块磁盘上，如果某个索引比较热，写入量大，对应的shard所在磁盘就比其他繁忙很多。</p>
<p>多块磁盘推荐做raid，每个磁盘的IO基本上是均匀分布的。</p>
</blockquote>
<p>官方原文：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">The path.data settings can be set to multiple paths, in which case all paths will be used to store data (although the files belonging to a single shard will all be stored on the same data path):</span><br><span class="line">path:</span><br><span class="line">  data:</span><br><span class="line">    - /mnt/elasticsearch_1</span><br><span class="line">    - /mnt/elasticsearch_2</span><br><span class="line">    - /mnt/elasticsearch_3</span><br></pre></td></tr></table></figure>
<p>也就是说，我们可以设置多个存储路径来存储数据，es会自动去协调分配，但是一个shard的文件只会被存储到一个path中。</p>
<p><strong>综上</strong></p>
<p>导致这个问题出现的根本原因是：</p>
<ul>
<li>这个node上分配了一个大索引的一个shard。</li>
<li>node级别只会分配这个shard存储到其中一个路径下，这里是/data2下</li>
<li>分配路径的策略是：优先找磁盘剩余空间大的盘</li>
</ul>
<h2 id="ES扩容及缩容"><a href="#ES扩容及缩容" class="headerlink" title="ES扩容及缩容"></a>ES扩容及缩容</h2><h3 id="扩容"><a href="#扩容" class="headerlink" title="扩容"></a>扩容</h3><p>扩容比较简单，在配置文件中指定现有es节点的地址，启动之后就会自动添加进当前的集群，注意cluster name需要一致。</p>
<p>在新节点添加进来之后，shard会自动挪动，如果集群压力较大，数据量较多，在挪动的时候可能会影响集群的读写，那么，这个时候我可以自定义的选择合适的时间去操作，配置为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PUT _cluster/settings</span><br><span class="line">&#123;</span><br><span class="line">  &quot;persistent&quot;: &#123;</span><br><span class="line">    &quot;cluster.routing.allocation.enable&quot;: &quot;none&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>避免集群shard移动，待到合适的时间，设置：</p>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PUT _cluster/settings &#123; "persistent": &#123; "cluster.routing.allocation.enable": null &#125; &#125;</span><br></pre></td></tr></table></figure>
<p>恢复shard移动</p>
<p>具体可以参考：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/6.2/rolling-upgrades.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/6.2/rolling-upgrades.html</a></p>
<p>注意：</p>
<ul>
<li>设置为none之后，如果创建了新的索引，那么该索引的分片将不会被分配，会被置为：UNASSIGNED。也就意味着无法往这个新索引中写入数据</li>
<li>在设置之前的索引，数据写入不受影响。</li>
</ul>
<h3 id="缩容"><a href="#缩容" class="headerlink" title="缩容"></a>缩容</h3><p>使用exclude：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PUT _cluster/settings</span><br><span class="line">&#123;</span><br><span class="line">  &quot;transient&quot; : &#123;</span><br><span class="line">    &quot;cluster.routing.allocation.exclude._ip&quot; : &quot;10.0.0.1&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>把要下线的机器exclude，然后数据会自动迁移到其他节点并且自动rebalance，集群不需要重启。</p>
<p>迁移完后可以重新划分节点角色。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#通过IP，排除集群中的某个节点：节点IP：10.100.0.11</span><br><span class="line">curl -XPUT http://&lt;domain&gt;:&lt;port&gt;/_cluster/settings?pretty -d &apos;&#123;&quot;transient&quot;:&#123;&quot;cluster.routing.allocation.exclude._ip&quot;:&quot;10.100.0.11&quot;&#125;&#125;&apos;</span><br><span class="line"></span><br><span class="line">#通过IP，排除集群中的多个节点：节点IP：10.10.0.11,10.100.0.12</span><br><span class="line">curl -XPUT http://&lt;domain&gt;:&lt;port&gt;/_cluster/settings?pretty -d &apos;&#123;&quot;transient&quot;:&#123;&quot;cluster.routing.allocation.exclude._ip&quot;:&quot;10.100.0.11,10.100.0.12&quot;&#125;&#125;&apos;</span><br><span class="line"></span><br><span class="line">#取消节点排除的限制</span><br><span class="line">curl -XPUT http://&lt;domain&gt;:&lt;port&gt;/_cluster/settings?pretty -d &apos;&#123;&quot;transient&quot;:&#123;&quot;cluster.routing.allocation.exclude._ip&quot;: null&#125;&#125;&apos;</span><br></pre></td></tr></table></figure>
<p>注意：当迁移过程中，其他节点的负载较高时，可以先取消，就是上面的设置为null</p>
<p>所以，整个的下线操作是：</p>
<ol>
<li>exclude掉要下线的节点</li>
<li>确认shard，待该节点上没有shard之后，停止该节点</li>
<li>将exclude设置为null</li>
</ol>
<p>问题：如何查看和控制shard的移动速度，防止数据量过大时出现问题。</p>
<h3 id="相关参数"><a href="#相关参数" class="headerlink" title="相关参数"></a>相关参数</h3><p>除了上面提到的哪些，还有一些集群级别的参数可以动态定义</p>
<p>迁移相关：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cluster.routing.allocation.cluster_concurrent_rebalance</span><br></pre></td></tr></table></figure>
<p>参考链接：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.3/shards-allocation.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/5.3/shards-allocation.html</a></p>
<p>主要是modules中的集群部分内容</p>
<p>索引相关：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">indices.recovery.max_bytes_per_sec</span><br></pre></td></tr></table></figure>
<p>参考链接：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.3/recovery.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/5.3/recovery.html</a></p>
<h2 id="ES故障处理"><a href="#ES故障处理" class="headerlink" title="ES故障处理"></a>ES故障处理</h2><h2 id="集群节点宕机导致shard-unassigned"><a href="#集群节点宕机导致shard-unassigned" class="headerlink" title="集群节点宕机导致shard unassigned"></a>集群节点宕机导致shard unassigned</h2><p>使用这个去获取未分配的分片详情</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET http://192.168.1.188:9200/_cat/shards|grep UNASSIGNED</span><br></pre></td></tr></table></figure>
<p>未分配的是副本分片，那么修改副本数量：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PUT applog-prod-2016.12.18/_settings</span><br><span class="line">&#123;</span><br><span class="line">  &quot;index&quot;:&#123;</span><br><span class="line">    &quot;number_of_replicas&quot;:0</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果是主分片丢失了，那么没有办法了，要承受数据丢失，我们使用reindex，来尽可能的保证数据的完整</p>
<p>整体的流程如下：</p>
<ul>
<li>创建一个新的索引，mapping与要reindex的源index保持一致</li>
<li>执行reindex</li>
<li>删除原有的index</li>
<li>创建新的index，名称使用删除的名称</li>
<li>再次执行reindex，将数据恢复进去</li>
<li>删除掉临时的index即可</li>
</ul>
<p>接口如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">POST _reindex</span><br><span class="line">&#123;</span><br><span class="line">  &quot;source&quot;: &#123;</span><br><span class="line">    &quot;index&quot;: &quot;twitter&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;dest&quot;: &#123;</span><br><span class="line">    &quot;index&quot;: &quot;new_twitter&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不想再次创建索引的话也可以使用alias</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST /_aliases</span><br><span class="line">&#123;</span><br><span class="line">    &quot;actions&quot; : [</span><br><span class="line">        &#123; &quot;add&quot; : &#123; &quot;index&quot; : &quot;twitter&quot;, &quot;alias&quot; : &quot;alias1&quot; &#125; &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这种形式的话，那么临时的索引就能删除掉</p>
<h1 id="kibana部署"><a href="#kibana部署" class="headerlink" title="kibana部署"></a>kibana部署</h1><h2 id="安装部署"><a href="#安装部署" class="headerlink" title="安装部署"></a>安装部署</h2><p>参考链接：<a href="https://www.elastic.co/guide/en/kibana/6.5/install.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/kibana/6.5/install.html</a></p>
<h2 id="ES数据如何展示在kibana上"><a href="#ES数据如何展示在kibana上" class="headerlink" title="ES数据如何展示在kibana上"></a>ES数据如何展示在kibana上</h2><p>如何将es的索引数据展示在kibana上？</p>
<p>manager–&gt;index patterns</p>
<p>输入index的匹配规则，注意索引需要有一个时间字段，以作为排序</p>
<h2 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h2><p>参考链接：<a href="https://www.elastic.co/guide/en/kibana/5.3/production.html#load-balancing" target="_blank" rel="noopener">https://www.elastic.co/guide/en/kibana/5.3/production.html#load-balancing</a></p>
<p>使用es中的转发节点去实现，es的这个转发节点其实就是负载均衡的作用，它会去协调各个节点。</p>
<h2 id="ES的监控指标如何展示在kibana上"><a href="#ES的监控指标如何展示在kibana上" class="headerlink" title="ES的监控指标如何展示在kibana上"></a>ES的监控指标如何展示在kibana上</h2><h2 id="kibana监控"><a href="#kibana监控" class="headerlink" title="kibana监控"></a>kibana监控</h2><h2 id="kibana搜索"><a href="#kibana搜索" class="headerlink" title="kibana搜索"></a>kibana搜索</h2><p>参考链接：<a href="https://www.elastic.co/guide/en/kibana/6.5/kuery-query.html#_new_simplified_syntax" target="_blank" rel="noopener">https://www.elastic.co/guide/en/kibana/6.5/kuery-query.html#_new_simplified_syntax</a></p>
<h3 id="lucence-query-syntax"><a href="#lucence-query-syntax" class="headerlink" title="lucence query syntax"></a>lucence query syntax</h3><p>kibana上的查询方式是基于lucence的，</p>
<p>官方的内容：</p>
<p>Kibana’s query language has historically been based on the Lucene query syntax. The following are some tips that can help get you started.</p>
<ul>
<li>To perform a free text search, simply enter a text string. For example, if you’re searching web server logs, you could enter <code>safari</code> to search all fields for the term <code>safari</code>.</li>
<li>To search for a value in a specific field, prefix the value with the name of the field. For example, you could enter <code>status:200</code> to find all of the entries that contain the value <code>200</code> in the <code>status</code> field.</li>
<li>To search for a range of values, you can use the bracketed range syntax, <code>[START_VALUE TO END_VALUE]</code>. For example, to find entries that have 4xx status codes, you could enter <code>status:[400 TO 499]</code>.</li>
<li>To specify more complex search criteria, you can use the Boolean operators <code>AND</code>, <code>OR</code>, and <code>NOT</code>. For example, to find entries that have 4xx status codes and have an extension of <code>php</code> or <code>html</code>, you could enter <code>status:[400 TO 499] AND (extension:php OR extension:html)</code>.</li>
</ul>
<p>For more detailed information about the Lucene query syntax, see the <a href="https://www.elastic.co/guide/en/elasticsearch/reference/6.5/query-dsl-query-string-query.html#query-string-syntax" target="_blank" rel="noopener">Query String Query</a> docs.</p>
<h2 id="kibana-apm展示"><a href="#kibana-apm展示" class="headerlink" title="kibana apm展示"></a>kibana apm展示</h2><h2 id="xpack-monitor监控"><a href="#xpack-monitor监控" class="headerlink" title="xpack-monitor监控"></a>xpack-monitor监控</h2><p>默认情况下，在kibana界面是不展示各es节点的负载、资源使用率、索引信息等指标的，我们可以添加上这个功能，这在排查问题时还是挺有效果的。</p>
<p>除了能监控es，xpack体系还能监控filebeat、logstash等组件</p>
<h3 id="在线方式安装"><a href="#在线方式安装" class="headerlink" title="在线方式安装"></a>在线方式安装</h3><p>es端配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/elasticsearch-plugin install x-pack</span><br></pre></td></tr></table></figure>
<p>如果es设置了关闭自动创建index，那么还需要添加下面这行配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">action.auto_create_index: .security,.monitoring*,.watches,.triggered_watches,.watcher-history*</span><br></pre></td></tr></table></figure>
<p>kibana端配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/kibana-plugin install x-pack</span><br></pre></td></tr></table></figure>
<h3 id="离线方式安装"><a href="#离线方式安装" class="headerlink" title="离线方式安装"></a>离线方式安装</h3><p>参考链接：<a href="https://www.elastic.co/guide/en/x-pack/5.1/installing-xpack.html#xpack-installing-offline" target="_blank" rel="noopener">https://www.elastic.co/guide/en/x-pack/5.1/installing-xpack.html#xpack-installing-offline</a></p>
<p>如果服务器不能直连公网等，那么可以把相关的包文件下载下来上次到服务器上。</p>
<p>首先下载文件，并传输到服务器上。</p>
<p>然后执行以下命令</p>
<p><strong>es：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/elasticsearch-plugin install file:///path/to/file/x-pack-5.1.2.zip</span><br></pre></td></tr></table></figure>
<p><strong>kibana：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/kibana-plugin install file:///path/to/file/x-pack-5.1.2.zip</span><br></pre></td></tr></table></figure>
<h3 id="xpack相关配置参数"><a href="#xpack相关配置参数" class="headerlink" title="xpack相关配置参数"></a>xpack相关配置参数</h3><p>有以下相关参数：</p>
<table>
<thead>
<tr>
<th>Setting</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>xpack.security.enabled</code></td>
<td>Set to <code>false</code> to disable X-Pack security. Configure in both <code>elasticsearch.yml</code> and <code>kibana.yml</code>.</td>
</tr>
<tr>
<td><code>xpack.monitoring.enabled</code></td>
<td>Set to <code>false</code> to disable X-Pack monitoring. Configure in both <code>elasticsearch.yml</code> and <code>kibana.yml</code>.</td>
</tr>
<tr>
<td><code>xpack.graph.enabled</code></td>
<td>Set to <code>false</code> to disable X-Pack graph. Configure in both <code>elasticsearch.yml</code> and <code>kibana.yml</code>.</td>
</tr>
<tr>
<td><code>xpack.watcher.enabled</code></td>
<td>Set to <code>false</code> to disable Watcher. Configure in <code>elasticsearch.yml</code>only.</td>
</tr>
<tr>
<td><code>xpack.reporting.enabled</code></td>
<td>Set to <code>false</code> to disable X-Pack reporting. Configure in <code>kibana.yml</code> only.</td>
</tr>
</tbody>
</table>
<p>默认情况下，所有的参数功能都是打开的，可以根据实际情况去选择开启</p>
<p>我们一般的实际配置是：</p>
<p><strong>es节点</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[elk@es032.ecs.east1-e config]$ grep xpack elasticsearch.yml</span><br><span class="line">xpack.security.audit.enabled: false</span><br><span class="line">xpack.monitoring.enabled: true</span><br><span class="line">xpack.security.enabled: false</span><br><span class="line">xpack.graph.enabled: false</span><br><span class="line">xpack.watcher.enabled: false</span><br></pre></td></tr></table></figure>
<p><strong>kibana</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[elk@redis2.dwb.dgt config]$ grep xpack kibana.yml</span><br><span class="line">xpack.monitoring.elasticsearch.url: &quot;http://172.24.48.34:9200&quot;</span><br><span class="line">xpack.monitoring.enabled: true</span><br><span class="line">xpack.security.enabled: false</span><br><span class="line">xpack.graph.enabled: false</span><br><span class="line">xpack.reporting.enabled: false</span><br></pre></td></tr></table></figure>
<h3 id="license更新"><a href="#license更新" class="headerlink" title="license更新"></a>license更新</h3><p>1、去下面这个链接提交 基础 license 申请</p>
<p><a href="https://license.elastic.co/registration/" target="_blank" rel="noopener">https://license.elastic.co/registration/</a></p>
<p>2、ELK 会给你填写的邮箱中发一封邮件。</p>
<p>去中间这个链接地址下载 license 文件</p>
<p>3、如果你和我一样使用的 ELK 6.3 版本，那么你需要使用以下以命令更新 License。注：License 更新命令经常变化，如果出现报错请注意报错信息。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># @license.json是你刚才下载的 license 文件上传到服务器上。</span><br><span class="line">curl -XPOST &apos;http://192.168.1.1:9200/_xpack/license/start_basic?acknowledge=true&apos; -H &quot;Content-Type:application/json&quot; -d @license.json</span><br></pre></td></tr></table></figure>
<p>5版本的命令是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT -u elastic &apos;http://172.16.1.128:9500/_xpack/license?acknowledge=true&apos; -H &quot;Content-Type: application/json&quot; -d @xiaohua-wang-9f31d302-4f35-46ad-b67d-2278833f3d58-v5.json</span><br></pre></td></tr></table></figure>
<p>默认密码是changeme</p>
<p>参考链接：<a href="https://www.elastic.co/guide/en/x-pack/5.6/installing-license.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/x-pack/5.6/installing-license.html</a></p>
<h1 id="补充-yaml语法"><a href="#补充-yaml语法" class="headerlink" title="补充-yaml语法"></a>补充-yaml语法</h1><p>YAML语言的设计参考了JSON，XML和SDL等语言。也是一种数据交互的格式语言，YAML 强调以<strong>数据为中心</strong>,简洁易读,编写简单。</p>
<p>YAML主要的作用是作为程序的配置文件。</p>
<h2 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h2><p>yaml语言有以下特点：</p>
<ul>
<li>大小写敏感</li>
<li>通过缩进表示层级关系</li>
<li><strong>禁止使用tab缩进，只能使用空格键</strong> （个人感觉这条最重要）</li>
<li>缩进的空格数目不重要，只要相同层级左对齐即可</li>
<li>使用#表示注释</li>
</ul>
<h2 id="支持的数据结构"><a href="#支持的数据结构" class="headerlink" title="支持的数据结构"></a>支持的数据结构</h2><p>支持以下数据结构：</p>
<ul>
<li>对象：键值对的<strong>集合</strong>，又称为映射（mapping）/ 哈希（hashes） / 字典（dictionary）</li>
<li>数组：一组按次序排列的值，又称为序列（sequence） / 列表（list）</li>
<li>纯量（scalars）：单个的、不可再分的值</li>
</ul>
<h2 id="数据结构的书写形式"><a href="#数据结构的书写形式" class="headerlink" title="数据结构的书写形式"></a>数据结构的书写形式</h2><h3 id="对象"><a href="#对象" class="headerlink" title="对象"></a>对象</h3><p>Map（属性和值）（键值对）的形式： key:(空格)v ：表示一堆键值对，空格不可省略。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">car:</span><br><span class="line">    color: red</span><br><span class="line">    brand: BMW</span><br></pre></td></tr></table></figure>
<p>一行写法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">car:&#123;color: red，brand: BMW&#125;</span><br></pre></td></tr></table></figure>
<p>相当于JSON格式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;color&quot;:&quot;red&quot;,&quot;brand&quot;:&quot;BMW&quot;&#125;</span><br></pre></td></tr></table></figure>
<h3 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h3><p>一组连词线开头的行，构成一个数组。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">brand:</span><br><span class="line">   - audi</span><br><span class="line">   - bmw</span><br><span class="line">   - ferrari</span><br></pre></td></tr></table></figure>
<p>一行写法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brand: [audi,bmw,ferrari]</span><br></pre></td></tr></table></figure>
<p>相当于JSON</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[&quot;auri&quot;,&quot;bmw&quot;,&quot;ferrari&quot;]</span><br></pre></td></tr></table></figure>
<h3 id="纯量"><a href="#纯量" class="headerlink" title="纯量"></a>纯量</h3><p>纯量是最基本的、不可再分的值。以下数据类型都属于 JavaScript 的纯量。</p>
<ul>
<li>字符串</li>
<li>布尔值</li>
<li>整数</li>
<li>浮点数</li>
<li>Null</li>
<li>时间</li>
<li>日期</li>
</ul>
<h1 id="补充-kafka安装部署"><a href="#补充-kafka安装部署" class="headerlink" title="补充-kafka安装部署"></a>补充-kafka安装部署</h1><h2 id="kafka-3"><a href="#kafka-3" class="headerlink" title="kafka"></a>kafka</h2><p>参考文档：</p>
<ul>
<li><a href="https://kafka.apache.org/11/documentation.html#quickstart" target="_blank" rel="noopener">https://kafka.apache.org/11/documentation.html#quickstart</a></li>
</ul>
<h3 id="启动-1"><a href="#启动-1" class="headerlink" title="启动"></a>启动</h3><p>启动zk</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bin/zookeeper-server-start.sh config/zookeeper.properties</span><br><span class="line">可以是：</span><br><span class="line">nohup bin/zookeeper-server-start.sh config/zookeeper.properties &gt; zk.log 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure>
<p>启动kafka</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bin/kafka-server-start.sh config/server.properties</span><br><span class="line">可以是</span><br><span class="line">nohup  bin/kafka-server-start.sh config/server.properties &gt; kafka.log 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure>
<h2 id="kafka-manager"><a href="#kafka-manager" class="headerlink" title="kafka-manager"></a>kafka-manager</h2><p>参考链接：</p>
<ul>
<li><a href="https://github.com/yahoo/kafka-manager/tree/1.3.3.16" target="_blank" rel="noopener">https://github.com/yahoo/kafka-manager/tree/1.3.3.16</a></li>
<li><a href="https://www.cnblogs.com/frankdeng/p/9584870.html" target="_blank" rel="noopener">https://www.cnblogs.com/frankdeng/p/9584870.html</a></li>
</ul>
<p>注意：.sbt/repositories文件中，每行后面不能有空格，每行都是以换行结尾的。如果存在空格，那么使用delete键删除。</p>
<h3 id="启动-2"><a href="#启动-2" class="headerlink" title="启动"></a>启动</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[admin@node21 kafka-manager-1.3.3.18]$ nohup bin/kafka-manager -Dconfig.file=conf/application.conf -Dhttp.port=8080 &amp;</span><br></pre></td></tr></table></figure>
<h1 id="补充-logrotate"><a href="#补充-logrotate" class="headerlink" title="补充-logrotate"></a>补充-logrotate</h1><p>参考链接：</p>
<ul>
<li><a href="https://linux.cn/article-4126-1.html" target="_blank" rel="noopener">https://linux.cn/article-4126-1.html</a></li>
<li><a href="https://linux.cn/article-8227-1.html" target="_blank" rel="noopener">https://linux.cn/article-8227-1.html</a></li>
</ul>
<p>注意：</p>
<p>在一个配置文件中，如果指定了多个日志文件，那么当第一个文件不需要进行轮转的时候，下面的文件就算需要进行轮转，也都会跳过，也就是说：当有多个日志文件时，下一个文件的操作，完全依赖上一个文件是否已经存在，当已经存在的时候，下面就不会再进行操作。</p>
<p>例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@node001 logrotate.d]# cat /etc/logrotate.d/syslog</span><br><span class="line">/var/log/cron</span><br><span class="line">/var/log/maillog</span><br><span class="line">&#123;</span><br><span class="line">    sharedscripts</span><br><span class="line">    create 0664 root root</span><br><span class="line">    postrotate</span><br><span class="line">	/bin/kill -HUP `cat /var/run/syslogd.pid 2&gt; /dev/null` 2&gt; /dev/null || true</span><br><span class="line">    endscript</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">logrotate /etc/logrotate.conf  -f</span><br></pre></td></tr></table></figure>
<p>强制生成新文件的时候，当cron的轮询文件已经存在，但是maillog不存在的时候，这个时候，将会不操作，也就是，不会对maillog进行日志轮转。</p>
<h1 id="补充-JVM知识"><a href="#补充-JVM知识" class="headerlink" title="补充-JVM知识"></a>补充-JVM知识</h1><h1 id="补充-lucene知识"><a href="#补充-lucene知识" class="headerlink" title="补充-lucene知识"></a>补充-lucene知识</h1>
      
    </div>
    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div></div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/wechatpay.jpg" alt="XiaoHua WANG 微信支付"/>
        <p>微信支付</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/alipay.jpg" alt="XiaoHua WANG 支付宝"/>
        <p>支付宝</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/ELK/" rel="tag"># ELK</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/06/18/IT科学技术知识体系结构-Linux运维方向/大数据/大数据科普/大数据科普/" rel="next" title="大数据科普">
                <i class="fa fa-chevron-left"></i> 大数据科普
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/06/18/IT科学技术知识体系结构-Linux运维方向/编程开发/Python/python从入门到实践/" rel="prev" title="python从入门到实践">
                python从入门到实践 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
        <!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
<span class="jiathis_txt">分享到：</span>
<a class="jiathis_button_fav">收藏夹</a>
<a class="jiathis_button_copy">复制网址</a>
<a class="jiathis_button_email">邮件</a>
<a class="jiathis_button_weixin">微信</a>
<a class="jiathis_button_qzone">QQ空间</a>
<a class="jiathis_button_tqq">腾讯微博</a>
<a class="jiathis_button_douban">豆瓣</a>
<a class="jiathis_button_share">一键分享</a>

<a href="http://www.jiathis.com/share?uid=2140465" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a>
<a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript" >
var jiathis_config={
  data_track_clickback:true,
  summary:"",
  shortUrl:false,
  hideMore:false
}
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=" charset="utf-8"></script>
<!-- JiaThis Button END -->
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="lv-container" data-id="city" data-uid="MTAyMC8zMzg1NC8xMDQwNw=="></div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/touxiang.jpg"
                alt="XiaoHua WANG" />
            
              <p class="site-author-name" itemprop="name">XiaoHua WANG</p>
              <p class="site-description motion-element" itemprop="description">Focus on Linux operations and development.</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">64</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">67</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">58</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#基础知识"><span class="nav-number">1.</span> <span class="nav-text">基础知识</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#实现架构"><span class="nav-number">1.1.</span> <span class="nav-text">实现架构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#架构说明"><span class="nav-number">1.2.</span> <span class="nav-text">架构说明</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Filebeat部署"><span class="nav-number">2.</span> <span class="nav-text">Filebeat部署</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#filebeat工作原理"><span class="nav-number">2.1.</span> <span class="nav-text">filebeat工作原理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#prospector"><span class="nav-number">2.1.1.</span> <span class="nav-text">prospector</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#harvester"><span class="nav-number">2.1.2.</span> <span class="nav-text">harvester</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Filebeat如何保持文件的状态？"><span class="nav-number">2.2.</span> <span class="nav-text">Filebeat如何保持文件的状态？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Filebeat如何确保至少一次分发"><span class="nav-number">2.3.</span> <span class="nav-text">Filebeat如何确保至少一次分发</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#filebeat安装配置"><span class="nav-number">2.4.</span> <span class="nav-text">filebeat安装配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#基础环境"><span class="nav-number">2.4.1.</span> <span class="nav-text">基础环境</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#下载"><span class="nav-number">2.4.2.</span> <span class="nav-text">下载</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置"><span class="nav-number">2.4.3.</span> <span class="nav-text">配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#启动"><span class="nav-number">2.4.4.</span> <span class="nav-text">启动</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#filebeat的模块"><span class="nav-number">2.5.</span> <span class="nav-text">filebeat的模块</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#filebeat的配置详解"><span class="nav-number">2.6.</span> <span class="nav-text">filebeat的配置详解</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#设置prospectors-探勘器、查找器"><span class="nav-number">2.6.1.</span> <span class="nav-text">设置prospectors- 探勘器、查找器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Multiline-多行合并管理"><span class="nav-number">2.6.2.</span> <span class="nav-text">Multiline-多行合并管理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#加载外部的配置文件"><span class="nav-number">2.6.3.</span> <span class="nav-text">加载外部的配置文件</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#prospector-config"><span class="nav-number">2.6.3.1.</span> <span class="nav-text">prospector config</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#动态重加载"><span class="nav-number">2.6.3.2.</span> <span class="nav-text">动态重加载</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#output配置"><span class="nav-number">2.7.</span> <span class="nav-text">output配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#es"><span class="nav-number">2.7.1.</span> <span class="nav-text">es</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#logstash"><span class="nav-number">2.7.2.</span> <span class="nav-text">logstash</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#kafka"><span class="nav-number">2.7.3.</span> <span class="nav-text">kafka</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#filebeat监控"><span class="nav-number">2.8.</span> <span class="nav-text">filebeat监控</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置文件权限问题"><span class="nav-number">2.9.</span> <span class="nav-text">配置文件权限问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#系统日志权限问题"><span class="nav-number">2.10.</span> <span class="nav-text">系统日志权限问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#filebea案例"><span class="nav-number">2.11.</span> <span class="nav-text">filebea案例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#收集终端标准输出"><span class="nav-number">2.11.1.</span> <span class="nav-text">收集终端标准输出</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Logstash"><span class="nav-number">3.</span> <span class="nav-text">Logstash</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#logstash概述"><span class="nav-number">3.1.</span> <span class="nav-text">logstash概述</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#logstash工作流"><span class="nav-number">3.1.1.</span> <span class="nav-text">logstash工作流</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#logstash术语表-glossary-of-terms"><span class="nav-number">3.2.</span> <span class="nav-text">logstash术语表-glossary of terms</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安装"><span class="nav-number">3.3.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置-1"><span class="nav-number">3.4.</span> <span class="nav-text">配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#filebeat-logstash配置案例"><span class="nav-number">3.4.1.</span> <span class="nav-text">filebeat+logstash配置案例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#grok过滤"><span class="nav-number">3.4.2.</span> <span class="nav-text">grok过滤</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#设置output为es"><span class="nav-number">3.4.3.</span> <span class="nav-text">设置output为es</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#启动参数"><span class="nav-number">3.4.4.</span> <span class="nav-text">启动参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#提取字段已经转变数据"><span class="nav-number">3.4.5.</span> <span class="nav-text">提取字段已经转变数据</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#logstash的-metadata字段"><span class="nav-number">3.5.</span> <span class="nav-text">logstash的@metadata字段</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#input部分"><span class="nav-number">3.6.</span> <span class="nav-text">input部分</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Common-option"><span class="nav-number">3.6.1.</span> <span class="nav-text">Common option</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#beats"><span class="nav-number">3.6.2.</span> <span class="nav-text">beats</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#kafka-1"><span class="nav-number">3.6.3.</span> <span class="nav-text">kafka</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#filter部分"><span class="nav-number">3.7.</span> <span class="nav-text">filter部分</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#grok"><span class="nav-number">3.7.1.</span> <span class="nav-text">grok</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#自定义pattern"><span class="nav-number">3.7.1.1.</span> <span class="nav-text">自定义pattern</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#overwrite"><span class="nav-number">3.7.1.2.</span> <span class="nav-text">overwrite</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#add-field"><span class="nav-number">3.7.1.3.</span> <span class="nav-text">add_field</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#remove-field"><span class="nav-number">3.7.1.4.</span> <span class="nav-text">remove_field</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#dissect"><span class="nav-number">3.7.2.</span> <span class="nav-text">dissect</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#字段追加"><span class="nav-number">3.7.2.1.</span> <span class="nav-text">字段追加</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#mutate"><span class="nav-number">3.7.3.</span> <span class="nav-text">mutate</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#replace"><span class="nav-number">3.7.3.1.</span> <span class="nav-text">replace</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#通用参数"><span class="nav-number">3.7.4.</span> <span class="nav-text">通用参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#if条件判断"><span class="nav-number">3.7.5.</span> <span class="nav-text">if条件判断</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#output部分"><span class="nav-number">3.8.</span> <span class="nav-text">output部分</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#kafka-2"><span class="nav-number">3.8.1.</span> <span class="nav-text">kafka</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Elasticsearch"><span class="nav-number">3.8.2.</span> <span class="nav-text">Elasticsearch</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#file"><span class="nav-number">3.8.3.</span> <span class="nav-text">file</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#codec部分"><span class="nav-number">3.9.</span> <span class="nav-text">codec部分</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#plain"><span class="nav-number">3.9.1.</span> <span class="nav-text">plain</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#line"><span class="nav-number">3.9.2.</span> <span class="nav-text">line</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#实际案例"><span class="nav-number">3.10.</span> <span class="nav-text">实际案例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#公网服务器日志收集"><span class="nav-number">3.10.1.</span> <span class="nav-text">公网服务器日志收集</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#nginx错误日志收集"><span class="nav-number">3.10.2.</span> <span class="nav-text">nginx错误日志收集</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Elasticsearch部署"><span class="nav-number">4.</span> <span class="nav-text">Elasticsearch部署</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ES工作原理"><span class="nav-number">4.1.</span> <span class="nav-text">ES工作原理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#基本概念"><span class="nav-number">4.1.1.</span> <span class="nav-text">基本概念</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#集群状态"><span class="nav-number">4.1.2.</span> <span class="nav-text">集群状态</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ES安装配置"><span class="nav-number">4.2.</span> <span class="nav-text">ES安装配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#基础环境配置"><span class="nav-number">4.2.1.</span> <span class="nav-text">基础环境配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#下载-1"><span class="nav-number">4.2.2.</span> <span class="nav-text">下载</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ES配置及配置文件详解"><span class="nav-number">4.2.3.</span> <span class="nav-text">ES配置及配置文件详解</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ES目录结构"><span class="nav-number">4.2.3.1.</span> <span class="nav-text">ES目录结构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#如何配置ES"><span class="nav-number">4.2.3.2.</span> <span class="nav-text">如何配置ES</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#重要配置参数说明"><span class="nav-number">4.2.3.3.</span> <span class="nav-text">重要配置参数说明</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#path-data和path-logs"><span class="nav-number">4.2.3.3.1.</span> <span class="nav-text">path.data和path.logs</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#cluster-name"><span class="nav-number">4.2.3.3.2.</span> <span class="nav-text">cluster.name</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#node-name"><span class="nav-number">4.2.3.3.3.</span> <span class="nav-text">node.name</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#bootstrap-memory-lock"><span class="nav-number">4.2.3.3.4.</span> <span class="nav-text">bootstrap.memory_lock</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#network-host"><span class="nav-number">4.2.3.3.5.</span> <span class="nav-text">network.host</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#discovery-zen-ping-unicast-hosts"><span class="nav-number">4.2.3.3.6.</span> <span class="nav-text">discovery.zen.ping.unicast.hosts</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#discovery-zen-minimum-master-nodes"><span class="nav-number">4.2.3.3.7.</span> <span class="nav-text">discovery.zen.minimum_master_nodes</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#网络相关配置汇总"><span class="nav-number">4.2.3.3.8.</span> <span class="nav-text">网络相关配置汇总</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ES的启动引导检查"><span class="nav-number">4.3.</span> <span class="nav-text">ES的启动引导检查</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#重要的系统配置"><span class="nav-number">4.4.</span> <span class="nav-text">重要的系统配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#JVM堆内存"><span class="nav-number">4.4.1.</span> <span class="nav-text">JVM堆内存</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#文件描述符"><span class="nav-number">4.4.2.</span> <span class="nav-text">文件描述符</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#关闭swap"><span class="nav-number">4.4.3.</span> <span class="nav-text">关闭swap</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#虚拟内存"><span class="nav-number">4.4.4.</span> <span class="nav-text">虚拟内存</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#最大线程数"><span class="nav-number">4.4.5.</span> <span class="nav-text">最大线程数</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ES集群部署"><span class="nav-number">4.5.</span> <span class="nav-text">ES集群部署</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ES集群配置"><span class="nav-number">4.5.1.</span> <span class="nav-text">ES集群配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#kibana配置"><span class="nav-number">4.5.2.</span> <span class="nav-text">kibana配置</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Mapping"><span class="nav-number">4.6.</span> <span class="nav-text">Mapping</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#mapping-type"><span class="nav-number">4.6.1.</span> <span class="nav-text">mapping type</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#字段数据类型"><span class="nav-number">4.6.2.</span> <span class="nav-text">字段数据类型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#动态mapping"><span class="nav-number">4.6.3.</span> <span class="nav-text">动态mapping</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#default-mapping"><span class="nav-number">4.6.3.1.</span> <span class="nav-text">_default_ mapping</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#明确mapping-Explicit-mappings"><span class="nav-number">4.6.4.</span> <span class="nav-text">明确mapping- Explicit mappings</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#更新已存在的mapping"><span class="nav-number">4.6.5.</span> <span class="nav-text">更新已存在的mapping</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#字段共享mapping"><span class="nav-number">4.6.6.</span> <span class="nav-text">字段共享mapping</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#案例"><span class="nav-number">4.6.7.</span> <span class="nav-text">案例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#元数据类型字段"><span class="nav-number">4.6.8.</span> <span class="nav-text">元数据类型字段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#字段数据类型-1"><span class="nav-number">4.6.9.</span> <span class="nav-text">字段数据类型</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#keyword数据类型"><span class="nav-number">4.6.9.1.</span> <span class="nav-text">keyword数据类型</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Text数据类型"><span class="nav-number">4.6.9.2.</span> <span class="nav-text">Text数据类型</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#二级字段类型-fields配置"><span class="nav-number">4.6.10.</span> <span class="nav-text">二级字段类型-fields配置</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ES-API"><span class="nav-number">4.7.</span> <span class="nav-text">ES API</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#API约定及惯例"><span class="nav-number">4.7.1.</span> <span class="nav-text">API约定及惯例</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#multiple-indices"><span class="nav-number">4.7.1.1.</span> <span class="nav-text">multiple indices</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Date-math-support-in-index-names"><span class="nav-number">4.7.1.2.</span> <span class="nav-text">Date math support in index names</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Common-option-1"><span class="nav-number">4.7.1.3.</span> <span class="nav-text">Common option</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#URL-based-access-control"><span class="nav-number">4.7.1.4.</span> <span class="nav-text">URL-based access control</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Document-APIs"><span class="nav-number">4.7.2.</span> <span class="nav-text">Document APIs</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Reading-and-Writing-documents-读写document"><span class="nav-number">4.7.2.1.</span> <span class="nav-text">Reading and Writing documents-读写document</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#基础写模型-Basic-write-model"><span class="nav-number">4.7.2.1.1.</span> <span class="nav-text">基础写模型- Basic write model</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#写失败处理"><span class="nav-number">4.7.2.1.2.</span> <span class="nav-text">写失败处理</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#基础读模型"><span class="nav-number">4.7.2.1.3.</span> <span class="nav-text">基础读模型</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#读失败处理"><span class="nav-number">4.7.2.1.4.</span> <span class="nav-text">读失败处理</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#新建document"><span class="nav-number">4.7.2.2.</span> <span class="nav-text">新建document</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#查询document"><span class="nav-number">4.7.2.3.</span> <span class="nav-text">查询document</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#删除document"><span class="nav-number">4.7.2.4.</span> <span class="nav-text">删除document</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Indices-APIs-索引api"><span class="nav-number">4.7.3.</span> <span class="nav-text">Indices APIs-索引api</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#创建索引"><span class="nav-number">4.7.3.1.</span> <span class="nav-text">创建索引</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#删除索引"><span class="nav-number">4.7.3.2.</span> <span class="nav-text">删除索引</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#查看索引"><span class="nav-number">4.7.3.3.</span> <span class="nav-text">查看索引</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#索引是否存在"><span class="nav-number">4.7.3.4.</span> <span class="nav-text">索引是否存在</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#put-mapping-mapping的新增"><span class="nav-number">4.7.3.5.</span> <span class="nav-text">put mapping-mapping的新增</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#get-mapping"><span class="nav-number">4.7.3.6.</span> <span class="nav-text">get mapping</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#获取具体字段的mapping"><span class="nav-number">4.7.3.7.</span> <span class="nav-text">获取具体字段的mapping</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#判断mapping-type是否存在"><span class="nav-number">4.7.3.8.</span> <span class="nav-text">判断mapping type是否存在</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#索引别名-index-aliases"><span class="nav-number">4.7.3.9.</span> <span class="nav-text">索引别名-index aliases</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#获取索引alias"><span class="nav-number">4.7.3.10.</span> <span class="nav-text">获取索引alias</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#索引模板"><span class="nav-number">4.7.3.11.</span> <span class="nav-text">索引模板</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#索引状态"><span class="nav-number">4.7.3.12.</span> <span class="nav-text">索引状态</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#refresh"><span class="nav-number">4.7.3.13.</span> <span class="nav-text">refresh</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#cat-apis"><span class="nav-number">4.7.4.</span> <span class="nav-text">cat apis</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#作用"><span class="nav-number">4.7.4.1.</span> <span class="nav-text">作用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#参数"><span class="nav-number">4.7.4.2.</span> <span class="nav-text">参数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#具体接口"><span class="nav-number">4.7.4.3.</span> <span class="nav-text">具体接口</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ES常用API"><span class="nav-number">4.7.5.</span> <span class="nav-text">ES常用API</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Search-api"><span class="nav-number">4.7.6.</span> <span class="nav-text">Search api</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#参数形式"><span class="nav-number">4.7.6.1.</span> <span class="nav-text">参数形式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#请求体形式"><span class="nav-number">4.7.6.2.</span> <span class="nav-text">请求体形式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#count"><span class="nav-number">4.7.6.3.</span> <span class="nav-text">count</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Cluster-api-集群api"><span class="nav-number">4.7.7.</span> <span class="nav-text">Cluster api-集群api</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Analyis-分词"><span class="nav-number">4.8.</span> <span class="nav-text">Analyis-分词</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Ik分词器"><span class="nav-number">4.8.1.</span> <span class="nav-text">Ik分词器</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#插件管理"><span class="nav-number">4.9.</span> <span class="nav-text">插件管理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Index-Modules-索引模块"><span class="nav-number">4.10.</span> <span class="nav-text">Index Modules-索引模块</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#slow-log"><span class="nav-number">4.10.1.</span> <span class="nav-text">slow log</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#slow-log实际案例"><span class="nav-number">4.10.2.</span> <span class="nav-text">slow log实际案例</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#查询DSL"><span class="nav-number">4.11.</span> <span class="nav-text">查询DSL</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#查询语句以及过滤语句"><span class="nav-number">4.11.1.</span> <span class="nav-text">查询语句以及过滤语句</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#full-text-query-全文查询"><span class="nav-number">4.11.2.</span> <span class="nav-text">full-text query-全文查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Term-Query-术语查询"><span class="nav-number">4.11.3.</span> <span class="nav-text">Term Query-术语查询</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#批处理-Batch-Processing"><span class="nav-number">4.12.</span> <span class="nav-text">批处理-Batch Processing</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Modules-ES组件"><span class="nav-number">4.13.</span> <span class="nav-text">Modules-ES组件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#node"><span class="nav-number">4.13.1.</span> <span class="nav-text">node</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#线程池-Thread-Pool"><span class="nav-number">4.13.2.</span> <span class="nav-text">线程池-Thread Pool</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#zen-discovery-集群发现过程"><span class="nav-number">4.13.3.</span> <span class="nav-text">zen discovery-集群发现过程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ES的Merge功能"><span class="nav-number">4.14.</span> <span class="nav-text">ES的Merge功能</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#基本概念："><span class="nav-number">4.14.1.</span> <span class="nav-text">基本概念：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#merge-scheduling"><span class="nav-number">4.14.2.</span> <span class="nav-text">merge scheduling</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#forcemerge"><span class="nav-number">4.14.3.</span> <span class="nav-text">forcemerge</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#merge优化"><span class="nav-number">4.14.4.</span> <span class="nav-text">merge优化</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ES数据查询"><span class="nav-number">4.15.</span> <span class="nav-text">ES数据查询</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#routing参数"><span class="nav-number">4.15.1.</span> <span class="nav-text">routing参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#search"><span class="nav-number">4.15.2.</span> <span class="nav-text">search</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#多索引及多type操作"><span class="nav-number">4.15.2.1.</span> <span class="nav-text">多索引及多type操作</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#URI-search"><span class="nav-number">4.15.2.2.</span> <span class="nav-text">URI search</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Request-body-search"><span class="nav-number">4.15.2.3.</span> <span class="nav-text">Request body search</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#From-size"><span class="nav-number">4.15.2.3.1.</span> <span class="nav-text">From/size</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sort"><span class="nav-number">4.15.2.3.2.</span> <span class="nav-text">sort</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#source-filtering"><span class="nav-number">4.15.2.3.3.</span> <span class="nav-text">_source filtering</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#search-template"><span class="nav-number">4.15.2.4.</span> <span class="nav-text">search template</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DSL-查询语句"><span class="nav-number">4.15.3.</span> <span class="nav-text">DSL-查询语句</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#score"><span class="nav-number">4.15.3.1.</span> <span class="nav-text">_score</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#query-and-filter-context"><span class="nav-number">4.15.3.2.</span> <span class="nav-text">query and filter context</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#match-all-query"><span class="nav-number">4.15.3.3.</span> <span class="nav-text">match all query</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#full-text-queries-text数据类型的全文内容检索"><span class="nav-number">4.15.3.4.</span> <span class="nav-text">full text queries-text数据类型的全文内容检索</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#match-query"><span class="nav-number">4.15.3.4.1.</span> <span class="nav-text">match query</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#multi-match-query"><span class="nav-number">4.15.3.4.2.</span> <span class="nav-text">multi match query</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#term-level-queries-术语级别查询"><span class="nav-number">4.15.3.5.</span> <span class="nav-text">term level queries-术语级别查询</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#term-query"><span class="nav-number">4.15.3.5.1.</span> <span class="nav-text">term query</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#terms-query"><span class="nav-number">4.15.3.5.2.</span> <span class="nav-text">terms query</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#range-query"><span class="nav-number">4.15.3.5.3.</span> <span class="nav-text">range query</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#exists-query"><span class="nav-number">4.15.3.5.4.</span> <span class="nav-text">exists query</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#复合查询"><span class="nav-number">4.15.4.</span> <span class="nav-text">复合查询</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#bool-query"><span class="nav-number">4.15.4.1.</span> <span class="nav-text">bool query</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#kibana查询数据"><span class="nav-number">4.15.5.</span> <span class="nav-text">kibana查询数据</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ES监控"><span class="nav-number">4.16.</span> <span class="nav-text">ES监控</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ES调优"><span class="nav-number">4.17.</span> <span class="nav-text">ES调优</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ES常见问题"><span class="nav-number">4.18.</span> <span class="nav-text">ES常见问题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#慢查慢写日志设置及收集"><span class="nav-number">4.18.1.</span> <span class="nav-text">慢查慢写日志设置及收集</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#热线程"><span class="nav-number">4.18.2.</span> <span class="nav-text">热线程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#节点多磁盘时分配不均匀"><span class="nav-number">4.18.3.</span> <span class="nav-text">节点多磁盘时分配不均匀</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ES扩容及缩容"><span class="nav-number">4.19.</span> <span class="nav-text">ES扩容及缩容</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#扩容"><span class="nav-number">4.19.1.</span> <span class="nav-text">扩容</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#缩容"><span class="nav-number">4.19.2.</span> <span class="nav-text">缩容</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#相关参数"><span class="nav-number">4.19.3.</span> <span class="nav-text">相关参数</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ES故障处理"><span class="nav-number">4.20.</span> <span class="nav-text">ES故障处理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#集群节点宕机导致shard-unassigned"><span class="nav-number">4.21.</span> <span class="nav-text">集群节点宕机导致shard unassigned</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#kibana部署"><span class="nav-number">5.</span> <span class="nav-text">kibana部署</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#安装部署"><span class="nav-number">5.1.</span> <span class="nav-text">安装部署</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ES数据如何展示在kibana上"><span class="nav-number">5.2.</span> <span class="nav-text">ES数据如何展示在kibana上</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#负载均衡"><span class="nav-number">5.3.</span> <span class="nav-text">负载均衡</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ES的监控指标如何展示在kibana上"><span class="nav-number">5.4.</span> <span class="nav-text">ES的监控指标如何展示在kibana上</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#kibana监控"><span class="nav-number">5.5.</span> <span class="nav-text">kibana监控</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#kibana搜索"><span class="nav-number">5.6.</span> <span class="nav-text">kibana搜索</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#lucence-query-syntax"><span class="nav-number">5.6.1.</span> <span class="nav-text">lucence query syntax</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#kibana-apm展示"><span class="nav-number">5.7.</span> <span class="nav-text">kibana apm展示</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#xpack-monitor监控"><span class="nav-number">5.8.</span> <span class="nav-text">xpack-monitor监控</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#在线方式安装"><span class="nav-number">5.8.1.</span> <span class="nav-text">在线方式安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#离线方式安装"><span class="nav-number">5.8.2.</span> <span class="nav-text">离线方式安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#xpack相关配置参数"><span class="nav-number">5.8.3.</span> <span class="nav-text">xpack相关配置参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#license更新"><span class="nav-number">5.8.4.</span> <span class="nav-text">license更新</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#补充-yaml语法"><span class="nav-number">6.</span> <span class="nav-text">补充-yaml语法</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#特点"><span class="nav-number">6.1.</span> <span class="nav-text">特点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#支持的数据结构"><span class="nav-number">6.2.</span> <span class="nav-text">支持的数据结构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#数据结构的书写形式"><span class="nav-number">6.3.</span> <span class="nav-text">数据结构的书写形式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#对象"><span class="nav-number">6.3.1.</span> <span class="nav-text">对象</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#数组"><span class="nav-number">6.3.2.</span> <span class="nav-text">数组</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#纯量"><span class="nav-number">6.3.3.</span> <span class="nav-text">纯量</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#补充-kafka安装部署"><span class="nav-number">7.</span> <span class="nav-text">补充-kafka安装部署</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#kafka-3"><span class="nav-number">7.1.</span> <span class="nav-text">kafka</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#启动-1"><span class="nav-number">7.1.1.</span> <span class="nav-text">启动</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#kafka-manager"><span class="nav-number">7.2.</span> <span class="nav-text">kafka-manager</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#启动-2"><span class="nav-number">7.2.1.</span> <span class="nav-text">启动</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#补充-logrotate"><span class="nav-number">8.</span> <span class="nav-text">补充-logrotate</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#补充-JVM知识"><span class="nav-number">9.</span> <span class="nav-text">补充-JVM知识</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#补充-lucene知识"><span class="nav-number">10.</span> <span class="nav-text">补充-lucene知识</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">XiaoHua WANG</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("mlSs9Cm0Xv2D9B7cFqbp25Df-gzGzoHsz", "alKheIFly9OVC81YCV7otTrf");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  
  

  

  

  

</body>
</html>
