<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="VPC," />





  <link rel="alternate" href="/atom.xml" title="Watchmen1992's Blog" type="application/atom+xml" />






<meta name="description" content="VPC相关知识记录">
<meta name="keywords" content="VPC">
<meta property="og:type" content="article">
<meta property="og:title" content="VPC从入门到实践">
<meta property="og:url" content="http://yoursite.com/2018/04/17/IT科学技术知识体系结构-Linux运维方向/公有云产品/阿里云/VPC从入门到实践/index.html">
<meta property="og:site_name" content="Watchmen1992&#39;s Blog">
<meta property="og:description" content="VPC相关知识记录">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://picture.watchmen.xin/vpc/VswitchandVrouter.png">
<meta property="og:image" content="http://picture.watchmen.xin/vpc/logic.png">
<meta property="og:image" content="http://picture.watchmen.xin/vpc/vpc_vpc.png">
<meta property="og:image" content="http://picture.watchmen.xin/vpc/vpc_classic.png">
<meta property="og:image" content="http://picture.watchmen.xin/vpc/classic_vpc.png">
<meta property="og:image" content="http://picture.watchmen.xin/vpc/vpc_internet.png">
<meta property="og:image" content="http://picture.watchmen.xin/vpc/vpc_internet2.png">
<meta property="og:image" content="http://picture.watchmen.xin/vpc/vpc_idc.png">
<meta property="og:image" content="http://picture.watchmen.xin/vpc/noun.png">
<meta property="og:image" content="http://picture.watchmen.xin/vpc/limit1.png">
<meta property="og:image" content="http://picture.watchmen.xin/vpc/limit2.png">
<meta property="og:image" content="http://picture.watchmen.xin/vpc/scene1.png">
<meta property="og:image" content="http://picture.watchmen.xin/vpc/scene2.png">
<meta property="og:image" content="http://picture.watchmen.xin/vpc/scene3.png">
<meta property="og:image" content="http://picture.watchmen.xin/vpc/scene4.png">
<meta property="og:image" content="http://picture.watchmen.xin/vpc/vpcconfig.png">
<meta property="og:image" content="http://picture.watchmen.xin/vpc/vpcswitchconfig.png">
<meta property="og:image" content="http://picture.watchmen.xin/vpc/creatvpc.png">
<meta property="og:image" content="http://picture.watchmen.xin/vpc/defaultvpc.png">
<meta property="og:image" content="http://picture.watchmen.xin/vpc/route_vpc_inter.png">
<meta property="og:image" content="http://picture.watchmen.xin/vpc/route_vpc_vpc.png">
<meta property="og:image" content="http://picture.watchmen.xin/vpc/route_vpc_vpn.png">
<meta property="og:image" content="http://picture.watchmen.xin/vpc/route_vpc_idc.png">
<meta property="og:image" content="http://picture.watchmen.xin/vpc/route_vpc_idc2.png">
<meta property="og:image" content="http://picture.watchmen.xin/vpc/vpc_route_config.png">
<meta property="og:image" content="http://picture.watchmen.xin/vpc/singlevpc.png">
<meta property="og:image" content="http://picture.watchmen.xin/vpc/mutlivpc1.png">
<meta property="og:image" content="http://picture.watchmen.xin/vpc/mutlivpc2.png">
<meta property="og:image" content="http://picture.watchmen.xin/vpc/qa4.png">
<meta property="og:updated_time" content="2018-04-17T05:57:23.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="VPC从入门到实践">
<meta name="twitter:description" content="VPC相关知识记录">
<meta name="twitter:image" content="http://picture.watchmen.xin/vpc/VswitchandVrouter.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2018/04/17/IT科学技术知识体系结构-Linux运维方向/公有云产品/阿里云/VPC从入门到实践/"/>





  <title>VPC从入门到实践 | Watchmen1992's Blog</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?07235ad5687ee838f373b31c7c687d23";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Watchmen1992's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">锦瑟年华当与书香为度，是为不负天地人生。</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/17/IT科学技术知识体系结构-Linux运维方向/公有云产品/阿里云/VPC从入门到实践/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="XiaoHua WANG">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/touxiang.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Watchmen1992's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">VPC从入门到实践</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-17T13:57:23+08:00">
                2018-04-17
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2018-04-17T13:57:23+08:00">
                2018-04-17
              </time>
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IT科学技术知识体系结构-Linux运维方向/" itemprop="url" rel="index">
                    <span itemprop="name">IT科学技术知识体系结构-Linux运维方向</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IT科学技术知识体系结构-Linux运维方向/公有云产品/" itemprop="url" rel="index">
                    <span itemprop="name">公有云产品</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IT科学技术知识体系结构-Linux运维方向/公有云产品/阿里云/" itemprop="url" rel="index">
                    <span itemprop="name">阿里云</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/04/17/IT科学技术知识体系结构-Linux运维方向/公有云产品/阿里云/VPC从入门到实践/" class="leancloud_visitors" data-flag-title="VPC从入门到实践">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          
              <div class="post-description">
                  VPC相关知识记录
              </div>
          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>参考文献：</p>
<ul>
<li><a href="https://help.aliyun.com/product/27706.html" target="_blank" rel="noopener">阿里云-VPC官方帮助文档</a></li>
</ul>
<h1 id="VPC基础知识"><a href="#VPC基础知识" class="headerlink" title="VPC基础知识"></a>VPC基础知识</h1><h2 id="VPC概述"><a href="#VPC概述" class="headerlink" title="VPC概述"></a>VPC概述</h2><p>专有网络VPC（Virtual Private Cloud）是用户基于阿里云创建的<strong><code>自定义私有网络</code></strong>, 不同的专有网络之间二层逻辑隔离，用户可以在自己创建的专有网络内创建和管理云产品实例，比如ECS、负载均衡、RDS等。</p>
<p><strong>特点</strong></p>
<blockquote>
<p>专有网络VPC（Virtual Private Cloud）是基于阿里云构建的一个隔离的网络环境。每个专有网络（也就是每个VPC）之间逻辑上彻底隔离。</p>
<p>专有网络是独有的的云上私有网络。用户可以完全掌控自己的专有网络，例如选择IP地址范围、配置路由表和网关等，可以在自己定义的专有网络中使用阿里云资源如ECS、RDS、SLB等。</p>
<p>可以将专有网络连接到其他专有网络，或本地网络（这里的本地网络包括IDC和公司内部机房），形成一个按需定制的网络环境，实现应用的平滑迁移上云和对数据中心的扩展。</p>
<p>【默认情况下，VPC内主机是无法与外网连接的。这里需要借助阿里云的公网介入产品，例如弹性公网IP、NAT网关、负载均衡等】</p>
</blockquote>
<p><strong>VPC重点内容小结：</strong></p>
<ul>
<li>不同用户的云服务器部署在不同的专有网络里。</li>
<li>不同专有网络之间通过隧道ID进行隔离。专有网络内部由于交换机和路由器的存在，所以可以像传统网络环境一样划分子网，每一个子网内部的不同云服务器使用同一个交换机互联，不同子网间使用路由器互联。</li>
<li>不同专有网络之间内部网络完全隔离，只能通过对外映射的IP（弹性公网IP和NAT IP）互联。</li>
<li>由于使用隧道封装技术对云服务器的IP报文进行封装，所以云服务器的数据链路层（二层MAC地址）信息不会进入物理网络，实现了不同云服务器间二层网络隔离，因此也实现了不同专有网络间二层网络隔离。</li>
<li>专有网络内的ECS使用安全组防火墙进行三层网络访问控制。</li>
</ul>
<h2 id="VPC中的路由器和交换机"><a href="#VPC中的路由器和交换机" class="headerlink" title="VPC中的路由器和交换机"></a>VPC中的路由器和交换机</h2><p><strong>路由器（VRouter）</strong>是专有网络的枢纽。作为专有网络中重要的功能组件，它可以连接VPC内的各个交换机，同时也是连接VPC和其他网络的网关设备。每个专有网络创建成功后，系统会自动创建一个路由器。每个路由器关联一张路由表。更多信息，参见路由。</p>
<p><strong>交换机（VSwitch）</strong>是组成专有网络的基础网络设备，用来连接不同的云产品实例。创建专有网络之后，您可以通过创建交换机为专有网络划分一个或多个子网。同一专有网络内的不同交换机之间内网互通。您可以将应用部署在不同可用区的交换机内，提高应用的可用性。</p>
<blockquote>
<p>说明：交换机不支持组播和广播。您可以通过阿里云提供的组播代理工具实现组播代理。详情参见组播代理概述。</p>
</blockquote>
<p>整体拓扑架构<br>如下图所示：</p>
<p><img src="http://picture.watchmen.xin/vpc/VswitchandVrouter.png" alt="路由器和交换机"></p>
<p><strong>VPC可以使用的私网地址范围：</strong></p>
<p>在创建专有网络和交换机时，您需要以CIDR地址块的形式指定专有网络使用的私网网段。关于CIDR的相关信息，参见维基百科上的Classless Inter-Domain Routing条目说明。</p>
<p>您可以使用下表中标准的私网网段及其子网作为VPC的私网地址。<strong><code>专有网络创建成功之后，无法修改网段。</code></strong>建议使用比较大的网段，尽量避免后续扩容。</p>
<table>
<thead>
<tr>
<th style="text-align:center">网段</th>
<th style="text-align:center">可用私网IP数量 （不包括系统保留）</th>
<th style="text-align:center">IP地址范围</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">192.168.0.0/16</td>
<td style="text-align:center">65532</td>
<td style="text-align:center">192.168.0.0-192.168.255.255</td>
</tr>
<tr>
<td style="text-align:center">172.16.0.0/12</td>
<td style="text-align:center">1048572</td>
<td style="text-align:center">172.16.0.0-172.31.255.255</td>
</tr>
<tr>
<td style="text-align:center">10.0.0.0/8</td>
<td style="text-align:center">16777212</td>
<td style="text-align:center">10.0.0.0-10.255.255.255</td>
</tr>
</tbody>
</table>
<p>最终每个网段的可用IP数量要总数减去4（系统去掉了0以及保留了最后3个）</p>
<p>交换机的网段不能和所属的专有网络的网段重叠，可以是其子集或者相同，网段大小在<strong><code>16位网络掩码与29位网络掩码</code></strong>之间。 如果交换机的网段和专有网络的网段相同，您只能创建一个交换机。</p>
<p>更多网络规划的信息，参考VPC网络规划。</p>
<p><strong>关系梳理：</strong></p>
<blockquote>
<p>一个VPC（专有网络）是一个大网段，例如：192.168.0.0/16</p>
<p>如果掩码是24位，那么这里一共可以划分出来2^8=256个子网</p>
<ul>
<li>每一个可用区的可用主机数量为：2^8=256个（可用的为252个，剔除了0和255、254、253)</li>
</ul>
<p>一个交换机在一个可用区中，一个交换机也就是一个子网，路由器连接的是每个交换机，对外的网段是VPC的网段。</p>
</blockquote>
<h2 id="基础架构及实现原理"><a href="#基础架构及实现原理" class="headerlink" title="基础架构及实现原理"></a>基础架构及实现原理</h2><h3 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h3><p>随着云计算的不断发展，对虚拟化网络的要求越来越高，比如弹性（scalability）、安全性（security）、可靠性（reliability）和私密性（privacy），并且还有极高的互联性能（performance）需求，因此催生了多种多样的网络虚拟化技术。</p>
<p>比较早的解决方案，是将虚拟机的网络和物理网络融合在一起，形成一个扁平的网络架构，例如大二层网络。随着虚拟化网络规模的扩大，这种方案中的<strong><code>ARP欺骗、广播风暴、主机扫描</code></strong>等问题会越来越严重。为了解决这些问题，出现了各种网络隔离技术，把物理网络和虚拟网络彻底隔开。其中一种技术是用户之间用VLAN进行隔离，<strong><code>但是VLAN的数量最大只能支持到4096个</code></strong>，无法支撑公共云的巨大用户量。</p>
<h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><p>基于目前主流的隧道技术，专有网络（Virtual Private Cloud，简称VPC）隔离了虚拟网络。每个VPC都有一个独立的隧道号，一个隧道号对应着一个虚拟化网络。一个VPC内的ECS（Elastic Compute Service）实例之间的传输数据包都会加上隧道封装，带有唯一的隧道ID标识，然后送到物理网络上进行传输。不同VPC内的ECS实例因为所在的隧道ID不同，本身处于两个不同的路由平面，所以不同VPC内的ECS实例无法进行通信，天然地进行了隔离。</p>
<p>基于隧道技术和软件定义网络（Software Defined Network，简称SDN）技术，阿里云的研发在硬件网关和自研交换机设备的基础上实现了VPC产品。</p>
<h3 id="逻辑架构"><a href="#逻辑架构" class="headerlink" title="逻辑架构"></a>逻辑架构</h3><p>如下图所示，VPC包含交换机、网关和控制器三个重要的组件。交换机和网关组成了数据通路的关键路径，<strong><code>控制器</code></strong>使用自研的协议<strong><code>下发转发表</code></strong>到<strong><code>网关和交换机</code></strong>，完成了配置通路的关键路径。整体架构里面，配置通路和数据通路互相分离。<strong><code>交换机是分布式的结点</code></strong>，网关和控制器都是集群部署并且是多机房互备的，并且所有链路上都有冗余容灾，提升了VPC产品的整体可用性。</p>
<p>交换机和网关性能在业界都是领先的。自研的SDN协议和控制器，能轻松管控公共云成千上万张虚拟网络。</p>
<p><img src="http://picture.watchmen.xin/vpc/logic.png" alt="实现原理"></p>
<h2 id="VPC通信"><a href="#VPC通信" class="headerlink" title="VPC通信"></a>VPC通信</h2><p>专有网络是完全隔离的网络环境。默认情况下，相同专有云网络内的ECS和云服务可以进行私网通信，但VPC与VPC之间、VPC与经典网络或公网不能互通。您可以使用弹性公网IP、高速通道、NAT、VPN网关或公网负载均衡等公网产品实现专有网络间的通信。</p>
<ul>
<li><p>VPC与VPC通信</p>
</li>
<li><p>VPC与经典网络通信</p>
</li>
<li><p>VPC与Internet通信</p>
</li>
<li><p>VPC与本地IDC通信</p>
</li>
</ul>
<h3 id="VPC与VPC通信"><a href="#VPC与VPC通信" class="headerlink" title="VPC与VPC通信"></a>VPC与VPC通信</h3><p>默认情况，不同专有网络间的ECS不能直接进行私网通信。</p>
<p>您可以使用<strong><code>高速通道</code></strong>的路由器接口，在两侧VPC的路由器上分别<strong><code>创建路由器接口</code></strong>，以及自有的骨干传输网络来搭建高速通道，轻松实现VPC之间安全可靠、方便快捷的通信。配置详情参考同账号下专有网络内网互通。</p>
<p><img src="http://picture.watchmen.xin/vpc/vpc_vpc.png" alt=""></p>
<h3 id="VPC与经典网络通信"><a href="#VPC与经典网络通信" class="headerlink" title="VPC与经典网络通信"></a>VPC与经典网络通信</h3><p>默认专有网络内的ECS不能访问经典网络的ECS或者云服务。</p>
<p><strong>VPC访问经典网络</strong></p>
<p>VPC与经典网络可以通过公网IP进行通信。只要VPC和经典网络中的ECS实例或云实例的公网IP符合下表中的任意一一条要求，专有网络就可以访问经典网络的云服务。</p>
<p><img src="http://picture.watchmen.xin/vpc/vpc_classic.png" alt=""></p>
<p><strong>经典网络访问VPC</strong></p>
<p>经典网络也可以通过公网IP访问VPC，只要VPC中的ECS实例或云服务也配置了公网IP。</p>
<p><img src="http://picture.watchmen.xin/vpc/classic_vpc.png" alt=""></p>
<h3 id="VPC与Internel通信"><a href="#VPC与Internel通信" class="headerlink" title="VPC与Internel通信"></a>VPC与Internel通信</h3><p>默认情况下，专有网络内的ECS不能与公网互通。您可以通过以下途径中的一种打通VPC与公网的通信：</p>
<ul>
<li><p>为专有网络中的ECS实例分配公网IP，实现专有网络与公网的通信。详情参考分配公网IP。</p>
</li>
<li><p>您可以通过在ECS上绑定弹性公网IP（EIP），实现专有网络与公网的互通。详情参考弹性公网IP。</p>
</li>
</ul>
<p><img src="http://picture.watchmen.xin/vpc/vpc_internet.png" alt=""></p>
<ul>
<li>在专有网络的ECS上设置NAT网关，实现专有网络与公网的互通。详情参考端口映射和SNAT设置。</li>
</ul>
<p><img src="http://picture.watchmen.xin/vpc/vpc_internet2.png" alt=""></p>
<blockquote>
<p>如果您有多台ECS需要和公网互通，您可以使用NAT网关的共享带宽包，一个带宽包内的所有ECS实例共享带宽，以节省您的费用。</p>
</blockquote>
<ul>
<li>专有网络的ECS实例添加到一个公网负载均衡实例中。详情参考配置公网负载均衡。<blockquote>
<p>此情形下，专有网络中的ECS实例不能访问公网，只能接收负载均衡转发的公网请求。</p>
</blockquote>
</li>
</ul>
<h3 id="VPC与本地IDC通信"><a href="#VPC与本地IDC通信" class="headerlink" title="VPC与本地IDC通信"></a>VPC与本地IDC通信</h3><p>默认情况下，本地IDC网络中心和专有网络之间不能通信，您可以通过以下途径打通本地IDC与VPC之间的通信：</p>
<ul>
<li>您可以使用高速通道的物理专线来连通本地IDC到阿里云的专线接入点，并建立虚拟边界路由器作为VPC到IDC的数据转发桥梁。详情参考专线接入。</li>
</ul>
<p><img src="http://picture.watchmen.xin/vpc/vpc_idc.png" alt=""></p>
<ul>
<li>您可以使用VPN网关来实现本地IDC网络中心与专有网络的互通，详情参考搭建VPN网关。</li>
</ul>
<h2 id="名词解释"><a href="#名词解释" class="headerlink" title="名词解释"></a>名词解释</h2><p><img src="http://picture.watchmen.xin/vpc/noun.png" alt=""></p>
<p><strong>注意：</strong> 路由条目包括系统路由和自定义路由两种类型。</p>
<h2 id="使用限制"><a href="#使用限制" class="headerlink" title="使用限制"></a>使用限制</h2><p><img src="http://picture.watchmen.xin/vpc/limit1.png" alt=""></p>
<p><img src="http://picture.watchmen.xin/vpc/limit2.png" alt=""></p>
<p><strong>注意：</strong></p>
<ul>
<li>每个VPC只有一个路由器，也就只有一张路由表</li>
<li>每个VPC可以容纳的云产品数量最多为15000个</li>
<li>路由器不支持动态路由协议</li>
<li>交换机不支持二层的广播个组播</li>
</ul>
<h2 id="VPC应用场景"><a href="#VPC应用场景" class="headerlink" title="VPC应用场景"></a>VPC应用场景</h2><p>此部分介绍了专有网络常用的使用场景和架构：</p>
<ul>
<li>场景一：本地数据中心+云上业务的混合云模式</li>
</ul>
<ul>
<li>场景二：多租户的安全隔离</li>
</ul>
<ul>
<li>场景三：主动访问公网的抓取类业务</li>
</ul>
<ul>
<li>场景四：多个应用流量波动大——共享带宽包</li>
</ul>
<h3 id="场景一：本地数据中心-云上对外业务的混合云模式"><a href="#场景一：本地数据中心-云上对外业务的混合云模式" class="headerlink" title="场景一：本地数据中心+云上对外业务的混合云模式"></a>场景一：本地数据中心+云上对外业务的混合云模式</h3><p>如果您有以下业务需求，建议您使用VPC+高速通道+ECS+RDS的配置架构。</p>
<ul>
<li>将<strong><code>内部核心系统与核心数据放置在自建数据中心</code></strong>以确保核心数据的安全；</li>
</ul>
<ul>
<li>云上部署<strong><code>对外</code></strong>客户的应用系统，实时应对业务访问量激增。</li>
</ul>
<p><strong>架构解读：</strong> 使用VPC、RDS、ECS搭建云上业务系统，核心数据部署在云下自建数据中心，使用高速通道专线接入保证云上数据快速同步，实现云上云下数据互通，搭建一个混合云使用环境。</p>
<p><img src="http://picture.watchmen.xin/vpc/scene1.png" alt=""></p>
<h3 id="场景二：多租户的安全隔离"><a href="#场景二：多租户的安全隔离" class="headerlink" title="场景二：多租户的安全隔离"></a>场景二：多租户的安全隔离</h3><p>如果您有以下业务需求，建议使用VPC+ECS+RDS+SLB的配置架构。</p>
<ul>
<li>希望在云上构建一个完全隔离的业务环境，因为传统云架构的多租户共享机制不能保证数据安全；</li>
</ul>
<ul>
<li>自主定义私有网络配置。</li>
</ul>
<p><strong>架构解读：</strong>您可以在阿里云上创建一个专有网络，和其他租户的网络完全隔离。您可以完全掌控自己的虚拟网络，例如选择自己的IP地址范围、划分网段、配置路由表和网关等，从而实现安全而轻松的资源访问和应用程序访问。此外，您也可以通过专线或VPN等连接方式将您的专有网络与传统数据中心相连，形成一个按需定制的网络环境，实现应用的平滑迁移上云和对数据中心的扩展。</p>
<p><img src="http://picture.watchmen.xin/vpc/scene2.png" alt=""></p>
<h3 id="场景三：主动访问公网的抓取类业务"><a href="#场景三：主动访问公网的抓取类业务" class="headerlink" title="场景三：主动访问公网的抓取类业务"></a>场景三：主动访问公网的抓取类业务</h3><p>如果您有以下业务需求，建议使用VPC+ECS+NAT网关的配置架构。</p>
<ul>
<li>专有网络中的多个服务器可以主动访问互联网；</li>
</ul>
<ul>
<li>避免这些服务器的公网IP暴露在公网上。</li>
</ul>
<p><strong>架构解读：</strong> 您可以对专有网络中的同一虚拟交换机下的所有ECS做SNAT配置，多台ECS通过同一公网IP访问互联网，并可随时进行公网IP替换，避免被外界攻击。</p>
<p><img src="http://picture.watchmen.xin/vpc/scene3.png" alt=""></p>
<h3 id="场景四：多个应用流量波动大——共享带宽包"><a href="#场景四：多个应用流量波动大——共享带宽包" class="headerlink" title="场景四：多个应用流量波动大——共享带宽包"></a>场景四：多个应用流量波动大——共享带宽包</h3><p>如果您有以下需求，建设使用VPC+NAT网关+ECS的配置架构。</p>
<ul>
<li>系统中同时存在多个面向互联网的应用；</li>
</ul>
<ul>
<li>各个应用都需要对外提供服务，并且其波峰时间点不一致。</li>
</ul>
<p><strong>架构解读：</strong>您可以购买多个专有网络类型的ECS，分别承载不同的应用业务，前端挂载NAT网关，通过配置DNAT IP转发规则实现多IP共享带宽功能，减轻波峰波谷效应，从而减少您的成本。</p>
<p><img src="http://picture.watchmen.xin/vpc/scene4.png" alt=""></p>
<h2 id="NAT网关"><a href="#NAT网关" class="headerlink" title="NAT网关"></a>NAT网关</h2><p>SNAT：在NAT网关上操作，接受到后端ECS主机发送来的数据包时，将源IP地址，修改为自身的IP地址，堆外隐藏内部的信息，是内部主动对外的</p>
<p>DNAT：在NAT网关上操作，接受到internet发送过来的数据包时，将目的IP地址进行修改（这个时候是NAT网关的地址），修改成为内部ECS主机的IP地址。用于后端多套系统共享带宽。</p>
<p>S：源是NAT网关</p>
<p>D:目的地是NAT网关</p>
<hr>
<h1 id="入门实践"><a href="#入门实践" class="headerlink" title="入门实践"></a>入门实践</h1><h2 id="搭建专有网络"><a href="#搭建专有网络" class="headerlink" title="搭建专有网络"></a>搭建专有网络</h2><p>本教程将指引您搭建一个专有网络，并为专有网络中的ECS实例绑定一个弹性公网IP（EIP）进行公网访问。</p>
<p><strong>参考文献:</strong> <a href="https://help.aliyun.com/document_detail/65430.html?spm=a2c4g.11186623.6.549.DUeCbh" target="_blank" rel="noopener">官方帮助文档-搭建专有网络</a></p>
<h3 id="步骤1-创建专有网络和交换机"><a href="#步骤1-创建专有网络和交换机" class="headerlink" title="步骤1 创建专有网络和交换机"></a>步骤1 创建专有网络和交换机</h3><p>在专有网络中部署云资源，您必须至少创建一台交换机。完成以下操作步骤，创建专有网络和交换机：</p>
<ol>
<li><p>登录专有网络管理控制台。</p>
</li>
<li><p>在顶部菜单栏，选择专有网络的地域。</p>
</li>
</ol>
<p><strong>注意：</strong>专有网络的地域和要部署的云资源的地域必须相同，本操作选择华北2（也就是北京地域）。</p>
<ol>
<li>单击创建专有网络，根据以下信息配置专有网络和交换机，然后单击确定。</li>
</ol>
<p><strong>配置对照表：</strong></p>
<p><img src="http://picture.watchmen.xin/vpc/vpcconfig.png" alt=""></p>
<p><img src="http://picture.watchmen.xin/vpc/vpcswitchconfig.png" alt=""></p>
<p><strong>创建如下图所示：</strong></p>
<p><img src="http://picture.watchmen.xin/vpc/creatvpc.png" alt=""></p>
<p><strong>注意：</strong></p>
<blockquote>
<p>每个交换机的第一个和最后三个IP地址为系统保留地址。</p>
<p>例如/20的掩码，可以使用的IP范围应该是4094个（2^12-2=4096-2=4094），但是实际平台上显示可分配使用IP为4092个，因为有4个已经被系统占用（以172.16.0.0/20为例，172.176.0.0、172.31.255.253、172.31.255.254和172.31.255.255这些地址是系统保留地址。）</p>
</blockquote>
<h3 id="步骤二-创建ECS实例"><a href="#步骤二-创建ECS实例" class="headerlink" title="步骤二 创建ECS实例"></a>步骤二 创建ECS实例</h3><p>完成以下操作，在已创建的VPC中创建一个ECS实例：</p>
<ol>
<li>在专有网络控制台的左侧导航栏，单击交换机。</li>
<li>选择交换机的地域，本操作选择华北1。</li>
<li>找到已创建的交换机，然后单击购买 &gt; ECS实例。</li>
<li><p>配置ECS实例后，单击立即购买。</p>
<p> 本操作中ECS实例的网络配置如下：</p>
<ul>
<li>网络：选择已创建的专有网络和交换机。</li>
<li>公网IP地址：选择不分配。</li>
</ul>
</li>
<li><p>返回ECS管理控制台，查看已创建的ECS实例。</p>
</li>
</ol>
<h3 id="步骤三-创建EIP"><a href="#步骤三-创建EIP" class="headerlink" title="步骤三 创建EIP"></a>步骤三 创建EIP</h3><p>弹性公网IP（EIP）是可以独立购买和持有的公网IP地址资源。完成以下操作，创建EIP：</p>
<ol>
<li>在专有网络控制台的左侧导航栏，单击弹性公网IP。</li>
<li>选择EIP的地域，然后单击申请弹性公网IP。本操作，选择华北1。</li>
<li>配置EIP，完成支付。</li>
</ol>
<h3 id="步骤四-绑定EIP"><a href="#步骤四-绑定EIP" class="headerlink" title="步骤四 绑定EIP"></a>步骤四 绑定EIP</h3><p>完成以下操作，将EIP绑定到已创建的ECS实例上：</p>
<ol>
<li>在专有网络控制台的左侧导航栏，单击弹性公网IP。</li>
<li>选择EIP的地域。</li>
<li>找到已创建的EIP，然后单击绑定。</li>
<li>在弹出的对话框中，实例类型选择ECS实例，然后选择已创建的ECS实例。</li>
<li>单击确定。</li>
</ol>
<h3 id="步骤五-公网访问测试"><a href="#步骤五-公网访问测试" class="headerlink" title="步骤五 公网访问测试"></a>步骤五 公网访问测试</h3><p>以上4和步骤均省略，可以自行查看文档</p>
<h2 id="ECS安全组配置"><a href="#ECS安全组配置" class="headerlink" title="ECS安全组配置"></a>ECS安全组配置</h2><p>这部分内容见官方文档：</p>
<ul>
<li><a href="https://help.aliyun.com/document_detail/65408.html?spm=a2c4g.11186623.6.552.HqSE0R" target="_blank" rel="noopener">官方文档1</a></li>
<li><a href="https://help.aliyun.com/document_detail/25387.html?spm=a2c4g.11186623.2.3.fLHLD5" target="_blank" rel="noopener">官方文档2</a></li>
</ul>
<h2 id="交换机"><a href="#交换机" class="headerlink" title="交换机"></a>交换机</h2><p>交换机（VSwitch）是组成专有网络的基础网络设备，用来连接不同的云产品实例。创建专有网络之后，您可以通过创建交换机为专有网络划分一个或多个子网，同一专有网络内的不同交换机之间内网互通。</p>
<p>您可以将应用部署在不同可用区的交换机内，提高应用的可用性。</p>
<blockquote>
<p>交换机不支持组播和广播。您可以通过阿里云提供的组播代理工具实现组播代理。详情参见组播代理概述。</p>
</blockquote>
<h3 id="交换机的网段"><a href="#交换机的网段" class="headerlink" title="交换机的网段"></a>交换机的网段</h3><p>在创建交换机时，您需要以CIDR地址块的形式指定交换机的私网网段，交换机的网段限制如下：</p>
<ul>
<li>交换机的网段可以和其所属的VPC网段相同或者是其VPC网段的子集。</li>
</ul>
<p>例如，VPC的网段是192.168.0.0/16，那么该VPC内的交换机的网段可以是192.168.0.0/16，也可以是192.168.0.0/17，一直到192.168.0.0/29。</p>
<p>说明：如果您的交换机网段和所属VPC网段相同，您只能在该VPC下创建一台交换机。</p>
<ul>
<li>交换机的网段的大小在16位网络掩码与29位网络掩码之间，可提供8-65536个地址。</li>
</ul>
<ul>
<li>每个交换机的第一个和最后三个IP地址为系统保留地址。</li>
</ul>
<p>以192.168.1.0/24为例，192.168.1.0、 192.168.1.253、 192.168.1.254和192.168.1.255这些地址是系统保留地址。</p>
<ul>
<li>交换机网段的确定还需要考虑该交换机下容纳的主机的数量。</li>
</ul>
<ul>
<li><font color="red"><strong>如果该交换机有和其他专有网络的交换机，或本地数据中心通信的需求，确保交换机的网段和要通信的网段不冲突。</strong></font>

</li>
</ul>
<h3 id="默认的专有网络和交换机"><a href="#默认的专有网络和交换机" class="headerlink" title="默认的专有网络和交换机"></a>默认的专有网络和交换机</h3><p>当创建一个云产品实例时，如果您没有提前创建专有网络和交换机，您可以使用系统提供的默认专有网络配置。在实例创建后，一个默认的专有网络和交换机也会随之创建好。</p>
<p><strong>说明：</strong>每个地域只有一个默认专有网络，但每个专有网络内的每个可用区都可创建一个默认交换机。</p>
<p>默认专有网和交换机的配置如下表所示。</p>
<p><img src="http://picture.watchmen.xin/vpc/defaultvpc.png" alt=""></p>
<h2 id="路由表和路由条目"><a href="#路由表和路由条目" class="headerlink" title="路由表和路由条目"></a>路由表和路由条目</h2><p>创建专有网络时，系统会为该专有网络自动创建一个路由器和一张路由表。</p>
<p>路由表中的每一项是一条路由条目。路由条目指定了网络流量的导向目的地，由<strong><code>目标网段、下一跳类型、下一跳</code></strong>三部分组成。路由条目包括系统路由和自定义路由。</p>
<p>您不可以直接删除专有网络的路由器或路由表，但可以在路由表中添加自定义路由条目转发流量。删除VPC后，关联的路由器和路由表也会随之删除。</p>
<h3 id="系统路由"><a href="#系统路由" class="headerlink" title="系统路由"></a>系统路由</h3><p>创建VPC时，系统会自动添加一条目标网段为100.64.0.0/10的系统路由用于VPC内的云产品通信。另外，阿里云也会为交换机自动添加一条以交换机网段为目标网段的系统路由。</p>
<p>我们不可以创建，也不能删除系统路由。</p>
<p>比如我创建了一个网段为192.168.0.0/16的专有网络，并在该专有网络下创建了两个网段为192.168.1.0/24和192.168.0.0/24的交换机，则该专有网络的路由表中会有如下三条系统路由：</p>
<pre><code>目标网段            下一跳类型    下一跳        类型
100.64.0.0/10            -        -        系统
192.168.1.0/24            -        -        系统
192.168.0.0/24            -        -        系统
</code></pre><h3 id="自定义路由"><a href="#自定义路由" class="headerlink" title="自定义路由"></a>自定义路由</h3><p>您可以根据需要，添加自定义路由。针对不同的功能，专有网络提供如下<font color="red"><strong><code>下一跳类型</code></strong></font>的路由：</p>
<ul>
<li><p><strong>ECS实例：</strong>将指向目标网段的流量转发到专有网络内的一台ECS实例上。</p>
<p>  当需要通过该ECS实例部署的应用访问互联网或其他应用时，配置此类型的路由。【一般是网关管理类应用服务器】</p>
<p>  适用于将指定网络访问路由至ECS实例进行流量统一转发和管理的场景，例如将一台ECS实例配置为公网网关管理其他ECS实例访问公网。</p>
</li>
</ul>
<ul>
<li><p><strong>VPN网关：</strong>将指向目标网段的流量转发到一个VPN网关上。</p>
<p>  当需要通过VPN网关连接本地网络或者其他专有网络时，配置此类型的路由。</p>
</li>
</ul>
<ul>
<li><p><strong>专有网络：</strong>将来指向标网段的流量转发到一个专有网络内。</p>
<p>  当需要使用高速通道连接两个专有网络时，配置此类型的路由。</p>
</li>
</ul>
<ul>
<li><p><strong>边界路由器：</strong>将指向目标网段的流量转发到一个边界路由器上。</p>
<p>  当需要使用高速通道连接本地网络（物理专线接入）时，才需要配置此类型的路由。</p>
</li>
</ul>
<h3 id="选路规则"><a href="#选路规则" class="headerlink" title="选路规则"></a>选路规则</h3><p>路由表采用最长前缀匹配原则作为流量的路由选路规则。最长前缀匹配是指当路由表中有多条条目可以匹配目的IP时，采用掩码最长（最精确）的一条路由作为匹配项并确定下一跳。</p>
<h3 id="路由实例"><a href="#路由实例" class="headerlink" title="路由实例"></a>路由实例</h3><h4 id="VPC内网路由"><a href="#VPC内网路由" class="headerlink" title="VPC内网路由"></a>VPC内网路由</h4><p>当您在VPC内的一台ECS实例（ECS01）自建了NAT网关或绑定了弹性公网IP，您需要专有网络内的云资源通过该ECS实例访问公网时（实际上是<strong><code>被外部访问</code></strong>），可以添加如下一条自定义路由：</p>
<pre><code>目标网段    下一跳类型    下一跳
0.0.0.0/0    ECS实例    ECS01
</code></pre><p><img src="http://picture.watchmen.xin/vpc/route_vpc_inter.png" alt=""></p>
<h4 id="VPC互连"><a href="#VPC互连" class="headerlink" title="VPC互连"></a>VPC互连</h4><p>VPC之间的互连又可以分为两种情况，一种是直接使用高速通道进行连接，一种是使用VPN网关进行连接。</p>
<p><strong>第一种：使用高速通道进行连接</strong></p>
<p>当使用高速通道连接两个VPC（VPC1 172.16.0.0/12和VPC2 192.168.0.0/16）时，创建完两个互相连接的路由器接口后，您还需要在两个VPC中分别添加如下一条路由：</p>
<p><strong>VPC1的路由配置:</strong></p>
<pre><code>目标网段    下一跳类型    下一跳
192.168.0.0/16    路由器接口（专有网络方向）
</code></pre><p><strong>VPC2的路由配置:</strong></p>
<pre><code>目标网段    下一跳类型    下一跳
172.16.0.0/12    路由器接口（专有网络方向）
</code></pre><p><img src="http://picture.watchmen.xin/vpc/route_vpc_vpc.png" alt=""></p>
<p><strong>第二种：使用VPN网关进行连接</strong></p>
<p>如下图所示，当使用VPN网关连接两个VPC（VPC1 172.16.0.0/12和VPC2 10.0.0.0/8）时，配置完VPN网关后，需要在VPC中分别添加如下路由：</p>
<p><strong>VPC1的路由配置</strong></p>
<pre><code>目标网段    下一跳类型    下一跳
10.0.0.0/8    VPN网关    VPN网关1
</code></pre><p><strong>VPC2的路由配置</strong></p>
<pre><code>目标网段    下一跳类型    下一跳
172.16.0.0/12    VPN网关    VPN网关2
</code></pre><p><img src="http://picture.watchmen.xin/vpc/route_vpc_vpn.png" alt=""></p>
<h4 id="VPC连接本地网络-（自建机房或者IDC）"><a href="#VPC连接本地网络-（自建机房或者IDC）" class="headerlink" title="VPC连接本地网络-（自建机房或者IDC）"></a>VPC连接本地网络-（自建机房或者IDC）</h4><p>VPC连接本地网络又可以分为两种情况，一种是直接使用高速通道进行连接，一种是使用VPN网关进行连接。</p>
<p><strong>第一种：使用高速通道连接本地网络</strong></p>
<p>如下图所示，当使用高速通道物理专线连接专有网络和本地网络时，配置完专线和边界路由器后，需要配置如下路由：</p>
<p><strong>VPC端的路由配置</strong></p>
<pre><code>目标网段    下一跳类型    下一跳
192.168.0.0/16    路由器接口（普通路由）    RI1
</code></pre><p><strong>边界路由器端的配置</strong></p>
<pre><code>目标网段    下一跳类型    下一跳
192.168.0.0/16    指向专线    RI3
172.16.0.0/12    指向VPC    RI2
</code></pre><p><strong>本地网络的路由配置</strong></p>
<pre><code>目标网段    下一跳类型    下一跳
172.16.0.0/12    —    本地网关设备
</code></pre><p><img src="http://picture.watchmen.xin/vpc/route_vpc_idc.png" alt=""></p>
<p><strong>第二种：使用VPN网关连接本地网络</strong></p>
<p>如下图所示，当使用VPN网关连接VPC（网段：172.16.0.0/12）和本地网络（网段：192.168.0.0/16）时，配置好VPN网关后，需要在VPC内添加如下一条路由：</p>
<pre><code>目标网段    下一跳类型    下一跳
192.168.0.0/16    VPN网关    已创建的VPN网关
</code></pre><p><img src="http://picture.watchmen.xin/vpc/route_vpc_idc2.png" alt=""></p>
<h3 id="添加自定义路由"><a href="#添加自定义路由" class="headerlink" title="添加自定义路由"></a>添加自定义路由</h3><p><strong>步骤如下所示：</strong></p>
<ol>
<li><p>登录专有网络管理控制台。</p>
</li>
<li><p>在左侧导航栏，单击路由表。</p>
</li>
<li><p>选择路由表所属的VPC的地域，然后单击目标路由表的ID链接。</p>
</li>
<li><p>单击添加路由条目。</p>
</li>
<li><p>在弹出的对话框，配置路由条目：</p>
</li>
</ol>
<p><img src="http://picture.watchmen.xin/vpc/vpc_route_config.png" alt=""></p>
<h1 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a>最佳实践</h1><h2 id="网络规划"><a href="#网络规划" class="headerlink" title="网络规划"></a>网络规划</h2><p>在进行网络规划的时候，有几个问题需要去解决：</p>
<ul>
<li>问题1：应该使用几个VPC？</li>
<li>问题2：应该使用几个交换机？</li>
<li>问题3：应该选择什么网段？</li>
<li>问题4：VPC与VPC互通或者与线下IDC互通时，如何规划网段？</li>
</ul>
<h3 id="问题1：应该使用几个VPC？"><a href="#问题1：应该使用几个VPC？" class="headerlink" title="问题1：应该使用几个VPC？"></a>问题1：应该使用几个VPC？</h3><p><strong>单个VPC：</strong></p>
<p>如果没有多地域部署系统的要求且各系统之间也不需要通过VPC进行隔离，那么推荐使用一个VPC。</p>
<p>目前，<strong><code>单个VPC内运行的云产品实例可达15000个</code></strong>，这样的容量基本上可以满足需求。</p>
<p><strong>ps：可用区是指在同一地域内，电力和网络互相独立的物理区域，在同一地域内可用区与可用区之间内网互通。</strong></p>
<p>单个VPC的拓扑如下所示：</p>
<p><img src="http://picture.watchmen.xin/vpc/singlevpc.png" alt=""></p>
<p><strong>多个VPC：</strong></p>
<p>有以下需求时，那么建议使用多个VPC</p>
<ul>
<li>多地域部署系统</li>
</ul>
<p><strong><code>VPC是地域级别的资源</code></strong>，是不能跨地域部署的。当您有多地域部署系统的需求时，就必然需要使用多个VPC。基于阿里巴巴骨干网构建的高速通道产品能轻松实现跨地域，跨国VPC间的互通。详情参考高速通道VPC互通。</p>
<p><img src="http://picture.watchmen.xin/vpc/mutlivpc1.png" alt=""></p>
<ul>
<li>多业务系统隔离</li>
</ul>
<p>如果在一个地域的多个业务系统需要通过VPC进行严格隔离，比如生产环境和测试环境，那么也需要使用多个VPC，如下图所示。</p>
<p><img src="http://picture.watchmen.xin/vpc/mutlivpc2.png" alt=""></p>
<h3 id="问题2：应该使用几个交换机？"><a href="#问题2：应该使用几个交换机？" class="headerlink" title="问题2：应该使用几个交换机？"></a>问题2：应该使用几个交换机？</h3><p>首先，即使只使用一个VPC，也尽量使用至少两个交换机，并且将两个交换机分布在不同可用区，这样可以实现跨可用区容灾。</p>
<p>同一地域不同可用区之间的网络通信延迟很小，但也需要经过业务系统的适配和验证。由于系统调用复杂加上系统处理时间、跨可用区调用等原因可能产生期望之外的网络延迟。建议您进行系统优化和适配，在高可用和低延迟之间找到平衡。</p>
<p>其次，使用多少个交换机还和系统规模、系统规划有关。如果前端系统可以被公网访问并且有主动访问公网的需求，考虑到容灾可以将不同的前端系统部署在不同的交换机下，将后端系统部署在另外的交换机下。</p>
<h3 id="问题3：应该选择什么网段？"><a href="#问题3：应该选择什么网段？" class="headerlink" title="问题3：应该选择什么网段？"></a>问题3：应该选择什么网段？</h3><p>在创建VPC和交换机时，您必须以无类域间路由块 (CIDR block) 的形式为您的专有网络划分私网网段。</p>
<p><strong>VPC网段规划</strong></p>
<ul>
<li><p>网段范围</p>
<pre><code>网段    可用IP地址数量    备注
192.168.0.0/16    65532    去除系统占用地址
172.16.0.0/12    1048572    去除系统占用地址
10.0.0.0/8    16777212    去除系统占用地址
</code></pre></li>
</ul>
<p><strong>注意：</strong>如果有除此之外的特殊网段要求，也可以提工单或者通过客户经理申请开通。</p>
<ul>
<li><p>如果有多个VPC，或者有VPC和线下IDC构建混合云的需求，建议使用上面这些标准网段的子网作为VPC的网段，掩码建议不超过16位。</p>
</li>
<li><p>如果云上只有一个VPC并且不需要和本地IDC互通时，可以选择上表中的任何一个网段或其子网。</p>
</li>
<li><p>VPC网段的选择还需要考虑到是否使用了经典网络。如果您使用了经典网络，并且计划将经典网络的ECS实例和VPC网络连通，那么，建议您选择非10.0.0.0/8作为VPC的网段，因为经典网络的网段也是10.0.0.0/8。</p>
</li>
</ul>
<p><strong>交换机网段</strong></p>
<p>可以根据以下建议规划交换机网段。同样，交换机创建成功后，网段无法再修改。</p>
<ul>
<li><p>交换机的网段的大小在16位网络掩码与29位网络掩码之间，可提供8-65536个地址。16位掩码能支持65532个ECS实例，而小于29位掩码又太小，没有意义。</p>
</li>
<li><p>交换机的网段可以和其所属的VPC网段相同，或者是其VPC网段的子网。比如VPC的网段是192.168.0.0/16，那么该VPC下的虚拟交换机的网段可以是192.168.0.0/16，也可以是192.168.0.0/17一直到192.168.0.0/29。</p>
<blockquote>
<p>如果交换机网段和所属VPC网段相同，您在该VPC下只能创建一台交换机。</p>
</blockquote>
</li>
<li><p>每个交换机的第一个和最后三个IP地址为系统保留地址。以192.168.1.0/24为例，192.168.1.0、 192.168.1.253、192.168.1.254和192.168.1.255这些地址是系统保留地址。</p>
</li>
<li><p>ClassicLink功能允许经典网络的ECS和192.168.0.0/16，10.0.0.0/8，172.16.0.0/12这三个VPC网段的ECS通信。例如，如果要和经典网络通信的VPC网段是10.0.0.0/8，则要和经典网络ECS通信的交换机的网段必须是10.111.0.0/16。详情参考ClassicLink。</p>
</li>
<li><p>交换机网段的确定还需要考虑该交换机下容纳ECS的数量。</p>
</li>
</ul>
<h3 id="问题4：VPC与VPC互通或者与本地数据中心互通时，如何规划网段？"><a href="#问题4：VPC与VPC互通或者与本地数据中心互通时，如何规划网段？" class="headerlink" title="问题4：VPC与VPC互通或者与本地数据中心互通时，如何规划网段？"></a>问题4：VPC与VPC互通或者与本地数据中心互通时，如何规划网段？</h3><p>如下图所示，比如您在华东1、华北2、华南1三个地域分别有VPC1、VPC2和VPC3三个VPC。VPC1和VPC2通过高速通道内网互通，VPC3目前没有和其他VPC通信的需求，将来可能需要和VPC2通信。另外，您在上海还有一个自建IDC，需要通过高速通道（专线功能）和华东1的VPC1私网互通。</p>
<p><img src="http://picture.watchmen.xin/vpc/qa4.png" alt=""></p>
<p>此例中VPC1和VPC2使用了不同的网段，而VPC3暂时没有和其他VPC互通的需求，所以VPC3的网段和VPC2的网段相同。但考虑到将来VPC2和VPC3之间有私网互通的需求，所以两个VPC中的交换机的网段都不相同。VPC互通要求互通的交换机的网段不能一样，但VPC的网段可以一样。</p>
<p>在多VPC的情况下，建议遵循如下网段规划原则：</p>
<ul>
<li><p>尽可能做到不同VPC的网段不同，不同VPC可以使用标准网段的子网来增加VPC可用的网段数。</p>
</li>
<li><p>如果不能做到不同VPC的网段不同，则尽量保证不同VPC的交换机网段不同。</p>
</li>
<li><p>如果也不能做到交换机网段不同，则保证要通信的交换机网段不同。</p>
</li>
</ul>

      
    </div>
    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div></div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/wechatpay.jpg" alt="XiaoHua WANG 微信支付"/>
        <p>微信支付</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/alipay.jpg" alt="XiaoHua WANG 支付宝"/>
        <p>支付宝</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/VPC/" rel="tag"># VPC</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/04/16/IT科学技术知识体系结构-Linux运维方向/IT基础知识/IT英语/IT常用英语记录/" rel="next" title="IT常用英语记录">
                <i class="fa fa-chevron-left"></i> IT常用英语记录
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/04/17/编程语言/Python/django项目/Python-django项目/" rel="prev" title="《Python编程从入门到实践》-Django项目">
                《Python编程从入门到实践》-Django项目 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
        <!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
<span class="jiathis_txt">分享到：</span>
<a class="jiathis_button_fav">收藏夹</a>
<a class="jiathis_button_copy">复制网址</a>
<a class="jiathis_button_email">邮件</a>
<a class="jiathis_button_weixin">微信</a>
<a class="jiathis_button_qzone">QQ空间</a>
<a class="jiathis_button_tqq">腾讯微博</a>
<a class="jiathis_button_douban">豆瓣</a>
<a class="jiathis_button_share">一键分享</a>

<a href="http://www.jiathis.com/share?uid=2140465" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a>
<a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript" >
var jiathis_config={
  data_track_clickback:true,
  summary:"",
  shortUrl:false,
  hideMore:false
}
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=" charset="utf-8"></script>
<!-- JiaThis Button END -->
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="lv-container" data-id="city" data-uid="MTAyMC8zMzg1NC8xMDQwNw=="></div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/touxiang.jpg"
                alt="XiaoHua WANG" />
            
              <p class="site-author-name" itemprop="name">XiaoHua WANG</p>
              <p class="site-description motion-element" itemprop="description">Focus on Linux operations and development.</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">55</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">61</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">47</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#VPC基础知识"><span class="nav-number">1.</span> <span class="nav-text">VPC基础知识</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#VPC概述"><span class="nav-number">1.1.</span> <span class="nav-text">VPC概述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#VPC中的路由器和交换机"><span class="nav-number">1.2.</span> <span class="nav-text">VPC中的路由器和交换机</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#基础架构及实现原理"><span class="nav-number">1.3.</span> <span class="nav-text">基础架构及实现原理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#问题"><span class="nav-number">1.3.1.</span> <span class="nav-text">问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#解决方案"><span class="nav-number">1.3.2.</span> <span class="nav-text">解决方案</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#逻辑架构"><span class="nav-number">1.3.3.</span> <span class="nav-text">逻辑架构</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#VPC通信"><span class="nav-number">1.4.</span> <span class="nav-text">VPC通信</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#VPC与VPC通信"><span class="nav-number">1.4.1.</span> <span class="nav-text">VPC与VPC通信</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#VPC与经典网络通信"><span class="nav-number">1.4.2.</span> <span class="nav-text">VPC与经典网络通信</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#VPC与Internel通信"><span class="nav-number">1.4.3.</span> <span class="nav-text">VPC与Internel通信</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#VPC与本地IDC通信"><span class="nav-number">1.4.4.</span> <span class="nav-text">VPC与本地IDC通信</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#名词解释"><span class="nav-number">1.5.</span> <span class="nav-text">名词解释</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用限制"><span class="nav-number">1.6.</span> <span class="nav-text">使用限制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#VPC应用场景"><span class="nav-number">1.7.</span> <span class="nav-text">VPC应用场景</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#场景一：本地数据中心-云上对外业务的混合云模式"><span class="nav-number">1.7.1.</span> <span class="nav-text">场景一：本地数据中心+云上对外业务的混合云模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#场景二：多租户的安全隔离"><span class="nav-number">1.7.2.</span> <span class="nav-text">场景二：多租户的安全隔离</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#场景三：主动访问公网的抓取类业务"><span class="nav-number">1.7.3.</span> <span class="nav-text">场景三：主动访问公网的抓取类业务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#场景四：多个应用流量波动大——共享带宽包"><span class="nav-number">1.7.4.</span> <span class="nav-text">场景四：多个应用流量波动大——共享带宽包</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#NAT网关"><span class="nav-number">1.8.</span> <span class="nav-text">NAT网关</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#入门实践"><span class="nav-number">2.</span> <span class="nav-text">入门实践</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#搭建专有网络"><span class="nav-number">2.1.</span> <span class="nav-text">搭建专有网络</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#步骤1-创建专有网络和交换机"><span class="nav-number">2.1.1.</span> <span class="nav-text">步骤1 创建专有网络和交换机</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#步骤二-创建ECS实例"><span class="nav-number">2.1.2.</span> <span class="nav-text">步骤二 创建ECS实例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#步骤三-创建EIP"><span class="nav-number">2.1.3.</span> <span class="nav-text">步骤三 创建EIP</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#步骤四-绑定EIP"><span class="nav-number">2.1.4.</span> <span class="nav-text">步骤四 绑定EIP</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#步骤五-公网访问测试"><span class="nav-number">2.1.5.</span> <span class="nav-text">步骤五 公网访问测试</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ECS安全组配置"><span class="nav-number">2.2.</span> <span class="nav-text">ECS安全组配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#交换机"><span class="nav-number">2.3.</span> <span class="nav-text">交换机</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#交换机的网段"><span class="nav-number">2.3.1.</span> <span class="nav-text">交换机的网段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#默认的专有网络和交换机"><span class="nav-number">2.3.2.</span> <span class="nav-text">默认的专有网络和交换机</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#路由表和路由条目"><span class="nav-number">2.4.</span> <span class="nav-text">路由表和路由条目</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#系统路由"><span class="nav-number">2.4.1.</span> <span class="nav-text">系统路由</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#自定义路由"><span class="nav-number">2.4.2.</span> <span class="nav-text">自定义路由</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#选路规则"><span class="nav-number">2.4.3.</span> <span class="nav-text">选路规则</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#路由实例"><span class="nav-number">2.4.4.</span> <span class="nav-text">路由实例</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#VPC内网路由"><span class="nav-number">2.4.4.1.</span> <span class="nav-text">VPC内网路由</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#VPC互连"><span class="nav-number">2.4.4.2.</span> <span class="nav-text">VPC互连</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#VPC连接本地网络-（自建机房或者IDC）"><span class="nav-number">2.4.4.3.</span> <span class="nav-text">VPC连接本地网络-（自建机房或者IDC）</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#添加自定义路由"><span class="nav-number">2.4.5.</span> <span class="nav-text">添加自定义路由</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#最佳实践"><span class="nav-number">3.</span> <span class="nav-text">最佳实践</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#网络规划"><span class="nav-number">3.1.</span> <span class="nav-text">网络规划</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#问题1：应该使用几个VPC？"><span class="nav-number">3.1.1.</span> <span class="nav-text">问题1：应该使用几个VPC？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#问题2：应该使用几个交换机？"><span class="nav-number">3.1.2.</span> <span class="nav-text">问题2：应该使用几个交换机？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#问题3：应该选择什么网段？"><span class="nav-number">3.1.3.</span> <span class="nav-text">问题3：应该选择什么网段？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#问题4：VPC与VPC互通或者与本地数据中心互通时，如何规划网段？"><span class="nav-number">3.1.4.</span> <span class="nav-text">问题4：VPC与VPC互通或者与本地数据中心互通时，如何规划网段？</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">XiaoHua WANG</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("mlSs9Cm0Xv2D9B7cFqbp25Df-gzGzoHsz", "alKheIFly9OVC81YCV7otTrf");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  
  

  

  

  

</body>
</html>
