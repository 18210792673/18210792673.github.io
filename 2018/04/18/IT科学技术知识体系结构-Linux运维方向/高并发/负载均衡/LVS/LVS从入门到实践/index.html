<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="LVS," />





  <link rel="alternate" href="/atom.xml" title="Watchmen1992's Blog" type="application/atom+xml" />






<meta name="description" content="本文讲述4层负载均衡-LVS的相关知识">
<meta name="keywords" content="LVS">
<meta property="og:type" content="article">
<meta property="og:title" content="LVS从入门到实践">
<meta property="og:url" content="http://yoursite.com/2018/04/18/IT科学技术知识体系结构-Linux运维方向/高并发/负载均衡/LVS/LVS从入门到实践/index.html">
<meta property="og:site_name" content="Watchmen1992&#39;s Blog">
<meta property="og:description" content="本文讲述4层负载均衡-LVS的相关知识">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://picture.watchmen.xin/LVS/core.png">
<meta property="og:updated_time" content="2018-04-18T01:07:47.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="LVS从入门到实践">
<meta name="twitter:description" content="本文讲述4层负载均衡-LVS的相关知识">
<meta name="twitter:image" content="http://picture.watchmen.xin/LVS/core.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2018/04/18/IT科学技术知识体系结构-Linux运维方向/高并发/负载均衡/LVS/LVS从入门到实践/"/>





  <title>LVS从入门到实践 | Watchmen1992's Blog</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?07235ad5687ee838f373b31c7c687d23";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Watchmen1992's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">锦瑟年华当与书香为度，是为不负天地人生。</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/18/IT科学技术知识体系结构-Linux运维方向/高并发/负载均衡/LVS/LVS从入门到实践/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="XiaoHua WANG">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/touxiang.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Watchmen1992's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">LVS从入门到实践</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-18T09:07:47+08:00">
                2018-04-18
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2018-04-18T09:07:47+08:00">
                2018-04-18
              </time>
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IT科学技术知识体系结构-Linux运维方向/" itemprop="url" rel="index">
                    <span itemprop="name">IT科学技术知识体系结构-Linux运维方向</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IT科学技术知识体系结构-Linux运维方向/高并发/" itemprop="url" rel="index">
                    <span itemprop="name">高并发</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IT科学技术知识体系结构-Linux运维方向/高并发/负载均衡/" itemprop="url" rel="index">
                    <span itemprop="name">负载均衡</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IT科学技术知识体系结构-Linux运维方向/高并发/负载均衡/LVS/" itemprop="url" rel="index">
                    <span itemprop="name">LVS</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/04/18/IT科学技术知识体系结构-Linux运维方向/高并发/负载均衡/LVS/LVS从入门到实践/" class="leancloud_visitors" data-flag-title="LVS从入门到实践">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          
              <div class="post-description">
                  本文讲述4层负载均衡-LVS的相关知识
              </div>
          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>有关负载均衡基础知识详见<strong><code>高并发-负载均衡-负载均衡基础知识</code></strong>相关文章，这里不再进行赘述。</p>
<p>LVS相关的工作模式、调度算法等相关内容都会放在单独的文章中</p>
<p><strong>参考文献：</strong></p>
<ul>
<li><p><a href="http://www.linuxvirtualserver.org/index.html" target="_blank" rel="noopener">LVS官网</a></p>
</li>
<li><p><a href="http://www.linuxvirtualserver.org/zh/lvs1.html" target="_blank" rel="noopener">LVS项目介绍</a></p>
</li>
<li><p><a href="http://www.linuxvirtualserver.org/zh/lvs2.html" target="_blank" rel="noopener">LVS集群的体系结构</a></p>
</li>
<li><p><a href="http://www.linuxvirtualserver.org/zh/lvs3.html" target="_blank" rel="noopener">LVS集群中的IP负载均衡技术</a></p>
</li>
<li><p><a href="http://www.linuxvirtualserver.org/zh/lvs4.html" target="_blank" rel="noopener">LVS集群的负载调度</a></p>
</li>
<li><p><a href="https://mp.weixin.qq.com/s?__biz=MzA3OTgyMDcwNg==&amp;mid=2650634739&amp;idx=1&amp;sn=d1b7318f2dc467e1d08d2e2bc30d67a8&amp;chksm=87a47b3eb0d3f22824425247644de7884e8f4062a623b414e093a1873c722f70c727b16754a6&amp;mpshare=1&amp;scene=1&amp;srcid=0610dlO5zhRbku14wfGNriyr#rd" target="_blank" rel="noopener">高薪Linux必备之高并发场景 LVS 简快入门实战（万字长文）</a></p>
</li>
<li><p><a href="https://blog.csdn.net/l1902090/article/details/25660393" target="_blank" rel="noopener">LVS配置之ipvsadm命令学习笔记</a></p>
</li>
</ul>
<h1 id="LVS介绍"><a href="#LVS介绍" class="headerlink" title="LVS介绍"></a>LVS介绍</h1><p>LVS是Linux Virtual Server的简写，意即Linux虚拟服务器，是一个虚拟的服务器集群系统，可以在UNIX/LINUX平台下实现负载均衡集群功能。该项目在1998年5月由章文嵩博士组织成立，是中国国内最早出现的自由软件项目之一。</p>
<h2 id="为什么使用LVS？"><a href="#为什么使用LVS？" class="headerlink" title="为什么使用LVS？"></a>为什么使用LVS？</h2><h2 id="LVS内核模块ip-vs介绍"><a href="#LVS内核模块ip-vs介绍" class="headerlink" title="LVS内核模块ip_vs介绍"></a>LVS内核模块ip_vs介绍</h2><p>早在2.2内核时， IPVS就已经以内核补丁的形式出现。</p>
<p>从2.4.23版本开始，IPVS软件就合并到Linux内核的常用版本的内核补丁的集合。</p>
<p>从2.4.24以后IPVS已经成为Linux官方标准内核的一部分。</p>
<p><img src="http://picture.watchmen.xin/LVS/core.png" alt="core"></p>
<p>也就是说：<font color="red"><strong><code>LVS无需安装！！！</code></strong></font></p>
<p>我们在操作系统上安装的是管理工具，第一种叫ipvsadm，第二种叫keepalive</p>
<p>ipvsadm是通过命令行配置管理，而keepalive读取配置文件管理并提供了HA的功能</p>
<p>后面我们会用Shell脚本实现keepalive的功能</p>
<h1 id="LVS集群搭建"><a href="#LVS集群搭建" class="headerlink" title="LVS集群搭建"></a>LVS集群搭建</h1><h2 id="整体架构"><a href="#整体架构" class="headerlink" title="整体架构"></a>整体架构</h2><p>此处插入visio图或者亿图的图</p>
<h2 id="安装ipvsadm管理工具"><a href="#安装ipvsadm管理工具" class="headerlink" title="安装ipvsadm管理工具"></a>安装ipvsadm管理工具</h2><p>ipvsadm是LVS在应用层的管理命令，我们可以通过这个命令去管理LVS的配置。一般操作系统都已经集成了LVS相关模块，但是ipvsadm命令仍然需要使用yum单独安装。</p>
<p>注意：我们安装ipvsadm的主要目的是使用它该查看LVS的运行状态，而不是使用它来进行配置，具体的配置我们使用keepalived来实现。</p>
<ul>
<li><p>安装ipvsadm</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install ipvsadm</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看当前LVS状态，顺便激活LVS内核模块。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ipvsadm</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看系统的LVS模块</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@qa-common013 ~]#  lsmod | grep ip_vs</span><br><span class="line"></span><br><span class="line">ip_vs                 126705  0 </span><br><span class="line"></span><br><span class="line">libcrc32c               1246  1 ip_vs</span><br><span class="line"></span><br><span class="line">ipv6                  336368  1 ip_vs</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>下面，我们简单介绍一个ipvsadm命令的一些常用用法</p>
<h3 id="ipvsadm命令"><a href="#ipvsadm命令" class="headerlink" title="ipvsadm命令"></a>ipvsadm命令</h3><p>关于具体的详细的用法可以查看帮助文档，这里不用太多篇幅，因为基本上不会使用它来进行配置，所以也就没有太大的必要去花这个时间成本，这里只说常用的组合命令。</p>
<ul>
<li><p>显示内核中的虚拟服务规则</p>
<p>  -L | -l   –list</p>
</li>
<li><p>数字形式显示IP端口</p>
<p>  -n  –numeric</p>
</li>
<li><p>显示ipvs中目前存在的连接，也可以用于分析调度情况</p>
<p>  -c  –connection</p>
</li>
</ul>
<ul>
<li><p>查看当前配置的虚拟服务和各个RS的权重</p>
<p>  ipvsadm -Ln</p>
</li>
<li><p>查看当前ipvs模块中记录的连接（可用于观察转发情况）</p>
<p>  ipvsadm -lnc</p>
</li>
</ul>
<ul>
<li><p>查看ipvs模块的转发情况统计</p>
<p>  ipvsadm -Ln –stats  –rate</p>
</li>
</ul>
<p><strong>–stats和–rate统计在分析问题时经常用到，输出各项的含义：</strong></p>
<pre><code>--stat选项是统计自该条转发规则生效以来的包

1. Conns    (connections scheduled)  已经转发过的连接数

2. InPkts   (incoming packets)       入包个数

3. OutPkts  (outgoing packets)       出包个数

4. InBytes  (incoming bytes)         入流量（字节）

5. OutBytes (outgoing bytes)         出流量（字节）

--rate选项是显示速率信息

1. CPS      (current connection rate)   每秒连接数

2. InPPS    (current in packet rate)    每秒的入包个数

3. OutPPS   (current out packet rate)   每秒的出包个数

4. InBPS    (current in byte rate)      每秒入流量（字节）

5. OutBPS   (current out byte rate)     每秒入流量（字节）
</code></pre><h3 id="LVS中文站点-ipvsadm"><a href="#LVS中文站点-ipvsadm" class="headerlink" title="LVS中文站点 -ipvsadm"></a>LVS中文站点 -ipvsadm</h3><p>对ipvsadm 的命令参考，并根据自己使用的经验，进行了一个简单的翻译，希望<br>对ipvsadm 的使用者有一定的帮助。<br>为了更好的让大家理解这份命令手册，将手册里面用到的几个术语先简单的介绍<br>一下：<br>1，virtual-service-address:是指虚拟服务器的ip 地址<br>2，real-service-address:是指真实服务器的ip 地址<br>3，scheduler：调度方法<br>(lna@networksbase.com 翻译 ipvsadm v1.21 2004 年4 月)</p>
<p>ipvsadm 的用法和格式如下：</p>
<pre><code>ipvsadm -A|E -t|u|f virutal-service-address:port [-s scheduler] [-p
[timeout]] [-M netmask]
ipvsadm -D -t|u|f virtual-service-address
ipvsadm -C
ipvsadm -R
ipvsadm -S [-n]
ipvsadm -a|e -t|u|f service-address:port -r real-server-address:port
[-g|i|m][-w weight]
ipvsadm -d -t|u|f service-address -r server-address
ipvsadm -L|l [options]
ipvsadm -Z [-t|u|f service-address]
ipvsadm --set tcp tcpfin udp
ipvsadm --start-daemon state [--mcast-interface interface]
ipvsadm --stop-daemon
ipvsadm -h
</code></pre><p><strong>命令选项解释：</strong></p>
<p>有两种命令选项格式，长的和短的，具有相同的意思。在实际使用时，两种都可<br>以。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">-A --add-service 在内核的虚拟服务器表中添加一条新的虚拟服务器记录。也</span><br><span class="line"></span><br><span class="line">就是增加一台新的虚拟服务器。</span><br><span class="line"></span><br><span class="line">-E --edit-service 编辑内核虚拟服务器表中的一条虚拟服务器记录。</span><br><span class="line"></span><br><span class="line">-D --delete-service 删除内核虚拟服务器表中的一条虚拟服务器记录。</span><br><span class="line"></span><br><span class="line">-C --clear 清除内核虚拟服务器表中的所有记录。</span><br><span class="line"></span><br><span class="line">-R --restore 恢复虚拟服务器规则</span><br><span class="line"></span><br><span class="line">-S --save 保存虚拟服务器规则，输出为-R 选项可读的格式</span><br><span class="line"></span><br><span class="line">-a --add-server 在内核虚拟服务器表的一条记录里添加一条新的真实服务器</span><br><span class="line"></span><br><span class="line">记录。也就是在一个虚拟服务器中增加一台新的真实服务器</span><br><span class="line"></span><br><span class="line">-e --edit-server 编辑一条虚拟服务器记录中的某条真实服务器记录</span><br><span class="line"></span><br><span class="line">-d --delete-server 删除一条虚拟服务器记录中的某条真实服务器记录</span><br><span class="line"></span><br><span class="line">-L|-l --list 显示内核虚拟服务器表</span><br><span class="line"></span><br><span class="line">-Z --zero 虚拟服务表计数器清零（清空当前的连接数量等）</span><br><span class="line"></span><br><span class="line">--set tcp tcpfin udp 设置连接超时值</span><br><span class="line"></span><br><span class="line">--start-daemon 启动同步守护进程。他后面可以是master 或backup，用来说</span><br><span class="line"></span><br><span class="line">明LVS Router 是master 或是backup。在这个功能上也可以采用keepalived 的</span><br><span class="line"></span><br><span class="line">VRRP 功能。</span><br><span class="line"></span><br><span class="line">--stop-daemon 停止同步守护进程</span><br><span class="line"></span><br><span class="line">-h --help 显示帮助信息</span><br><span class="line"></span><br><span class="line">其他的选项:</span><br><span class="line"></span><br><span class="line">-t --tcp-service service-address 说明虚拟服务器提供的是tcp 的服务</span><br><span class="line"></span><br><span class="line">[vip:port] or [real-server-ip:port]</span><br><span class="line"></span><br><span class="line">-u --udp-service service-address 说明虚拟服务器提供的是udp 的服务</span><br><span class="line"></span><br><span class="line">[vip:port] or [real-server-ip:port]</span><br><span class="line"></span><br><span class="line">-f --fwmark-service fwmark 说明是经过iptables 标记过的服务类型。</span><br><span class="line"></span><br><span class="line">-s --scheduler scheduler 使用的调度算法，有这样几个选项</span><br><span class="line"></span><br><span class="line">rr|wrr|lc|wlc|lblc|lblcr|dh|sh|sed|nq,</span><br><span class="line"></span><br><span class="line">默认的调度算法是： wlc.</span><br><span class="line"></span><br><span class="line">-p --persistent [timeout] 持久稳固的服务。这个选项的意思是来自同一个客</span><br><span class="line"></span><br><span class="line">户的多次请求，将被同一台真实的服务器处理。timeout 的默认值为300 秒。</span><br><span class="line"></span><br><span class="line">-M --netmask netmask persistent granularity mask</span><br><span class="line"></span><br><span class="line">-r --real-server server-address 真实的服务器[Real-Server:port]</span><br><span class="line"></span><br><span class="line">-g --gatewaying 指定LVS 的工作模式为直接路由模式（也是LVS 默认的模式）</span><br><span class="line"></span><br><span class="line">-i --ipip 指定LVS 的工作模式为隧道模式</span><br><span class="line"></span><br><span class="line">-m --masquerading 指定LVS 的工作模式为NAT 模式</span><br><span class="line"></span><br><span class="line">-w --weight weight 真实服务器的权值</span><br><span class="line"></span><br><span class="line">--mcast-interface interface 指定组播的同步接口</span><br><span class="line"></span><br><span class="line">-c --connection 显示LVS 目前的连接 如：ipvsadm -L -c</span><br><span class="line"></span><br><span class="line">--timeout 显示tcp tcpfin udp 的timeout 值 如：ipvsadm -L --timeout</span><br><span class="line"></span><br><span class="line">--daemon 显示同步守护进程状态</span><br><span class="line"></span><br><span class="line">--stats 显示统计信息</span><br></pre></td></tr></table></figure>
<p>-A –add-service 在内核的虚拟服务器表中添加一条新的虚拟服务器记录。也<br>就是增加一台新的虚拟服务器。<br>-E –edit-service 编辑内核虚拟服务器表中的一条虚拟服务器记录。<br>-D –delete-service 删除内核虚拟服务器表中的一条虚拟服务器记录。<br>-C –clear 清除内核虚拟服务器表中的所有记录。<br>-R –restore 恢复虚拟服务器规则<br>-S –save 保存虚拟服务器规则，输出为-R 选项可读的格式<br>-a –add-server 在内核虚拟服务器表的一条记录里添加一条新的真实服务器<br>记录。也就是在一个虚拟服务器中增加一台新的真实服务器<br>-e –edit-server 编辑一条虚拟服务器记录中的某条真实服务器记录<br>-d –delete-server 删除一条虚拟服务器记录中的某条真实服务器记录<br>-L|-l –list 显示内核虚拟服务器表<br>-Z –zero 虚拟服务表计数器清零（清空当前的连接数量等）<br>–set tcp tcpfin udp 设置连接超时值<br>–start-daemon 启动同步守护进程。他后面可以是master 或backup，用来说<br>明LVS Router 是master 或是backup。在这个功能上也可以采用keepalived 的<br>VRRP 功能。<br>–stop-daemon 停止同步守护进程<br>-h –help 显示帮助信息<br>其他的选项:<br>-t –tcp-service service-address 说明虚拟服务器提供的是tcp 的服务<br>[vip:port] or [real-server-ip:port]<br>-u –udp-service service-address 说明虚拟服务器提供的是udp 的服务<br>[vip:port] or [real-server-ip:port]<br>-f –fwmark-service fwmark 说明是经过iptables 标记过的服务类型。<br>-s –scheduler scheduler 使用的调度算法，有这样几个选项<br>rr|wrr|lc|wlc|lblc|lblcr|dh|sh|sed|nq,<br>默认的调度算法是： wlc.<br>-p –persistent [timeout] 持久稳固的服务。这个选项的意思是来自同一个客<br>户的多次请求，将被同一台真实的服务器处理。timeout 的默认值为300 秒。<br>-M –netmask netmask persistent granularity mask<br>-r –real-server server-address 真实的服务器[Real-Server:port]<br>-g –gatewaying 指定LVS 的工作模式为直接路由模式（也是LVS 默认的模式）<br>-i –ipip 指定LVS 的工作模式为隧道模式<br>-m –masquerading 指定LVS 的工作模式为NAT 模式<br>-w –weight weight 真实服务器的权值<br>–mcast-interface interface 指定组播的同步接口<br>-c –connection 显示LVS 目前的连接 如：ipvsadm -L -c<br>–timeout 显示tcp tcpfin udp 的timeout 值 如：ipvsadm -L –timeout<br>–daemon 显示同步守护进程状态<br>–stats 显示统计信息<br>–rate 显示速率信息<br>–sort 对虚拟服务器和真实服务器排序输出<br>–numeric -n 输出IP 地址和端口的数字形式</p>
<h2 id="Keepalived安装配置"><a href="#Keepalived安装配置" class="headerlink" title="Keepalived安装配置"></a>Keepalived安装配置</h2><h2 id="安装keepalived的原因"><a href="#安装keepalived的原因" class="headerlink" title="安装keepalived的原因"></a>安装keepalived的原因</h2><p>LVS是没有提供对后端realserver节点的存活状态检测功能的，所有需要单独的软件进行实现</p>
<p>关于keepalived的部分，请查看keepalived的章节内容，这里这是做一个简单的介绍</p>
<p>跳转链接：</p>
<h3 id="安装keepalived依赖关系"><a href="#安装keepalived依赖关系" class="headerlink" title="安装keepalived依赖关系"></a>安装keepalived依赖关系</h3><pre><code># yum -y install gcc openssl-devel libnl libnl-devel libnfnetlink-devel
</code></pre><p><strong>依赖关系说明：</strong></p>
<ul>
<li>gcc：C语言编译器，因Keepalived由C编写而成，因此正确编译需要该软件支持</li>
<li>openssl-devel：keepalived需要调用openssl开发库中某些函数</li>
<li>libnl和libnl-devel ：支持IPVS with IPv6</li>
<li>libnfnetlink-devel：keepalibed需要调用NETLINK模块提供的某些函数</li>
</ul>
<h3 id="安装keepalived"><a href="#安装keepalived" class="headerlink" title="安装keepalived"></a>安装keepalived</h3><pre><code>[root@localhost software]# pwd ; ls
/root/software
keepalived-1.3.6.tar.gz 
[root@master software]#  tar -zxvf  keepalived-1.3.6.tar.gz 
[root@master software]# cd keepalived-1.3.6/
[root@master keepalived-1.3.6]# ./configure  -sysconfdir=/etc  --sbindir=/usr/sbin
[root@master keepalived-1.3.6]#  make &amp;&amp; make install
</code></pre><p><strong>安装完成相关文件路径如下：</strong></p>
<ul>
<li>启动配置文件路径：/etc/keepalived</li>
<li>系统配置文件路径：/etc/sysconfig/keepalived</li>
<li>启动脚本路径：/usr/sbin/keepalived</li>
</ul>
<h3 id="keepalived配置"><a href="#keepalived配置" class="headerlink" title="keepalived配置"></a>keepalived配置</h3><p>有关keepalived的配置文件详解部分，可以看我的高可用系列文章，这里就不占用篇幅再进行赘述了。</p>
<p>keepalived的配置部分没有一个统一的标准，主要是根据后端所承载的业务进行配置，因此将这一部分单独拿了出来，放在下面的：<strong><code>LVS负载均衡配置实践章节</code></strong></p>
<h4 id="配置文件说明"><a href="#配置文件说明" class="headerlink" title="配置文件说明"></a>配置文件说明</h4><h4 id="自定义日志文件"><a href="#自定义日志文件" class="headerlink" title="自定义日志文件"></a>自定义日志文件</h4><h2 id="后端服务器节点配置"><a href="#后端服务器节点配置" class="headerlink" title="后端服务器节点配置"></a>后端服务器节点配置</h2><p>所有的后端节点都需要做如下操作</p>
<h3 id="VIP配置"><a href="#VIP配置" class="headerlink" title="VIP配置"></a>VIP配置</h3><pre><code># cat /etc/sysconfig/network-scripts/ifcfg-lo:0
DEVICE=lo:0
IPADDR=192.168.80.200
NETMASK=255.255.255.255
ONBOOT=yes

# systemctl restart network
</code></pre><h3 id="网络参数配置"><a href="#网络参数配置" class="headerlink" title="网络参数配置"></a>网络参数配置</h3><p><strong>在内核参数配置文件中添加以下参数</strong></p>
<pre><code># vim /etc/sysctl.conf 

net.ipv4.conf.lo.arp_ignore = 1
net.ipv4.conf.lo.arp_announce = 2
net.ipv4.conf.all.arp_ignore = 1
net.ipv4.conf.all.arp_announce = 2

# sysctl -p
</code></pre><p>关于配置这些的原因，在最后一个章节有详细说明</p>
<h1 id="Keepalived的LVS负载均衡配置"><a href="#Keepalived的LVS负载均衡配置" class="headerlink" title="Keepalived的LVS负载均衡配置"></a>Keepalived的LVS负载均衡配置</h1><p>因为Keepalived的大部分配置都是围绕LVS的，因此关于Keepalived的LVS部分将写在这里，不放在原本的单独系列中</p>
<h2 id="通用TCP服务"><a href="#通用TCP服务" class="headerlink" title="通用TCP服务"></a>通用TCP服务</h2><p>通用TCP检测用于转发mysql、redis等走TCP的服务，配置文件如下</p>
<pre><code># vim keepalived.conf

! Configuration File for keepalived

global_defs {
   router_id LVS-master
}

vrrp_instance VI_1{        #固定写法，VI_1为自定义的实例名
    state BACKUP        #定义设备在VRRP实例中的初始角色，MASTER为主，BACKUP为备设备
    interface ens33        #定义HA监测网络的接口，用于发送和接受信息
    virtual_router_id 60    #虚拟路由标识,唯一标识一个实例，不同实例不能相同，所有角色必须设置为相同值
    priority 100        #该节点在当前VRRP实例中的优先级，用于选举决定节点角色
    advert_int 1        #同步检查间隔，即VRRP通告发送间隔，只有MASTER发送，BACKUP节点只接收
    nopreempt            #不抢占参数，只能在BACKUP上设置，MASTER忽视该参数,上文中有详细讲解
    authentication {        #定义节点间通信的验证类型和密码，在VRRP实例中，所有节点信息必须相同
        auth_type PASS
        auth_pass 1111
    }
    virtual_ipaddress {        #固定写法，即将进入设置虚拟IP子模块
        192.168.80.200/24
    }
}

    virtual_server 192.168.80.200 6379 {    #固定写法，后面为VIP及对应端口

        delay_loop 3            #定义对后端节点进行健康监测的时间间隔，单位是秒

        lb_algo lc                #定义负载均衡调度算法，可使用的有:rr,wrr,lc,wlc,lblc,lblcr,sh,dh

        lb_kind DR                #定义LVS的工作模式，可设置为NAT,DR,TUN

        protocol TCP            #定义转发协议类型，可设置为TCP和UDP    \如果用户一直在操作，则不受这个时间限制

        persistence_timeout 50
</code></pre><p>​<br>        real_server 192.168.80.129 6379 {<br>            weight 1            #定义权重值，默认为1，根据服务器性能决定<br>           TCP_CHECK {            #定义检测方式<br>                connect_port 6379        #健康检查的端口，不指定默认为real_server的端口<br>                connect_timeout 3        #无响应超时时间，单位是秒<br>                nb_get_retry 3        #重试次数<br>                delay_before_retry 3    #每次重试的时间间隔，单位是秒<br>                  }<br>    }<br>    }        </p>
<p><strong>注意：</strong></p>
<p>在新版本的keepalived中nb_get_retry字段已经被弃用，使用retry 字段进行代替</p>
<h2 id="Web服务"><a href="#Web服务" class="headerlink" title="Web服务"></a>Web服务</h2><p><strong>1.计算HTTP_GET方式所需校验值</strong></p>
<pre><code># genhash -s 192.168.80.128 -p 80 -u /index.html
MD5SUM = 650a1c9c9baa20730b4fcfdbe4cdc135
</code></pre><p><strong>2.编辑配置文件</strong></p>
<pre><code># vim keepalived.conf

! Configuration File for keepalived

global_defs {
   router_id LVS-master
}

vrrp_instance VI_1{        #固定写法，VI_1为自定义的实例名
    state BACKUP        #定义设备在VRRP实例中的初始角色，MASTER为主，BACKUP为备设备
    interface ens33        #定义HA监测网络的接口，用于发送和接受信息
    virtual_router_id 60    #虚拟路由标识,唯一标识一个实例，不同实例不能相同，所有角色必须设置为相同值
    priority 100        #该节点在当前VRRP实例中的优先级，用于选举决定节点角色
    advert_int 1        #同步检查间隔，即VRRP通告发送间隔，只有MASTER发送，BACKUP节点只接收
    nopreempt            #不抢占参数，只能在BACKUP上设置，MASTER忽视该参数,上文中有详细讲解
    authentication {        #定义节点间通信的验证类型和密码，在VRRP实例中，所有节点信息必须相同
        auth_type PASS
        auth_pass 1111
    }
    virtual_ipaddress {        #固定写法，即将进入设置虚拟IP子模块
        192.168.80.200/24
    }
}
</code></pre><p>​<br>    virtual_server 192.168.80.200 80 {    #固定写法，后面为VIP及对应端口<br>        delay_loop 3            #定义对后端节点进行健康监测的时间间隔，单位是秒<br>        lb_algo lc                #定义负载均衡调度算法，可使用的有:rr,wrr,lc,wlc,lblc,lblcr,sh,dh<br>        lb_kind DR                #定义LVS的工作模式，可设置为NAT,DR,TUN<br>        protocol TCP            #定义转发协议类型，可设置为TCP和UDP    \如果用户一直在操作，则不受这个时间限制<br>        persistence_timeout 50</p>
<p>​<br>​<br>    real_server 192.168.80.128 80 {<br>            weight 2            #定义权重值，默认为1，根据服务器性能决定<br>           HTTP_GET {            #定义检测方式<br>                url {                       #HTTP/SSL检查的URL，可以指定多个URL<br>                  path /index.html          #URL路径<br>                  digest 650a1c9c9baa20730b4fcfdbe4cdc135   #HTTP检查后的摘要信息,计算方式:genhash -s ip -p port -u /index.html<br>                    status_code 200         #HTTP检查的返回状态码，成功一般为200<br>                }<br>                bindto 192.168.5.128        #表示通过此地址来发送请求对服务器进行健康检查<br>                connect_port 80             #健康检查的端口，不指定默认为real_server的端口<br>                connect_timeout 3           #无响应超时时间，单位是秒<br>                nb_get_retry 3              #重试次数<br>                delay_before_retry 3        #每次重试的时间间隔，单位是秒<br>            }</p>
<pre><code>}
}
</code></pre><h1 id="实战案例"><a href="#实战案例" class="headerlink" title="实战案例"></a>实战案例</h1><h2 id="案例1-多网卡内网外IP双主LVS-双Nginx四七层负载均衡部署"><a href="#案例1-多网卡内网外IP双主LVS-双Nginx四七层负载均衡部署" class="headerlink" title="案例1-多网卡内网外IP双主LVS+双Nginx四七层负载均衡部署"></a>案例1-多网卡内网外IP双主LVS+双Nginx四七层负载均衡部署</h2><h3 id="系统架构图"><a href="#系统架构图" class="headerlink" title="系统架构图"></a>系统架构图</h3><p><strong>说明：</strong></p>
<ul>
<li>LVS服务器，4块网卡两两做bond，bond0配置为内网IP，bond1配置为公网IP</li>
<li>Nginx服务器，4块网卡两两做bond，bond0配置为内网IP，bond1配置为公网IP</li>
<li>内网IP及公网IP均为同一网段</li>
<li>LVS+keepalived的配置，LVS1为VRRP51组的master，LVS2为VRRP52组的master，互为BACKUP，组成双主的模式</li>
<li>LVS服务器的bond1网卡默认不配置公网IP，但是要处于up状态，因为bond1为VIP配置接口</li>
<li>LVS+keepalived的配置中，VRRP实例组的HA心跳检测接口使用bond0</li>
<li>LVS+keepalived的配置中，VIP均配置为公网IP</li>
<li>VIP连接的后端realserver的IP地址配置为NGINX服务器的内网地址</li>
<li>到Nginx服务器的状态监测可以使用页面返回状态码或genhash的形式</li>
<li>手动将VRRP组的角色设置为MATSER之后，会无视nopreempt的配置</li>
<li>keepalived的fault状态使用脚本进行人为的控制</li>
<li>默认路由触发只在MASTER角色的VRRP实例组中配置，防止主备切换时路由被删除</li>
</ul>
<h3 id="前端LVS配置"><a href="#前端LVS配置" class="headerlink" title="前端LVS配置"></a>前端LVS配置</h3><h4 id="LVS-keepalived配置文件"><a href="#LVS-keepalived配置文件" class="headerlink" title="LVS+keepalived配置文件"></a>LVS+keepalived配置文件</h4><h5 id="LVS1-配置文件"><a href="#LVS1-配置文件" class="headerlink" title="LVS1-配置文件"></a>LVS1-配置文件</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br></pre></td><td class="code"><pre><span class="line">[root@lvs001 ~]# cat /usr/local/keepalived/etc/keepalived-lvs1.conf </span><br><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id 51M_52B</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_51 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface bond0</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 110</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass DwdLvs11</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        103.13.244.19/29 dev bond1</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_routes &#123;</span><br><span class="line">        0.0.0.0/0 via 103.13.244.17</span><br><span class="line">    &#125;</span><br><span class="line">    notify_master  &quot;/usr/local/keepalived/scripts/master.py lvs001 51 103.13.244.19&quot;</span><br><span class="line">    notify_backup  &quot;/usr/local/keepalived/scripts/backup.py lvs001  51 103.13.244.19&quot;</span><br><span class="line">    notify_fault  &quot;/usr/local/keepalived/scripts/fault.py lvs001 51 103.13.244.19&quot;</span><br><span class="line">    notify_stop  &quot;/usr/local/keepalived/scripts/stop.py lvs001 51 103.13.244.19&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_52 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface bond0</span><br><span class="line">    virtual_router_id 52</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    nopreempt</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass DwdLvs22</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        103.13.244.20/29 dev bond1</span><br><span class="line">    &#125;</span><br><span class="line">    notify_master  &quot;/usr/local/keepalived/scripts/master.py lvs001 52 103.13.244.20&quot;</span><br><span class="line">    notify_backup  &quot;/usr/local/keepalived/scripts/backup.py lvs001 52 103.13.244.20&quot;</span><br><span class="line">    notify_fault  &quot;/usr/local/keepalived/scripts/fault.py lvs001 52 103.13.244.20&quot;</span><br><span class="line">    notify_stop  &quot;/usr/local/keepalived/scripts/stop.py lvs001 52 103.13.244.20&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">virtual_server 103.13.244.19 80 &#123;</span><br><span class="line">    delay_loop 3</span><br><span class="line">    lb_algo rr</span><br><span class="line">    lb_kind DR</span><br><span class="line">    persistence_timeout 50</span><br><span class="line">    protocol TCP</span><br><span class="line"></span><br><span class="line">    real_server 10.11.0.13 80 &#123;</span><br><span class="line">       weight 1</span><br><span class="line">       HTTP_GET &#123;</span><br><span class="line">            url &#123;</span><br><span class="line">	      path /index.html</span><br><span class="line">	      status_code 200</span><br><span class="line">	    &#125;</span><br><span class="line">            connect_port 80</span><br><span class="line">            connect_timeout 3</span><br><span class="line">            nb_get_retry 3 </span><br><span class="line">            delay_before_retry 2</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br><span class="line">    real_server 10.11.0.14 80 &#123;</span><br><span class="line">       weight 1</span><br><span class="line">       HTTP_GET &#123;</span><br><span class="line">            url &#123;</span><br><span class="line">	    path /index.html</span><br><span class="line">	    status_code 200</span><br><span class="line">	    &#125;</span><br><span class="line">            connect_port 80</span><br><span class="line">            connect_timeout 3</span><br><span class="line">            nb_get_retry 3 </span><br><span class="line">            delay_before_retry 2</span><br><span class="line">     &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">virtual_server 103.13.244.19 443 &#123;</span><br><span class="line">    delay_loop 3</span><br><span class="line">    lb_algo rr</span><br><span class="line">    lb_kind DR</span><br><span class="line">    persistence_timeout 50</span><br><span class="line">    protocol TCP</span><br><span class="line"></span><br><span class="line">    real_server 10.11.0.13 443 &#123;</span><br><span class="line">       weight 1</span><br><span class="line">       SSL_GET &#123;</span><br><span class="line">           url &#123;</span><br><span class="line">	    path /index.html</span><br><span class="line">	    status_code 200</span><br><span class="line">	   &#125;</span><br><span class="line">            connect_port 443</span><br><span class="line">            connect_timeout 3</span><br><span class="line">            nb_get_retry 3 </span><br><span class="line">            delay_before_retry 2</span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br><span class="line">    real_server 10.11.0.14 443 &#123;</span><br><span class="line">       weight 1</span><br><span class="line">       SSL_GET &#123;</span><br><span class="line">           url &#123;</span><br><span class="line">	    path /index.html</span><br><span class="line">	    status_code 200</span><br><span class="line">	   &#125;</span><br><span class="line">            connect_port 443</span><br><span class="line">            connect_timeout 3</span><br><span class="line">            nb_get_retry 3 </span><br><span class="line">            delay_before_retry 2</span><br><span class="line">          &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">virtual_server 103.13.244.20 80 &#123;</span><br><span class="line">    delay_loop 3</span><br><span class="line">    lb_algo rr</span><br><span class="line">    lb_kind DR</span><br><span class="line">    persistence_timeout 50</span><br><span class="line">    protocol TCP</span><br><span class="line"></span><br><span class="line">    real_server 10.11.0.13 80 &#123;</span><br><span class="line">       weight 1</span><br><span class="line">       HTTP_GET &#123;</span><br><span class="line">            url &#123;</span><br><span class="line">	      path /index.html</span><br><span class="line">	      status_code 200</span><br><span class="line">	    &#125;</span><br><span class="line">            connect_port 80</span><br><span class="line">            connect_timeout 3</span><br><span class="line">            nb_get_retry 3 </span><br><span class="line">            delay_before_retry 2</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br><span class="line">    real_server 10.11.0.14 80 &#123;</span><br><span class="line">       weight 1</span><br><span class="line">       HTTP_GET &#123;</span><br><span class="line">            url &#123;</span><br><span class="line">	    path /index.html</span><br><span class="line">	    status_code 200</span><br><span class="line">	    &#125;</span><br><span class="line">            connect_port 80</span><br><span class="line">            connect_timeout 3</span><br><span class="line">            nb_get_retry 3 </span><br><span class="line">            delay_before_retry 2</span><br><span class="line">     &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">virtual_server 103.13.244.20 443 &#123;</span><br><span class="line">    delay_loop 3</span><br><span class="line">    lb_algo rr</span><br><span class="line">    lb_kind DR</span><br><span class="line">    persistence_timeout 50</span><br><span class="line">    protocol TCP</span><br><span class="line"></span><br><span class="line">    real_server 10.11.0.13 443 &#123;</span><br><span class="line">       weight 1</span><br><span class="line">       SSL_GET &#123;</span><br><span class="line">           url &#123;</span><br><span class="line">	    path /index.html</span><br><span class="line">	    status_code 200</span><br><span class="line">	   &#125;</span><br><span class="line">            connect_port 443</span><br><span class="line">            connect_timeout 3</span><br><span class="line">            nb_get_retry 3 </span><br><span class="line">            delay_before_retry 2</span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br><span class="line">    real_server 10.11.0.14 443 &#123;</span><br><span class="line">       weight 1</span><br><span class="line">       SSL_GET &#123;</span><br><span class="line">           url &#123;</span><br><span class="line">	    path /index.html</span><br><span class="line">	    status_code 200</span><br><span class="line">	   &#125;</span><br><span class="line">            connect_port 443</span><br><span class="line">            connect_timeout 3</span><br><span class="line">            nb_get_retry 3 </span><br><span class="line">            delay_before_retry 2</span><br><span class="line">          &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="LVS2-配置文件"><a href="#LVS2-配置文件" class="headerlink" title="LVS2-配置文件"></a>LVS2-配置文件</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br></pre></td><td class="code"><pre><span class="line">[root@lvs002 ~]# cat /usr/local/keepalived/etc/keepalived-lvs2.conf </span><br><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id 51B_52M</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_51 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface bond0</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 100</span><br><span class="line">    nopreempt</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass DwdLvs11</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        103.13.244.19/29 dev bond1</span><br><span class="line">    &#125;</span><br><span class="line">    notify_master  &quot;/usr/local/keepalived/scripts/master.py lvs002 51 103.13.244.19&quot;</span><br><span class="line">    notify_backup  &quot;/usr/local/keepalived/scripts/backup.py lvs002  51 103.13.244.19&quot;</span><br><span class="line">    notify_fault  &quot;/usr/local/keepalived/scripts/fault.py lvs002 51 103.13.244.19&quot;</span><br><span class="line">    notify_stop  &quot;/usr/local/keepalived/scripts/stop.py lvs002 51 103.13.244.19&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_52 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface bond0</span><br><span class="line">    virtual_router_id 52</span><br><span class="line">    priority 110</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass DwdLvs22</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        103.13.244.20/29 dev bond1</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_routes &#123;</span><br><span class="line">        0.0.0.0/0 via 103.13.244.17</span><br><span class="line">    &#125;</span><br><span class="line">    notify_master  &quot;/usr/local/keepalived/scripts/master.py lvs002 52 103.13.244.20&quot;</span><br><span class="line">    notify_backup  &quot;/usr/local/keepalived/scripts/backup.py lvs002 52 103.13.244.20&quot;</span><br><span class="line">    notify_fault  &quot;/usr/local/keepalived/scripts/fault.py lvs002 52 103.13.244.20&quot;</span><br><span class="line">    notify_stop  &quot;/usr/local/keepalived/scripts/stop.py lvs002 52 103.13.244.20&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">virtual_server 103.13.244.19 80 &#123;</span><br><span class="line">    delay_loop 3</span><br><span class="line">    lb_algo rr</span><br><span class="line">    lb_kind DR</span><br><span class="line">    persistence_timeout 50</span><br><span class="line">    protocol TCP</span><br><span class="line"></span><br><span class="line">    real_server 10.11.0.13 80 &#123;</span><br><span class="line">       weight 1</span><br><span class="line">       HTTP_GET &#123;</span><br><span class="line">            url &#123;</span><br><span class="line">	      path /index.html</span><br><span class="line">	      status_code 200</span><br><span class="line">	    &#125;</span><br><span class="line">            connect_port 80</span><br><span class="line">            connect_timeout 3</span><br><span class="line">            nb_get_retry 3 </span><br><span class="line">            delay_before_retry 2</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br><span class="line">    real_server 10.11.0.14 80 &#123;</span><br><span class="line">       weight 1</span><br><span class="line">       HTTP_GET &#123;</span><br><span class="line">            url &#123;</span><br><span class="line">	    path /index.html</span><br><span class="line">	    status_code 200</span><br><span class="line">	    &#125;</span><br><span class="line">            connect_port 80</span><br><span class="line">            connect_timeout 3</span><br><span class="line">            nb_get_retry 3 </span><br><span class="line">            delay_before_retry 2</span><br><span class="line">     &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">virtual_server 103.13.244.19 443 &#123;</span><br><span class="line">    delay_loop 3</span><br><span class="line">    lb_algo rr</span><br><span class="line">    lb_kind DR</span><br><span class="line">    persistence_timeout 50</span><br><span class="line">    protocol TCP</span><br><span class="line"></span><br><span class="line">    real_server 10.11.0.13 443 &#123;</span><br><span class="line">       weight 1</span><br><span class="line">       SSL_GET &#123;</span><br><span class="line">           url &#123;</span><br><span class="line">	    path /index.html</span><br><span class="line">	    status_code 200</span><br><span class="line">	   &#125;</span><br><span class="line">            connect_port 443</span><br><span class="line">            connect_timeout 3</span><br><span class="line">            nb_get_retry 3 </span><br><span class="line">            delay_before_retry 2</span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br><span class="line">    real_server 10.11.0.14 443 &#123;</span><br><span class="line">       weight 1</span><br><span class="line">       SSL_GET &#123;</span><br><span class="line">           url &#123;</span><br><span class="line">	    path /index.html</span><br><span class="line">	    status_code 200</span><br><span class="line">	   &#125;</span><br><span class="line">            connect_port 443</span><br><span class="line">            connect_timeout 3</span><br><span class="line">            nb_get_retry 3 </span><br><span class="line">            delay_before_retry 2</span><br><span class="line">          &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">virtual_server 103.13.244.20 80 &#123;</span><br><span class="line">    delay_loop 3</span><br><span class="line">    lb_algo rr</span><br><span class="line">    lb_kind DR</span><br><span class="line">    persistence_timeout 50</span><br><span class="line">    protocol TCP</span><br><span class="line"></span><br><span class="line">    real_server 10.11.0.13 80 &#123;</span><br><span class="line">       weight 1</span><br><span class="line">       HTTP_GET &#123;</span><br><span class="line">            url &#123;</span><br><span class="line">	      path /index.html</span><br><span class="line">	      status_code 200</span><br><span class="line">	    &#125;</span><br><span class="line">            connect_port 80</span><br><span class="line">            connect_timeout 3</span><br><span class="line">            nb_get_retry 3 </span><br><span class="line">            delay_before_retry 2</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br><span class="line">    real_server 10.11.0.14 80 &#123;</span><br><span class="line">       weight 1</span><br><span class="line">       HTTP_GET &#123;</span><br><span class="line">            url &#123;</span><br><span class="line">	    path /index.html</span><br><span class="line">	    status_code 200</span><br><span class="line">	    &#125;</span><br><span class="line">            connect_port 80</span><br><span class="line">            connect_timeout 3</span><br><span class="line">            nb_get_retry 3 </span><br><span class="line">            delay_before_retry 2</span><br><span class="line">     &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">virtual_server 103.13.244.20 443 &#123;</span><br><span class="line">    delay_loop 3</span><br><span class="line">    lb_algo rr</span><br><span class="line">    lb_kind DR</span><br><span class="line">    persistence_timeout 50</span><br><span class="line">    protocol TCP</span><br><span class="line"></span><br><span class="line">    real_server 10.11.0.13 443 &#123;</span><br><span class="line">       weight 1</span><br><span class="line">       SSL_GET &#123;</span><br><span class="line">           url &#123;</span><br><span class="line">	    path /index.html</span><br><span class="line">	    status_code 200</span><br><span class="line">	   &#125;</span><br><span class="line">            connect_port 443</span><br><span class="line">            connect_timeout 3</span><br><span class="line">            nb_get_retry 3 </span><br><span class="line">            delay_before_retry 2</span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br><span class="line">    real_server 10.11.0.14 443 &#123;</span><br><span class="line">       weight 1</span><br><span class="line">       SSL_GET &#123;</span><br><span class="line">           url &#123;</span><br><span class="line">	    path /index.html</span><br><span class="line">	    status_code 200</span><br><span class="line">	   &#125;</span><br><span class="line">            connect_port 443</span><br><span class="line">            connect_timeout 3</span><br><span class="line">            nb_get_retry 3 </span><br><span class="line">            delay_before_retry 2</span><br><span class="line">          &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="notify触发脚本"><a href="#notify触发脚本" class="headerlink" title="notify触发脚本"></a>notify触发脚本</h5><p>注意scripts目录及相关的脚本需要手动创建</p>
<p>邮件接收列表根据实际情况进行调整，下面代码中只写了我一个人</p>
<h6 id="LVS-1端脚本"><a href="#LVS-1端脚本" class="headerlink" title="LVS-1端脚本"></a>LVS-1端脚本</h6><ul>
<li><p>master.py</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@lvs001 ~]# cat /usr/local/keepalived/scripts/master.py </span><br><span class="line">#!/usr/bin/env python</span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line">__author__ = &apos;wangxiaohua&apos;</span><br><span class="line">import sys,os</span><br><span class="line"></span><br><span class="line">host =  sys.argv[1]</span><br><span class="line">vrrp_id = sys.argv[2]</span><br><span class="line">vip = sys.argv[3]</span><br><span class="line">mail_subject = &quot;&#123;Host&#125; - Keepalived state change&quot;.format(Host=host)</span><br><span class="line">mail_list = &quot;wangxiaohua@dianwoda.com&quot;</span><br><span class="line"></span><br><span class="line">send_message = &quot;Event_Host: &#123;Host&#125;\nCorrect configuration: VRRP-51(103.133.244.19-MASTER) ; VRRP-52(103.13.244.20-BACKUP)\n\</span><br><span class="line">Event_VRRPID: &#123;Vrrpid&#125;\nEvent_Vip: &#123;Vip&#125;\nEvent: Entering the Master state.Get VIP.Attention please!!!\n&quot;.format(Host=host,Vrrpid=vrrp_id,Vip=vip)</span><br><span class="line"></span><br><span class="line">temp_str = &apos;&quot;&apos;</span><br><span class="line"></span><br><span class="line">content_list = send_message.split(&apos;\n&apos;)</span><br><span class="line"></span><br><span class="line">for i in range(len(content_list)-1):</span><br><span class="line">    temp_str += content_list[i] + &quot;\n&quot;</span><br><span class="line"></span><br><span class="line">temp_str += &apos;&quot;&apos;</span><br><span class="line"></span><br><span class="line">os.system(&apos;echo &apos; + temp_str + &quot;|&quot; + &apos;mail -s &apos; + &apos;&quot;&apos; + mail_subject + &apos;&quot; &apos; + mail_list)</span><br></pre></td></tr></table></figure>
</li>
<li><p>backup.py</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@lvs001 ~]# cat /usr/local/keepalived/scripts/backup.py </span><br><span class="line">#!/usr/bin/env python</span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line">__author__ = &apos;wangxiaohua&apos;</span><br><span class="line">import sys,os</span><br><span class="line"></span><br><span class="line">host =  sys.argv[1]</span><br><span class="line">vrrp_id = sys.argv[2]</span><br><span class="line">vip = sys.argv[3]</span><br><span class="line">mail_subject = &quot;&#123;Host&#125; - Keepalived state change&quot;.format(Host=host)</span><br><span class="line">mail_list = &quot;wangxiaohua@dianwoda.com&quot;</span><br><span class="line"></span><br><span class="line">send_message = &quot;Event_Host: &#123;Host&#125;\nCorrect configuration: VRRP-51(103.133.244.19-MASTER) ; VRRP-52(103.13.244.20-BACKUP)\n\</span><br><span class="line">Event_VRRPID: &#123;Vrrpid&#125;\nEvent_Vip: &#123;Vip&#125;\nEvent: Entering the Backup state.Remove VIP.Attention please!!!\n&quot;.format(Host=host,Vrrpid=vrrp_id,Vip=vip)</span><br><span class="line"></span><br><span class="line">temp_str = &apos;&quot;&apos;</span><br><span class="line"></span><br><span class="line">content_list = send_message.split(&apos;\n&apos;)</span><br><span class="line"></span><br><span class="line">for i in range(len(content_list)-1):</span><br><span class="line">    temp_str += content_list[i] + &quot;\n&quot;</span><br><span class="line"></span><br><span class="line">temp_str += &apos;&quot;&apos;</span><br><span class="line"></span><br><span class="line">os.system(&apos;echo &apos; + temp_str + &quot;|&quot; + &apos;mail -s &apos; + &apos;&quot;&apos; + mail_subject + &apos;&quot; &apos; + mail_list)</span><br></pre></td></tr></table></figure>
</li>
<li><p>fault.py</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@lvs001 ~]# cat /usr/local/keepalived/scripts/fault.py </span><br><span class="line">#!/usr/bin/env python</span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line">__author__ = &apos;wangxiaohua&apos;</span><br><span class="line">import sys,os</span><br><span class="line"></span><br><span class="line">host =  sys.argv[1]</span><br><span class="line">vrrp_id = sys.argv[2]</span><br><span class="line">vip = sys.argv[3]</span><br><span class="line">mail_subject = &quot;&#123;Host&#125; - Keepalived state change&quot;.format(Host=host)</span><br><span class="line">mail_list = &quot;wangxiaohua@dianwoda.com&quot;</span><br><span class="line"></span><br><span class="line">send_message = &quot;Event_Host: &#123;Host&#125;\nCorrect configuration: VRRP-51(103.133.244.19-MASTER) ; VRRP-52(103.13.244.20-BACKUP)\n\</span><br><span class="line">Event_VRRPID: &#123;Vrrpid&#125;\nEvent_Vip: &#123;Vip&#125;\nEvent: Entering the Fault state.Remove VIP.Attention please!!!\n&quot;.format(Host=host,Vrrpid=vrrp_id,Vip=vip)</span><br><span class="line"></span><br><span class="line">temp_str = &apos;&quot;&apos;</span><br><span class="line"></span><br><span class="line">content_list = send_message.split(&apos;\n&apos;)</span><br><span class="line"></span><br><span class="line">for i in range(len(content_list)-1):</span><br><span class="line">    temp_str += content_list[i] + &quot;\n&quot;</span><br><span class="line"></span><br><span class="line">temp_str += &apos;&quot;&apos;</span><br><span class="line"></span><br><span class="line">os.system(&apos;echo &apos; + temp_str + &quot;|&quot; + &apos;mail -s &apos; + &apos;&quot;&apos; + mail_subject + &apos;&quot; &apos; + mail_list)</span><br></pre></td></tr></table></figure>
</li>
<li><p>stop.py</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@lvs001 ~]# cat /usr/local/keepalived/scripts/stop.py </span><br><span class="line">#!/usr/bin/env python</span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line">__author__ = &apos;wangxiaohua&apos;</span><br><span class="line">import sys,os</span><br><span class="line"></span><br><span class="line">host =  sys.argv[1]</span><br><span class="line">vrrp_id = sys.argv[2]</span><br><span class="line">vip = sys.argv[3]</span><br><span class="line">mail_subject = &quot;&#123;Host&#125; - Keepalived state change&quot;.format(Host=host)</span><br><span class="line">mail_list = &quot;wangxiaohua@dianwoda.com&quot;</span><br><span class="line"></span><br><span class="line">send_message = &quot;Event_Host: &#123;Host&#125;\nCorrect configuration: VRRP-51(103.133.244.19-MASTER) ; VRRP-52(103.13.244.20-BACKUP)\n\</span><br><span class="line">Event_VRRPID: &#123;Vrrpid&#125;\nEvent_Vip: &#123;Vip&#125;\nEvent: Entering the Stop state.Get VIP.Attention please!!!\n&quot;.format(Host=host,Vrrpid=vrrp_id,Vip=vip)</span><br><span class="line"></span><br><span class="line">temp_str = &apos;&quot;&apos;</span><br><span class="line"></span><br><span class="line">content_list = send_message.split(&apos;\n&apos;)</span><br><span class="line"></span><br><span class="line">for i in range(len(content_list)-1):</span><br><span class="line">    temp_str += content_list[i] + &quot;\n&quot;</span><br><span class="line"></span><br><span class="line">temp_str += &apos;&quot;&apos;</span><br><span class="line"></span><br><span class="line">os.system(&apos;echo &apos; + temp_str + &quot;|&quot; + &apos;mail -s &apos; + &apos;&quot;&apos; + mail_subject + &apos;&quot; &apos; + mail_list)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h6 id="LVS-2端脚本"><a href="#LVS-2端脚本" class="headerlink" title="LVS-2端脚本"></a>LVS-2端脚本</h6><ul>
<li><p>master.py</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@lvs002 ~]# cat /usr/local/keepalived/scripts/master.py </span><br><span class="line">#!/usr/bin/env python</span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line">__author__ = &apos;wangxiaohua&apos;</span><br><span class="line">import sys,os</span><br><span class="line"></span><br><span class="line">host =  sys.argv[1]</span><br><span class="line">vrrp_id = sys.argv[2]</span><br><span class="line">vip = sys.argv[3]</span><br><span class="line">mail_subject = &quot;&#123;Host&#125; - Keepalived state change&quot;.format(Host=host)</span><br><span class="line">mail_list = &quot;wangxiaohua@dianwoda.com&quot;</span><br><span class="line"></span><br><span class="line">send_message = &quot;Event_Host: &#123;Host&#125;\nCorrect configuration: VRRP-51(103.133.244.19-BACKUP) ; VRRP-52(103.13.244.20-MASTER)\n\</span><br><span class="line">Event_VRRPID: &#123;Vrrpid&#125;\nEvent_Vip: &#123;Vip&#125;\nEvent: Entering the Master state.Get VIP.Attention please!!!\n&quot;.format(Host=host,Vrrpid=vrrp_id,Vip=vip)</span><br><span class="line"></span><br><span class="line">temp_str = &apos;&quot;&apos;</span><br><span class="line"></span><br><span class="line">content_list = send_message.split(&apos;\n&apos;)</span><br><span class="line"></span><br><span class="line">for i in range(len(content_list)-1):</span><br><span class="line">    temp_str += content_list[i] + &quot;\n&quot;</span><br><span class="line"></span><br><span class="line">temp_str += &apos;&quot;&apos;</span><br><span class="line"></span><br><span class="line">os.system(&apos;echo &apos; + temp_str + &quot;|&quot; + &apos;mail -s &apos; + &apos;&quot;&apos; + mail_subject + &apos;&quot; &apos; + mail_list)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>backup.py</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@lvs002 ~]# cat /usr/local/keepalived/scripts/backup.py </span><br><span class="line">#!/usr/bin/env python</span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line">__author__ = &apos;wangxiaohua&apos;</span><br><span class="line">import sys,os</span><br><span class="line"></span><br><span class="line">host =  sys.argv[1]</span><br><span class="line">vrrp_id = sys.argv[2]</span><br><span class="line">vip = sys.argv[3]</span><br><span class="line">mail_subject = &quot;&#123;Host&#125; - Keepalived state change&quot;.format(Host=host)</span><br><span class="line">mail_list = &quot;wangxiaohua@dianwoda.com&quot;</span><br><span class="line"></span><br><span class="line">send_message = &quot;Event_Host: &#123;Host&#125;\nCorrect configuration: VRRP-51(103.133.244.19-BACKUP) ; VRRP-52(103.13.244.20-MASTER)\n\</span><br><span class="line">Event_VRRPID: &#123;Vrrpid&#125;\nEvent_Vip: &#123;Vip&#125;\nEvent: Entering the Backup state.Remove VIP.Attention please!!!\n&quot;.format(Host=host,Vrrpid=vrrp_id,Vip=vip)</span><br><span class="line"></span><br><span class="line">temp_str = &apos;&quot;&apos;</span><br><span class="line"></span><br><span class="line">content_list = send_message.split(&apos;\n&apos;)</span><br><span class="line"></span><br><span class="line">for i in range(len(content_list)-1):</span><br><span class="line">    temp_str += content_list[i] + &quot;\n&quot;</span><br><span class="line"></span><br><span class="line">temp_str += &apos;&quot;&apos;</span><br><span class="line"></span><br><span class="line">os.system(&apos;echo &apos; + temp_str + &quot;|&quot; + &apos;mail -s &apos; + &apos;&quot;&apos; + mail_subject + &apos;&quot; &apos; + mail_list)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>fault.py</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@lvs002 ~]# cat /usr/local/keepalived/scripts/fault.py </span><br><span class="line">#!/usr/bin/env python</span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line">__author__ = &apos;wangxiaohua&apos;</span><br><span class="line">import sys,os</span><br><span class="line"></span><br><span class="line">host =  sys.argv[1]</span><br><span class="line">vrrp_id = sys.argv[2]</span><br><span class="line">vip = sys.argv[3]</span><br><span class="line">mail_subject = &quot;&#123;Host&#125; - Keepalived state change&quot;.format(Host=host)</span><br><span class="line">mail_list = &quot;wangxiaohua@dianwoda.com&quot;</span><br><span class="line"></span><br><span class="line">send_message = &quot;Event_Host: &#123;Host&#125;\nCorrect configuration: VRRP-51(103.133.244.19-BACKUP) ; VRRP-52(103.13.244.20-MASTER)\n\</span><br><span class="line">Event_VRRPID: &#123;Vrrpid&#125;\nEvent_Vip: &#123;Vip&#125;\nEvent: Entering the Fault state.Remove VIP.Attention please!!!\n&quot;.format(Host=host,Vrrpid=vrrp_id,Vip=vip)</span><br><span class="line"></span><br><span class="line">temp_str = &apos;&quot;&apos;</span><br><span class="line"></span><br><span class="line">content_list = send_message.split(&apos;\n&apos;)</span><br><span class="line"></span><br><span class="line">for i in range(len(content_list)-1):</span><br><span class="line">    temp_str += content_list[i] + &quot;\n&quot;</span><br><span class="line"></span><br><span class="line">temp_str += &apos;&quot;&apos;</span><br><span class="line"></span><br><span class="line">os.system(&apos;echo &apos; + temp_str + &quot;|&quot; + &apos;mail -s &apos; + &apos;&quot;&apos; + mail_subject + &apos;&quot; &apos; + mail_list)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>stop.py</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@lvs002 ~]# cat /usr/local/keepalived/scripts/stop.py </span><br><span class="line">#!/usr/bin/env python</span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line">__author__ = &apos;wangxiaohua&apos;</span><br><span class="line">import sys,os</span><br><span class="line"></span><br><span class="line">host =  sys.argv[1]</span><br><span class="line">vrrp_id = sys.argv[2]</span><br><span class="line">vip = sys.argv[3]</span><br><span class="line">mail_subject = &quot;&#123;Host&#125; - Keepalived state change&quot;.format(Host=host)</span><br><span class="line">mail_list = &quot;wangxiaohua@dianwoda.com&quot;</span><br><span class="line"></span><br><span class="line">send_message = &quot;Event_Host: &#123;Host&#125;\nCorrect configuration: VRRP-51(103.133.244.19-BACKUP) ; VRRP-52(103.13.244.20-MASTER)\n\</span><br><span class="line">Event_VRRPID: &#123;Vrrpid&#125;\nEvent_Vip: &#123;Vip&#125;\nEvent: Entering the Stop state.Get VIP.Attention please!!!\n&quot;.format(Host=host,Vrrpid=vrrp_id,Vip=vip)</span><br><span class="line"></span><br><span class="line">temp_str = &apos;&quot;&apos;</span><br><span class="line"></span><br><span class="line">content_list = send_message.split(&apos;\n&apos;)</span><br><span class="line"></span><br><span class="line">for i in range(len(content_list)-1):</span><br><span class="line">    temp_str += content_list[i] + &quot;\n&quot;</span><br><span class="line"></span><br><span class="line">temp_str += &apos;&quot;&apos;</span><br><span class="line"></span><br><span class="line">os.system(&apos;echo &apos; + temp_str + &quot;|&quot; + &apos;mail -s &apos; + &apos;&quot;&apos; + mail_subject + &apos;&quot; &apos; + mail_list)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="软链接设置"><a href="#软链接设置" class="headerlink" title="软链接设置"></a>软链接设置</h4><p>LVS服务器主要的日志输出是在keepalived，因此我们需要做一个软链接，将分配的磁盘空间链接到keepalived的日志目录下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@lvs001 ~]# mkdir /data1/keepalived </span><br><span class="line">[root@lvs001 ~]# ln -s /data1/keepalived /var/log/</span><br></pre></td></tr></table></figure>
<h4 id="Keepalived自定义日志文件"><a href="#Keepalived自定义日志文件" class="headerlink" title="Keepalived自定义日志文件"></a>Keepalived自定义日志文件</h4><p><strong>编辑rsyslog配置文件</strong></p>
<p>[root@lvs001 ~]# vim /etc/rsyslog.conf</p>
<p>修改内容为以下（42行添加;local0.*，63行为新增）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">42 *.info;mail.none;authpriv.none;cron.none;local0.none                /var/log/messages</span><br><span class="line"></span><br><span class="line">63 local0.*                                        /var/log/keepalived/keepalived.log</span><br></pre></td></tr></table></figure>
<p>然后重启日志服务使配置生效：</p>
<p>[root@lvs001 ~]# /etc/init.d/rsyslog restart</p>
<p><strong>注意：</strong>/var/log/keepalived目录如果不存在需要手动创建</p>
<h4 id="防火墙配置"><a href="#防火墙配置" class="headerlink" title="防火墙配置"></a>防火墙配置</h4><p>两台LVS的配置均一致，这里仅以一台为例，在实际操作时<strong>==两台都需要进行配置==</strong></p>
<p>防火墙配置如下，并设置为开机自启动</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">-A INPUT -p tcp -m tcp --dport 80 -j ACCEPT</span><br><span class="line">-A INPUT -p tcp -m tcp --dport 443 -j ACCEPT</span><br><span class="line">-A INPUT -s 10.11.4.0/24 -p tcp -m tcp --dport 10051 -j ACCEPT</span><br><span class="line">-A INPUT -s 10.11.4.0/24 -p tcp -m tcp --dport 10050 -j ACCEPT</span><br><span class="line">-A INPUT -s 10.11.0.0/16 -p tcp -m tcp --dport 22 -j ACCEPT</span><br><span class="line">-A INPUT -s 10.10.10.0/24 -p tcp -m tcp --dport 22 -j ACCEPT</span><br><span class="line">-A INPUT -s 172.24.0.0/16 -p tcp -m tcp --dport 22 -j ACCEPT</span><br><span class="line">-A INPUT -p tcp -m tcp --dport 22 -j DROP</span><br></pre></td></tr></table></figure>
<p>[root@lvs001 ~]# chkconfig iptables on</p>
<h4 id="内核参数配置"><a href="#内核参数配置" class="headerlink" title="内核参数配置"></a>内核参数配置</h4><p>修改/etc/sysctl.conf，在文件末尾添加以下内容：</p>
<p>[root@lvs002 local]# cat /etc/sysctl.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net.ipv4.ip_forward = 1</span><br></pre></td></tr></table></figure>
<p>[root@lvs001 ~]# sysctl  -p<br>然后执行上述命令时配置生效</p>
<p><strong>关于内核参数的详细说明，详见最后的《注意事项及常见问题解答》</strong></p>
<h4 id="邮件发送设置"><a href="#邮件发送设置" class="headerlink" title="邮件发送设置"></a>邮件发送设置</h4><p>在Keepalived的状态切换时，需要进行相应的通知，因此此时需要在服务器上配置邮件发送相关设置</p>
<p><strong>安装发送工具mailx</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]#  yum -y install mailx </span><br><span class="line">配置文件路径：/etc/mail.rc</span><br></pre></td></tr></table></figure>
<p> <strong>编辑配置文件内容</strong></p>
<p>[root@master ~]# vim /etc/mail.rc</p>
<p>在文件的末尾添加以下内容，保存退出即可生效，不需要重启额外服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">set from=wangxiaohua@dianwoda.com</span><br><span class="line">set smtp=smtp.mxhichina.com</span><br><span class="line">set smtp-auth-user=wangxiaohua@dianwoda.com</span><br><span class="line">set smtp-auth-password=Wxh19926252837</span><br><span class="line">set smtp-auth=login</span><br></pre></td></tr></table></figure>
<p><strong>测试效果</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@lvs001 etc]# echo &quot;test mail&quot; | mail -s &quot;test mail&quot; wangxiaohua@dianwoda.com</span><br><span class="line">发送之后，即可在邮箱中看到此邮件</span><br></pre></td></tr></table></figure>
<p>在上生产环境时，申请额外的发送邮件账户</p>
<h4 id="启动keepalived服务"><a href="#启动keepalived服务" class="headerlink" title="启动keepalived服务"></a>启动keepalived服务</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/keepalived/sbin/keepalived -f /usr/local/keepalived/etc/keepalived-lvs1.conf -D -S 0</span><br><span class="line">and</span><br><span class="line">/usr/local/keepalived/sbin/keepalived -f /usr/local/keepalived/etc/keepalived-lvs2.conf -D -S 0</span><br></pre></td></tr></table></figure>
<p>启动参数说明：</p>
<ul>
<li>-f：指定配置文件</li>
<li>-S：设置日志输出接口，结合上面的rsyslog配置，实现自定义日志路径及文件</li>
</ul>
<p>查看LVS的连接状态（在后端主机配置完毕之后才可以看到realserver信息）：</p>
<p>[root@lvs001 ~]# ipvsadm -Ln –stats  –rate</p>
<h3 id="后端Nginx配置"><a href="#后端Nginx配置" class="headerlink" title="后端Nginx配置"></a>后端Nginx配置</h3><p>后端两台Nginx服务器的配置均一致，这里仅以一台为例，在实际操作时<strong>==两台都需要进行配置==</strong></p>
<h4 id="防火墙配置-1"><a href="#防火墙配置-1" class="headerlink" title="防火墙配置"></a>防火墙配置</h4><p>防火墙配置如下，并设置为开机自启动</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">-A INPUT -s 10.11.0.0/16 -p tcp -m tcp --dport 80 -j ACCEPT </span><br><span class="line">-A INPUT -s 10.11.4.0/24 -p tcp -m tcp --dport 10051 -j ACCEPT </span><br><span class="line">-A INPUT -s 10.11.4.0/24 -p tcp -m tcp --dport 10050 -j ACCEPT </span><br><span class="line">-A INPUT -s 10.11.0.0/16 -p tcp -m tcp --dport 22 -j ACCEPT </span><br><span class="line">-A INPUT -s 10.10.10.0/24 -p tcp -m tcp --dport 22 -j ACCEPT </span><br><span class="line">-A INPUT -s 172.24.0.0/16 -p tcp -m tcp --dport 22 -j ACCEPT </span><br><span class="line">-A INPUT -p tcp -m tcp --dport 22 -j DROP</span><br></pre></td></tr></table></figure>
<p>[root@nginx001 ~]# chkconfig  iptables on</p>
<h4 id="VIP配置-1"><a href="#VIP配置-1" class="headerlink" title="VIP配置"></a>VIP配置</h4><p>需要创建lo子接口网卡，配置VIP，注意掩码为32位</p>
<p>[root@nginx001 ~]# cat /etc/sysconfig/network-scripts/ifcfg-lo:0</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">DEVICE=lo:1</span><br><span class="line">IPADDR=103.13.244.19</span><br><span class="line">NETMASK=255.255.255.255</span><br><span class="line">ONBOOT=yes</span><br></pre></td></tr></table></figure>
<p>[root@nginx001 ~]# cat /etc/sysconfig/network-scripts/ifcfg-lo:1</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">DEVICE=lo:1</span><br><span class="line">IPADDR=103.13.244.20</span><br><span class="line">NETMASK=255.255.255.255</span><br><span class="line">ONBOOT=yes</span><br></pre></td></tr></table></figure>
<p>启用网卡：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ifdown lo:0 &amp;&amp; ifdown lo:1</span><br><span class="line">ifup lo:0 &amp;&amp; ifup lo:1</span><br><span class="line"></span><br><span class="line">如果上述不生效，则需要重启网络服务</span><br><span class="line">/etc/init.d/network restart</span><br></pre></td></tr></table></figure>
<h4 id="内核参数配置-1"><a href="#内核参数配置-1" class="headerlink" title="内核参数配置"></a>内核参数配置</h4><p>修改/etc/sysctl.conf，在文件末尾添加以下内容：</p>
<p>[root@nginx001 ~]# cat /etc/sysctl.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line">net.ipv4.conf.lo.arp_ignore = 1</span><br><span class="line">net.ipv4.conf.lo.arp_announce = 2</span><br><span class="line">net.ipv4.conf.all.arp_ignore = 1</span><br><span class="line">net.ipv4.conf.all.arp_announce = 2</span><br><span class="line">net.ipv4.conf.default.arp_filter = 1</span><br><span class="line">net.ipv4.conf.bond1.rp_filter=0</span><br><span class="line">net.ipv4.conf.bond0.rp_filter=0</span><br><span class="line">net.ipv4.conf.lo.rp_filter=0</span><br></pre></td></tr></table></figure>
<p>[root@nginx001 ~]# sysctl  -p<br>然后执行上述命令时配置生效</p>
<p><strong>关于内核参数的详细说明，详见最后的《注意事项及常见问题解答》</strong></p>
<h3 id="Zabbix监控配置"><a href="#Zabbix监控配置" class="headerlink" title="Zabbix监控配置"></a>Zabbix监控配置</h3><h4 id="LVS端配置"><a href="#LVS端配置" class="headerlink" title="LVS端配置"></a>LVS端配置</h4><ul>
<li><p>Keepalived服务的运行状态</p>
</li>
<li><p>keepalived的角色状态变化</p>
<blockquote>
<p>这部分使用keepalived的notify触发脚本进行控制</p>
<p>当进入某种状态的时候，发送邮件进行通知</p>
</blockquote>
<ul>
<li>进入backup状态：发送邮件进行通知（包含VRRP实例和IP地址信息）</li>
<li>进入master状态：发送邮件进行通知（包含VRRP实例和IP地址信息）</li>
<li>进入fault状态：发送邮件进行通知（包含VRRP实例和IP地址信息）</li>
<li>进入stop状态，程序终止，不使用触发脚本，使用zabbix进行监控</li>
</ul>
</li>
</ul>
<ul>
<li>LVS的统计数据监控</li>
</ul>
<p>统计LVS的负载状况，这里需要了解LVS相关的4层负载性能指标参数</p>
<ul>
<li>其他监控指标</li>
</ul>
<h4 id="NGINX端配置"><a href="#NGINX端配置" class="headerlink" title="NGINX端配置"></a>NGINX端配置</h4><ul>
<li>Nginx端口存活状态</li>
<li>NGINX-web监测</li>
<li>负载均衡统计数据监控</li>
</ul>
<p>统计nginx的负载状态，这里需要了解相关的负载性能指标参数，可以结合tsar实现</p>
<h1 id="注意事项及常见问题解答"><a href="#注意事项及常见问题解答" class="headerlink" title="注意事项及常见问题解答"></a>注意事项及常见问题解答</h1><h2 id="配置及启动顺序"><a href="#配置及启动顺序" class="headerlink" title="配置及启动顺序"></a>配置及启动顺序</h2><p>优先启动后端realserver，然后再启动LVS</p>
<h2 id="后端服务器端口配置问题"><a href="#后端服务器端口配置问题" class="headerlink" title="后端服务器端口配置问题"></a>后端服务器端口配置问题</h2><p>因为DR模式只是修改MAC地址，不会修改三层以上的信息，所以在配置后端节点的时候，端口号必须保持一致</p>
<p>也就是说，VIP的80端口，对应后端的服务器的端口也只能是80，而不能是81、8080等其他端口</p>
<p>如果非要实现后端服务器不和前端使用同样的端口，那么可以在realserver上使用iptables来将80的数据包转发到本地的8000上</p>
<h2 id="RealServer为什么要在lo接口上配置VIP？"><a href="#RealServer为什么要在lo接口上配置VIP？" class="headerlink" title="RealServer为什么要在lo接口上配置VIP？"></a>RealServer为什么要在lo接口上配置VIP？</h2><p>既然要让RS能够处理目标地址为vip的IP包，首先必须要让RS能接收到这个包。</p>
<p>在lo上配置vip能够完成接收包并将结果返回client。</p>
<h2 id="在eth0网卡上配置VIP可以吗？"><a href="#在eth0网卡上配置VIP可以吗？" class="headerlink" title="在eth0网卡上配置VIP可以吗？"></a>在eth0网卡上配置VIP可以吗？</h2><p>不可以，将VIP设置在eth0网卡上,会影响RS的arp请求,造成整体LVS集群arp缓存表紊乱，以至于整个负载均衡集群都不能正常工作。</p>
<h2 id="为什么要抑制ARP响应？"><a href="#为什么要抑制ARP响应？" class="headerlink" title="为什么要抑制ARP响应？"></a>为什么要抑制ARP响应？</h2><h2 id="公网IP配置"><a href="#公网IP配置" class="headerlink" title="公网IP配置"></a>公网IP配置</h2><p>因为采用LVS+Nginx的配置，4台主机共使用4个公网IP地址（4个公网IP在同一个网段）</p>
<p>他的路由规则是：</p>
<p>Nginx服务器接受到数据包之后（源IP为客户端的访问公网IP，例如60.网段目的IP为VIP（此时是配置再lo口上的））</p>
<p>然后Nginx查询路由表，没有60网段的直连理由</p>
<p>此时就要走默认路由了，主机就会在ARP响应表中，查找网关的IP地址和MAC地址，之后将报文转发给默认官网的MAC地址，即网关设备的相应接口 （此时的源IP为VIP，目的IP为客户端的IP，这里为60网段</p>
<p>路由器收到报文之后，解封装之后，发现目的IP地址（60网段）非直连网段，然后查找路由表</p>
<p>因此，配置的注意事项如下：</p>
<ul>
<li><p>还是使用DR模式，NAT模式的话要建立IP隧道，开销较大</p>
</li>
<li><p>keepalived的VIP配置接口为公网IP接口，也就是说和后端的nginx的公网IP在同一个交换机上</p>
</li>
<li><p>后端的realserver填写为公网IP</p>
</li>
<li><p>Nginx服务器配置公网</p>
</li>
<li><p>Nginx服务器默认路由为公网</p>
</li>
</ul>
<p>在nginx服务器上做好bond之后添加以下路由条目，防止将自己挡在网络外面：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">route add -net 103.13.244.16 netmask 255.255.255.248 dev bond1</span><br><span class="line">route add -net 10.11.0.0 netmask 255.255.0.0 gateway 10.11.0.254</span><br><span class="line">route add -net 172.24.0.0 netmask 255.255.0.0 gateway 10.11.0.254</span><br><span class="line">route add -net 10.10.0.0 netmask 255.255.255.0 gateway 10.11.0.254</span><br><span class="line"></span><br><span class="line">route del default gw 82.17.68.254</span><br><span class="line"></span><br><span class="line">route add default gw 10.11.0.254</span><br></pre></td></tr></table></figure>
<h2 id="DR模式为什么必须有一块网卡和VIP在同一个网段"><a href="#DR模式为什么必须有一块网卡和VIP在同一个网段" class="headerlink" title="DR模式为什么必须有一块网卡和VIP在同一个网段"></a>DR模式为什么必须有一块网卡和VIP在同一个网段</h2><h2 id="DR模式的AR响应问题"><a href="#DR模式的AR响应问题" class="headerlink" title="DR模式的AR响应问题"></a>DR模式的AR响应问题</h2><p>设置通过ARP机制实现：当real server接收到目的IP地址是VIP的ARP广播请求包时，不做出回应。 </p>
<h1 id="VIP配置网卡问题"><a href="#VIP配置网卡问题" class="headerlink" title="VIP配置网卡问题"></a>VIP配置网卡问题</h1><p>必须配置再bond1上 不能配置再bond0上</p>
<p>因为只有在bond1上 外网的客户端才能访问</p>
<p>因为10.11.0.0/24网段对外宣告的是这一段的路由，外界不会获悉103.13.244.19这个</p>
<p>19这个IP所在的网段是103.13.244.16/29这个网段  它应该身处于这一个网段只能才能被访问</p>
<p>也就是说：</p>
<p>VIP在bond1上</p>
<p>默认路由配置的也是103.13.244.17</p>
<p>bond1要每隔3秒和后端的realserver（ip:port）进行通信（建立tcp三次握手和挥手），检测后端节点的存活状态</p>
<p>也就是说 从103.13.244.19–&gt;10.11.0.13这条路是不通的</p>
<p>lb对后端realserver的检测（tcp的三次握手，内容是ip:port）</p>
<p>keepalived之间的检测（只是tcp的三次握手，而没有ip:prt）</p>
<h1 id="网卡流量转发-iptables"><a href="#网卡流量转发-iptables" class="headerlink" title="网卡流量转发-iptables"></a>网卡流量转发-iptables</h1><p>[root@IM ~]# sysctl net.ipv4.ip_forward #查看当前系统是否支持包转发。</p>
<p> [root@IM ~]# sysctl -w net.ipv4.ip_forward=1 #重启后失效 </p>
<p>[root@IM ~]# vi /etc/sysctl.conf #重启后任然有效 net.ipv4.ip_forward = 1  </p>
<p>[root@IM ~]# iptables -t -nat -A PREROUTING -d 192.168.4.128/32 -p tcp -m tcp –dport 88 -j DNAT –to-destination x.x.x.x:88 #外网的IP是映射到内网的IP，进来的IP88端口转发到指定IP的端口88</p>
<p>[root@IM ~]# iptables -t -nat -A POSTROUTING -d x.x.x.x -p tcp -m tcp –dport 88 -j SNAT –to 192.168.1.8 #返回的时候先外网的IP转发到网卡2的IP上。</p>
<p>[root@IM ~]# iptables -t -nat -A POSTROUTING -d 192.168.1.8 -p tcp -m tcp –dport 88 -j SNAT –to 192.168.4.128</p>
<p>#再把网卡2的IP转发到网卡1的IP地址，这样就可以从外网的IP返回了。<br>[root@IM ~]# service iptables save #把iptables规则保存到文件中</p>
<p>[root@IM ~]# vi /etc/rc.local #把iptbles规则写到开启启动中</p>
<p>#load iptbales<br>iptables-restore &gt; /etc/sysconfig/iptables</p>
<p>[root@IM ~]# service iptables restart #重启iptables。</p>
<h1 id="LVS-keepalived端口启动失败"><a href="#LVS-keepalived端口启动失败" class="headerlink" title="LVS+keepalived端口启动失败"></a>LVS+keepalived端口启动失败</h1><h1 id="现状及问题及解决方案"><a href="#现状及问题及解决方案" class="headerlink" title="现状及问题及解决方案"></a>现状及问题及解决方案</h1><h2 id="1-LVS的模式选择"><a href="#1-LVS的模式选择" class="headerlink" title="1. LVS的模式选择"></a>1. LVS的模式选择</h2><ul>
<li><p>NAT模式</p>
<blockquote>
<p>一台服务器上进行所有操作，承担负载太大，不可取。</p>
</blockquote>
</li>
<li><p>TUN模式</p>
<blockquote>
<p>与后端主机需要建立IP隧道，额外的开销无法避免，并且和DR模式一样，后端节点也是需要配置VIP，无法解决VIP的ARP响应问题</p>
</blockquote>
</li>
<li><p>DR模式</p>
</li>
</ul>
<h2 id="数据包流向"><a href="#数据包流向" class="headerlink" title="数据包流向"></a>数据包流向</h2><p>这里以lvs001，并配置公网IP103.13.244.19为例进行说明</p>
<p>配置文件配置：</p>
<ul>
<li>keepalived的VRRP组之间的检测网卡，绑定在bond0上，使用内网地址进行HA功能的检测</li>
<li>VIP设置为公网地址103.13.244.19，并且必须要绑定在bond1接口上（因为只有这样才能被公网客户端访问，如果绑定在bond0接口是无法被访问到的，因为<ul>
<li>公网的客户端通过路由寻找该公网地址，最终找到103.13.244.16/29所在网络，但是19不在该网段所在的交换机内。</li>
<li>如果103.13.244.19配置在10.11.0.0/24所在网段的交换机网络内，是无法被外界获悉的</li>
</ul>
</li>
<li>LVS的后端的真实服务器IP（realserver的IP）需要写公网地址（103.13.244.21/22），因为LB需要检测后端realserver的存活状态<ul>
<li>但是realsever写了公网IP地址之后，因为ARP问题，是无法访问的（因为此时LB的网卡上只配置了这一个VIP）,后端节点收到该ARP请求（arp请求的格式为：who is 21， tell 19，但是realserver本身就是配置了19）之后会内部屏蔽掉】</li>
<li>realserver写内网地址（例如10.11.0.13），开启路由转发功能</li>
</ul>
</li>
</ul>
<p><strong>数据包走向</strong></p>
<p>当用户的请求发往虚拟服务器，LB根据设定的包转发策略和负载均衡调度算法将用户请求转发给RS。 </p>
<p>RS再将用户请求结果返回给用户。同请求包一样，应答包的返回方式也与包转发策略有关。 </p>
<p>lvs001上开启路由转发</p>
<p>经过抓包，发现lvs001，能够根据路由转发，自动的和13建立连接，以时间间隔为3秒的方式来检测后端服务器的存活状态。</p>
<p>公网客户端换–&gt;VIP（19/20）</p>
<p>lvs001（19/20）收到该数据包之后，会通过10.11.0.11（不修改数据包的内容，直接转发）所在网卡，将数据包发送给10.11.0.13（通过抓包获取）</p>
<p>realserver获取到的数据包的内容是（源IP是公网的客户端IP地址，目标IP地址是VIP）</p>
<p>现在需要做的操作时realserver和公网的客户端进行通信</p>
<p>这个时候去了解LVS的路由转发核心</p>
<h1 id="数据包"><a href="#数据包" class="headerlink" title="数据包"></a>数据包</h1><p>TCP三次握手</p>
<p>公网客户端–&gt;19  发送tcp的syn报文</p>
<p>19接受到之后，处于tcp syn reciv  然后把这个报文直接转发给后端的realserver</p>
<p>lvs001上</p>
<p>[root@lvs001 ~]# netstat -s |grep reject<br>    113 packets rejects in established connections because of timestamp</p>
<p>nginx001上</p>
<p>[root@nginx001 ~]# netstat -s |grep reject<br>    89 packets rejects in established connections because of timestamp</p>
<h1 id="Keepalived监控"><a href="#Keepalived监控" class="headerlink" title="Keepalived监控"></a>Keepalived监控</h1><p>使用killall命令 killall -0 keepalived</p>
<p>编写脚本，检测keepalived进程的状态，当检测成功是返回值为0，检测失败时返回为非0的值</p>
<p>自定义监控脚本如下所示：</p>
<h1 id="LVS性能指标及监控"><a href="#LVS性能指标及监控" class="headerlink" title="LVS性能指标及监控"></a>LVS性能指标及监控</h1><p>​    </p>

      
    </div>
    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div></div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/wechatpay.jpg" alt="XiaoHua WANG 微信支付"/>
        <p>微信支付</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/alipay.jpg" alt="XiaoHua WANG 支付宝"/>
        <p>支付宝</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/LVS/" rel="tag"># LVS</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/04/17/编程语言/Python/个人总结/django项目/Python-django项目/" rel="next" title="《Python编程从入门到实践》-Django项目">
                <i class="fa fa-chevron-left"></i> 《Python编程从入门到实践》-Django项目
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/04/18/进程管理-进程性能分析/" rel="prev" title="进程管理-进程性能分析">
                进程管理-进程性能分析 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
        <!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
<span class="jiathis_txt">分享到：</span>
<a class="jiathis_button_fav">收藏夹</a>
<a class="jiathis_button_copy">复制网址</a>
<a class="jiathis_button_email">邮件</a>
<a class="jiathis_button_weixin">微信</a>
<a class="jiathis_button_qzone">QQ空间</a>
<a class="jiathis_button_tqq">腾讯微博</a>
<a class="jiathis_button_douban">豆瓣</a>
<a class="jiathis_button_share">一键分享</a>

<a href="http://www.jiathis.com/share?uid=2140465" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a>
<a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript" >
var jiathis_config={
  data_track_clickback:true,
  summary:"",
  shortUrl:false,
  hideMore:false
}
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=" charset="utf-8"></script>
<!-- JiaThis Button END -->
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="lv-container" data-id="city" data-uid="MTAyMC8zMzg1NC8xMDQwNw=="></div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/touxiang.jpg"
                alt="XiaoHua WANG" />
            
              <p class="site-author-name" itemprop="name">XiaoHua WANG</p>
              <p class="site-description motion-element" itemprop="description">Focus on Linux operations and development.</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">105</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">122</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">86</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#LVS介绍"><span class="nav-number">1.</span> <span class="nav-text">LVS介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#为什么使用LVS？"><span class="nav-number">1.1.</span> <span class="nav-text">为什么使用LVS？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#LVS内核模块ip-vs介绍"><span class="nav-number">1.2.</span> <span class="nav-text">LVS内核模块ip_vs介绍</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#LVS集群搭建"><span class="nav-number">2.</span> <span class="nav-text">LVS集群搭建</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#整体架构"><span class="nav-number">2.1.</span> <span class="nav-text">整体架构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安装ipvsadm管理工具"><span class="nav-number">2.2.</span> <span class="nav-text">安装ipvsadm管理工具</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ipvsadm命令"><span class="nav-number">2.2.1.</span> <span class="nav-text">ipvsadm命令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#LVS中文站点-ipvsadm"><span class="nav-number">2.2.2.</span> <span class="nav-text">LVS中文站点 -ipvsadm</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Keepalived安装配置"><span class="nav-number">2.3.</span> <span class="nav-text">Keepalived安装配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安装keepalived的原因"><span class="nav-number">2.4.</span> <span class="nav-text">安装keepalived的原因</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#安装keepalived依赖关系"><span class="nav-number">2.4.1.</span> <span class="nav-text">安装keepalived依赖关系</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装keepalived"><span class="nav-number">2.4.2.</span> <span class="nav-text">安装keepalived</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#keepalived配置"><span class="nav-number">2.4.3.</span> <span class="nav-text">keepalived配置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#配置文件说明"><span class="nav-number">2.4.3.1.</span> <span class="nav-text">配置文件说明</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#自定义日志文件"><span class="nav-number">2.4.3.2.</span> <span class="nav-text">自定义日志文件</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#后端服务器节点配置"><span class="nav-number">2.5.</span> <span class="nav-text">后端服务器节点配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#VIP配置"><span class="nav-number">2.5.1.</span> <span class="nav-text">VIP配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#网络参数配置"><span class="nav-number">2.5.2.</span> <span class="nav-text">网络参数配置</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Keepalived的LVS负载均衡配置"><span class="nav-number">3.</span> <span class="nav-text">Keepalived的LVS负载均衡配置</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#通用TCP服务"><span class="nav-number">3.1.</span> <span class="nav-text">通用TCP服务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Web服务"><span class="nav-number">3.2.</span> <span class="nav-text">Web服务</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#实战案例"><span class="nav-number">4.</span> <span class="nav-text">实战案例</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#案例1-多网卡内网外IP双主LVS-双Nginx四七层负载均衡部署"><span class="nav-number">4.1.</span> <span class="nav-text">案例1-多网卡内网外IP双主LVS+双Nginx四七层负载均衡部署</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#系统架构图"><span class="nav-number">4.1.1.</span> <span class="nav-text">系统架构图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#前端LVS配置"><span class="nav-number">4.1.2.</span> <span class="nav-text">前端LVS配置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#LVS-keepalived配置文件"><span class="nav-number">4.1.2.1.</span> <span class="nav-text">LVS+keepalived配置文件</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#LVS1-配置文件"><span class="nav-number">4.1.2.1.1.</span> <span class="nav-text">LVS1-配置文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#LVS2-配置文件"><span class="nav-number">4.1.2.1.2.</span> <span class="nav-text">LVS2-配置文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#notify触发脚本"><span class="nav-number">4.1.2.1.3.</span> <span class="nav-text">notify触发脚本</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#LVS-1端脚本"><span class="nav-number">4.1.2.1.3.1.</span> <span class="nav-text">LVS-1端脚本</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#LVS-2端脚本"><span class="nav-number">4.1.2.1.3.2.</span> <span class="nav-text">LVS-2端脚本</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#软链接设置"><span class="nav-number">4.1.2.2.</span> <span class="nav-text">软链接设置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Keepalived自定义日志文件"><span class="nav-number">4.1.2.3.</span> <span class="nav-text">Keepalived自定义日志文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#防火墙配置"><span class="nav-number">4.1.2.4.</span> <span class="nav-text">防火墙配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#内核参数配置"><span class="nav-number">4.1.2.5.</span> <span class="nav-text">内核参数配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#邮件发送设置"><span class="nav-number">4.1.2.6.</span> <span class="nav-text">邮件发送设置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#启动keepalived服务"><span class="nav-number">4.1.2.7.</span> <span class="nav-text">启动keepalived服务</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#后端Nginx配置"><span class="nav-number">4.1.3.</span> <span class="nav-text">后端Nginx配置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#防火墙配置-1"><span class="nav-number">4.1.3.1.</span> <span class="nav-text">防火墙配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#VIP配置-1"><span class="nav-number">4.1.3.2.</span> <span class="nav-text">VIP配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#内核参数配置-1"><span class="nav-number">4.1.3.3.</span> <span class="nav-text">内核参数配置</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Zabbix监控配置"><span class="nav-number">4.1.4.</span> <span class="nav-text">Zabbix监控配置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#LVS端配置"><span class="nav-number">4.1.4.1.</span> <span class="nav-text">LVS端配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#NGINX端配置"><span class="nav-number">4.1.4.2.</span> <span class="nav-text">NGINX端配置</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#注意事项及常见问题解答"><span class="nav-number">5.</span> <span class="nav-text">注意事项及常见问题解答</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#配置及启动顺序"><span class="nav-number">5.1.</span> <span class="nav-text">配置及启动顺序</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#后端服务器端口配置问题"><span class="nav-number">5.2.</span> <span class="nav-text">后端服务器端口配置问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RealServer为什么要在lo接口上配置VIP？"><span class="nav-number">5.3.</span> <span class="nav-text">RealServer为什么要在lo接口上配置VIP？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#在eth0网卡上配置VIP可以吗？"><span class="nav-number">5.4.</span> <span class="nav-text">在eth0网卡上配置VIP可以吗？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#为什么要抑制ARP响应？"><span class="nav-number">5.5.</span> <span class="nav-text">为什么要抑制ARP响应？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#公网IP配置"><span class="nav-number">5.6.</span> <span class="nav-text">公网IP配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DR模式为什么必须有一块网卡和VIP在同一个网段"><span class="nav-number">5.7.</span> <span class="nav-text">DR模式为什么必须有一块网卡和VIP在同一个网段</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DR模式的AR响应问题"><span class="nav-number">5.8.</span> <span class="nav-text">DR模式的AR响应问题</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#VIP配置网卡问题"><span class="nav-number">6.</span> <span class="nav-text">VIP配置网卡问题</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#网卡流量转发-iptables"><span class="nav-number">7.</span> <span class="nav-text">网卡流量转发-iptables</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#LVS-keepalived端口启动失败"><span class="nav-number">8.</span> <span class="nav-text">LVS+keepalived端口启动失败</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#现状及问题及解决方案"><span class="nav-number">9.</span> <span class="nav-text">现状及问题及解决方案</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-LVS的模式选择"><span class="nav-number">9.1.</span> <span class="nav-text">1. LVS的模式选择</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#数据包流向"><span class="nav-number">9.2.</span> <span class="nav-text">数据包流向</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#数据包"><span class="nav-number">10.</span> <span class="nav-text">数据包</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Keepalived监控"><span class="nav-number">11.</span> <span class="nav-text">Keepalived监控</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#LVS性能指标及监控"><span class="nav-number">12.</span> <span class="nav-text">LVS性能指标及监控</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">XiaoHua WANG</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("mlSs9Cm0Xv2D9B7cFqbp25Df-gzGzoHsz", "alKheIFly9OVC81YCV7otTrf");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  
  

  

  

  

</body>
</html>
