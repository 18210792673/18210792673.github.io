<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="LVS," />





  <link rel="alternate" href="/atom.xml" title="Watchmen1992's Blog" type="application/atom+xml" />






<meta name="description" content="LVS性能指标及监控">
<meta name="keywords" content="LVS">
<meta property="og:type" content="article">
<meta property="og:title" content="LVS性能指标及监控">
<meta property="og:url" content="http://yoursite.com/2018/07/10/IT科学技术知识体系结构-Linux运维方向/高并发/负载均衡/4层负载均衡-LVS/LVS性能指标及监控/index.html">
<meta property="og:site_name" content="Watchmen1992&#39;s Blog">
<meta property="og:description" content="LVS性能指标及监控">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2018-07-10T08:08:26.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="LVS性能指标及监控">
<meta name="twitter:description" content="LVS性能指标及监控">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2018/07/10/IT科学技术知识体系结构-Linux运维方向/高并发/负载均衡/4层负载均衡-LVS/LVS性能指标及监控/"/>





  <title>LVS性能指标及监控 | Watchmen1992's Blog</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?07235ad5687ee838f373b31c7c687d23";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Watchmen1992's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">锦瑟年华当与书香为度，是为不负天地人生。</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/07/10/IT科学技术知识体系结构-Linux运维方向/高并发/负载均衡/4层负载均衡-LVS/LVS性能指标及监控/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="XiaoHua WANG">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/touxiang.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Watchmen1992's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">LVS性能指标及监控</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-07-10T16:08:26+08:00">
                2018-07-10
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2018-07-10T16:08:26+08:00">
                2018-07-10
              </time>
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IT科学技术知识体系结构-Linux运维方向/" itemprop="url" rel="index">
                    <span itemprop="name">IT科学技术知识体系结构-Linux运维方向</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IT科学技术知识体系结构-Linux运维方向/高并发/" itemprop="url" rel="index">
                    <span itemprop="name">高并发</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IT科学技术知识体系结构-Linux运维方向/高并发/负载均衡/" itemprop="url" rel="index">
                    <span itemprop="name">负载均衡</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IT科学技术知识体系结构-Linux运维方向/高并发/负载均衡/4层负载均衡-LVS/" itemprop="url" rel="index">
                    <span itemprop="name">4层负载均衡-LVS</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/07/10/IT科学技术知识体系结构-Linux运维方向/高并发/负载均衡/4层负载均衡-LVS/LVS性能指标及监控/" class="leancloud_visitors" data-flag-title="LVS性能指标及监控">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          
              <div class="post-description">
                  LVS性能指标及监控
              </div>
          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><strong>参考文献：</strong></p>
<ul>
<li><a href="http://kb.linuxvirtualserver.org/wiki/Performance_and_Tuning" target="_blank" rel="noopener">Performance and Tuning - LVSKB</a></li>
</ul>
<h1 id="性能参数"><a href="#性能参数" class="headerlink" title="性能参数"></a>性能参数</h1><p>LVS 的性能主要通过以下几个方面来提高</p>
<h2 id="ipvs-connection-table-size-最大连接数"><a href="#ipvs-connection-table-size-最大连接数" class="headerlink" title="ipvs connection table size-最大连接数"></a>ipvs connection table size-最大连接数</h2><p>官方的解释如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">The IPVS connection hash table uses the chaining scheme to handle</span><br><span class="line">hash collisions. Using a big IPVS connection hash table will greatly</span><br><span class="line">reduce conflicts when there are hundreds of thousands of connections</span><br><span class="line">in the hash table.</span><br><span class="line"></span><br><span class="line">Note the table size must be power of 2. The table size will be the</span><br><span class="line">value of 2 to the your input number power. The number to choose is</span><br><span class="line">from 8 to 20, the default number is 12, which means the table size</span><br><span class="line">is 4096. Don&apos;t input the number too small, otherwise you will lose</span><br><span class="line">performance on it. You can adapt the table size yourself, according</span><br><span class="line">to your virtual server application. It is good to set the table size</span><br><span class="line">not far less than the number of connections per second multiplying</span><br><span class="line">average lasting time of connection in the table.  For example, your</span><br><span class="line">virtual server gets 200 connections per second, the connection lasts</span><br><span class="line">for 200 seconds in average in the connection table, the table size</span><br><span class="line">should be not far less than 200x200, it is good to set the table</span><br><span class="line">size 32768 (2**15).</span><br><span class="line"></span><br><span class="line">Another note that each connection occupies 128 bytes effectively and</span><br><span class="line">each hash entry uses 8 bytes, so you can estimate how much memory is</span><br><span class="line">needed for your box.</span><br><span class="line"></span><br><span class="line">You can overwrite this number setting conn_tab_bits module parameter</span><br><span class="line">or by appending ip_vs.conn_tab_bits=? to the kernel command line</span><br><span class="line">if IP VS was compiled built-in.</span><br></pre></td></tr></table></figure>
<p><strong>说明：</strong></p>
<ul>
<li><p>LVS的连接信息使用<code>IPVS connection hash table</code>这个哈希表去保存，它记录每个进来的连接及路由去向的信息 </p>
<blockquote>
<p>任何一个报文到达都需要查找连接Hash表。Hash表的查找复杂度为O(n/m)，其中n为Hash表中对象的个数，m为Hash表的桶个数。当对象在Hash表中均匀分布和Hash表的桶个数与对象个数一样多时，Hash表的查找复杂度可以接近O(1)。 </p>
</blockquote>
</li>
<li><p><code>table size</code>使用2的幂次方进行配置指定，范围为8-20，也就是说连接数的取值范围为：2^8-2^20</p>
</li>
<li><p>默认配置为2^12，也就是4096个连接数上限</p>
</li>
<li><p>在生产环境中，我们一般设置为最大值，也就是2^20（1048576）</p>
</li>
<li><p>注意，这些连接是需要占用内存的，因此要考虑到内存大小的因素</p>
<blockquote>
<p>每一个TCP连接需要占用约128字节，哈希表的每个条目需要占用8字节</p>
<p>以设置为最大值为例，那么，这些连接以及条目共占用内存如下：</p>
<p>2^20*(128byte+8byte) = 142606336byte = 136MB</p>
</blockquote>
</li>
</ul>
<p><strong>配置：</strong></p>
<p>在/etc/modprobe.d/目录下添加文件ip_vs.conf，内容为：</p>
<p>options ip_vs conn_tab_bits=22（文档中写的上限是20，但是实际配置的时候发现22也是可以的）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">echo &apos;options ip_vs conn_tab_bits=22&apos; &gt; /etc/modprobe.d/ipvs.conf</span><br><span class="line">modprobe -r ip_vs &amp;&amp; modprobe -a ip_vs</span><br><span class="line">ipvsadm -Ln</span><br></pre></td></tr></table></figure>
<p>注意，在卸载内核模块的时候，可能会有依赖关系，这时候使用lsmod先查看依赖调用关系，将调用的模块卸载之后再进行操作，例如，这里的操作如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@lvs001 modprobe.d]# modprobe -r ip_vs_rr</span><br><span class="line">[root@lvs001 modprobe.d]# modprobe -r ip_vs</span><br><span class="line">[root@lvs001 modprobe.d]# modprobe -a ip_vs</span><br><span class="line">[root@lvs001 modprobe.d]# modprobe -a ip_vs_rr</span><br></pre></td></tr></table></figure>
<h2 id="CPU-Soft-Interrupt-CPU软中断"><a href="#CPU-Soft-Interrupt-CPU软中断" class="headerlink" title="CPU Soft Interrupt -CPU软中断"></a>CPU Soft Interrupt -CPU软中断</h2><p>在Linux的网络调优方面，如果你发现网络流量上不去，那么有一个方面需要去查一下：<strong>网卡处理网络请求的中断是否被绑定/发送到单个CPU，导致只有一个CPU处理网络请求</strong></p>
<p>但是，在当前的对称多核处理器服务器上，一块网卡的IRQ还是只有一个CPU来响应，其它CPU无法参与，如果这个CPU还要忙其它的中断（其它网卡或者其它使用中断的外设（比如磁盘）），那么就会形成瓶颈。 </p>
<p><strong>动态查看CPU的irq情况</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">命令：mpstat -P ALL 1 </span><br><span class="line">%irq一列即说明了CPU忙于处理中断的时间占比</span><br></pre></td></tr></table></figure>
<p><strong>查看CPU处理中断的情况</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat /proc/interrupts </span><br><span class="line">这里记录的是自启动以来，每个CPU处理各类中断的数量（第一列是中断号，最后一列是对应的设备名）</span><br></pre></td></tr></table></figure>
<p>我们进行过滤，获取网卡的中断号，然后再分析CPU的中断情况</p>
<p>获取对应的中断号</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@lvs001 ~]# cat /proc/interrupts  | egrep &apos;em1|em2|p1p1|p1p2&apos; | awk &apos;&#123;print $1&#125;&apos;</span><br><span class="line">157:</span><br><span class="line">158:</span><br><span class="line">159:</span><br><span class="line">160:</span><br><span class="line">161:</span><br><span class="line">162:</span><br><span class="line">163:</span><br><span class="line">164:</span><br><span class="line">165:</span><br><span class="line">166:</span><br><span class="line">167:</span><br><span class="line">168:</span><br><span class="line">169:</span><br><span class="line">170:</span><br><span class="line">171:</span><br><span class="line">172:</span><br><span class="line">173:</span><br><span class="line">174:</span><br><span class="line">175:</span><br><span class="line">176:</span><br></pre></td></tr></table></figure>
<p>获取CPU的处理信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@lvs001 ~]# for i in &#123;157..176&#125;;do cat /proc/interrupts  | egrep -w $i ;done</span><br><span class="line"> 157:   13529132          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      em1-tx-0</span><br><span class="line"> 158:   32642550          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      em1-rx-1</span><br><span class="line"> 159:   30481981          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      em1-rx-2</span><br><span class="line"> 160:   15555217          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      em1-rx-3</span><br><span class="line"> 161:   25509530          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      em1-rx-4</span><br><span class="line"> 162:   13538297          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      em2-tx-0</span><br><span class="line"> 163:   25653580          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      em2-rx-1</span><br><span class="line"> 164:   25741710          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      em2-rx-2</span><br><span class="line"> 165:   35448970          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      em2-rx-3</span><br><span class="line"> 166:   25494937          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      em2-rx-4</span><br><span class="line"> 167:     256824          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      p1p1-tx-0</span><br><span class="line"> 168:     281534          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      p1p1-rx-1</span><br><span class="line"> CAL:        133     863797        189        189        189        189        188        189        189        189        189        189        189        189        189        189        188        188        168        185        188        186        188        188        188        188        188        188        188        189        187        130   Function call interrupts</span><br><span class="line"> 169:      64639          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      p1p1-rx-2</span><br><span class="line"> 170:      65879          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      p1p1-rx-3</span><br><span class="line"> 171:     425700          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      p1p1-rx-4</span><br><span class="line"> 172:     256754          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      p1p2-tx-0</span><br><span class="line"> 173:      43230          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      p1p2-rx-1</span><br><span class="line"> 174:          4          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      p1p2-rx-2</span><br><span class="line"> 175:          5          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      p1p2-rx-3</span><br><span class="line"> 176:          3          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      p1p2-rx-4</span><br><span class="line">[root@lvs001 ~]#</span><br></pre></td></tr></table></figure>
<p>这里显示不友好，建议复制到编辑器中查看</p>
<p>可以看到，这些网卡的中断都是由CPU0来处理的</p>
<p><strong>查看</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@lvs002 ~]# for i in &#123;157..176&#125;;do cat /proc/irq/$i/smp_affinity;done</span><br></pre></td></tr></table></figure>
<p><strong>配置</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for i in &#123;157..176&#125;;do echo ffffffff &gt; /proc/irq/$i/smp_affinity;done</span><br></pre></td></tr></table></figure>
<h2 id="Netfilter-Connection-Track-连接跟踪"><a href="#Netfilter-Connection-Track-连接跟踪" class="headerlink" title="Netfilter Connection Track-连接跟踪"></a>Netfilter Connection Track-连接跟踪</h2><p><strong>原文：</strong></p>
<p><a href="http://kb.linuxvirtualserver.org/wiki/IPVS" target="_blank" rel="noopener">IPVS</a> uses its own simple and fast connection tracking for performance reasons, instead of using netfilter connection tracking. So, if you don’t use firewalling feature at <a href="http://kb.linuxvirtualserver.org/wiki/Load_balancer" target="_blank" rel="noopener">load balancer</a> and you need an extremely fast load balancer, do not load netfilter conntrack modules into you system, because there is no need to do double tracking. Note that <a href="http://kb.linuxvirtualserver.org/wiki/LVS/NAT" target="_blank" rel="noopener">LVS/NAT</a> should work too without the conntrack modules.</p>
<p>Julian compared the performance of IPVS with ip_conntrack and without ip_conntrack. See <a href="http://archive.linuxvirtualserver.org/html/lvs-users/2001-12/msg00141.html" target="_blank" rel="noopener">http://archive.linuxvirtualserver.org/html/lvs-users/2001-12/msg00141.html</a></p>
<p>默认情况下LVS自身会记录连接信息，但是 iptables 也会记录 connection 的状态，但是很多情况下，我们并不需要 iptables 来做这件事，</p>
<p>我们可以告诉它 NOTRACK，不要记录这些信息。</p>
<p><strong>配置：</strong></p>
<p>增加raw表，在其他表处理之前，-j NOTRACK跳过其它表处理 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">iptables -t raw -A PREROUTING -d 103.13.244.16/29 -p tcp --dport 80 -j NOTRACK </span><br><span class="line">iptables -t raw -A OUTPUT -d 103.13.244.16/29 -p tcp --dport 80 -j NOTRACK </span><br><span class="line">iptables -t raw -A PREROUTING -d 103.13.244.16/29 -p tcp --dport 443 -j NOTRACK </span><br><span class="line">iptables -t raw -A OUTPUT -d 103.13.244.16/29 -p tcp --dport 443 -j NOTRACK </span><br><span class="line"></span><br><span class="line">[root@lvs002 ~]# /etc/init.d/iptables  save</span><br></pre></td></tr></table></figure>
<p>与之同时，因为涉及到内网之间的通信，因此这里也将连接跟踪表进行调大</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># vim /etc/sysctl.conf</span><br><span class="line"></span><br><span class="line">net.netfilter.nf_conntrack_max = 3065536 </span><br><span class="line">net.nf_conntrack_max = 3065536 </span><br><span class="line"></span><br><span class="line"># sysctl -p</span><br></pre></td></tr></table></figure>
<h2 id="Real-Server-syn-cookie参数"><a href="#Real-Server-syn-cookie参数" class="headerlink" title="Real Server - syn cookie参数"></a>Real Server - syn cookie参数</h2><p>参考链接：</p>
<ul>
<li><a href="https://link.zhihu.com/?target=http%3A//archive.linuxvirtualserver.org/html/lvs-users/2013-05/msg00020.html" target="_blank" rel="noopener">lvs-users IPVS SYN-cookies</a>  </li>
</ul>
<p>SYN Cookie是对TCP服务器端的<a href="https://baike.baidu.com/item/%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%8D%8F%E8%AE%AE" target="_blank" rel="noopener">三次握手协议</a>作一些修改，专门用来防范SYN Flood攻击的一种手段。它的原理是，在TCP服务器收到TCP SYN包并返回TCP SYN+ACK包时，不分配一个专门的数据区，而是根据这个SYN包计算出一个cookie值。在收到TCP ACK包时，TCP服务器在根据那个cookie值检查这个TCP ACK包的合法性。如果合法，再分配专门的数据区进行处理未来的TCP连接。 </p>
<p>SYN Flood攻击利用的是IPv4中TCP协议的<a href="https://baike.baidu.com/item/%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B" target="_blank" rel="noopener">三次握手</a>（Three-Way Handshake）过程进行的攻击。TCP协议规定，一端向另一端发起TCP连接时，它需要首先发送SYN 包到对方，对方收到后发送一个SYN+ACK包回来，发起方再发送 ACK包回去，这样<a href="https://baike.baidu.com/item/%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B" target="_blank" rel="noopener">三次握手</a>就结束了。我们把TCP连接的发起方叫作”TCP客户机（TCP Client）”，TCP连接的接收方叫作”TCP服务器（TCP Server）”。值得注意的是在TCP服务器收到TCP SYN request包时，在发送TCP SYN+ACK包回TCP客户机前，TCP服务器要先分配好一个数据区专门服务于这个即将形成的TCP连接。一般把收到SYN包而还未收到ACK包时的连接状态称为半开连接（Half-open Connection）。</p>
<p>在最常见的SYN Flood攻击中，攻击者在短时间内发送大量的TCP SYN包给受害者，这时攻击者是TCP客户机，受害者是TCP服务器。根据上面的描述，受害者会为每个TCP SYN包分配一个特定的数据区，只要这些SYN包具有不同的源地址（这一点对于攻击者来说是很容易伪造的）。这将给TCP<a href="https://baike.baidu.com/item/%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%B3%BB%E7%BB%9F" target="_blank" rel="noopener">服务器系统</a>造成很大的系统负担，最终导致系统不能正常工作。</p>
<p><a href="https://github.com/torvalds/linux/blob/6b15d6650c5301ce023d8df0cc3a60b1a76d377e/Documentation/networking/ip-sysctl.txt#L66" target="_blank" rel="noopener">内核文档说明</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">tcp_syncookies - BOOLEAN</span><br><span class="line">	Only valid when the kernel was compiled with CONFIG_SYN_COOKIES</span><br><span class="line">	Send out syncookies when the syn backlog queue of a socket</span><br><span class="line">	overflows. This is to prevent against the common &apos;SYN flood attack&apos;</span><br><span class="line">	Default: 1</span><br><span class="line"></span><br><span class="line">	Note, that syncookies is fallback facility.</span><br><span class="line">	It MUST NOT be used to help highly loaded servers to stand</span><br><span class="line">	against legal connection rate. If you see SYN flood warnings</span><br><span class="line">	in your logs, but investigation	shows that they occur</span><br><span class="line">	because of overload with legal connections, you should tune</span><br><span class="line">	another parameters until this warning disappear.</span><br><span class="line">	See: tcp_max_syn_backlog, tcp_synack_retries, tcp_abort_on_overflow.</span><br><span class="line"></span><br><span class="line">	syncookies seriously violate TCP protocol, do not allow</span><br><span class="line">	to use TCP extensions, can result in serious degradation</span><br><span class="line">	of some services (f.e. SMTP relaying), visible not by you,</span><br><span class="line">	but your clients and relays, contacting you. While you see</span><br><span class="line">	SYN flood warnings in logs not being really flooded, your server</span><br><span class="line">	is seriously misconfigured.</span><br><span class="line"></span><br><span class="line">	If you want to test which effects syncookies have to your</span><br><span class="line">	network connections you can set this knob to 2 to enable</span><br><span class="line">	unconditionally generation of syncookies.</span><br></pre></td></tr></table></figure>
<p>注意，即使开启该机制并不意味着所有的连接都是用SYN cookies机制来完成连接的建立，只有在半连接队列已满的情况下才会触发SYN cookies机制。由于SYN cookies机制严重违背TCP协议，不允许使用TCP扩展，可能对某些服务造成严重的性能影响（如SMTP转发），对于防御SYN flood攻击的确有效。对于没有收到攻击的高负载服务器，不要开启此选项，可以通过修改tcp_max_syn_backlog、tcp_synack_retries和tcp_abort_on_overflow系统参数来调节。</p>
<p>tcp_max_syn_backlog变量告诉你在内存中可以缓存多少个SYN请求。该变量需要打开tcp_syncookies才有效。如果服务器负载很高，可以尝试提高该变量的值。</p>
<p>tcp_synack_retries变量用于TCP三次握手机制中第二次握手，当收到客户端发来的SYN连接请求后，服务端将回复SYN+ACK包，这时服务端处于SYN_RCVD状态，并等 待客户端发来的回复ACK包。如果服务端没有收到客户端的ACK包，会重新发送SYN+ACK包，直到收到客户端的ACK包。该变量设置发送 SYN+ACK包的次数，超过这个次数，服务端将放弃连接。默认值是5。</p>
<p>tcp_abort_on_overflow变量的值是个布尔值，默认值为0（FALSE关闭）。如果开启，当服务端接收新连接的速度变慢时，服务端会发送RST包（reset包）给客户端，令客户端 重新连接。这意味着如果突然发生溢出，将重获连接。仅当你真的确定不能通过调整监听进程使接收连接的速度变快，可以启用该选项。该选项会影响到客户的连接。</p>
<p><strong>配置：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># vim /etc/sysctl.conf </span><br><span class="line">net.ipv4.tcp_syncookies = 1</span><br><span class="line">net.ipv4.tcp_tw_reuse = 1</span><br><span class="line">net.ipv4.tcp_tw_recycle = 1</span><br><span class="line">net.ipv4.tcp_fin_timeout = 30</span><br><span class="line">net.ipv4.tcp_max_syn_backlog = 2048</span><br><span class="line">保存退出后，执行：</span><br><span class="line"># sysctl -p</span><br></pre></td></tr></table></figure>
<p>参数说明如下：</p>
<p>net.ipv4.tcp_syncookies = 1<br>#表示开启SYN Cookies。当出现SYN等待队列溢出时，启用cookies来处理，可防范少量SYN<em>*</em>，默认为0，表示关闭；</p>
<p>net.ipv4.tcp_tw_reuse = 1<br>#表示开启重用。允许将TIME-WAIT sockets重新用于新的TCP连接，默认为0，表示关闭；为1，开启；</p>
<p>这个酌情开启，这里暂时不开启</p>
<p>net.ipv4.tcp_tw_recycle = 1<br>#表示开启TCP连接中TIME-WAIT sockets的快速回收，默认为0，表示关闭；为1，开启；</p>
<p>net.ipv4.tcp_fin_timeout</p>
<p>#修改系統默认的 TIMEOUT 时间，<strong>这里根据服务器的实际情况设置</strong>。默认为60秒</p>
<p>  另外细心的朋友可能发现了，报错信息： Possible SYN flooding on port 13370. Sending cookies.后面跟了句”Check SNMP counters”。这句我当时差点被误导，因为我的服务器上正好跑了一个snmp抓流量的服务，开始以为是它导致的，后来一想那是udp的协议，和tcp没关系呀。查了<a href="https://github.com/torvalds/linux/blob/797cee982eef9195736afc5e7f3b8f613c41d19a/net/ipv4/tcp_input.c" target="_blank" rel="noopener">kernel</a>的代码发现，原来那是print打印的固定info输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">static bool tcp_syn_flood_action(const struct sock *sk,</span><br><span class="line">                const struct sk_buff *skb,</span><br><span class="line">                const char *proto)</span><br><span class="line">&#123;</span><br><span class="line">    struct request_sock_queue *queue = &amp;inet_csk(sk)-&gt;icsk_accept_queue;</span><br><span class="line">    const char *msg = &quot;Dropping request&quot;;</span><br><span class="line">    bool want_cookie = false;</span><br><span class="line">    struct net *net = sock_net(sk);</span><br><span class="line">#ifdef CONFIG_SYN_COOKIES</span><br><span class="line">    if (net-&gt;ipv4.sysctl_tcp_syncookies) &#123;</span><br><span class="line">        msg = &quot;Sending cookies&quot;;</span><br><span class="line">        want_cookie = true;</span><br><span class="line">        __NET_INC_STATS(sock_net(sk), LINUX_MIB_TCPREQQFULLDOCOOKIES);</span><br><span class="line">    &#125; else</span><br><span class="line">#endif</span><br><span class="line">        __NET_INC_STATS(sock_net(sk), LINUX_MIB_TCPREQQFULLDROP);</span><br><span class="line">    if (!queue-&gt;synflood_warned &amp;&amp;</span><br><span class="line">    net-&gt;ipv4.sysctl_tcp_syncookies != 2 &amp;&amp;</span><br><span class="line">    xchg(&amp;queue-&gt;synflood_warned, 1) == 0)</span><br><span class="line">        pr_info(&quot;%s: Possible SYN flooding on port %d. %s.  Check SNMP counters.\n&quot;,</span><br><span class="line">            proto, ntohs(tcp_hdr(skb)-&gt;dest), msg);</span><br><span class="line">    return want_cookie;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="关闭网卡LRO和GRO"><a href="#关闭网卡LRO和GRO" class="headerlink" title="关闭网卡LRO和GRO"></a>关闭网卡LRO和GRO</h2><p>现在大多数网卡都具有LRO/GRO功能，即 网卡收包时将同一流的小包合并成大包 （tcpdump抓包可以看到&gt;MTU 1500bytes的数据包）交给 内核协议栈；LVS内核模块在处理&gt;MTU的数据包时，会丢弃；</p>
<p>因此，如果我们用LVS来传输大文件，很容易出现丢包，传输速度慢；</p>
<p>解决方法，关闭LRO/GRO功能，命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ethtool -k eth0 查看LRO/GRO当前是否打开</span><br><span class="line">ethtool -K eth0 lro off 关闭GRO</span><br><span class="line">ethtool -K eth0 gro off 关闭GRO</span><br><span class="line"></span><br><span class="line">查看：</span><br><span class="line">[root@lvs001 ~]# ethtool -k p1p1 | grep offload</span><br><span class="line">[root@lvs001 ~]# ethtool -k p1p2 | grep offload</span><br><span class="line"></span><br><span class="line">配置：</span><br><span class="line">[root@lvs001 ~]# ethtool -K p1p1 lro off</span><br><span class="line">[root@lvs001 ~]# ethtool -K p1p1 gro off</span><br><span class="line">[root@lvs001 ~]# ethtool -K p1p2 lro off</span><br><span class="line">[root@lvs001 ~]# ethtool -K p1p2 gro off</span><br></pre></td></tr></table></figure>
<p>offload特性，主要是指将原本在协议栈中进行的IP分片、TCP分段、重组、checksum校验等操作，转移到网卡硬件中进行，降低系统CPU的消耗，提高处理性能。 </p>
<p>包括 LSO/LRO、GSO/GRO、TSO/UFO 等。</p>
<p><strong>LSO/LRO</strong></p>
<p>分别对应到发送和接收两个方向，是 Large Segment Offload 和 Large Receive Offload。</p>
<p>首先来看 LSO。我们知道计算机网络上传输的数据基本单位是离散的网包，既然是网包，就有大小限制，这个限制就是 MTU（Maximum Transmission Unit）的大小，一般是1518字节。比如我们想发送很多数据出去，经过os协议栈的时候，会自动帮你拆分成几个不超过MTU的网包。然而，这个拆分是比较费计算资源的（比如很多时候还要计算分别的checksum），由 CPU 来做的话，往往会造成使用率过高。那可不可以把这些简单重复的操作 offload 到网卡上呢？</p>
<p>于是就有了 LSO，在发送数据超过 MTU 限制的时候（太容易发生了），OS 只需要提交一次传输请求给网卡，网卡会自动的把数据拿过来，然后进行切，并封包发出，发出的网包不超过 MTU 限制。</p>
<p>接下来看 LSO，当网卡收到很多碎片包的时候，LRO 可以辅助自动组合成一段较大的数据，一次性提交给 OS处理。</p>
<p>一般的，LSO 和 LRO 主要面向 TCP 报文。</p>
<p><strong>GSO/GRO</strong></p>
<p>Generic Segmentation Offload 和 Generic Receive Offload，分别比 LSO 和 LRO 更通用，自动检测网卡支持特性，支持分包则直接发给网卡，否则先分包后发给网卡。新的驱动一般用 GSO/GRO。 </p>
<p><strong>TSO/UFO</strong></p>
<p>TCP Segmentation Offload 和 UDP fragmentation offload，分别对应 TCP 报文和 UDP 报文。</p>
<p>很典型的，TCP 协议中就考虑了分片存在的情况，往往是切分 TCP 的数据包，叫做 TSO。而一般的情况，则称为 LSO 或者 GSO。</p>
<p>对于其他不支持切片的协议例如 UDP，则只能进行 IP 层上的切片。</p>
<p><strong>检查与开关</strong></p>
<p>可以通过 <code>ethtool -k eth0</code> 命令来查看各个选项的当前状态，注意输出中各种 off-load 选项的状态。 </p>
<p><strong>总结</strong></p>
<p>也就是说，在将数据包转发出去的时候，包的大小必须小于1500字节，但是在处理收到的数据包的时候，包的大小没有1500字节的限制</p>
<ul>
<li>发送模式：<ul>
<li>TSO</li>
<li>GSO</li>
<li>UFO</li>
</ul>
</li>
<li>接收模式：<ul>
<li>LRO</li>
<li>GRO</li>
<li>RSS</li>
</ul>
</li>
</ul>
<p><strong>注意</strong></p>
<p>目前常用的抓包工具大部分都是从协议栈中（如数据链路层）捕获数据包，而网卡的offload特性会将数据包的分片、重组等工作转移到协议栈以下的硬件层面进行，因此在开启TSO、GRO等机制的情况下，我们使用tcpdump、wireshark等工具抓取到的数据包往往不能真实反应链路上实际的数据帧，给网络流量特征的分析造成不利影响。</p>
<p>在某些情况下，例如分片攻击等攻击方式，甚至可能会因为网卡设备的offload机制处理，而规避防火墙、IDS以及人工的检查。针对这些情况，可以选择关闭网卡offload的相关选项，或者在链路的其他节点进行抓包。</p>
<h2 id="proc下的IP-VS参数设置"><a href="#proc下的IP-VS参数设置" class="headerlink" title="/proc下的IP_VS参数设置"></a>/proc下的IP_VS参数设置</h2><p>根据前文的介绍，可以通过ipvsadm命令和LVS内核打交道；</p>
<p>除此之外，我们还可以通过proc参数，来 配置全局参数 和 获取统计信息；</p>
<ul>
<li>配置全局参数，位于目录/proc/sys/net/ipv4/vs/下；</li>
<li>获取统计信息，位于目录/proc/net/下；</li>
</ul>
<p>参考资料：<a href="https://github.com/torvalds/linux/blob/master/Documentation/networking/ipvs-sysctl.txt#L41" target="_blank" rel="noopener">官方内核文档</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@lvs001 ~]# ll /proc/sys/net/ipv4/vs | awk &apos;&#123;print $9&#125;&apos;</span><br><span class="line">am_droprate</span><br><span class="line">amemthresh</span><br><span class="line">cache_bypass</span><br><span class="line">conn_reuse_mode</span><br><span class="line">drop_entry</span><br><span class="line">drop_packet</span><br><span class="line">expire_nodest_conn</span><br><span class="line">expire_quiescent_template</span><br><span class="line">nat_icmp_send</span><br><span class="line">secure_tcp</span><br><span class="line">sync_qlen_max</span><br><span class="line">sync_refresh_period</span><br><span class="line">sync_retries</span><br><span class="line">sync_sock_size</span><br><span class="line">sync_threshold</span><br><span class="line">sync_version</span><br></pre></td></tr></table></figure>
<p>有一些几个参数需要进行调整</p>
<ul>
<li><p>cache_bypass </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cache_bypass - BOOLEAN</span><br><span class="line">        0 - disabled (default)</span><br><span class="line">        not 0 - enabled</span><br><span class="line"></span><br><span class="line">        If it is enabled, forward packets to the original destination</span><br><span class="line">        directly when no cache server is available and destination</span><br><span class="line">        address is not local (iph-&gt;daddr is RTN_UNICAST). It is mostly</span><br><span class="line">        used in transparent web cache cluster.</span><br></pre></td></tr></table></figure>
<p>主要用于缓存体系，enable之后，当后端配置的是缓存系统的时候，当没有可用的sever时，直接将数据包转发给后端的数据产生节点</p>
</li>
</ul>
<ul>
<li><p>conn_reuse_mode </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">conn_reuse_mode - INTEGER</span><br><span class="line">	1 - default</span><br><span class="line"></span><br><span class="line">	Controls how ipvs will deal with connections that are detected</span><br><span class="line">	port reuse. It is a bitmap, with the values being:</span><br><span class="line"></span><br><span class="line">	0: disable any special handling on port reuse. The new</span><br><span class="line">	connection will be delivered to the same real server that was</span><br><span class="line">	servicing the previous connection. This will effectively</span><br><span class="line">	disable expire_nodest_conn.</span><br><span class="line"></span><br><span class="line">	bit 1: enable rescheduling of new connections when it is safe.</span><br><span class="line">	That is, whenever expire_nodest_conn and for TCP sockets, when</span><br><span class="line">	the connection is in TIME_WAIT state (which is only possible if</span><br><span class="line">	you use NAT mode).</span><br><span class="line"></span><br><span class="line">	bit 2: it is bit 1 plus, for TCP connections, when connections</span><br><span class="line">	are in FIN_WAIT state, as this is the last state seen by load</span><br><span class="line">	balancer in Direct Routing mode. This bit helps on adding new</span><br><span class="line">	real servers to a very busy cluster.</span><br></pre></td></tr></table></figure>
<p>用户后端server开启端口reuse（端口复用，服务器上启动多个进程监听同一个端口，在tenginx中使用时能够极大的提高性能）的情况。</p>
<p>当设置enable的时候，接受到新连接之后，将进行重新调度，将连接请求分发到启动该端口的其他进程上</p>
</li>
<li><p>expire_nodest_conn</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">expire_nodest_conn - BOOLEAN</span><br><span class="line">        0 - disabled (default)</span><br><span class="line">        not 0 - enabled</span><br><span class="line"></span><br><span class="line">        The default value is 0, the load balancer will silently drop</span><br><span class="line">        packets when its destination server is not available. It may</span><br><span class="line">        be useful, when user-space monitoring program deletes the</span><br><span class="line">        destination server (because of server overload or wrong</span><br><span class="line">        detection) and add back the server later, and the connections</span><br><span class="line">        to the server can continue.</span><br><span class="line"></span><br><span class="line">        If this feature is enabled, the load balancer will expire the</span><br><span class="line">        connection immediately when a packet arrives and its</span><br><span class="line">        destination server is not available, then the client program</span><br><span class="line">        will be notified that the connection is closed. This is</span><br><span class="line">        equivalent to the feature some people requires to flush</span><br><span class="line">        connections when its destination is not available.</span><br></pre></td></tr></table></figure>
<p>设置为0时，当后端的server被检测为不可用时，不会立即将连接断开，而是会保持一段时间，让其自然过期失效，如果在这个过程当中，server又恢复正常，那么将继续使用这个连接</p>
<p>当设置为为enable（非0）时，当检测到后端的server不可用时，将会立即将这个连接关闭。</p>
</li>
<li><p>expire_quiescent_template </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">expire_quiescent_template - BOOLEAN</span><br><span class="line">	0 - disabled (default)</span><br><span class="line">	not 0 - enabled</span><br><span class="line"></span><br><span class="line">	When set to a non-zero value, the load balancer will expire</span><br><span class="line">	persistent templates when the destination server is quiescent.</span><br><span class="line">	This may be useful, when a user makes a destination server</span><br><span class="line">	quiescent by setting its weight to 0 and it is desired that</span><br><span class="line">	subsequent otherwise persistent connections are sent to a</span><br><span class="line">	different destination server.  By default new persistent</span><br><span class="line">	connections are allowed to quiescent destination servers.</span><br><span class="line"></span><br><span class="line">	If this feature is enabled, the load balancer will expire the</span><br><span class="line">	persistence template if it is to be used to schedule a new</span><br><span class="line">	connection and the destination server is quiescent.</span><br></pre></td></tr></table></figure>
<p>默认值为0，当RS的weight为0时（例如健康监测失败时，LB会将RS的权重重置为0），会话保持的新建连接还会继续调度到该RS上</p>
<p>如果设置为非0，那么当weight为0时，LB会将话保持的连接模板置为无效，重新调度新的RS； </p>
</li>
<li><p>sync_threshold</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">sync_threshold - vector of 2 INTEGERs: sync_threshold, sync_period</span><br><span class="line">	default 3 50</span><br><span class="line"></span><br><span class="line">	It sets synchronization threshold, which is the minimum number</span><br><span class="line">	of incoming packets that a connection needs to receive before</span><br><span class="line">	the connection will be synchronized. A connection will be</span><br><span class="line">	synchronized, every time the number of its incoming packets</span><br><span class="line">	modulus sync_period equals the threshold. The range of the</span><br><span class="line">	threshold is from 0 to sync_period.</span><br><span class="line"></span><br><span class="line">	When sync_period and sync_refresh_period are 0, send sync only</span><br><span class="line">	for state changes or only once when pkts matches sync_threshold</span><br></pre></td></tr></table></figure>
<p> 同步阈值设置，该文件中的值为两个整数，默认为3 50 </p>
<p>数值表示含义如下（以3 50为例）：接受到3个数据包及以上，该连接就可以被同步</p>
</li>
</ul>
<h2 id="Linux系统调优-网络内核参数"><a href="#Linux系统调优-网络内核参数" class="headerlink" title="Linux系统调优-网络内核参数"></a>Linux系统调优-网络内核参数</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">net.ipv4.tcp_tw_recyle=1</span><br><span class="line">net.ipv4.tcp_tw_reuse=1</span><br><span class="line">net.ipv4.tcp_max_syn_backlog=8192</span><br><span class="line">net.ipv4.tcp_keepalive_time=1800</span><br><span class="line">net.ipv4.tcp_fin_timeout=30</span><br><span class="line">net.core.rmem_max=16777216</span><br><span class="line">net.core.wmem_max=16777216</span><br><span class="line">net.ipv4.tcp_rmem=4096 87380 16777216</span><br><span class="line">net.ipv4.tcp_wmem=4096 65536 16777216</span><br><span class="line">net.core.netdev_max_backlog=3000</span><br></pre></td></tr></table></figure>
<h2 id="算法优化"><a href="#算法优化" class="headerlink" title="算法优化"></a>算法优化</h2><p><strong>SH调度算法</strong>-<strong>尽量不要采用</strong>  </p>
<p>一些业务为了支持会话保持，选择SH调度算法，以实现 同一源ip的请求调度到同一台RS上；但 SH算法本省没有实现一致性hash，一旦一台RS down，当前所有连接都会断掉；如果配置了inhibit_on_failure，那就更悲剧了，调度到该RS上的流量会一直损失；     实际线上使用时，如需<strong>会话保持</strong>，建议配置<strong>persistence_timeout参数，</strong>保证一段时间同一源ip的请求到同一RS上； </p>
<p><strong>WLC调度算法-注意RS donw-&gt;up的影响</strong>    </p>
<p>WLC算法下，RS一旦出现down后up的情况，瞬间所有的新建连接都会调度到该RS上，可能会超过该RS处理请求的上限；  </p>
<h2 id="快速配置"><a href="#快速配置" class="headerlink" title="快速配置"></a>快速配置</h2><p>[root@lvs002 ~]# vim /etc/sysctl.conf </p>
<p>[root@lvs002 ~]# sysctl  -p</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">net.ipv4.conf.default.rp_filter = 1</span><br><span class="line">net.ipv4.conf.default.accept_source_route = 0</span><br><span class="line">kernel.sysrq = 0</span><br><span class="line">kernel.core_uses_pid = 1</span><br><span class="line">kernel.msgmnb = 65536</span><br><span class="line">kernel.msgmax = 65536</span><br><span class="line">kernel.shmmax = 68719476736</span><br><span class="line">kernel.shmall = 4294967296</span><br><span class="line">net.core.netdev_max_backlog = 2048</span><br><span class="line">net.ipv4.ip_local_port_range = 10000 65000</span><br><span class="line">net.ipv4.tcp_max_tw_buckets = 462144</span><br><span class="line">vm.swappiness = 1</span><br><span class="line">net.ipv4.tcp_max_syn_backlog = 65535</span><br><span class="line">net.core.somaxconn = 32768</span><br><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line">net.netfilter.nf_conntrack_max = 3065536</span><br><span class="line">net.nf_conntrack_max = 3065536</span><br><span class="line">net.ipv4.tcp_syncookies = 1</span><br><span class="line">net.ipv4.tcp_tw_recycle = 1</span><br><span class="line">net.ipv4.tcp_fin_timeout = 30</span><br><span class="line">net.ipv4.tcp_keepalive_time = 1800</span><br><span class="line">net.core.rmem_max = 16777216</span><br><span class="line">net.core.wmem_max = 16777216</span><br><span class="line">net.ipv4.tcp_rmem = 4096 87380 16777216</span><br><span class="line">net.ipv4.tcp_wmem = 4096 65536 16777216</span><br><span class="line">net.core.netdev_max_backlog = 3000</span><br></pre></td></tr></table></figure>
<h1 id="LVS监控"><a href="#LVS监控" class="headerlink" title="LVS监控"></a>LVS监控</h1><p>一般情况下，我们可以通过watch ipvsadm -ln来监视lvs的当前状态，但如果我们想分析一段时间（一周，一月或者更长）的连接数情况，ipvsadm就无能为力了。我们可以借助一个叫lvs-rrd的小工具来达到这个目的。</p>
<p>lvs-rrd官网链接：<a href="http://tepedino.org/lvs-rrd/" target="_blank" rel="noopener">http://tepedino.org/lvs-rrd/</a></p>
<p>但是在这里，由于这个工具只能收集连接数的数据，因此我们还是采用zabbix进行集中监控</p>
<h2 id="使用lvs-rrd监控lvs状态"><a href="#使用lvs-rrd监控lvs状态" class="headerlink" title="使用lvs-rrd监控lvs状态"></a>使用lvs-rrd监控lvs状态</h2><p><a href="http://www.tepedino.org/lvs-rrd/" target="_blank" rel="noopener">lvs_rrd</a>工具实现了网页的形式来查看lvs状态功能。</p>
<p>其主要有两个脚本组成：信息收集脚本和图像绘制脚本。</p>
<p>信息收集脚本是将lvs的信息生成rrd格式的数据文件，然后利用图像绘制脚本生成图像，并生成一个php页面，这个页面中引用其所生成的图像，这样我们可以通过web页面的形式查看生成的php页面，就可以时时的查看lvs的状态信息。</p>
<p>lvs_rrd需要部署在LVS-Master和LVS-Backup上，更准确的说lvs_rrd中的信息收集脚本一定要在LVS director 上运行（不能安装在其他服务器上）。</p>
<p>但是通过配置图像生成脚本和图像的生成目录，我们也可以将源数据时时的复制到其他的服务器中，再在其他服务器上生成图像展示</p>
<p>下面简单的介绍部署的步骤</p>
<p><strong>下载安装rrdtool（画图）工具</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">wget https://oss.oetiker.ch/rrdtool/pub/rrdtool-1.4.7.tar.gz</span><br><span class="line"></span><br><span class="line">yum -y install cairo-devel libxml2-devel pango-devel pango libpng-devel freetype freetype-devel libart_lgpl-devel perl-ExtUtils-CBuilder perl-ExtUtils-MakeMaker dejavu-lgc-sans-fonts</span><br><span class="line"></span><br><span class="line">./configure --prefix=/usr/local/rrdtool</span><br><span class="line">make &amp;&amp;  make install </span><br><span class="line"></span><br><span class="line">echo &quot;/usr/local/rrdtool/lib&quot; &gt;&gt; /etc/ld.so.conf</span><br><span class="line">ldconfig</span><br></pre></td></tr></table></figure>
<p><strong>安装nginx</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">yum -y install pcre pcre-devel php php-fpm</span><br><span class="line"></span><br><span class="line">useradd -s /sbin/nologin nginx</span><br><span class="line"></span><br><span class="line">wget https://nginx.org/download/nginx-1.14.0.tar.gz</span><br><span class="line"></span><br><span class="line">./configure --prefix=/usr/local/nginx --user=nginx --group=nginx --with-http_ssl_module --with-http_stub_status_module --with-pcre</span><br><span class="line"></span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>
<p>注意修改nginx的监听端口为非80</p>
<p><strong>nginx+php配置</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/php-fpm start</span><br><span class="line">chkconfig php-fpm on</span><br></pre></td></tr></table></figure>
<p>在nginx配置文件中添加以下内容</p>
<pre><code>location ~ \.php$ {
    root           html;
    fastcgi_pass   127.0.0.1:9000;
    fastcgi_index  index.php;
    fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;
    include        fastcgi_params;
}
</code></pre><p><strong>下载安装lvs-rrd工具</strong></p>
<p>这里使用最新的0.7版本，该版本要求rrdtool版本最低为： 1.2.x </p>
<p>将lvs-rrd-v0.7.tar.gz解压后将文件夹复制到/data/www/目录下并更名为lvs</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget http://tepedino.org/lvs-rrd/lvs-rrd-v0.7.tar.gz</span><br><span class="line">tar -zxvf lvs-rrd-v0.7.tar.gz</span><br><span class="line"></span><br><span class="line">mv lvs-rrd-v0.7 /usr/local/nginx/html/lvs-rrd</span><br></pre></td></tr></table></figure>
<p>修改相应的脚本文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vim lvs.rrd.update 修改以下内容</span><br><span class="line"></span><br><span class="line">RRDTOOL=&quot;/usr/local/rrdtool/bin/rrdtool&quot;	#rrdtool可执行程序路径</span><br><span class="line">IPVSADM=&quot;/sbin/ipvsadm&quot;					   #ipvsadm命令路径</span><br><span class="line">WORKDIR=&quot;/data1/lvs-rrd&quot;				   #rrdtool收集的数据的存放路径</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">vim graph-lvs.sh 修改以下内容</span><br><span class="line"></span><br><span class="line"># WORKDIR must match the directory used in the update script.</span><br><span class="line">WORKDIR=&quot;/data1/lvs-rrd&quot;				#rrdtool收集的数据的存放路径,同上面一致</span><br><span class="line">RRDTOOL=&quot;/usr/local/rrdtool/bin/rrdtool&quot;  #rrdtool可执行程序路径</span><br><span class="line"># Where to put the graphs. </span><br><span class="line">GRAPHS=&quot;/data1/lvs-rrd/graphs&quot;			#生成的图片保存路径</span><br><span class="line">WEBPATH=&quot;/lvs-rrd/graphs&quot;				#web访问的路径</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vim lvs-rrd.php</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line">header(&quot;Cache-Control: max-age=300, must-revalidate&quot;);</span><br><span class="line">system(&quot;/usr/local/nginx/html/lvs-rrd/graph-lvs.sh -H&quot;);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>注意：WEBPATH的配置是浏览器实际访问时图片的访问路径，也就是<a href="http://ip:port/webpath/xxx.gif" target="_blank" rel="noopener">http://ip:port/webpath/xxx.gif</a></p>
<p>在日志中的输出显示为：</p>
<p>/usr/local/nginx/html/lvs-rrd/graphs/lvs.All.All.All.All.All-year.gif</p>
<p>因此需要手动在站点目录下创建该目录并创建软链接，将<code>生成的图片保存路径</code>链接到该目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /usr/local/nginx/html/lvs-rrd/graphs</span><br><span class="line">ln -s /data1/lvs-rrd/graphs /usr/local/nginx/html/lvs-rrd/graphs</span><br></pre></td></tr></table></figure>
<p><strong>配置nginx认证</strong></p>
<p>在nginx配置文件的server中配置如下两行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">auth_basic              &quot;dwd&quot;;</span><br><span class="line">auth_basic_user_file    htpasswd;</span><br></pre></td></tr></table></figure>
<p>然后执行以下命令创建加密文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">htpasswd -bc htpasswd  ops-lvs Dwd_Ops_123</span><br></pre></td></tr></table></figure>
<p><strong>配置计划任务</strong></p>
<p>这里，将更新数据的间隔时间设置为30s</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">* * * * * /usr/local/nginx/html/lvs-rrd/lvs.rrd.update &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">* * * * * /usr/local/nginx/html/lvs-rrd/graph-lvs.sh -H &gt; /dev/null 2&gt;&amp;1</span><br><span class="line">* * * * * sleep 30 ; /usr/local/nginx/html/lvs-rrd/lvs.rrd.update &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">* * * * * sleep 30 ; /usr/local/nginx/html/lvs-rrd/graph-lvs.sh -H &gt; /dev/null 2&gt;&amp;1</span><br></pre></td></tr></table></figure>
<h2 id="Zabbix监控LVS"><a href="#Zabbix监控LVS" class="headerlink" title="Zabbix监控LVS"></a>Zabbix监控LVS</h2><p><strong>监控指标：</strong></p>
<p>动态的数据：</p>
<ul>
<li>cps(connect per second) ，每秒的连接数情况</li>
<li>InPPS(input packge per second)，每秒的入向数据包数量情况</li>
<li>OutPPS(output packge per second)，每秒的出向数据包数量情况</li>
<li>InBPS（input byte per second）,每秒的流入字节数情况</li>
<li>OutBPS(output byte per second)，每秒的流出字节数情况</li>
<li>ActiveConn，处于ESAT的连接（使用系统的netstat无法看到）</li>
<li>InActConn，处于非ESAT的连接（使用系统的netstat无法看到）</li>
</ul>
<p>静态统计数据：</p>
<ul>
<li>Conns，自启动之后的总连接数</li>
<li>InPkts，自启动之后的总入向数据包数量统计</li>
<li>OutPkts，自启动之后的总出向数据包数量统计</li>
<li>InBytes，自启动之后的总入向字节数统计</li>
<li>OutBytes，自启动之后的总出向字节数统计</li>
</ul>
<p><strong>监控逻辑：</strong></p>
<p>使用ipvsadm命令从服务器中采集数据</p>
<p>所使用的命令分别为：</p>
<ul>
<li>ipvsadm -Ln –rate</li>
<li>ipvsadm -Ln –stats</li>
</ul>
<p><strong>注意：</strong>zabbix配置文件中需要打开sudo的权限，拥有root的权限之后才能执行ipvsadm命令去获取数据</p>

      
    </div>
    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div></div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/wechatpay.jpg" alt="XiaoHua WANG 微信支付"/>
        <p>微信支付</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/alipay.jpg" alt="XiaoHua WANG 支付宝"/>
        <p>支付宝</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/LVS/" rel="tag"># LVS</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/07/08/编程语言/Python/老男孩视频学习笔记/day03-集合及文件操作知识补充+函数/" rel="next" title="day03-集合及文件操作知识补充+函数">
                <i class="fa fa-chevron-left"></i> day03-集合及文件操作知识补充+函数
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/07/11/IT科学技术知识体系结构-Linux运维方向/性能调优/网络调优/网卡中断与CPU绑定/" rel="prev" title="网卡中断与CPU绑定">
                网卡中断与CPU绑定 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
        <!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
<span class="jiathis_txt">分享到：</span>
<a class="jiathis_button_fav">收藏夹</a>
<a class="jiathis_button_copy">复制网址</a>
<a class="jiathis_button_email">邮件</a>
<a class="jiathis_button_weixin">微信</a>
<a class="jiathis_button_qzone">QQ空间</a>
<a class="jiathis_button_tqq">腾讯微博</a>
<a class="jiathis_button_douban">豆瓣</a>
<a class="jiathis_button_share">一键分享</a>

<a href="http://www.jiathis.com/share?uid=2140465" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a>
<a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript" >
var jiathis_config={
  data_track_clickback:true,
  summary:"",
  shortUrl:false,
  hideMore:false
}
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=" charset="utf-8"></script>
<!-- JiaThis Button END -->
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="lv-container" data-id="city" data-uid="MTAyMC8zMzg1NC8xMDQwNw=="></div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/touxiang.jpg"
                alt="XiaoHua WANG" />
            
              <p class="site-author-name" itemprop="name">XiaoHua WANG</p>
              <p class="site-description motion-element" itemprop="description">Focus on Linux operations and development.</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">60</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">62</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">48</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#性能参数"><span class="nav-number">1.</span> <span class="nav-text">性能参数</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ipvs-connection-table-size-最大连接数"><span class="nav-number">1.1.</span> <span class="nav-text">ipvs connection table size-最大连接数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CPU-Soft-Interrupt-CPU软中断"><span class="nav-number">1.2.</span> <span class="nav-text">CPU Soft Interrupt -CPU软中断</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Netfilter-Connection-Track-连接跟踪"><span class="nav-number">1.3.</span> <span class="nav-text">Netfilter Connection Track-连接跟踪</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Real-Server-syn-cookie参数"><span class="nav-number">1.4.</span> <span class="nav-text">Real Server - syn cookie参数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#关闭网卡LRO和GRO"><span class="nav-number">1.5.</span> <span class="nav-text">关闭网卡LRO和GRO</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#proc下的IP-VS参数设置"><span class="nav-number">1.6.</span> <span class="nav-text">/proc下的IP_VS参数设置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Linux系统调优-网络内核参数"><span class="nav-number">1.7.</span> <span class="nav-text">Linux系统调优-网络内核参数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#算法优化"><span class="nav-number">1.8.</span> <span class="nav-text">算法优化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#快速配置"><span class="nav-number">1.9.</span> <span class="nav-text">快速配置</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#LVS监控"><span class="nav-number">2.</span> <span class="nav-text">LVS监控</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#使用lvs-rrd监控lvs状态"><span class="nav-number">2.1.</span> <span class="nav-text">使用lvs-rrd监控lvs状态</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Zabbix监控LVS"><span class="nav-number">2.2.</span> <span class="nav-text">Zabbix监控LVS</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">XiaoHua WANG</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("mlSs9Cm0Xv2D9B7cFqbp25Df-gzGzoHsz", "alKheIFly9OVC81YCV7otTrf");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  
  

  

  

  

</body>
</html>
